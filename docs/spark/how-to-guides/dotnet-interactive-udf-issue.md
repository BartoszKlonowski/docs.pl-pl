---
title: Pisz i Wywołaj UDF w programie .NET dla środowisk interaktywnych Apache Spark.
description: Dowiedz się, jak pisać i wywoływać UDF w programie .NET dla Apache Spark Interactive shells.
ms.date: 10/09/2020
ms.topic: conceptual
ms.custom: mvc,how-to
ms.openlocfilehash: d02ce7ec92ac1758b490b66d241d4957082eb20e
ms.sourcegitcommit: eb7e87496f42361b1da98562dd75b516c9d58bbc
ms.translationtype: MT
ms.contentlocale: pl-PL
ms.lasthandoff: 10/09/2020
ms.locfileid: "91877931"
---
# <a name="write-and-call-udfs-in-net-for-apache-spark-interactive-environments"></a><span data-ttu-id="bd49f-103">Pisz i Wywołaj UDF w programie .NET dla środowisk interaktywnych Apache Spark</span><span class="sxs-lookup"><span data-stu-id="bd49f-103">Write and call UDFs in .NET for Apache Spark interactive environments</span></span>

<span data-ttu-id="bd49f-104">W tym artykule dowiesz się, jak używać funkcji zdefiniowanych przez użytkownika (UDF) w środowisku programu .NET dla Apache Spark Interactive.</span><span class="sxs-lookup"><span data-stu-id="bd49f-104">In this article you will learn how to use User Defined Functions (UDFs) in a .NET for Apache Spark interactive environment.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="bd49f-105">Wymagania wstępne</span><span class="sxs-lookup"><span data-stu-id="bd49f-105">Prerequisites</span></span>

1. <span data-ttu-id="bd49f-106">Instalowanie [programu .NET Interactive](https://github.com/dotnet/interactive)</span><span class="sxs-lookup"><span data-stu-id="bd49f-106">Install [.NET Interactive](https://github.com/dotnet/interactive)</span></span>
2. <span data-ttu-id="bd49f-107">Zainstaluj [laboratorium Jupyter Lab](https://jupyter.org/)</span><span class="sxs-lookup"><span data-stu-id="bd49f-107">Install [Jupyter lab](https://jupyter.org/)</span></span>

## <a name="net-for-apach-spark-interactive-experience"></a><span data-ttu-id="bd49f-108">Środowisko .NET for Apach Spark Interactive</span><span class="sxs-lookup"><span data-stu-id="bd49f-108">.NET for Apach Spark Interactive experience</span></span>

<span data-ttu-id="bd49f-109">[Platforma .NET dla Apache Spark](https://github.com/dotnet/spark) używa [programu .NET Interactive](https://devblogs.microsoft.com/dotnet/net-interactive-is-here-net-notebooks-preview-2/) , aby zapewnić obsługę środowiska interaktywnego w środowisku Spark.</span><span class="sxs-lookup"><span data-stu-id="bd49f-109">[.NET for Apache Spark](https://github.com/dotnet/spark) uses [.NET Interactive](https://devblogs.microsoft.com/dotnet/net-interactive-is-here-net-notebooks-preview-2/) to provide .NET support for interactive experience inside Spark.</span></span> <span data-ttu-id="bd49f-110">Aby dowiedzieć się, jak skonfigurować środowisko w celu wypróbowania programu .NET Interactive z notesami Jupyter, zobacz [repozytorium interaktywne platformy .NET](https://github.com/dotnet/interactive).</span><span class="sxs-lookup"><span data-stu-id="bd49f-110">To understand how to setup the environment to try .NET Interactive with Jupyter notebooks, see the [.NET Interactive repository](https://github.com/dotnet/interactive).</span></span>

<span data-ttu-id="bd49f-111">Zaleca się także zapoznanie się z [tym artykułem dotyczącym serializacji UDF w programie .NET](udf-guide.md) , aby Apache Spark zrozumieć, jakie UDF są i jak są serializowane w programie .net dla Apache Spark.</span><span class="sxs-lookup"><span data-stu-id="bd49f-111">Also, it is recommended to go through [this article about UDF serialization in .NET for Apache Spark](udf-guide.md) to understand what UDFs are and how they are serialized in .NET for Apache Spark.</span></span>
<span data-ttu-id="bd49f-112">W tym przewodniku wykorzystano notesy Jupyter, które ilustrują sposób korzystania z UDF w interaktywnym środowisku.</span><span class="sxs-lookup"><span data-stu-id="bd49f-112">This guide uses Jupyter Notebooks to illustrate how to use UDFs in an interactive experience.</span></span>

## <a name="define-a-udf-in-net-interactive"></a><span data-ttu-id="bd49f-113">Definiowanie formatu UDF w programie .NET Interactive</span><span class="sxs-lookup"><span data-stu-id="bd49f-113">Define a UDF in .NET Interactive</span></span>

<span data-ttu-id="bd49f-114">W interaktywnym środowisku, komórka może być uważana za fragment kodu, który jest przesyłany jako część jednej iteracji [REPL](https://en.wikipedia.org/wiki/Read%E2%80%93eval%E2%80%93print_loop).</span><span class="sxs-lookup"><span data-stu-id="bd49f-114">In the interactive experience, a cell can be thought of as the code snippet being submitted as part of one iteration of the [REPL](https://en.wikipedia.org/wiki/Read%E2%80%93eval%E2%80%93print_loop).</span></span> <span data-ttu-id="bd49f-115">Na przykład zapoznaj się z następującym notesem, aby zrozumieć, co oznacza:</span><span class="sxs-lookup"><span data-stu-id="bd49f-115">For example, take a look at the following notebook to understand what that means:</span></span>

![Jupyter Notebook komórki](./media/dotnet-interactive/dotnet-interactive-cells.png)

<span data-ttu-id="bd49f-117">Każdy z tych bloków oznaczony przez czerwoną strzałkę jest jedną komórką lub jednym przesłanianiem kodu do platformy Spark.</span><span class="sxs-lookup"><span data-stu-id="bd49f-117">Each of those blocks marked by the red arrow is one cell, or one submission of code to Spark.</span></span> <span data-ttu-id="bd49f-118">Teraz podczas definiowania elementu UDF, który odwołuje się do niestandardowego obiektu zdefiniowanego przez użytkownika, jest wymagane, aby format UDF został zdefiniowany w tej samej komórce, w której jest zdefiniowany obiekt, do którego się odwołuje.</span><span class="sxs-lookup"><span data-stu-id="bd49f-118">Now when defining a UDF that references a custom user-defined object, it is required that the UDF be defined in the same cell where the object it references is defined.</span></span> <span data-ttu-id="bd49f-119">Spójrzmy na to, co wygląda jak na przykład:</span><span class="sxs-lookup"><span data-stu-id="bd49f-119">Let's look at what that looks like as an example:</span></span>

![Praca w formacie UDF](./media/dotnet-interactive/working-udf.png)

## <a name="call-a-udf-on-a-dataframe"></a><span data-ttu-id="bd49f-121">Wywoływanie formatu UDF w ramce Dataframe</span><span class="sxs-lookup"><span data-stu-id="bd49f-121">Call a UDF on a DataFrame</span></span>

<span data-ttu-id="bd49f-122">Podczas wywoływania wcześniej zdefiniowanego elementu UDF na tym komputerze `DataFrame` Ważne jest upewnienie się, że format UDF jest zdefiniowany w wcześniej przesłanej komórce przed wywołaniem go, jak można zobaczyć w poprzednim przykładzie.</span><span class="sxs-lookup"><span data-stu-id="bd49f-122">When calling a previously defined UDF on a `DataFrame` it is important to make sure the UDF is defined in a previously submitted cell, before calling it, as can be seen in the previous example.</span></span>

<span data-ttu-id="bd49f-123">Teraz zobaczmy, co się stanie, jeśli wywołamy funkcję UDF w tej samej komórce, w której jest zdefiniowana.</span><span class="sxs-lookup"><span data-stu-id="bd49f-123">Now let's see what happens if we call the UDF in the same cell where it is defined.</span></span>

![Niepowodzenie wywołania UDF](./media/dotnet-interactive/udf_fails.png)

<span data-ttu-id="bd49f-125">Powyższym wyróżnionym błędem jest fakt, że zestawy UDF muszą zostać najpierw skompilowane i wysłane do procesów roboczych, zanim będzie można je wywołać w ramce Dataframe.</span><span class="sxs-lookup"><span data-stu-id="bd49f-125">The above highlighted error is because the UDF assemblies need to first be compiled and shipped to the workers before it can be called on a DataFrame.</span></span>

<span data-ttu-id="bd49f-126">Poniżej przedstawiono kilka istotnych kwestii, które należy wziąć pod uwagę podczas wdrażania UDF na platformie .NET dla Apache Spark interaktywnego środowiska (na przykład [notesów Azure Synapse](https://docs.microsoft.com/azure/synapse-analytics/spark/apache-spark-development-using-notebooks)).</span><span class="sxs-lookup"><span data-stu-id="bd49f-126">These are a few important things to keep in mind while implementing UDFs in .NET for Apache Spark interactive experience (such as [Azure Synapse Notebooks](https://docs.microsoft.com/azure/synapse-analytics/spark/apache-spark-development-using-notebooks)).</span></span>

## <a name="faqs"></a><span data-ttu-id="bd49f-127">Często zadawane pytania</span><span class="sxs-lookup"><span data-stu-id="bd49f-127">FAQs</span></span>

1. <span data-ttu-id="bd49f-128">**Dlaczego mój element UDF odwołujący się do niestandardowego obiektu zdefiniowanego przez użytkownika zgłasza błąd `Type Submission#_ is not marked as serializable` ?**</span><span class="sxs-lookup"><span data-stu-id="bd49f-128">**Why does my UDF referencing a custom user-defined object throws the error `Type Submission#_ is not marked as serializable`?**</span></span>  
    <span data-ttu-id="bd49f-129">Środowisko .NET Interactive zawija każdą z tych komórek z klasą otoki numeru przesyłania komórki, aby jednoznacznie identyfikować każdą komórkę, która jest przesyłana.</span><span class="sxs-lookup"><span data-stu-id="bd49f-129">.NET Interactive wraps each of these cells with a wrapper class of the cell submission number, to uniquely identify each cell being submitted.</span></span> <span data-ttu-id="bd49f-130">Jak opisano szczegółowo w [tym przewodniku](udf-guide.md), podczas serializacji elementu UDF, który odwołuje się do obiektu niestandardowego, jego obiekt docelowy jest również wybierany do serializacji, który w przypadku programu .NET Interactive jest opakowany przez klasę otoki komórki, w której jest zdefiniowany obiekt niestandardowy.</span><span class="sxs-lookup"><span data-stu-id="bd49f-130">Now as explained in detail in [this guide](udf-guide.md), when a UDF that references a custom object is being serialized its target is also picked up for serialization, which in the case of .NET Interactive gets wrapped by the wrapper class of the cell where the custom object is defined.</span></span>
   <span data-ttu-id="bd49f-131">Teraz zobaczmy, jak ma to wpływ na definicję formatu UDF w notesie:</span><span class="sxs-lookup"><span data-stu-id="bd49f-131">Now let's see how that affects our UDF definition in the notebook:</span></span>

    ![Błąd serializacji UDF](./media/dotnet-interactive/udf-serialization-error.png)

    <span data-ttu-id="bd49f-133">Jak widać w przypadku `udf2_fails` , zobaczysz komunikat o błędzie informujący, że typ `Submission#7` nie jest oznaczony jako możliwy do serializacji. jest to spowodowane tym, że program .NET Interactive Works otacza każdy obiekt zdefiniowany w komórce `Submission#` klasą, która jest generowana na bieżąco i dlatego nie jest oznaczona jako, a tym `Serializable` błędem.</span><span class="sxs-lookup"><span data-stu-id="bd49f-133">As can be seen in the case of `udf2_fails`, we see the error message which says Type `Submission#7` is not marked as serializable, this is because how .NET Interactive works is it wraps every object defined in a cell with its `Submission#` class which is generated on the fly and hence is not marked as `Serializable`, hence the error.</span></span>
    <span data-ttu-id="bd49f-134">Z tego powodu jest wymagane, **aby element UDF odwołujący się do obiektu niestandardowego został zdefiniowany w tej samej komórce co ten obiekt**.</span><span class="sxs-lookup"><span data-stu-id="bd49f-134">For this reason, it is **required that a UDF referencing a custom object in it, is defined in the same cell as that object**.</span></span>

2. <span data-ttu-id="bd49f-135">**Dlaczego zmienne emisji nie współpracują z programem .NET Interactive?**</span><span class="sxs-lookup"><span data-stu-id="bd49f-135">**Why Broadcast Variables don't work with .NET Interactive?**</span></span>  
    <span data-ttu-id="bd49f-136">Ze względu na przyczyny opisane powyżej zmienne emisji nie działają w programie .NET Interactive.</span><span class="sxs-lookup"><span data-stu-id="bd49f-136">For the reasons explained above, broadcast variables don't work with .NET Interactive.</span></span> <span data-ttu-id="bd49f-137">Warto zapoznać się z [tym przewodnikiem dotyczącym zmiennych emisji](broadcast-guide.md) , aby lepiej zrozumieć, jakie zmienne emisji są i jak ich używać.</span><span class="sxs-lookup"><span data-stu-id="bd49f-137">It is a good idea to go through [this guide on broadcast variables](broadcast-guide.md) to get a deeper understanding of what broadcast variables are and how to use them.</span></span> <span data-ttu-id="bd49f-138">Zmienne emisji nie współpracują ze scenariuszami interaktywnymi wynikają z tego, że projekt programu .NET Interactive jest dołączany do każdego obiektu zdefiniowanego w komórce przy użyciu klasy przesłanej komórek, która nie jest oznaczona jako możliwa do serializacji, kończy się niepowodzeniem z wyjątkiem tego samego wyjątku, jak pokazano wcześniej.</span><span class="sxs-lookup"><span data-stu-id="bd49f-138">The reason broadcast variables don't work with interactive scenarios is because of .NET interactive's design of appending each object defined in a cell with it's cell submission class, which since is not marked serializable, fails with the same exception as shown previously.</span></span>
   <span data-ttu-id="bd49f-139">Szczegółowemy nieco więcej z poniższym przykładem:</span><span class="sxs-lookup"><span data-stu-id="bd49f-139">Let's dive a little deeper with the following example:</span></span>

    ![Zmienne emisji kończą się niepowodzeniem](./media/dotnet-interactive/broadcast-fails.png)

    <span data-ttu-id="bd49f-141">Zgodnie z zaleceniami w poprzednich sekcjach definiujemy zarówno format UDF, jak i obiekt, do którego się odwołuje (zmienna emisji w tym przypadku) w tej samej komórce, ale nadal widzimy `SerializationException` błąd podczas tworzenia wniosku o `Microsoft.Spark.Sql.Session` nieoznaczony jako możliwy do serializacji.</span><span class="sxs-lookup"><span data-stu-id="bd49f-141">As recommended in the previous sections, we define both the UDF and the object it is referencing (broadcast variable in this case) in the same cell, but we still see the `SerializationException` error complaining about `Microsoft.Spark.Sql.Session` not being marked as serializable.</span></span> <span data-ttu-id="bd49f-142">Jest to spowodowane tym, że gdy kompilator próbuje serializować obiekt zmiennej emisji `bv` , odnajdzie jego nazwę do dołączenia do [`SparkSession`](https://github.com/dotnet/spark/blob/master/src/csharp/Microsoft.Spark/Sql/SparkSession.cs#L20) obiektu `spark` , którego wymaga do oznaczenia jako możliwego do serializacji.</span><span class="sxs-lookup"><span data-stu-id="bd49f-142">This is because when the compiler tries to serialize the broadcast variable object `bv`, it finds its name to be appended with [`SparkSession`](https://github.com/dotnet/spark/blob/master/src/csharp/Microsoft.Spark/Sql/SparkSession.cs#L20) object `spark` which it requires to be marked as serializable.</span></span> <span data-ttu-id="bd49f-143">Może to być bardziej łatwe dzięki przejęciu wglądu w kompilację z dekompilowanym zestawem tej komórki:</span><span class="sxs-lookup"><span data-stu-id="bd49f-143">This can be demonstrated with more ease by taking a peek at the decompiled assembly of this cell submission:</span></span>

    ![Dekompilowany kod zestawu](./media/dotnet-interactive/decompiledAssembly.png)

    <span data-ttu-id="bd49f-145">Jeśli oznaczemy [`SparkSession`](https://github.com/dotnet/spark/blob/master/src/csharp/Microsoft.Spark/Sql/SparkSession.cs#L20) klasę jako `[Serializable]` , możemy to zrobić, ale nie jest to idealne rozwiązanie, ponieważ nie chcemy, aby użytkownik mógł serializować obiekt SparkSession, ponieważ może to spowodować niebrzmieniae niepożądane zachowanie.</span><span class="sxs-lookup"><span data-stu-id="bd49f-145">If we mark the [`SparkSession`](https://github.com/dotnet/spark/blob/master/src/csharp/Microsoft.Spark/Sql/SparkSession.cs#L20) class as `[Serializable]`, we can get this to work, but this is not an ideal solution as we don't want to give the user the ability to serialize a SparkSession object, as that could lead to some very weird undesirable behavior.</span></span> <span data-ttu-id="bd49f-146">Jest to znany problem, który jest śledzony w [tym miejscu](https://github.com/dotnet/spark/issues/619) i zostanie rozwiązany w przyszłych wersjach.</span><span class="sxs-lookup"><span data-stu-id="bd49f-146">This is a known issue and being tracked [here](https://github.com/dotnet/spark/issues/619) and will be resolved in future versions.</span></span>
