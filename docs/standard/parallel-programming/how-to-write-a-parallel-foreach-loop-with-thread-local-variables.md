---
title: "Porady: zapisywanie równoległej pętli ForEach ze zmiennymi lokalnymi wątku"
ms.custom: 
ms.date: 03/30/2017
ms.prod: .net
ms.reviewer: 
ms.suite: 
ms.technology: dotnet-standard
ms.tgt_pltfrm: 
ms.topic: article
dev_langs:
- csharp
- vb
helpviewer_keywords: parallel foreach loop, how to use local state
ms.assetid: 24b10041-b30b-45cb-aa65-66cf568ca76d
caps.latest.revision: "18"
author: rpetrusha
ms.author: ronpet
manager: wpickett
ms.workload:
- dotnet
- dotnetcore
ms.openlocfilehash: 4c65edd8959cbf5f83e3353770f71cad130953d1
ms.sourcegitcommit: e7f04439d78909229506b56935a1105a4149ff3d
ms.translationtype: MT
ms.contentlocale: pl-PL
ms.lasthandoff: 12/23/2017
---
# <a name="how-to-write-a-parallelforeach-loop-with-thread-local-variables"></a><span data-ttu-id="308bc-102">Porady: zapisywanie równoległej pętli ForEach ze zmiennymi lokalnymi wątku</span><span class="sxs-lookup"><span data-stu-id="308bc-102">How to: Write a Parallel.ForEach Loop with Thread-Local Variables</span></span>
<span data-ttu-id="308bc-103">W poniższym przykładzie pokazano, w jaki sposób napisać metodę <xref:System.Threading.Tasks.Parallel.ForEach%2A>, która używa zmiennych lokalnych wątku.</span><span class="sxs-lookup"><span data-stu-id="308bc-103">The following example shows how to write a <xref:System.Threading.Tasks.Parallel.ForEach%2A> method that uses thread-local variables.</span></span> <span data-ttu-id="308bc-104">Gdy wykonywana jest pętla <xref:System.Threading.Tasks.Parallel.ForEach%2A>, kolekcja źródłowa jest dzielona na wiele partycji.</span><span class="sxs-lookup"><span data-stu-id="308bc-104">When a <xref:System.Threading.Tasks.Parallel.ForEach%2A> loop executes, it divides its source collection into multiple partitions.</span></span> <span data-ttu-id="308bc-105">Każda partycja otrzyma własną kopię zmiennej „lokalnej wątku”.</span><span class="sxs-lookup"><span data-stu-id="308bc-105">Each partition will get its own copy of the "thread-local" variable.</span></span> <span data-ttu-id="308bc-106">(Termin „lokalna wątku” jest nieprecyzyjny, ponieważ w niektórych przypadkach dwie partycje mogą działać w tym samym wątku).</span><span class="sxs-lookup"><span data-stu-id="308bc-106">(The term "thread-local" is slightly inaccurate here, because in some cases two partitions may run on the same thread.)</span></span>  
  
 <span data-ttu-id="308bc-107">Kod i parametry w przykładzie przypominają zbliżone w odpowiadającej metodzie <xref:System.Threading.Tasks.Parallel.For%2A>.</span><span class="sxs-lookup"><span data-stu-id="308bc-107">The code and parameters in this example closely resemble the corresponding <xref:System.Threading.Tasks.Parallel.For%2A> method.</span></span> <span data-ttu-id="308bc-108">Aby uzyskać więcej informacji, zobacz [porady: zapisywanie równoległej pętli for ze zmiennymi lokalnymi wątku](../../../docs/standard/parallel-programming/how-to-write-a-parallel-for-loop-with-thread-local-variables.md).</span><span class="sxs-lookup"><span data-stu-id="308bc-108">For more information, see [How to: Write a Parallel.For Loop with Thread-Local Variables](../../../docs/standard/parallel-programming/how-to-write-a-parallel-for-loop-with-thread-local-variables.md).</span></span>  
  
 <span data-ttu-id="308bc-109">Aby użyć zmiennej lokalnej wątku w <xref:System.Threading.Tasks.Parallel.ForEach%2A> pętli, należy wywołać jednego z przeciążeń metody, które przyjmuje dwa parametry typu.</span><span class="sxs-lookup"><span data-stu-id="308bc-109">To use a thread-local variable in a <xref:System.Threading.Tasks.Parallel.ForEach%2A> loop, you must call one of the method overloads that takes two type parameters.</span></span> <span data-ttu-id="308bc-110">Pierwszy parametr typu `TSource`, określa typ elementu źródła, a drugi parametr typu `TLocal`, określa typ zmiennej lokalnej wątku.</span><span class="sxs-lookup"><span data-stu-id="308bc-110">The first type parameter, `TSource`, specifies the type of the source element, and the second type parameter, `TLocal`, specifies the type of the thread-local variable.</span></span>  
  
## <a name="example"></a><span data-ttu-id="308bc-111">Przykład</span><span class="sxs-lookup"><span data-stu-id="308bc-111">Example</span></span>  
 <span data-ttu-id="308bc-112">Następujące przykładowe wywołania <xref:System.Threading.Tasks.Parallel.ForEach%60%602%28System.Collections.Generic.IEnumerable%7B%60%600%7D%2CSystem.Func%7B%60%601%7D%2CSystem.Func%7B%60%600%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%601%2C%60%601%7D%2CSystem.Action%7B%60%601%7D%29?displayProperty=nameWithType> przeciążenia do obliczenia sumy tablicę elementów milion.</span><span class="sxs-lookup"><span data-stu-id="308bc-112">The following example calls <xref:System.Threading.Tasks.Parallel.ForEach%60%602%28System.Collections.Generic.IEnumerable%7B%60%600%7D%2CSystem.Func%7B%60%601%7D%2CSystem.Func%7B%60%600%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%601%2C%60%601%7D%2CSystem.Action%7B%60%601%7D%29?displayProperty=nameWithType> overload to compute the sum of an array of one million elements.</span></span> <span data-ttu-id="308bc-113">To przeciążenie ma cztery parametry:</span><span class="sxs-lookup"><span data-stu-id="308bc-113">This overload has four parameters:</span></span>  
  
-   <span data-ttu-id="308bc-114">`source`, który jest źródłem danych.</span><span class="sxs-lookup"><span data-stu-id="308bc-114">`source`, which is the data source.</span></span> <span data-ttu-id="308bc-115">Musi on implementować <xref:System.Collections.Generic.IEnumerable%601>.</span><span class="sxs-lookup"><span data-stu-id="308bc-115">It must implement <xref:System.Collections.Generic.IEnumerable%601>.</span></span> <span data-ttu-id="308bc-116">Źródło danych w tym przykładzie jest elementem członkowskim milion `IEnumerable<Int32>` obiektu zwróconego przez <xref:System.Linq.Enumerable.Range%2A?displayProperty=nameWithType> metody.</span><span class="sxs-lookup"><span data-stu-id="308bc-116">The data source in our example is the one million member `IEnumerable<Int32>` object returned by the <xref:System.Linq.Enumerable.Range%2A?displayProperty=nameWithType> method.</span></span>  
  
-   <span data-ttu-id="308bc-117">`localInit`, lub funkcji, która inicjuje zmiennej lokalnej wątku.</span><span class="sxs-lookup"><span data-stu-id="308bc-117">`localInit`, or the function that initializes the thread-local variable.</span></span> <span data-ttu-id="308bc-118">Ta funkcja jest wywoływana raz dla każdej partycji, w którym <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> wykonuje operację.</span><span class="sxs-lookup"><span data-stu-id="308bc-118">This function is called once for each partition in which the <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> operation executes.</span></span> <span data-ttu-id="308bc-119">Naszym przykładzie inicjuje zmiennej lokalnej wątku od zera.</span><span class="sxs-lookup"><span data-stu-id="308bc-119">Our example initializes the thread-local variable to zero.</span></span>  
  
-   <span data-ttu-id="308bc-120">`body`, <xref:System.Func%604> który jest wywoływany przez równoległej pętli w każdej iteracji pętli.</span><span class="sxs-lookup"><span data-stu-id="308bc-120">`body`, a <xref:System.Func%604> that is invoked by the parallel loop on each iteration of the loop.</span></span> <span data-ttu-id="308bc-121">Podpis jest `Func\<TSource, ParallelLoopState, TLocal, TLocal>`.</span><span class="sxs-lookup"><span data-stu-id="308bc-121">Its signature is `Func\<TSource, ParallelLoopState, TLocal, TLocal>`.</span></span> <span data-ttu-id="308bc-122">Podaj kod dla obiekt delegowany i przekazuje pętli w parametrach wejściowych, które są:</span><span class="sxs-lookup"><span data-stu-id="308bc-122">You supply the code for the delegate, and the loop passes in the input parameters, which are:</span></span>  
  
    -   <span data-ttu-id="308bc-123">Bieżący element <xref:System.Collections.Generic.IEnumerable%601>.</span><span class="sxs-lookup"><span data-stu-id="308bc-123">The current element of the <xref:System.Collections.Generic.IEnumerable%601>.</span></span>  
  
    -   <span data-ttu-id="308bc-124">A <xref:System.Threading.Tasks.ParallelLoopState> zmiennej, czy można użyć w kodzie pełnomocnika, aby sprawdzić stan pętli.</span><span class="sxs-lookup"><span data-stu-id="308bc-124">A <xref:System.Threading.Tasks.ParallelLoopState> variable that you can use in your delegate's code to examine the state of the loop.</span></span>  
  
    -   <span data-ttu-id="308bc-125">Zmiennej lokalnej wątku.</span><span class="sxs-lookup"><span data-stu-id="308bc-125">The thread-local variable.</span></span>  
  
     <span data-ttu-id="308bc-126">Pełnomocnika zwraca zmiennej lokalnej wątku, które są następnie przekazywane do następnej iteracji pętli, które wykonuje w tej określonej partycji.</span><span class="sxs-lookup"><span data-stu-id="308bc-126">Your delegate returns the thread-local variable, which is then passed to the next iteration of the loop that executes in that particular partition.</span></span> <span data-ttu-id="308bc-127">Każda partycja pętli przechowuje oddzielnego wystąpienia tej zmiennej.</span><span class="sxs-lookup"><span data-stu-id="308bc-127">Each loop partition maintains a separate instance of this variable.</span></span>  
  
     <span data-ttu-id="308bc-128">W tym przykładzie delegat dodaje wartość całkowitą każdej zmiennej lokalnej wątku, co umożliwia utrzymywanie uruchomionej całkowitej wartości elementów całkowitą w tej partycji.</span><span class="sxs-lookup"><span data-stu-id="308bc-128">In the example, the delegate adds the value of each integer to the thread-local variable, which maintains a running total of the values of the integer elements in that partition.</span></span>  
  
-   <span data-ttu-id="308bc-129">`localFinally`, `Action<TLocal>` delegata, który <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> wywołuje po zakończeniu operacji pętli w każdej partycji.</span><span class="sxs-lookup"><span data-stu-id="308bc-129">`localFinally`, an `Action<TLocal>` delegate that the <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> invokes when the looping operations in each partition have completed.</span></span> <span data-ttu-id="308bc-130"><xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> Metoda przekazuje Twojej `Action<TLocal>` delegata końcowa wartość zmiennej lokalnej wątku dla tego wątku (lub pętli partycji), i podaj kod, który wykonuje działania wymagane do łączenia wynik tej partycji z wynikami z innych partycji.</span><span class="sxs-lookup"><span data-stu-id="308bc-130">The <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> method passes your `Action<TLocal>` delegate the final value of the thread-local variable for this thread (or loop partition), and you provide the code that performs the required action for combining the result from this partition with the results from the other partitions.</span></span> <span data-ttu-id="308bc-131">Delegat może być wywoływany współbieżnie przez wiele zadań.</span><span class="sxs-lookup"><span data-stu-id="308bc-131">This delegate can be invoked concurrently by multiple tasks.</span></span> <span data-ttu-id="308bc-132">W związku z tym w przykładzie użyto <xref:System.Threading.Interlocked.Add%28System.Int32%40%2CSystem.Int32%29?displayProperty=nameWithType> metody synchronizujący dostęp do `total` zmiennej.</span><span class="sxs-lookup"><span data-stu-id="308bc-132">Because of this, the example uses the <xref:System.Threading.Interlocked.Add%28System.Int32%40%2CSystem.Int32%29?displayProperty=nameWithType> method to synchronize access to the `total` variable.</span></span> <span data-ttu-id="308bc-133">Ponieważ typ delegata to <xref:System.Action%601>, żadna wartość nie jest zwracana.</span><span class="sxs-lookup"><span data-stu-id="308bc-133">Because the delegate type is an <xref:System.Action%601>, there is no return value.</span></span>  
  
 [!code-csharp[TPL_Parallel#04](../../../samples/snippets/csharp/VS_Snippets_Misc/tpl_parallel/cs/foreachthreadlocal.cs#04)]
 [!code-vb[TPL_Parallel#04](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_parallel/vb/foreachthreadlocal.vb#04)]  
  
## <a name="see-also"></a><span data-ttu-id="308bc-134">Zobacz też</span><span class="sxs-lookup"><span data-stu-id="308bc-134">See Also</span></span>  
 [<span data-ttu-id="308bc-135">Równoległość danych</span><span class="sxs-lookup"><span data-stu-id="308bc-135">Data Parallelism</span></span>](../../../docs/standard/parallel-programming/data-parallelism-task-parallel-library.md)  
 [<span data-ttu-id="308bc-136">Instrukcje: zapisywanie pętli Parallel.For ze zmiennymi lokalnymi wątku</span><span class="sxs-lookup"><span data-stu-id="308bc-136">How to: Write a Parallel.For Loop with Thread-Local Variables</span></span>](../../../docs/standard/parallel-programming/how-to-write-a-parallel-for-loop-with-thread-local-variables.md)  
 [<span data-ttu-id="308bc-137">Wyrażenia Lambda w PLINQ i TPL</span><span class="sxs-lookup"><span data-stu-id="308bc-137">Lambda Expressions in PLINQ and TPL</span></span>](../../../docs/standard/parallel-programming/lambda-expressions-in-plinq-and-tpl.md)
