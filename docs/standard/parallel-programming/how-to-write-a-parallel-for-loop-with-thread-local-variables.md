---
title: 'Porady: zapisywanie równoległej pętli For ze zmiennymi lokalnymi wątku'
ms.date: 03/30/2017
ms.technology: dotnet-standard
dev_langs:
- csharp
- vb
helpviewer_keywords:
- parallel for loops, how to use local state
ms.assetid: 68384064-7ee7-41e2-90e3-71f00bde01bb
ms.openlocfilehash: 14f4f1402f564d38bb508e893521a3951c1509f4
ms.sourcegitcommit: 7588136e355e10cbc2582f389c90c127363c02a5
ms.translationtype: MT
ms.contentlocale: pl-PL
ms.lasthandoff: 03/15/2020
ms.locfileid: "73139707"
---
# <a name="how-to-write-a-parallelfor-loop-with-thread-local-variables"></a><span data-ttu-id="1ad9e-102">Porady: zapisywanie równoległej pętli For ze zmiennymi lokalnymi wątku</span><span class="sxs-lookup"><span data-stu-id="1ad9e-102">How to: Write a Parallel.For Loop with Thread-Local Variables</span></span>
<span data-ttu-id="1ad9e-103">W tym przykładzie pokazano, jak używać zmiennych lokalnych wątku do przechowywania <xref:System.Threading.Tasks.Parallel.For%2A> i pobierania stanu w każdym oddzielnym zadaniu utworzonym przez pętlę.</span><span class="sxs-lookup"><span data-stu-id="1ad9e-103">This example shows how to use thread-local variables to store and retrieve state in each separate task that is created by a <xref:System.Threading.Tasks.Parallel.For%2A> loop.</span></span> <span data-ttu-id="1ad9e-104">Za pomocą danych lokalnych wątku, można uniknąć narzutów synchronizacji dużej liczby dostępu do stanu udostępnionego.</span><span class="sxs-lookup"><span data-stu-id="1ad9e-104">By using thread-local data, you can avoid the overhead of synchronizing a large number of accesses to shared state.</span></span> <span data-ttu-id="1ad9e-105">Zamiast zapisywać do zasobu udostępnionego na każdej iteracji, należy obliczyć i przechowywać wartość, dopóki wszystkie iteracje dla zadania zostaną zakończone.</span><span class="sxs-lookup"><span data-stu-id="1ad9e-105">Instead of writing to a shared resource on each iteration, you compute and store the value until all iterations for the task are complete.</span></span> <span data-ttu-id="1ad9e-106">Następnie można zapisać wynik końcowy raz do zasobu udostępnionego lub przekazać go do innej metody.</span><span class="sxs-lookup"><span data-stu-id="1ad9e-106">You can then write the final result once to the shared resource, or pass it to another method.</span></span>  
  
## <a name="example"></a><span data-ttu-id="1ad9e-107">Przykład</span><span class="sxs-lookup"><span data-stu-id="1ad9e-107">Example</span></span>  
 <span data-ttu-id="1ad9e-108">Poniższy przykład wywołuje <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> metodę do obliczania sumy wartości w tablicy, która zawiera milion elementów.</span><span class="sxs-lookup"><span data-stu-id="1ad9e-108">The following example calls the <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> method to calculate the sum of the values in an array that contains one million elements.</span></span> <span data-ttu-id="1ad9e-109">Wartość każdego elementu jest równa jego indeksu.</span><span class="sxs-lookup"><span data-stu-id="1ad9e-109">The value of each element is equal to its index.</span></span>  
  
 [!code-csharp[TPL_Parallel#05](../../../samples/snippets/csharp/VS_Snippets_Misc/tpl_parallel/cs/forandforeach_simple.cs#05)]
 [!code-vb[TPL_Parallel#05](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_parallel/vb/forwiththreadlocal.vb#05)]  
  
 <span data-ttu-id="1ad9e-110">Pierwsze dwa parametry każdej <xref:System.Threading.Tasks.Parallel.For%2A> metody określają początkowe i końcowe wartości iteracji.</span><span class="sxs-lookup"><span data-stu-id="1ad9e-110">The first two parameters of every <xref:System.Threading.Tasks.Parallel.For%2A> method specify the beginning and ending iteration values.</span></span> <span data-ttu-id="1ad9e-111">W tym przeciążeniu metody trzeci parametr jest, gdzie zainicjować stan lokalny.</span><span class="sxs-lookup"><span data-stu-id="1ad9e-111">In this overload of the method, the third parameter is where you initialize your local state.</span></span> <span data-ttu-id="1ad9e-112">W tym kontekście stan lokalny oznacza zmienną, której okres istnienia rozciąga się od tuż przed pierwszą iteracją pętli w bieżącym wątku, do tuż po ostatniej iteracji.</span><span class="sxs-lookup"><span data-stu-id="1ad9e-112">In this context, local state means a variable whose lifetime extends from just before the first iteration of the loop on the current thread, to just after the last iteration.</span></span>  
  
 <span data-ttu-id="1ad9e-113">Typ trzeciego parametru jest <xref:System.Func%601> `TResult` where jest typem zmiennej, która będzie przechowywać stan lokalny wątku.</span><span class="sxs-lookup"><span data-stu-id="1ad9e-113">The type of the third parameter is a <xref:System.Func%601> where `TResult` is the type of the variable that will store the thread-local state.</span></span> <span data-ttu-id="1ad9e-114">Jego typ jest zdefiniowany przez argument typu <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> ogólnego podany podczas <xref:System.Int64>wywoływania metody ogólnej, która w tym przypadku jest .</span><span class="sxs-lookup"><span data-stu-id="1ad9e-114">Its type is defined by the generic type argument supplied when calling the generic <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> method, which in this case is <xref:System.Int64>.</span></span> <span data-ttu-id="1ad9e-115">Argument typu informuje kompilator typu zmiennej tymczasowej, która będzie używana do przechowywania stanu lokalnego wątku.</span><span class="sxs-lookup"><span data-stu-id="1ad9e-115">The type argument tells the compiler the type of the temporary variable that will be used to store the thread-local state.</span></span> <span data-ttu-id="1ad9e-116">W tym przykładzie `() => 0` wyrażenie `Function() 0` (lub w języku Visual Basic) inicjuje zmienną lokalną wątku do zera.</span><span class="sxs-lookup"><span data-stu-id="1ad9e-116">In this example, the expression `() => 0` (or `Function() 0` in Visual Basic) initializes the thread-local variable to zero.</span></span> <span data-ttu-id="1ad9e-117">Jeśli argument typu ogólnego jest typem odwołania lub typem wartości zdefiniowanym przez użytkownika, wyrażenie będzie wyglądać tak:</span><span class="sxs-lookup"><span data-stu-id="1ad9e-117">If the generic type argument is a reference type or user-defined value type, the expression would look like this:</span></span>  
  
```csharp  
() => new MyClass()  
```  
  
```vb  
Function() new MyClass()  
```  
  
 <span data-ttu-id="1ad9e-118">Czwarty parametr definiuje logikę pętli.</span><span class="sxs-lookup"><span data-stu-id="1ad9e-118">The fourth parameter defines the loop logic.</span></span> <span data-ttu-id="1ad9e-119">Musi to być wyrażenie delegata lub lambda, którego podpis znajduje się `Func<int, ParallelLoopState, long, long>` w języku C# lub `Func(Of Integer, ParallelLoopState, Long, Long)` w języku Visual Basic.</span><span class="sxs-lookup"><span data-stu-id="1ad9e-119">It must be a delegate or lambda expression whose signature is `Func<int, ParallelLoopState, long, long>` in C# or `Func(Of Integer, ParallelLoopState, Long, Long)` in Visual Basic.</span></span> <span data-ttu-id="1ad9e-120">Pierwszy parametr jest wartością licznika pętli dla tej iteracji pętli.</span><span class="sxs-lookup"><span data-stu-id="1ad9e-120">The first parameter is the value of the loop counter for that iteration of the loop.</span></span> <span data-ttu-id="1ad9e-121">Drugi to <xref:System.Threading.Tasks.ParallelLoopState> obiekt, który może służyć do wyrwania się z pętli; ten obiekt jest <xref:System.Threading.Tasks.Parallel> dostarczany przez klasę do każdego wystąpienia pętli.</span><span class="sxs-lookup"><span data-stu-id="1ad9e-121">The second is a <xref:System.Threading.Tasks.ParallelLoopState> object that can be used to break out of the loop; this object is provided by the <xref:System.Threading.Tasks.Parallel> class to each occurrence of the loop.</span></span> <span data-ttu-id="1ad9e-122">Trzeci parametr jest zmienną lokalną wątku.</span><span class="sxs-lookup"><span data-stu-id="1ad9e-122">The third parameter is the thread-local variable.</span></span> <span data-ttu-id="1ad9e-123">Ostatni parametr jest typem zwracania.</span><span class="sxs-lookup"><span data-stu-id="1ad9e-123">The last parameter is the return type.</span></span> <span data-ttu-id="1ad9e-124">W takim przypadku typ <xref:System.Int64> jest, ponieważ jest to <xref:System.Threading.Tasks.Parallel.For%2A> typ, który określił w argument typu.</span><span class="sxs-lookup"><span data-stu-id="1ad9e-124">In this case, the type is <xref:System.Int64> because that is the type we specified in the <xref:System.Threading.Tasks.Parallel.For%2A> type argument.</span></span> <span data-ttu-id="1ad9e-125">Ta zmienna `subtotal` jest nazwany i jest zwracany przez wyrażenie lambda.</span><span class="sxs-lookup"><span data-stu-id="1ad9e-125">That variable is named `subtotal` and is returned by the lambda expression.</span></span> <span data-ttu-id="1ad9e-126">Wartość zwracana jest używana `subtotal` do inicjowania na każdej kolejnej iteracji pętli.</span><span class="sxs-lookup"><span data-stu-id="1ad9e-126">The return value is used to initialize `subtotal` on each subsequent iteration of the loop.</span></span> <span data-ttu-id="1ad9e-127">Ten ostatni parametr można również pomyśleć jako wartość, która jest przekazywana `localFinally` do każdej iteracji, a następnie przekazywana do pełnomocnika po zakończeniu ostatniej iteracji.</span><span class="sxs-lookup"><span data-stu-id="1ad9e-127">You can also think of this last parameter as a value that is passed to each iteration, and then passed to the `localFinally` delegate when the last iteration is complete.</span></span>  
  
 <span data-ttu-id="1ad9e-128">Piąty parametr definiuje metodę, która jest wywoływana raz, po zakończeniu wszystkich iteracji w określonym wątku.</span><span class="sxs-lookup"><span data-stu-id="1ad9e-128">The fifth parameter defines the method that is called once, after all the iterations on a particular thread have completed.</span></span> <span data-ttu-id="1ad9e-129">Typ argumentu wejściowego ponownie odpowiada argumentowi <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> typu metody i typowi zwróconemu przez wyrażenie lambda.</span><span class="sxs-lookup"><span data-stu-id="1ad9e-129">The type of the input argument again corresponds to the type argument of the <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> method and the type returned by the body lambda expression.</span></span> <span data-ttu-id="1ad9e-130">W tym przykładzie wartość jest dodawana do zmiennej w <xref:System.Threading.Interlocked.Add%2A?displayProperty=nameWithType> zakresie klasy w bezpieczny sposób wątku, wywołując metodę.</span><span class="sxs-lookup"><span data-stu-id="1ad9e-130">In this example, the value is added to a variable at class scope in a thread safe way by calling the <xref:System.Threading.Interlocked.Add%2A?displayProperty=nameWithType> method.</span></span> <span data-ttu-id="1ad9e-131">Za pomocą zmiennej lokalnej wątku, uniknięliśmy zapisywania do tej zmiennej klasy na każdej iteracji pętli.</span><span class="sxs-lookup"><span data-stu-id="1ad9e-131">By using a thread-local variable, we have avoided writing to this class variable on every iteration of the loop.</span></span>  
  
 <span data-ttu-id="1ad9e-132">Aby uzyskać więcej informacji na temat używania wyrażeń lambda, zobacz [Wyrażenia Lambda w PLINQ i TPL](../../../docs/standard/parallel-programming/lambda-expressions-in-plinq-and-tpl.md).</span><span class="sxs-lookup"><span data-stu-id="1ad9e-132">For more information about how to use lambda expressions, see [Lambda Expressions in PLINQ and TPL](../../../docs/standard/parallel-programming/lambda-expressions-in-plinq-and-tpl.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="1ad9e-133">Zobacz też</span><span class="sxs-lookup"><span data-stu-id="1ad9e-133">See also</span></span>

- [<span data-ttu-id="1ad9e-134">Równoległość danych</span><span class="sxs-lookup"><span data-stu-id="1ad9e-134">Data Parallelism</span></span>](../../../docs/standard/parallel-programming/data-parallelism-task-parallel-library.md)
- [<span data-ttu-id="1ad9e-135">Programowanie równoległe</span><span class="sxs-lookup"><span data-stu-id="1ad9e-135">Parallel Programming</span></span>](../../../docs/standard/parallel-programming/index.md)
- [<span data-ttu-id="1ad9e-136">Biblioteka zadań równoległych (TPL)</span><span class="sxs-lookup"><span data-stu-id="1ad9e-136">Task Parallel Library (TPL)</span></span>](../../../docs/standard/parallel-programming/task-parallel-library-tpl.md)
- [<span data-ttu-id="1ad9e-137">Wyrażenia Lambda w PLINQ i TPL</span><span class="sxs-lookup"><span data-stu-id="1ad9e-137">Lambda Expressions in PLINQ and TPL</span></span>](../../../docs/standard/parallel-programming/lambda-expressions-in-plinq-and-tpl.md)
