---
title: Anulowanie w zarządzanych wątkach
ms.date: 03/30/2017
ms.technology: dotnet-standard
dev_langs:
- csharp
- vb
helpviewer_keywords:
- cancellation in .NET, overview
ms.assetid: eea11fe5-d8b0-4314-bb5d-8a58166fb1c3
author: rpetrusha
ms.author: ronpet
ms.openlocfilehash: a764912e46707b6f10e720f95a7d971ec4fc8e15
ms.sourcegitcommit: 3d5d33f384eeba41b2dff79d096f47ccc8d8f03d
ms.translationtype: MT
ms.contentlocale: pl-PL
ms.lasthandoff: 05/04/2018
ms.locfileid: "33592174"
---
# <a name="cancellation-in-managed-threads"></a><span data-ttu-id="44d32-102">Anulowanie w zarządzanych wątkach</span><span class="sxs-lookup"><span data-stu-id="44d32-102">Cancellation in Managed Threads</span></span>
<span data-ttu-id="44d32-103">Począwszy od [!INCLUDE[net_v40_long](../../../includes/net-v40-long-md.md)], .NET Framework używa ujednoliconego modelu wspólnych anulowania asynchroniczne lub długotrwałej operacji synchronicznych.</span><span class="sxs-lookup"><span data-stu-id="44d32-103">Starting with the [!INCLUDE[net_v40_long](../../../includes/net-v40-long-md.md)], the .NET Framework uses a unified model for cooperative cancellation of asynchronous or long-running synchronous operations.</span></span> <span data-ttu-id="44d32-104">Ten model jest oparty na obiekt lekkie o nazwie token anulowania.</span><span class="sxs-lookup"><span data-stu-id="44d32-104">This model is based on a lightweight object called a cancellation token.</span></span> <span data-ttu-id="44d32-105">Obiekt, który wywołuje jeden lub więcej operacji można anulować, na przykład, tworząc nowe wątki i zadań, przekazuje token do każdej operacji.</span><span class="sxs-lookup"><span data-stu-id="44d32-105">The object that invokes one or more cancelable operations, for example by creating new threads or tasks, passes the token to each operation.</span></span> <span data-ttu-id="44d32-106">Poszczególnych działań z kolei może przekazać kopie tokenu do innych operacji.</span><span class="sxs-lookup"><span data-stu-id="44d32-106">Individual operations can in turn pass copies of the token to other operations.</span></span> <span data-ttu-id="44d32-107">W późniejszym czasie obiekt, który utworzył token służy do żądania, że operacje zatrzymana, co robią.</span><span class="sxs-lookup"><span data-stu-id="44d32-107">At some later time, the object that created the token can use it to request that the operations stop what they are doing.</span></span> <span data-ttu-id="44d32-108">Tylko obiektu żądającego mogą wystawiać żądanie anulowania, a każdy odbiornik jest odpowiedzialny za żądanie po raz pierwszy, a odpowiadającym odpowiednią i odpowiednim w sposób.</span><span class="sxs-lookup"><span data-stu-id="44d32-108">Only the requesting object can issue the cancellation request, and each listener is responsible for noticing the request and responding to it in an appropriate and timely manner.</span></span>  
  
 <span data-ttu-id="44d32-109">Ogólne wzorzec stosowania modelu wspólnych anulowania jest:</span><span class="sxs-lookup"><span data-stu-id="44d32-109">The general pattern for implementing the cooperative cancellation model is:</span></span>  
  
-   <span data-ttu-id="44d32-110">Utwórz wystąpienie <xref:System.Threading.CancellationTokenSource> obiektu, który zarządza i wysyła powiadomienie do anulowania do poszczególnych anulowanie tokenów.</span><span class="sxs-lookup"><span data-stu-id="44d32-110">Instantiate a <xref:System.Threading.CancellationTokenSource> object, which manages and sends cancellation notification to the individual cancellation tokens.</span></span>  
  
-   <span data-ttu-id="44d32-111">Przekaż token zwracany przez <xref:System.Threading.CancellationTokenSource.Token%2A?displayProperty=nameWithType> właściwości do każdego zadania lub wątku, który nasłuchuje anulowania.</span><span class="sxs-lookup"><span data-stu-id="44d32-111">Pass the token returned by the <xref:System.Threading.CancellationTokenSource.Token%2A?displayProperty=nameWithType> property to each task or thread that listens for cancellation.</span></span>  
  
-   <span data-ttu-id="44d32-112">Mechanizm dla każdego wątku odpowiedzieć na anulowanie.</span><span class="sxs-lookup"><span data-stu-id="44d32-112">Provide a mechanism for each task or thread to respond to cancellation.</span></span>  
  
-   <span data-ttu-id="44d32-113">Wywołanie <xref:System.Threading.CancellationTokenSource.Cancel%2A?displayProperty=nameWithType> metodę w celu zapewnienia powiadomienia o anulowaniu.</span><span class="sxs-lookup"><span data-stu-id="44d32-113">Call the <xref:System.Threading.CancellationTokenSource.Cancel%2A?displayProperty=nameWithType> method to provide notification of cancellation.</span></span>  
  
> [!IMPORTANT]
>  <span data-ttu-id="44d32-114"><xref:System.Threading.CancellationTokenSource> Klasa implementuje <xref:System.IDisposable> interfejsu.</span><span class="sxs-lookup"><span data-stu-id="44d32-114">The <xref:System.Threading.CancellationTokenSource> class implements the <xref:System.IDisposable> interface.</span></span> <span data-ttu-id="44d32-115">Należy się upewnić wywołać <xref:System.Threading.CancellationTokenSource.Dispose%2A?displayProperty=nameWithType> metody po zakończeniu przy użyciu źródła token anulowania można zwolnić wszelkie niezarządzane zasoby, które przechowuje.</span><span class="sxs-lookup"><span data-stu-id="44d32-115">You should be sure to call the <xref:System.Threading.CancellationTokenSource.Dispose%2A?displayProperty=nameWithType> method when you have finished using the cancellation token source to free any unmanaged resources it holds.</span></span>  
  
 <span data-ttu-id="44d32-116">Na poniższej ilustracji przedstawiono relację między źródłem tokenu i wszystkie kopie jego tokenu.</span><span class="sxs-lookup"><span data-stu-id="44d32-116">The following illustration shows the relationship between a token source and all the copies of its token.</span></span>  
  
 <span data-ttu-id="44d32-117">![CancellationTokenSource i anulowanie tokenów](../../../docs/standard/threading/media/vs-cancellationtoken.png "VS_CancellationToken")</span><span class="sxs-lookup"><span data-stu-id="44d32-117">![CancellationTokenSource and cancellation tokens](../../../docs/standard/threading/media/vs-cancellationtoken.png "VS_CancellationToken")</span></span>  
  
 <span data-ttu-id="44d32-118">Nowy model anulowania ułatwia tworzenie aplikacji obsługujących anulowania i bibliotek i obsługuje następujące funkcje:</span><span class="sxs-lookup"><span data-stu-id="44d32-118">The new cancellation model makes it easier to create cancellation-aware applications and libraries, and it supports the following features:</span></span>  
  
-   <span data-ttu-id="44d32-119">Anulowanie jest współpracy i nie jest wymuszana odbiornika.</span><span class="sxs-lookup"><span data-stu-id="44d32-119">Cancellation is cooperative and is not forced on the listener.</span></span> <span data-ttu-id="44d32-120">Odbiornik Określa, jak bezpiecznie przerwanie w odpowiedzi na żądanie anulowania.</span><span class="sxs-lookup"><span data-stu-id="44d32-120">The listener determines how to gracefully terminate in response to a cancellation request.</span></span>  
  
-   <span data-ttu-id="44d32-121">Żąda różni się od nasłuchiwania.</span><span class="sxs-lookup"><span data-stu-id="44d32-121">Requesting is distinct from listening.</span></span> <span data-ttu-id="44d32-122">Obiekt, który wywołuje operację można anulować można kontrolować, gdy (Jeśli kiedykolwiek) anulowania żądania.</span><span class="sxs-lookup"><span data-stu-id="44d32-122">An object that invokes a cancelable operation can control when (if ever) cancellation is requested.</span></span>  
  
-   <span data-ttu-id="44d32-123">Przy użyciu wywołania metody tylko jednego obiektu żądającego wystawia żądanie anulowania wszystkie kopie tokenu.</span><span class="sxs-lookup"><span data-stu-id="44d32-123">The requesting object issues the cancellation request to all copies of the token by using just one method call.</span></span>  
  
-   <span data-ttu-id="44d32-124">Odbiornik można słuchać wiele tokenów jednocześnie łącząc je do jednej *token połączony*.</span><span class="sxs-lookup"><span data-stu-id="44d32-124">A listener can listen to multiple tokens simultaneously by joining them into one *linked token*.</span></span>  
  
-   <span data-ttu-id="44d32-125">Kod użytkownika można zauważyć i odpowiadać na żądania anulowania kod biblioteki, a kod biblioteki można zauważyć i odpowiadać na żądania anulowania z kodu użytkownika.</span><span class="sxs-lookup"><span data-stu-id="44d32-125">User code can notice and respond to cancellation requests from library code, and library code can notice and respond to cancellation requests from user code.</span></span>  
  
-   <span data-ttu-id="44d32-126">Odbiorniki może otrzymać powiadomienie żądań anulowania sondowania, wywołania zwrotnego rejestracji lub Oczekiwanie na uchwyty oczekiwania.</span><span class="sxs-lookup"><span data-stu-id="44d32-126">Listeners can be notified of cancellation requests by polling, callback registration, or waiting on wait handles.</span></span>  
  
## <a name="cancellation-types"></a><span data-ttu-id="44d32-127">Typy anulowania</span><span class="sxs-lookup"><span data-stu-id="44d32-127">Cancellation Types</span></span>  
 <span data-ttu-id="44d32-128">Framework anulowania jest wdrażany jako zestaw powiązanych typów, które są wymienione w poniższej tabeli.</span><span class="sxs-lookup"><span data-stu-id="44d32-128">The cancellation framework is implemented as a set of related types, which are listed in the following table.</span></span>  
  
|<span data-ttu-id="44d32-129">Nazwa typu</span><span class="sxs-lookup"><span data-stu-id="44d32-129">Type name</span></span>|<span data-ttu-id="44d32-130">Opis</span><span class="sxs-lookup"><span data-stu-id="44d32-130">Description</span></span>|  
|---------------|-----------------|  
|<xref:System.Threading.CancellationTokenSource>|<span data-ttu-id="44d32-131">Obiekt, który tworzy token anulowania, a także generuje żądanie anulowania wszystkie kopie tego tokenu.</span><span class="sxs-lookup"><span data-stu-id="44d32-131">Object that creates a cancellation token, and also issues the cancellation request for all copies of that token.</span></span>|  
|<xref:System.Threading.CancellationToken>|<span data-ttu-id="44d32-132">Typ wartości lekkie przekazany do co najmniej jednego odbiornika, zazwyczaj jako parametr metody.</span><span class="sxs-lookup"><span data-stu-id="44d32-132">Lightweight value type passed to one or more listeners, typically as a method parameter.</span></span> <span data-ttu-id="44d32-133">Odbiorniki monitorować wartości `IsCancellationRequested` właściwości tokenu sondowania, wywołania zwrotnego lub dojście oczekiwania.</span><span class="sxs-lookup"><span data-stu-id="44d32-133">Listeners monitor the value of the `IsCancellationRequested` property of the token by polling, callback, or wait handle.</span></span>|  
|<xref:System.OperationCanceledException>|<span data-ttu-id="44d32-134">Zaakceptuj przeciążeń konstruktora tego wyjątku <xref:System.Threading.CancellationToken> jako parametr.</span><span class="sxs-lookup"><span data-stu-id="44d32-134">Overloads of this exception's constructor accept a <xref:System.Threading.CancellationToken> as a parameter.</span></span> <span data-ttu-id="44d32-135">Obiekty nasłuchujące Opcjonalnie można zgłosić tego wyjątku, aby zweryfikować źródło anulowanie i powiadomić inne osoby, które zostały wysłane odpowiedzi na żądanie anulowania.</span><span class="sxs-lookup"><span data-stu-id="44d32-135">Listeners can optionally throw this exception to verify the source of the cancellation and notify others that it has responded to a cancellation request.</span></span>|  
  
 <span data-ttu-id="44d32-136">Nowy model anulowania jest zintegrowany z [!INCLUDE[dnprdnshort](../../../includes/dnprdnshort-md.md)] w kilku typów.</span><span class="sxs-lookup"><span data-stu-id="44d32-136">The new cancellation model is integrated into the [!INCLUDE[dnprdnshort](../../../includes/dnprdnshort-md.md)] in several types.</span></span> <span data-ttu-id="44d32-137">Najważniejsze alerty są <xref:System.Threading.Tasks.Parallel?displayProperty=nameWithType>, <xref:System.Threading.Tasks.Task?displayProperty=nameWithType>, <xref:System.Threading.Tasks.Task%601?displayProperty=nameWithType> i <xref:System.Linq.ParallelEnumerable?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="44d32-137">The most important ones are <xref:System.Threading.Tasks.Parallel?displayProperty=nameWithType>, <xref:System.Threading.Tasks.Task?displayProperty=nameWithType>, <xref:System.Threading.Tasks.Task%601?displayProperty=nameWithType> and <xref:System.Linq.ParallelEnumerable?displayProperty=nameWithType>.</span></span> <span data-ttu-id="44d32-138">Firma Microsoft zaleca używanie tego nowego modelu anulowania dla wszystkich nowy kod biblioteki i aplikacji.</span><span class="sxs-lookup"><span data-stu-id="44d32-138">We recommend that you use this new cancellation model for all new library and application code.</span></span>  
  
## <a name="code-example"></a><span data-ttu-id="44d32-139">Przykład kodu</span><span class="sxs-lookup"><span data-stu-id="44d32-139">Code Example</span></span>  
 <span data-ttu-id="44d32-140">W poniższym przykładzie tworzy obiektu żądającego <xref:System.Threading.CancellationTokenSource> obiektu, a następnie przekazuje jego <xref:System.Threading.CancellationTokenSource.Token%2A> właściwości można anulować operację.</span><span class="sxs-lookup"><span data-stu-id="44d32-140">In the following example, the requesting object creates a <xref:System.Threading.CancellationTokenSource> object, and then passes its <xref:System.Threading.CancellationTokenSource.Token%2A> property to the cancelable operation.</span></span> <span data-ttu-id="44d32-141">Operacja, która odbiera żądanie monitoruje wartość <xref:System.Threading.CancellationToken.IsCancellationRequested%2A> właściwości tokenu za pomocą sondowania.</span><span class="sxs-lookup"><span data-stu-id="44d32-141">The operation that receives the request monitors the value of the <xref:System.Threading.CancellationToken.IsCancellationRequested%2A> property of the token by polling.</span></span> <span data-ttu-id="44d32-142">Jeśli wartość staje się `true`, odbiornik może obsłużyć w jakikolwiek sposób jest odpowiedni.</span><span class="sxs-lookup"><span data-stu-id="44d32-142">When the value becomes `true`, the listener can terminate in whatever manner is appropriate.</span></span> <span data-ttu-id="44d32-143">W tym przykładzie metoda po prostu kończy działanie, czyli wszystko, który jest wymagany w wielu przypadkach.</span><span class="sxs-lookup"><span data-stu-id="44d32-143">In this example, the method just exits, which is all that is required in many cases.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="44d32-144">W przykładzie użyto <xref:System.Threading.ThreadPool.QueueUserWorkItem%2A> metodę, aby wykazać, że nowa struktura anulowania jest zgodny z interfejsów API starszej wersji.</span><span class="sxs-lookup"><span data-stu-id="44d32-144">The example uses the <xref:System.Threading.ThreadPool.QueueUserWorkItem%2A> method to demonstrate that the new cancellation framework is compatible with legacy APIs.</span></span> <span data-ttu-id="44d32-145">Na przykład, który korzysta z nowych, preferowane <xref:System.Threading.Tasks.Task?displayProperty=nameWithType> typu, zobacz [porady: anulowanie zadania i jego elementy podrzędne](../../../docs/standard/parallel-programming/how-to-cancel-a-task-and-its-children.md).</span><span class="sxs-lookup"><span data-stu-id="44d32-145">For an example that uses the new, preferred <xref:System.Threading.Tasks.Task?displayProperty=nameWithType> type, see [How to: Cancel a Task and Its Children](../../../docs/standard/parallel-programming/how-to-cancel-a-task-and-its-children.md).</span></span>  
  
 [!code-csharp[Cancellation#1](../../../samples/snippets/csharp/VS_Snippets_Misc/cancellation/cs/cancellationex1.cs#1)]
 [!code-vb[Cancellation#1](../../../samples/snippets/visualbasic/VS_Snippets_Misc/cancellation/vb/cancellationex1.vb#1)]  
  
## <a name="operation-cancellation-versus-object-cancellation"></a><span data-ttu-id="44d32-146">Anulowanie operacji lub anulowania obiektu</span><span class="sxs-lookup"><span data-stu-id="44d32-146">Operation Cancellation Versus Object Cancellation</span></span>  
 <span data-ttu-id="44d32-147">W ramach nowych anulowania anulowania odwołuje się do operacji, a nie obiektów.</span><span class="sxs-lookup"><span data-stu-id="44d32-147">In the new cancellation framework, cancellation refers to operations, not objects.</span></span> <span data-ttu-id="44d32-148">Żądanie anulowania oznacza, że operacja ma zostać zatrzymana, jak najszybciej po wykonaniu wymagane oczyszczania.</span><span class="sxs-lookup"><span data-stu-id="44d32-148">The cancellation request means that the operation should stop as soon as possible after any required cleanup is performed.</span></span> <span data-ttu-id="44d32-149">Jeden token anulowania powinny odwoływać się do jednego "można anulować operacji" jednak tej operacji może być wdrażana w programie.</span><span class="sxs-lookup"><span data-stu-id="44d32-149">One cancellation token should refer to one "cancelable operation," however that operation may be implemented in your program.</span></span> <span data-ttu-id="44d32-150">Po <xref:System.Threading.CancellationToken.IsCancellationRequested%2A> ustawioną właściwość tokenu `true`, nie można przywrócić `false`.</span><span class="sxs-lookup"><span data-stu-id="44d32-150">After the <xref:System.Threading.CancellationToken.IsCancellationRequested%2A> property of the token has been set to `true`, it cannot be reset to `false`.</span></span> <span data-ttu-id="44d32-151">W związku z tym anulowanie tokenów nie można użyć ponownie po zostały anulowane.</span><span class="sxs-lookup"><span data-stu-id="44d32-151">Therefore, cancellation tokens cannot be reused after they have been canceled.</span></span>  
  
 <span data-ttu-id="44d32-152">Jeśli potrzebujesz mechanizm anulowania obiektu, można utworzyć ją na mechanizm anulowania operacji przez wywołanie metody <xref:System.Threading.CancellationToken.Register%2A?displayProperty=nameWithType> metody, jak pokazano w poniższym przykładzie.</span><span class="sxs-lookup"><span data-stu-id="44d32-152">If you require an object cancellation mechanism, you can base it on the operation cancellation mechanism by calling the <xref:System.Threading.CancellationToken.Register%2A?displayProperty=nameWithType> method, as shown in the following example.</span></span>  
  
 [!code-csharp[Cancellation#2](../../../samples/snippets/csharp/VS_Snippets_Misc/cancellation/cs/objectcancellation1.cs#2)]
 [!code-vb[Cancellation#2](../../../samples/snippets/visualbasic/VS_Snippets_Misc/cancellation/vb/objectcancellation1.vb#2)]  
  
 <span data-ttu-id="44d32-153">Jeśli obiekt obsługuje więcej niż jednej równoczesnych operacji można anulować, przekazać oddzielne token jako dane wejściowe do każdej operacji można anulować distinct.</span><span class="sxs-lookup"><span data-stu-id="44d32-153">If an object supports more than one concurrent cancelable operation, pass a separate token as input to each distinct cancelable operation.</span></span> <span data-ttu-id="44d32-154">W ten sposób można anulować jedną operację bez wpływu na inne.</span><span class="sxs-lookup"><span data-stu-id="44d32-154">That way, one operation can be cancelled without affecting the others.</span></span>  
  
## <a name="listening-and-responding-to-cancellation-requests"></a><span data-ttu-id="44d32-155">Nasłuchiwania i odpowiada na żądania anulowania</span><span class="sxs-lookup"><span data-stu-id="44d32-155">Listening and Responding to Cancellation Requests</span></span>  
 <span data-ttu-id="44d32-156">Delegowanie użytkownika Realizator można anulować operacji określa jak zakończyć operację w odpowiedzi na żądanie anulowania.</span><span class="sxs-lookup"><span data-stu-id="44d32-156">In the user delegate, the implementer of a cancelable operation determines how to terminate the operation in response to a cancellation request.</span></span> <span data-ttu-id="44d32-157">W wielu przypadkach delegowanie użytkownika można po prostu wykonać wszystkie wymagane oczyszczania i wróć natychmiast.</span><span class="sxs-lookup"><span data-stu-id="44d32-157">In many cases, the user delegate can just perform any required cleanup and then return immediately.</span></span>  
  
 <span data-ttu-id="44d32-158">Jednak w przypadku bardziej złożonych, może być konieczne dla pełnomocnika użytkownika, aby powiadomić kod biblioteki, która nastąpiła anulowania.</span><span class="sxs-lookup"><span data-stu-id="44d32-158">However, in more complex cases, it might be necessary for the user delegate to notify library code that cancellation has occurred.</span></span> <span data-ttu-id="44d32-159">W takich przypadkach prawidłowy sposób, aby zakończyć operację jest dla pełnomocnika, aby wywołać <xref:System.Threading.CancellationToken.ThrowIfCancellationRequested%2A>, metody, która spowoduje, że <xref:System.OperationCanceledException> zostanie wygenerowany.</span><span class="sxs-lookup"><span data-stu-id="44d32-159">In such cases, the correct way to terminate the operation is for the delegate to call the <xref:System.Threading.CancellationToken.ThrowIfCancellationRequested%2A>, method, which will cause an <xref:System.OperationCanceledException> to be thrown.</span></span> <span data-ttu-id="44d32-160">Kod biblioteki można przechwycić tego wyjątku w wątku delegata użytkownika i sprawdź token wyjątek, aby ustalić, czy wyjątek wskazuje wspólne anulowanie lub wyjątkowej sytuacji.</span><span class="sxs-lookup"><span data-stu-id="44d32-160">Library code can catch this exception on the user delegate thread and examine the exception's token to determine whether the exception indicates cooperative cancellation or some other exceptional situation.</span></span>  
  
 <span data-ttu-id="44d32-161"><xref:System.Threading.Tasks.Task> Klasy uchwytów <xref:System.OperationCanceledException> w ten sposób.</span><span class="sxs-lookup"><span data-stu-id="44d32-161">The <xref:System.Threading.Tasks.Task> class handles <xref:System.OperationCanceledException> in this way.</span></span> <span data-ttu-id="44d32-162">Aby uzyskać więcej informacji, zobacz [anulowanie zadania](../../../docs/standard/parallel-programming/task-cancellation.md).</span><span class="sxs-lookup"><span data-stu-id="44d32-162">For more information, see [Task Cancellation](../../../docs/standard/parallel-programming/task-cancellation.md).</span></span>  
  
### <a name="listening-by-polling"></a><span data-ttu-id="44d32-163">Nasłuchiwanie za pomocą sondowania</span><span class="sxs-lookup"><span data-stu-id="44d32-163">Listening by Polling</span></span>  
 <span data-ttu-id="44d32-164">Do obliczenia długotrwałe tej pętli lub recurse, można wykrywać żądanie anulowania okresowo Sondując wartość <xref:System.Threading.CancellationToken.IsCancellationRequested%2A?displayProperty=nameWithType> właściwości.</span><span class="sxs-lookup"><span data-stu-id="44d32-164">For long-running computations that loop or recurse, you can listen for a cancellation request by periodically polling the value of the <xref:System.Threading.CancellationToken.IsCancellationRequested%2A?displayProperty=nameWithType> property.</span></span> <span data-ttu-id="44d32-165">Jeśli jego wartość wynosi `true`, metoda powinna wyczyścić i zakończyć tak szybko jak to możliwe.</span><span class="sxs-lookup"><span data-stu-id="44d32-165">If its value is `true`, the method should clean up and terminate as quickly as possible.</span></span> <span data-ttu-id="44d32-166">Optymalną częstotliwość sondowania zależy od typu aplikacji.</span><span class="sxs-lookup"><span data-stu-id="44d32-166">The optimal frequency of polling depends on the type of application.</span></span> <span data-ttu-id="44d32-167">Jest developer, aby określić najlepszy sondowania częstotliwość dla dowolnego danego programu.</span><span class="sxs-lookup"><span data-stu-id="44d32-167">It is up to the developer to determine the best polling frequency for any given program.</span></span> <span data-ttu-id="44d32-168">Sondowanie sam nie znacznie wpływu na wydajność.</span><span class="sxs-lookup"><span data-stu-id="44d32-168">Polling itself does not significantly impact performance.</span></span> <span data-ttu-id="44d32-169">Poniższy przykład przedstawia sposób możliwe do sondowania.</span><span class="sxs-lookup"><span data-stu-id="44d32-169">The following example shows one possible way to poll.</span></span>  
  
 [!code-csharp[Cancellation#3](../../../samples/snippets/csharp/VS_Snippets_Misc/cancellation/cs/cancellationex11.cs#3)]
 [!code-vb[Cancellation#3](../../../samples/snippets/visualbasic/VS_Snippets_Misc/cancellation/vb/cancellationex11.vb#3)]  
  
 <span data-ttu-id="44d32-170">Aby uzyskać bardziej szczegółowy przykład, zobacz [porady: nasłuchiwanie żądań anulowania za pomocą sondowania](../../../docs/standard/threading/how-to-listen-for-cancellation-requests-by-polling.md).</span><span class="sxs-lookup"><span data-stu-id="44d32-170">For a more complete example, see [How to: Listen for Cancellation Requests by Polling](../../../docs/standard/threading/how-to-listen-for-cancellation-requests-by-polling.md).</span></span>  
  
### <a name="listening-by-registering-a-callback"></a><span data-ttu-id="44d32-171">Nasłuchiwanie rejestrując wywołania zwrotnego</span><span class="sxs-lookup"><span data-stu-id="44d32-171">Listening by Registering a Callback</span></span>  
 <span data-ttu-id="44d32-172">Niektóre operacje, mogą stać się zablokowane w taki sposób, że ich nie można sprawdzić wartość token anulowania w odpowiednim czasie.</span><span class="sxs-lookup"><span data-stu-id="44d32-172">Some operations can become blocked in such a way that they cannot check the value of the cancellation token in a timely manner.</span></span> <span data-ttu-id="44d32-173">W tych przypadkach należy zarejestrować metody wywołania zwrotnego, która odblokowuje metody, gdy zostanie odebrane żądanie anulowania.</span><span class="sxs-lookup"><span data-stu-id="44d32-173">For these cases, you can register a callback method that unblocks the method when a cancellation request is received.</span></span>  
  
 <span data-ttu-id="44d32-174"><xref:System.Threading.CancellationToken.Register%2A> Metoda zwraca <xref:System.Threading.CancellationTokenRegistration> obiekt, który jest używany w tym celu.</span><span class="sxs-lookup"><span data-stu-id="44d32-174">The <xref:System.Threading.CancellationToken.Register%2A> method returns a <xref:System.Threading.CancellationTokenRegistration> object that is used specifically for this purpose.</span></span> <span data-ttu-id="44d32-175">Poniższy przykład przedstawia użycie <xref:System.Threading.CancellationToken.Register%2A> metodę, aby anulować asynchroniczne żądanie sieci Web.</span><span class="sxs-lookup"><span data-stu-id="44d32-175">The following example shows how to use the <xref:System.Threading.CancellationToken.Register%2A> method to cancel an asynchronous Web request.</span></span>  
  
 [!code-csharp[Cancellation#4](../../../samples/snippets/csharp/VS_Snippets_Misc/cancellation/cs/cancellationex4.cs#4)]
 [!code-vb[Cancellation#4](../../../samples/snippets/visualbasic/VS_Snippets_Misc/cancellation/vb/cancellationex4.vb#4)]  
  
 <span data-ttu-id="44d32-176"><xref:System.Threading.CancellationTokenRegistration> Obiektu zarządza synchronizacja wątku i zapewnia, że wywołanie zwrotne zakończy wykonywanie w określonym punkcie w czasie.</span><span class="sxs-lookup"><span data-stu-id="44d32-176">The <xref:System.Threading.CancellationTokenRegistration> object manages thread synchronization and ensures that the callback will stop executing at a precise point in time.</span></span>  
  
 <span data-ttu-id="44d32-177">Aby zapewnić czas reakcji systemu i uniknąć zakleszczenia, poniższe wskazówki musi występować podczas rejestrowania wywołań zwrotnych:</span><span class="sxs-lookup"><span data-stu-id="44d32-177">In order to ensure system responsiveness and to avoid deadlocks, the following guidelines must be followed when registering callbacks:</span></span>  
  
-   <span data-ttu-id="44d32-178">Powinna być szybkie metody wywołania zwrotnego, ponieważ jest ona wywoływana synchronicznie i w związku z tym wywołaniu <xref:System.Threading.CancellationTokenSource.Cancel%2A> wraca do momentu zwraca wywołania zwrotnego.</span><span class="sxs-lookup"><span data-stu-id="44d32-178">The callback method should be fast because it is called synchronously and therefore the call to <xref:System.Threading.CancellationTokenSource.Cancel%2A> does not return until the callback returns.</span></span>  
  
-   <span data-ttu-id="44d32-179">Jeśli należy wywołać <xref:System.Threading.CancellationTokenRegistration.Dispose%2A> podczas wywołania zwrotnego jest uruchomiona, przytrzymaj blokadę wywołania zwrotnego oczekuje na programie można zakleszczenie.</span><span class="sxs-lookup"><span data-stu-id="44d32-179">If you call <xref:System.Threading.CancellationTokenRegistration.Dispose%2A> while the callback is running, and you hold a lock that the callback is waiting on, your program can deadlock.</span></span> <span data-ttu-id="44d32-180">Po `Dispose` zwraca można zwolnić wszystkie zasoby wymagane przez wywołanie zwrotne.</span><span class="sxs-lookup"><span data-stu-id="44d32-180">After `Dispose` returns, you can free any resources required by the callback.</span></span>  
  
-   <span data-ttu-id="44d32-181">Wywołania zwrotne nie należy wykonać wszelkie ręczne wątku lub <xref:System.Threading.SynchronizationContext> użycia w wywołaniu zwrotnym.</span><span class="sxs-lookup"><span data-stu-id="44d32-181">Callbacks should not perform any manual thread or <xref:System.Threading.SynchronizationContext> usage in a callback.</span></span> <span data-ttu-id="44d32-182">Jeśli wywołanie zwrotne muszą być wykonywane w szczególności wątku, użyj <xref:System.Threading.CancellationTokenRegistration?displayProperty=nameWithType> Konstruktor, który pozwala określić, że syncContext docelowy jest aktywne <xref:System.Threading.SynchronizationContext.Current%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="44d32-182">If a callback must run on a particular thread, use the <xref:System.Threading.CancellationTokenRegistration?displayProperty=nameWithType> constructor that enables you to specify that the target syncContext is the active <xref:System.Threading.SynchronizationContext.Current%2A?displayProperty=nameWithType>.</span></span> <span data-ttu-id="44d32-183">Wykonywanie wątków ręcznego w wywołaniu zwrotnym może spowodować zakleszczenia.</span><span class="sxs-lookup"><span data-stu-id="44d32-183">Performing manual threading in a callback can cause deadlock.</span></span>  
  
 <span data-ttu-id="44d32-184">Aby uzyskać bardziej szczegółowy przykład, zobacz [porady: rejestrowanie wywołań zwrotnych żądań anulowania](../../../docs/standard/threading/how-to-register-callbacks-for-cancellation-requests.md).</span><span class="sxs-lookup"><span data-stu-id="44d32-184">For a more complete example, see [How to: Register Callbacks for Cancellation Requests](../../../docs/standard/threading/how-to-register-callbacks-for-cancellation-requests.md).</span></span>  
  
### <a name="listening-by-using-a-wait-handle"></a><span data-ttu-id="44d32-185">Nasłuchiwanie przy użyciu dojścia oczekiwania</span><span class="sxs-lookup"><span data-stu-id="44d32-185">Listening by Using a Wait Handle</span></span>  
 <span data-ttu-id="44d32-186">Gdy zablokować można anulować operacji podczas oczekiwania na pierwotny, takich jak synchronizacja <xref:System.Threading.ManualResetEvent?displayProperty=nameWithType> lub <xref:System.Threading.Semaphore?displayProperty=nameWithType>, można użyć <xref:System.Threading.CancellationToken.WaitHandle%2A?displayProperty=nameWithType> właściwości, aby umożliwić wykonanie operacji oczekiwania na zdarzenia i żądania anulowania.</span><span class="sxs-lookup"><span data-stu-id="44d32-186">When a cancelable operation can block while it waits on a synchronization primitive such as a <xref:System.Threading.ManualResetEvent?displayProperty=nameWithType> or <xref:System.Threading.Semaphore?displayProperty=nameWithType>, you can use the <xref:System.Threading.CancellationToken.WaitHandle%2A?displayProperty=nameWithType> property to enable the operation to wait on both the event and the cancellation request.</span></span> <span data-ttu-id="44d32-187">Dojście oczekiwania token anulowania będzie stają się sygnalizowane w odpowiedzi na żądanie anulowania, a metoda może używać wartości zwrotnej <xref:System.Threading.WaitHandle.WaitAny%2A> token metody, aby ustalić, czy został on anulowania, która sygnalizuje.</span><span class="sxs-lookup"><span data-stu-id="44d32-187">The wait handle of the cancellation token will become signaled in response to a cancellation request, and the method can use the return value of the <xref:System.Threading.WaitHandle.WaitAny%2A> method to determine whether it was the cancellation token that signaled.</span></span> <span data-ttu-id="44d32-188">Operację można, a następnie wystarczy zamknąć lub throw <xref:System.OperationCanceledException>odpowiednio.</span><span class="sxs-lookup"><span data-stu-id="44d32-188">The operation can then just exit, or throw a <xref:System.OperationCanceledException>, as appropriate.</span></span>  
  
 [!code-csharp[Cancellation#5](../../../samples/snippets/csharp/VS_Snippets_Misc/cancellation/cs/cancellationex9.cs#5)]
 [!code-vb[Cancellation#5](../../../samples/snippets/visualbasic/VS_Snippets_Misc/cancellation/vb/cancellationex9.vb#5)]  
  
 <span data-ttu-id="44d32-189">W nowy kod, którego celem jest [!INCLUDE[net_v40_long](../../../includes/net-v40-long-md.md)], <xref:System.Threading.ManualResetEventSlim?displayProperty=nameWithType> i <xref:System.Threading.SemaphoreSlim?displayProperty=nameWithType> zarówno obsługi nowej struktury anulowania w ich `Wait` metody.</span><span class="sxs-lookup"><span data-stu-id="44d32-189">In new code that targets the [!INCLUDE[net_v40_long](../../../includes/net-v40-long-md.md)], <xref:System.Threading.ManualResetEventSlim?displayProperty=nameWithType> and <xref:System.Threading.SemaphoreSlim?displayProperty=nameWithType> both support the new cancellation framework in their `Wait` methods.</span></span> <span data-ttu-id="44d32-190">Można przekazać <xref:System.Threading.CancellationToken> do metody, i gdy zażądano anulowania zdarzenia budzi i zgłasza <xref:System.OperationCanceledException>.</span><span class="sxs-lookup"><span data-stu-id="44d32-190">You can pass the <xref:System.Threading.CancellationToken> to the method, and when the cancellation is requested, the event wakes up and throws an <xref:System.OperationCanceledException>.</span></span>  
  
 [!code-csharp[Cancellation#6](../../../samples/snippets/csharp/VS_Snippets_Misc/cancellation/cs/cancellationex10.cs#6)]
 [!code-vb[Cancellation#6](../../../samples/snippets/visualbasic/VS_Snippets_Misc/cancellation/vb/cancellationex10.vb#6)]  
  
 <span data-ttu-id="44d32-191">Na przykład bardziej szczegółowy, zobacz [porady: nasłuchiwanie anulowania żądania ma czekać obsługi przez](../../../docs/standard/threading/how-to-listen-for-cancellation-requests-that-have-wait-handles.md).</span><span class="sxs-lookup"><span data-stu-id="44d32-191">For a more complete example, see [How to: Listen for Cancellation Requests That Have Wait Handles](../../../docs/standard/threading/how-to-listen-for-cancellation-requests-that-have-wait-handles.md).</span></span>  
  
### <a name="listening-to-multiple-tokens-simultaneously"></a><span data-ttu-id="44d32-192">Nasłuchiwanie jednocześnie wiele tokenów</span><span class="sxs-lookup"><span data-stu-id="44d32-192">Listening to Multiple Tokens Simultaneously</span></span>  
 <span data-ttu-id="44d32-193">W niektórych przypadkach odbiornik może mieć jednocześnie nasłuchiwanie na wiele tokenów anulowania.</span><span class="sxs-lookup"><span data-stu-id="44d32-193">In some cases, a listener may have to listen to multiple cancellation tokens simultaneously.</span></span> <span data-ttu-id="44d32-194">Na przykład można anulować operację może być konieczne monitorować token anulowania wewnętrzny oprócz typ tokenu przekazanego w zewnętrznie jako argument do parametru metody.</span><span class="sxs-lookup"><span data-stu-id="44d32-194">For example, a cancelable operation may have to monitor an internal cancellation token in addition to a token passed in externally as an argument to a method parameter.</span></span> <span data-ttu-id="44d32-195">W tym celu należy utworzyć połączonego źródła tokenu, które może dołączyć do dwóch lub więcej tokenów do jednego tokenu, jak pokazano w poniższym przykładzie.</span><span class="sxs-lookup"><span data-stu-id="44d32-195">To accomplish this, create a linked token source that can join two or more tokens into one token, as shown in the following example.</span></span>  
  
 [!code-csharp[Cancellation#7](../../../samples/snippets/csharp/VS_Snippets_Misc/cancellation/cs/cancellationex13.cs#7)]
 [!code-vb[Cancellation#7](../../../samples/snippets/visualbasic/VS_Snippets_Misc/cancellation/vb/cancellationex13.vb#7)]  
  
 <span data-ttu-id="44d32-196">Należy zauważyć, że należy wywołać `Dispose` połączonego tokenu źródłowego po zakończeniu z nim.</span><span class="sxs-lookup"><span data-stu-id="44d32-196">Notice that you must call `Dispose` on the linked token source when you are done with it.</span></span> <span data-ttu-id="44d32-197">Aby uzyskać bardziej szczegółowy przykład, zobacz [porady: nasłuchiwanie wielu żądań anulowania](../../../docs/standard/threading/how-to-listen-for-multiple-cancellation-requests.md).</span><span class="sxs-lookup"><span data-stu-id="44d32-197">For a more complete example, see [How to: Listen for Multiple Cancellation Requests](../../../docs/standard/threading/how-to-listen-for-multiple-cancellation-requests.md).</span></span>  
  
## <a name="cooperation-between-library-code-and-user-code"></a><span data-ttu-id="44d32-198">Współpraca między kodem biblioteki i kodem użytkownika</span><span class="sxs-lookup"><span data-stu-id="44d32-198">Cooperation Between Library Code and User Code</span></span>  
 <span data-ttu-id="44d32-199">Framework ujednoliconego anulowania umożliwia kod biblioteki anulować kod użytkownika i kodu użytkownika anulować kod biblioteki w sposób współpracy.</span><span class="sxs-lookup"><span data-stu-id="44d32-199">The unified cancellation framework makes it possible for library code to cancel user code, and for user code to cancel library code in a cooperative manner.</span></span> <span data-ttu-id="44d32-200">Smooth współpracy zależy od każdej strony poniższych wskazówek:</span><span class="sxs-lookup"><span data-stu-id="44d32-200">Smooth cooperation depends on each side following these guidelines:</span></span>  
  
-   <span data-ttu-id="44d32-201">Jeśli kod biblioteki udostępnia operacje można anulować, on również zawierał metody publiczne akceptujących token anulowania zewnętrznego, dzięki czemu kod użytkownika można żądanie anulowania.</span><span class="sxs-lookup"><span data-stu-id="44d32-201">If library code provides cancelable operations, it should also provide public methods that accept an external cancellation token so that user code can request cancellation.</span></span>  
  
-   <span data-ttu-id="44d32-202">Jeśli kod biblioteki odwołuje się do kodu użytkownika, kod biblioteki należy interpretować OperationCanceledException(externalToken) jako *wspólne anulowanie*i niekoniecznie wyjątek błędu.</span><span class="sxs-lookup"><span data-stu-id="44d32-202">If library code calls into user code, the library code should interpret an OperationCanceledException(externalToken) as *cooperative cancellation*, and not necessarily as a failure exception.</span></span>  
  
-   <span data-ttu-id="44d32-203">Obiekty delegowane użytkownik powinien próbować odpowiadać na żądania anulowania kod biblioteki w odpowiednim czasie.</span><span class="sxs-lookup"><span data-stu-id="44d32-203">User-delegates should attempt to respond to cancellation requests from library code in a timely manner.</span></span>  
  
 <span data-ttu-id="44d32-204"><xref:System.Threading.Tasks.Task?displayProperty=nameWithType> i <xref:System.Linq.ParallelEnumerable?displayProperty=nameWithType> przedstawiono klasy, które wykonuje te wytyczne.</span><span class="sxs-lookup"><span data-stu-id="44d32-204"><xref:System.Threading.Tasks.Task?displayProperty=nameWithType> and <xref:System.Linq.ParallelEnumerable?displayProperty=nameWithType> are examples of classes that follows these guidelines.</span></span> <span data-ttu-id="44d32-205">Aby uzyskać więcej informacji, zobacz [anulowanie zadania](../../../docs/standard/parallel-programming/task-cancellation.md)i [porady: Anulowanie zapytania PLINQ](../../../docs/standard/parallel-programming/how-to-cancel-a-plinq-query.md).</span><span class="sxs-lookup"><span data-stu-id="44d32-205">For more information, see [Task Cancellation](../../../docs/standard/parallel-programming/task-cancellation.md)and [How to: Cancel a PLINQ Query](../../../docs/standard/parallel-programming/how-to-cancel-a-plinq-query.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="44d32-206">Zobacz też</span><span class="sxs-lookup"><span data-stu-id="44d32-206">See Also</span></span>  
 [<span data-ttu-id="44d32-207">Zarządzana wątkowość — podstawy</span><span class="sxs-lookup"><span data-stu-id="44d32-207">Managed Threading Basics</span></span>](../../../docs/standard/threading/managed-threading-basics.md)
