---
title: "Zarządzanie sesjami WIF"
ms.custom: 
ms.date: 03/30/2017
ms.prod: .net-framework
ms.reviewer: 
ms.suite: 
ms.technology: dotnet-clr
ms.tgt_pltfrm: 
ms.topic: article
ms.assetid: 98bce126-18a9-401b-b20d-67ee462a5f8a
caps.latest.revision: "7"
author: BrucePerlerMS
ms.author: bruceper
manager: mbaldwin
ms.openlocfilehash: 9c41b9c0c9abe3fc80d16dbd847c35c8b2da7038
ms.sourcegitcommit: bd1ef61f4bb794b25383d3d72e71041a5ced172e
ms.translationtype: MT
ms.contentlocale: pl-PL
ms.lasthandoff: 10/18/2017
---
# <a name="wif-session-management"></a><span data-ttu-id="743e5-102">Zarządzanie sesjami WIF</span><span class="sxs-lookup"><span data-stu-id="743e5-102">WIF Session Management</span></span>
<span data-ttu-id="743e5-103">Gdy pierwszy klient próbuje uzyskać dostępu do chronionego zasobu, która jest obsługiwana przez jednostkę uzależnioną, klient muszą najpierw uwierzytelnić się z usługą tokenu zabezpieczeń (STS), który jest uznawany za zaufany przez jednostkę uzależnioną.</span><span class="sxs-lookup"><span data-stu-id="743e5-103">When a client first tries to access a protected resource that is hosted by a relying party, the client must first authenticate itself to a security token service (STS) that is trusted by the relying party.</span></span> <span data-ttu-id="743e5-104">Usługa tokenu Zabezpieczającego następnie wystawia token zabezpieczający do klienta.</span><span class="sxs-lookup"><span data-stu-id="743e5-104">The STS then issues a security token to the client.</span></span> <span data-ttu-id="743e5-105">Klient przedstawia ten token do jednostki uzależnionej, co powoduje przyznanie dostępu klientów do chronionego zasobu.</span><span class="sxs-lookup"><span data-stu-id="743e5-105">The client presents this token to the relying party, which then grants the client access to the protected resource.</span></span> <span data-ttu-id="743e5-106">Jednak nie chcesz umożliwić klientowi ponownego uwierzytelnienia do serwera STS dla każdego żądania, szczególnie, ponieważ może nie nawet być w tym samym komputerze lub w tej samej domenie co jednostki uzależnionej.</span><span class="sxs-lookup"><span data-stu-id="743e5-106">However, you don’t want the client to have to re-authenticate to the STS for each request, especially because it might not even be on the same computer or in the same domain as the relying party.</span></span> <span data-ttu-id="743e5-107">Zamiast tego Windows Identity Foundation (WIF) ma klienta i ustanowienia sesji, w którym klient używa tokenu zabezpieczającego sesji do samodzielnego uwierzytelnienia do jednostki uzależnionej dla wszystkich żądań, po pierwszym żądaniu jednostki uzależnionej.</span><span class="sxs-lookup"><span data-stu-id="743e5-107">Instead, Windows Identity Foundation (WIF) has the client and relying party establish a session in which the client uses a session security token to authenticate itself to the relying party for all requests after the first request.</span></span> <span data-ttu-id="743e5-108">Jednostki uzależnionej można użyć tego tokenu zabezpieczającego sesji, który jest przechowywany w pliku cookie, aby odtworzyć klienta <xref:System.Security.Claims.ClaimsPrincipal?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="743e5-108">The relying party can use this session security token, which is stored inside a cookie, to reconstruct the client’s <xref:System.Security.Claims.ClaimsPrincipal?displayProperty=nameWithType>.</span></span>  
  
 <span data-ttu-id="743e5-109">Usługa tokenu Zabezpieczającego definiuje rodzaju uwierzytelniania klient musi dostarczyć.</span><span class="sxs-lookup"><span data-stu-id="743e5-109">The STS defines what authentication the client must provide.</span></span> <span data-ttu-id="743e5-110">Jednak klient może mieć wiele poświadczeń, z którymi uwierzytelniania się do serwera STS.</span><span class="sxs-lookup"><span data-stu-id="743e5-110">However, the client might have multiple credentials with which it can authenticate itself to the STS.</span></span> <span data-ttu-id="743e5-111">Na przykład może mieć tokenu z usługi Windows Live, nazwę użytkownika i hasło, certyfikatu i smartkey.</span><span class="sxs-lookup"><span data-stu-id="743e5-111">For example, it might have a token from Windows Live, a user name and password, a certificate, and a smartkey.</span></span> <span data-ttu-id="743e5-112">W takim przypadku Usługa tokenu Zabezpieczającego przyznaje klienta kilka tożsamości z każda tożsamość odpowiadającego poświadczeń, który klient przedstawia.</span><span class="sxs-lookup"><span data-stu-id="743e5-112">In that case, the STS grants the client several identities, with each identity corresponding to one of the credentials that the client presents.</span></span> <span data-ttu-id="743e5-113">Jednostki uzależnionej można użyć co najmniej jednego z tych tożsamości, podczas jej decyduje o tym, jakiego poziomu dostępu klienta.</span><span class="sxs-lookup"><span data-stu-id="743e5-113">The relying party can use one or more of these identities when it decides what level of access to grant the client.</span></span>  
  
 <span data-ttu-id="743e5-114"><xref:System.IdentityModel.Tokens.SessionSecurityToken?displayProperty=nameWithType> Służy do rekonstrukcji klienta <xref:System.Security.Claims.ClaimsPrincipal?displayProperty=nameWithType>, który zawiera wszystkie tożsamości klienta w <xref:System.Security.Claims.ClaimsPrincipal.Identities%2A>.</span><span class="sxs-lookup"><span data-stu-id="743e5-114">The <xref:System.IdentityModel.Tokens.SessionSecurityToken?displayProperty=nameWithType> is used to reconstruct the client’s <xref:System.Security.Claims.ClaimsPrincipal?displayProperty=nameWithType>, which contains all of the client’s identities in <xref:System.Security.Claims.ClaimsPrincipal.Identities%2A>.</span></span> <span data-ttu-id="743e5-115">Każdy <xref:System.Security.Claims.ClaimsIdentity?displayProperty=nameWithType> w kolekcji zawiera tokeny ładowania początkowego, które są skojarzone z tą tożsamością.</span><span class="sxs-lookup"><span data-stu-id="743e5-115">Each <xref:System.Security.Claims.ClaimsIdentity?displayProperty=nameWithType> in the collection contains the bootstrap tokens that are associated with that identity.</span></span>  
  
 <span data-ttu-id="743e5-116">Jeśli wystawiony token nowej sesji o identyfikatorze sesji oryginalnego tokenu sesji, <xref:System.IdentityModel.Tokens.SessionSecurityTokenHandler?displayProperty=nameWithType> nie aktualizuje tokenu sesji w pamięci podręcznej tokenu.</span><span class="sxs-lookup"><span data-stu-id="743e5-116">If a new session token is issued with the session ID of the original session token, <xref:System.IdentityModel.Tokens.SessionSecurityTokenHandler?displayProperty=nameWithType> does not update the session token in the token cache.</span></span> <span data-ttu-id="743e5-117">Należy zawsze utworzyć wystąpienia tokenu sesji z unikalny identyfikator sesji.</span><span class="sxs-lookup"><span data-stu-id="743e5-117">You should always instantiate a session token with a unique session ID.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="743e5-118">Zgłasza Session.SecurityTokenHandler.ReadToken <xref:System.Xml.XmlException> wyjątek, jeśli otrzymuje nieprawidłowe dane wejściowe; na przykład, jeśli plik cookie zawierający tokenu sesji jest uszkodzony.</span><span class="sxs-lookup"><span data-stu-id="743e5-118">Session.SecurityTokenHandler.ReadToken throws a <xref:System.Xml.XmlException> exception if it receives invalid input; for example, if the cookie that contains the session token is corrupted.</span></span> <span data-ttu-id="743e5-119">Zalecamy przechwycić tego wyjątku, a następnie podaj zachowanie specyficzne dla aplikacji.</span><span class="sxs-lookup"><span data-stu-id="743e5-119">We recommend that you catch this exception and provide application-specific behavior.</span></span>  
  
 <span data-ttu-id="743e5-120">Jeśli chroniony strony sieci Web zawiera wiele zasobów (takich jak mała grafiki), które również znajdują się w domenie chronionych, klient musi zostać ponownie uwierzytelnione się do jednostki uzależnionej, aby pobrać każdego z tych zasobów.</span><span class="sxs-lookup"><span data-stu-id="743e5-120">If a protected Web page contains lots of resources (such as small graphics) that are also in the protected domain, the client must re-authenticate itself to the relying party to download each of those resources.</span></span> <span data-ttu-id="743e5-121">Użyj tokenu uwierzytelniania sesji uniknąć konieczności uwierzytelnienia do serwera STS dla każdego żądania, ale nadal oznacza, że pakiety są wysyłane za pośrednictwem wielu plików cookie.</span><span class="sxs-lookup"><span data-stu-id="743e5-121">Use of a session authentication token avoids the need to authenticate to the STS for each request, but it still means that many cookies are being sent over.</span></span> <span data-ttu-id="743e5-122">Można skonfigurować strony sieci Web, tak aby ważnych danych i zasobów są przechowywane w domenie chronionych, podczas gdy pomocnicza elementy są przechowywane w domenie niechronione i połączone z głównym strony sieci Web.</span><span class="sxs-lookup"><span data-stu-id="743e5-122">You might want to set up the Web page so that the important data and resources are stored in the protected domain while minor items are stored in an unprotected domain and linked to from the main Web page.</span></span> <span data-ttu-id="743e5-123">Ponadto należy ustawić ścieżkę pliku cookie, aby odwołać domenę chronioną.</span><span class="sxs-lookup"><span data-stu-id="743e5-123">Also, set the cookie path to reference only the protected domain.</span></span>  
  
 <span data-ttu-id="743e5-124">Do pracy w trybie odwołania, firma Microsoft zaleca zapewnienie obsługi dla <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.SessionSecurityTokenCreated> zdarzenia w **global.asax.cs** plików i ustawienie **IsReferenceMode** przekazana właściwość w tokenie <xref:System.IdentityModel.Services.SessionSecurityTokenCreatedEventArgs.SessionToken%2A> właściwości.</span><span class="sxs-lookup"><span data-stu-id="743e5-124">To operate in reference mode, Microsoft recommends providing a handler for the <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.SessionSecurityTokenCreated> event in the **global.asax.cs** file and setting the **IsReferenceMode** property on the token passed in the <xref:System.IdentityModel.Services.SessionSecurityTokenCreatedEventArgs.SessionToken%2A> property.</span></span> <span data-ttu-id="743e5-125">Te aktualizacje zapewnia, że tokenu sesji działa w trybie odwołań dla każdego żądania i jest ich drużyna jest faworytem za pośrednictwem jedynie ustawienia <xref:System.IdentityModel.Services.SessionAuthenticationModule.IsReferenceMode%2A> właściwości w Module sesji uwierzytelniania.</span><span class="sxs-lookup"><span data-stu-id="743e5-125">These updates will ensure that the session token operates in reference mode for every request and is favored over merely setting the  <xref:System.IdentityModel.Services.SessionAuthenticationModule.IsReferenceMode%2A> property on the Session Authentication Module.</span></span>  
  
## <a name="extensibility"></a><span data-ttu-id="743e5-126">Rozszerzalność</span><span class="sxs-lookup"><span data-stu-id="743e5-126">Extensibility</span></span>  
 <span data-ttu-id="743e5-127">Można rozszerzyć mechanizm zarządzania sesji.</span><span class="sxs-lookup"><span data-stu-id="743e5-127">You can extend the session management mechanism.</span></span> <span data-ttu-id="743e5-128">Powodem tego jest poprawić wydajność.</span><span class="sxs-lookup"><span data-stu-id="743e5-128">One reason for this would be to improve the performance.</span></span> <span data-ttu-id="743e5-129">Na przykład można utworzyć niestandardowego pliku cookie programu obsługi, który przekształca lub optymalizuje tokenu zabezpieczającego sesji od jego stan w pamięci i co przechodzi w stan pliku cookie.</span><span class="sxs-lookup"><span data-stu-id="743e5-129">For example, you could create a custom cookie handler that transforms or optimizes the session security token between its in-memory state and what goes into the cookie.</span></span> <span data-ttu-id="743e5-130">Aby to zrobić, można skonfigurować <xref:System.IdentityModel.Services.SessionAuthenticationModule.CookieHandler%2A?displayProperty=nameWithType> właściwość <xref:System.IdentityModel.Services.SessionAuthenticationModule?displayProperty=nameWithType> do używania obsługi niestandardowego pliku cookie, pochodzącą z <xref:System.IdentityModel.Services.CookieHandler?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="743e5-130">To do so, you can configure the <xref:System.IdentityModel.Services.SessionAuthenticationModule.CookieHandler%2A?displayProperty=nameWithType> property of the <xref:System.IdentityModel.Services.SessionAuthenticationModule?displayProperty=nameWithType> to use a custom cookie handler that derives from <xref:System.IdentityModel.Services.CookieHandler?displayProperty=nameWithType>.</span></span> <span data-ttu-id="743e5-131"><xref:System.IdentityModel.Services.ChunkedCookieHandler?displayProperty=nameWithType>jest domyślny program obsługi plików cookie, ponieważ pliki cookie przekracza dozwolony rozmiar dla protokołu HTTP (Hypertext Transfer); Jeśli zamiast tego użyj obsługi niestandardowego pliku cookie musi implementować podziału.</span><span class="sxs-lookup"><span data-stu-id="743e5-131"><xref:System.IdentityModel.Services.ChunkedCookieHandler?displayProperty=nameWithType> is the default cookie handler because the cookies exceed the allowable size for Hypertext Transfer Protocol (HTTP); if you use a custom cookie handler instead, you must implement chunking.</span></span>  
  
 <span data-ttu-id="743e5-132">Aby uzyskać więcej informacji, zobacz [ClaimsAwareWebFarm](http://go.microsoft.com/fwlink/?LinkID=248408) próbki (http://go.microsoft.com/fwlink/?LinkID=248408).</span><span class="sxs-lookup"><span data-stu-id="743e5-132">For more information, see [ClaimsAwareWebFarm](http://go.microsoft.com/fwlink/?LinkID=248408) (http://go.microsoft.com/fwlink/?LinkID=248408) sample.</span></span> <span data-ttu-id="743e5-133">W tym przykładzie pokazano pamięci podręcznej sesji gotowy farmy (w przeciwieństwie do tokenreplycache), dzięki czemu można użyć sesji przez odwołanie, zamiast wymiana dużych plików cookie. w tym przykładzie przedstawiono również prostszy sposób ochrony plików cookie w farmie.</span><span class="sxs-lookup"><span data-stu-id="743e5-133">This sample shows a farm ready session cache (as opposed to a tokenreplycache) so that you can use sessions by reference instead of exchanging big cookies; this sample also demonstrates an easier way of securing cookies in a farm.</span></span> <span data-ttu-id="743e5-134">Pamięci podręcznej sesji jest oparte na WCF.</span><span class="sxs-lookup"><span data-stu-id="743e5-134">The session cache is WCF-based.</span></span> <span data-ttu-id="743e5-135">W odniesieniu do zabezpieczania sesji w przykładzie pokazano nową funkcję w wersji WIF 4.5 transformacji pliku cookie oparte na MachineKey, który może być uruchomiony po prostu wklejając odpowiedni fragment kodu w pliku web.config. Próbka sam jest nie "przez człowieka", ale pokazuje, co jest potrzebne do tworzenia aplikacji gotowych farmy.</span><span class="sxs-lookup"><span data-stu-id="743e5-135">With regard to session securing, the sample demonstrates a new capability in WIF 4.5 of a cookie transform based on MachineKey, which can be activated by simply pasting the appropriate snippet in the web.config. The sample itself is not "farmed", but it demonstrates what you need for making your app farm-ready.</span></span>
