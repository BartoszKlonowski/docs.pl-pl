---
title: Zarządzanie sesjami programu WIF
ms.date: 03/30/2017
ms.assetid: 98bce126-18a9-401b-b20d-67ee462a5f8a
author: BrucePerlerMS
ms.openlocfilehash: 141eda509530cab1120d519c3cbc94693ef1cc51
ms.sourcegitcommit: 68653db98c5ea7744fd438710248935f70020dfb
ms.translationtype: MT
ms.contentlocale: pl-PL
ms.lasthandoff: 08/22/2019
ms.locfileid: "69946236"
---
# <a name="wif-session-management"></a><span data-ttu-id="e742e-102">Zarządzanie sesjami programu WIF</span><span class="sxs-lookup"><span data-stu-id="e742e-102">WIF Session Management</span></span>
<span data-ttu-id="e742e-103">Gdy klient próbuje uzyskać dostęp do chronionego zasobu, który jest obsługiwany przez jednostkę uzależnioną, klient musi najpierw się uwierzytelnić w usłudze tokenu zabezpieczającego (STS), która jest zaufana przez jednostkę uzależnioną.</span><span class="sxs-lookup"><span data-stu-id="e742e-103">When a client first tries to access a protected resource that is hosted by a relying party, the client must first authenticate itself to a security token service (STS) that is trusted by the relying party.</span></span> <span data-ttu-id="e742e-104">Usługa STS wystawia klientowi token zabezpieczający.</span><span class="sxs-lookup"><span data-stu-id="e742e-104">The STS then issues a security token to the client.</span></span> <span data-ttu-id="e742e-105">Klient przedstawia ten token jednostce uzależnionej, która następnie udziela Klientowi dostępu do chronionego zasobu.</span><span class="sxs-lookup"><span data-stu-id="e742e-105">The client presents this token to the relying party, which then grants the client access to the protected resource.</span></span> <span data-ttu-id="e742e-106">Nie ma jednak potrzeby ponownego uwierzytelnienia klienta w usłudze STS dla każdego żądania, szczególnie dlatego, że może to nie być nawet na tym samym komputerze lub w tej samej domenie co Jednostka uzależniona.</span><span class="sxs-lookup"><span data-stu-id="e742e-106">However, you don’t want the client to have to re-authenticate to the STS for each request, especially because it might not even be on the same computer or in the same domain as the relying party.</span></span> <span data-ttu-id="e742e-107">Zamiast tego program Windows Identity Foundation (WIF) ma klienta i jednostki uzależnionej ustanawiają sesję, w której klient używa tokenu zabezpieczeń sesji do samodzielnego uwierzytelnienia w jednostce uzależnionej dla wszystkich żądań po pierwszym żądaniu.</span><span class="sxs-lookup"><span data-stu-id="e742e-107">Instead, Windows Identity Foundation (WIF) has the client and relying party establish a session in which the client uses a session security token to authenticate itself to the relying party for all requests after the first request.</span></span> <span data-ttu-id="e742e-108">Jednostka uzależniona może używać tego tokenu zabezpieczeń sesji, który jest przechowywany w pliku cookie, aby odtworzyć klienta <xref:System.Security.Claims.ClaimsPrincipal?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="e742e-108">The relying party can use this session security token, which is stored inside a cookie, to reconstruct the client’s <xref:System.Security.Claims.ClaimsPrincipal?displayProperty=nameWithType>.</span></span>  
  
 <span data-ttu-id="e742e-109">Usługa STS definiuje, jakie uwierzytelnianie musi dostarczyć klient.</span><span class="sxs-lookup"><span data-stu-id="e742e-109">The STS defines what authentication the client must provide.</span></span> <span data-ttu-id="e742e-110">Jednak klient może mieć wiele poświadczeń, z którymi może się uwierzytelnić w usłudze STS.</span><span class="sxs-lookup"><span data-stu-id="e742e-110">However, the client might have multiple credentials with which it can authenticate itself to the STS.</span></span> <span data-ttu-id="e742e-111">Na przykład może mieć token z usługi Windows Live, nazwę użytkownika i hasło, certyfikat i SmartKey.</span><span class="sxs-lookup"><span data-stu-id="e742e-111">For example, it might have a token from Windows Live, a user name and password, a certificate, and a smartkey.</span></span> <span data-ttu-id="e742e-112">W takim przypadku usługa STS przyznaje klientowi kilka tożsamości z każdą tożsamością odpowiadającą jednemu z poświadczeń prezentowanym przez klienta.</span><span class="sxs-lookup"><span data-stu-id="e742e-112">In that case, the STS grants the client several identities, with each identity corresponding to one of the credentials that the client presents.</span></span> <span data-ttu-id="e742e-113">Jednostka uzależniona może korzystać z jednej lub więcej z tych tożsamości, gdy decyduje o tym, jaki poziom dostępu ma udzielić klientowi.</span><span class="sxs-lookup"><span data-stu-id="e742e-113">The relying party can use one or more of these identities when it decides what level of access to grant the client.</span></span>  
  
 <span data-ttu-id="e742e-114">Służy do rekonstruowania <xref:System.Security.Claims.ClaimsPrincipal?displayProperty=nameWithType>klienta programu, który zawiera wszystkie tożsamości klienta w programie <xref:System.Security.Claims.ClaimsPrincipal.Identities%2A>. <xref:System.IdentityModel.Tokens.SessionSecurityToken?displayProperty=nameWithType></span><span class="sxs-lookup"><span data-stu-id="e742e-114">The <xref:System.IdentityModel.Tokens.SessionSecurityToken?displayProperty=nameWithType> is used to reconstruct the client’s <xref:System.Security.Claims.ClaimsPrincipal?displayProperty=nameWithType>, which contains all of the client’s identities in <xref:System.Security.Claims.ClaimsPrincipal.Identities%2A>.</span></span> <span data-ttu-id="e742e-115">Każda <xref:System.Security.Claims.ClaimsIdentity?displayProperty=nameWithType> z kolekcji zawiera tokeny ładowania początkowego skojarzone z tą tożsamością.</span><span class="sxs-lookup"><span data-stu-id="e742e-115">Each <xref:System.Security.Claims.ClaimsIdentity?displayProperty=nameWithType> in the collection contains the bootstrap tokens that are associated with that identity.</span></span>  
  
 <span data-ttu-id="e742e-116">W przypadku wystawienia nowego tokenu sesji z identyfikatorem sesji oryginalnego tokenu sesji program <xref:System.IdentityModel.Tokens.SessionSecurityTokenHandler?displayProperty=nameWithType> nie aktualizuje tokenu sesji w pamięci podręcznej tokenów.</span><span class="sxs-lookup"><span data-stu-id="e742e-116">If a new session token is issued with the session ID of the original session token, <xref:System.IdentityModel.Tokens.SessionSecurityTokenHandler?displayProperty=nameWithType> does not update the session token in the token cache.</span></span> <span data-ttu-id="e742e-117">Należy zawsze utworzyć wystąpienie tokenu sesji z unikatowym IDENTYFIKATORem sesji.</span><span class="sxs-lookup"><span data-stu-id="e742e-117">You should always instantiate a session token with a unique session ID.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="e742e-118">Session. SecurityTokenHandler. ReadToken zgłasza <xref:System.Xml.XmlException> wyjątek, jeśli otrzymuje nieprawidłowe dane wejściowe; na przykład, jeśli plik cookie zawierający token sesji jest uszkodzony.</span><span class="sxs-lookup"><span data-stu-id="e742e-118">Session.SecurityTokenHandler.ReadToken throws a <xref:System.Xml.XmlException> exception if it receives invalid input; for example, if the cookie that contains the session token is corrupted.</span></span> <span data-ttu-id="e742e-119">Zalecamy, aby przechwytywać ten wyjątek i zapewnić zachowanie specyficzne dla aplikacji.</span><span class="sxs-lookup"><span data-stu-id="e742e-119">We recommend that you catch this exception and provide application-specific behavior.</span></span>  
  
 <span data-ttu-id="e742e-120">Jeśli chroniona Strona sieci Web zawiera wiele zasobów (takich jak małe grafiki), które są również w domenie chronionej, klient musi ponownie uwierzytelnić się w jednostce uzależnionej, aby pobrać każdy z tych zasobów.</span><span class="sxs-lookup"><span data-stu-id="e742e-120">If a protected Web page contains lots of resources (such as small graphics) that are also in the protected domain, the client must re-authenticate itself to the relying party to download each of those resources.</span></span> <span data-ttu-id="e742e-121">Użycie tokenu uwierzytelniania sesji pozwala uniknąć konieczności uwierzytelniania do usługi STS dla każdego żądania, ale nadal oznacza, że wiele plików cookie jest wysyłanych za pośrednictwem.</span><span class="sxs-lookup"><span data-stu-id="e742e-121">Use of a session authentication token avoids the need to authenticate to the STS for each request, but it still means that many cookies are being sent over.</span></span> <span data-ttu-id="e742e-122">Można skonfigurować stronę sieci Web tak, aby ważne dane i zasoby były przechowywane w chronionej domenie, podczas gdy elementy pomocnicze są przechowywane w niechronionej domenie i połączone z główną stroną sieci Web.</span><span class="sxs-lookup"><span data-stu-id="e742e-122">You might want to set up the Web page so that the important data and resources are stored in the protected domain while minor items are stored in an unprotected domain and linked to from the main Web page.</span></span> <span data-ttu-id="e742e-123">Ponadto należy ustawić ścieżkę pliku cookie, aby odwoływała się tylko do chronionej domeny.</span><span class="sxs-lookup"><span data-stu-id="e742e-123">Also, set the cookie path to reference only the protected domain.</span></span>  
  
 <span data-ttu-id="e742e-124">Aby działać w trybie odwołania, firma Microsoft <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.SessionSecurityTokenCreated> zaleca dostarczenie obsługi zdarzenia w pliku **Global.asax.cs** i ustawienie właściwości IsReferenceMode <xref:System.IdentityModel.Services.SessionSecurityTokenCreatedEventArgs.SessionToken%2A> dla tokenu przesłanego we właściwości.</span><span class="sxs-lookup"><span data-stu-id="e742e-124">To operate in reference mode, Microsoft recommends providing a handler for the <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.SessionSecurityTokenCreated> event in the **global.asax.cs** file and setting the **IsReferenceMode** property on the token passed in the <xref:System.IdentityModel.Services.SessionSecurityTokenCreatedEventArgs.SessionToken%2A> property.</span></span> <span data-ttu-id="e742e-125">Te aktualizacje zapewniają, że token sesji działa w trybie odwołania dla każdego żądania i jest preferowany tylko przez ustawienie <xref:System.IdentityModel.Services.SessionAuthenticationModule.IsReferenceMode%2A> właściwości w module uwierzytelniania sesji.</span><span class="sxs-lookup"><span data-stu-id="e742e-125">These updates will ensure that the session token operates in reference mode for every request and is favored over merely setting the  <xref:System.IdentityModel.Services.SessionAuthenticationModule.IsReferenceMode%2A> property on the Session Authentication Module.</span></span>  
  
## <a name="extensibility"></a><span data-ttu-id="e742e-126">Rozszerzalność</span><span class="sxs-lookup"><span data-stu-id="e742e-126">Extensibility</span></span>  
 <span data-ttu-id="e742e-127">Można zwiększyć mechanizm zarządzania sesją.</span><span class="sxs-lookup"><span data-stu-id="e742e-127">You can extend the session management mechanism.</span></span> <span data-ttu-id="e742e-128">Jedną z przyczyn tego problemu jest poprawa wydajności.</span><span class="sxs-lookup"><span data-stu-id="e742e-128">One reason for this would be to improve the performance.</span></span> <span data-ttu-id="e742e-129">Można na przykład utworzyć niestandardową obsługę plików cookie, która przekształca lub optymalizuje token zabezpieczeń sesji między jego stanem w pamięci i co prowadzi do pliku cookie.</span><span class="sxs-lookup"><span data-stu-id="e742e-129">For example, you could create a custom cookie handler that transforms or optimizes the session security token between its in-memory state and what goes into the cookie.</span></span> <span data-ttu-id="e742e-130">W tym celu można skonfigurować <xref:System.IdentityModel.Services.SessionAuthenticationModule.CookieHandler%2A?displayProperty=nameWithType> Właściwość <xref:System.IdentityModel.Services.SessionAuthenticationModule?displayProperty=nameWithType> do używania niestandardowego programu obsługi plików cookie, który pochodzi od <xref:System.IdentityModel.Services.CookieHandler?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="e742e-130">To do so, you can configure the <xref:System.IdentityModel.Services.SessionAuthenticationModule.CookieHandler%2A?displayProperty=nameWithType> property of the <xref:System.IdentityModel.Services.SessionAuthenticationModule?displayProperty=nameWithType> to use a custom cookie handler that derives from <xref:System.IdentityModel.Services.CookieHandler?displayProperty=nameWithType>.</span></span> <span data-ttu-id="e742e-131"><xref:System.IdentityModel.Services.ChunkedCookieHandler?displayProperty=nameWithType>jest domyślnym programem obsługi plików cookie, ponieważ pliki cookie przekraczają dozwolony rozmiar protokołu HTTP (Hypertext Transfer Protocol); Jeśli zamiast tego używasz niestandardowej obsługi plików cookie, musisz zaimplementować dzielenie.</span><span class="sxs-lookup"><span data-stu-id="e742e-131"><xref:System.IdentityModel.Services.ChunkedCookieHandler?displayProperty=nameWithType> is the default cookie handler because the cookies exceed the allowable size for Hypertext Transfer Protocol (HTTP); if you use a custom cookie handler instead, you must implement chunking.</span></span>  
  
 <span data-ttu-id="e742e-132">Aby uzyskać więcej informacji, zobacz przykład [ClaimsAwareWebFarm](https://go.microsoft.com/fwlink/?LinkID=248408) .</span><span class="sxs-lookup"><span data-stu-id="e742e-132">For more information, see [ClaimsAwareWebFarm](https://go.microsoft.com/fwlink/?LinkID=248408) sample.</span></span> <span data-ttu-id="e742e-133">Ten przykład pokazuje pamięć podręczną sesji w farmie (w przeciwieństwie do tokenreplycache), tak aby można było używać sesji przez odwołanie zamiast wymieniać duże pliki cookie; Ten przykład pokazuje również łatwiejszy sposób zabezpieczania plików cookie w farmie.</span><span class="sxs-lookup"><span data-stu-id="e742e-133">This sample shows a farm ready session cache (as opposed to a tokenreplycache) so that you can use sessions by reference instead of exchanging big cookies; this sample also demonstrates an easier way of securing cookies in a farm.</span></span> <span data-ttu-id="e742e-134">Pamięć podręczna sesji jest oparta na technologii WCF.</span><span class="sxs-lookup"><span data-stu-id="e742e-134">The session cache is WCF-based.</span></span> <span data-ttu-id="e742e-135">W odniesieniu do zabezpieczania sesji przykład ilustruje nową funkcję w WIF 4,5 przekształcenia plików cookie w oparciu o MachineKey, który można aktywować, po prostu wklejając odpowiedni fragment kodu w pliku Web. config. Sam przykład nie jest "w farmie", ale pokazuje, co jest potrzebne do przygotowania farmy aplikacji.</span><span class="sxs-lookup"><span data-stu-id="e742e-135">With regard to session securing, the sample demonstrates a new capability in WIF 4.5 of a cookie transform based on MachineKey, which can be activated by simply pasting the appropriate snippet in the web.config. The sample itself is not "farmed", but it demonstrates what you need for making your app farm-ready.</span></span>
