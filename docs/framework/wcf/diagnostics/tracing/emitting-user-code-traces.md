---
title: Emitowanie danych śledzenia elementu User-Code
ms.date: 03/30/2017
ms.assetid: fa54186a-8ffa-4332-b0e7-63867126fd49
ms.openlocfilehash: e8b2031165a83e24ba15a2fcf847a170f47e696a
ms.sourcegitcommit: cdb295dd1db589ce5169ac9ff096f01fd0c2da9d
ms.translationtype: MT
ms.contentlocale: pl-PL
ms.lasthandoff: 06/09/2020
ms.locfileid: "84589295"
---
# <a name="emitting-user-code-traces"></a><span data-ttu-id="7e489-102">Emitowanie danych śledzenia elementu User-Code</span><span class="sxs-lookup"><span data-stu-id="7e489-102">Emitting User-Code Traces</span></span>

<span data-ttu-id="7e489-103">Oprócz włączania śledzenia w konfiguracji w celu zbierania danych Instrumentacji generowanych przez Windows Communication Foundation (WCF), można również emitować dane śledzenia programowo w kodzie użytkownika.</span><span class="sxs-lookup"><span data-stu-id="7e489-103">In addition to enabling tracing in configuration to collect instrumentation data generated by Windows Communication Foundation (WCF), you can also emit traces programmatically in user code.</span></span> <span data-ttu-id="7e489-104">W ten sposób można aktywnie tworzyć dane instrumentacji, które można zapoznania później do celów diagnostycznych.</span><span class="sxs-lookup"><span data-stu-id="7e489-104">In this way, you can proactively create instrumentation data that you can peruse later for diagnostic purpose.</span></span> <span data-ttu-id="7e489-105">W tym temacie omówiono, jak to zrobić.</span><span class="sxs-lookup"><span data-stu-id="7e489-105">This topic discusses how you can do this.</span></span>

<span data-ttu-id="7e489-106">Ponadto [rozszerzanie](../../samples/extending-tracing.md) przykładu śledzenia obejmuje cały kod zademonstrowany w poniższych sekcjach.</span><span class="sxs-lookup"><span data-stu-id="7e489-106">In addition, the [Extending Tracing](../../samples/extending-tracing.md) sample includes all the code demonstrated in the following sections.</span></span>

## <a name="creating-a-trace-source"></a><span data-ttu-id="7e489-107">Tworzenie źródła śledzenia</span><span class="sxs-lookup"><span data-stu-id="7e489-107">Creating a Trace Source</span></span>

<span data-ttu-id="7e489-108">Możesz użyć poniższego kodu, aby utworzyć źródło śledzenia użytkownika.</span><span class="sxs-lookup"><span data-stu-id="7e489-108">You can use the following code to create a user trace source.</span></span>

```csharp
TraceSource ts = new TraceSource("myUserTraceSource");
```

## <a name="creating-activities"></a><span data-ttu-id="7e489-109">Tworzenie działań</span><span class="sxs-lookup"><span data-stu-id="7e489-109">Creating Activities</span></span>

<span data-ttu-id="7e489-110">Działania są logiczną jednostką przetwarzania.</span><span class="sxs-lookup"><span data-stu-id="7e489-110">Activities are logical unit of processing.</span></span> <span data-ttu-id="7e489-111">Można utworzyć jedno działanie dla każdej głównej jednostki przetwarzania, w której mają być zgrupowane dane śledzenia.</span><span class="sxs-lookup"><span data-stu-id="7e489-111">You can create one activity for each major processing unit in which you want traces to be grouped together.</span></span> <span data-ttu-id="7e489-112">Na przykład można utworzyć jedno działanie dla każdego żądania do usługi.</span><span class="sxs-lookup"><span data-stu-id="7e489-112">For example, you can create one activity for each request to the service.</span></span> <span data-ttu-id="7e489-113">Aby to zrobić, wykonaj następujące czynności.</span><span class="sxs-lookup"><span data-stu-id="7e489-113">To do so, perform the following steps.</span></span>

1. <span data-ttu-id="7e489-114">Zapisz identyfikator działania w zakresie.</span><span class="sxs-lookup"><span data-stu-id="7e489-114">Save the activity ID in scope.</span></span>

2. <span data-ttu-id="7e489-115">Utwórz nowy identyfikator działania.</span><span class="sxs-lookup"><span data-stu-id="7e489-115">Create a new activity ID.</span></span>

3. <span data-ttu-id="7e489-116">Przenieś z działania w zakresie do nowego, Ustaw nowe działanie w zakresie i Emituj śledzenie uruchamiania dla tego działania.</span><span class="sxs-lookup"><span data-stu-id="7e489-116">Transfer from the activity in scope to the new one, set the new activity in scope and emit a start trace for that activity.</span></span>

<span data-ttu-id="7e489-117">Poniższy kod demonstruje, jak to zrobić.</span><span class="sxs-lookup"><span data-stu-id="7e489-117">The following code demonstrates how to do this.</span></span>

```csharp
Guid oldID = Trace.CorrelationManager.ActivityId;
Guid traceID = Guid.NewGuid();
ts.TraceTransfer(0, "transfer", traceID);
Trace.CorrelationManager.ActivityId = traceID; // Trace is static
ts.TraceEvent(TraceEventType.Start, 0, "Add request");
```

## <a name="emitting-traces-within-a-user-activity"></a><span data-ttu-id="7e489-118">Emitowanie śladów w działaniu użytkownika</span><span class="sxs-lookup"><span data-stu-id="7e489-118">Emitting Traces within a User Activity</span></span>

<span data-ttu-id="7e489-119">Poniższy kod emituje ślady w działaniu użytkownika.</span><span class="sxs-lookup"><span data-stu-id="7e489-119">The following code emits traces within a user activity.</span></span>

```csharp
double value1 = 100.00D;
double value2 = 15.99D;
ts.TraceInformation("Client sends message to Add " + value1 + ", " + value2);
double result = client.Add(value1, value2);
ts.TraceInformation("Client receives Add response '" + result + "'");
```

## <a name="stopping-the-activities"></a><span data-ttu-id="7e489-120">Zatrzymywanie działań</span><span class="sxs-lookup"><span data-stu-id="7e489-120">Stopping the Activities</span></span>

<span data-ttu-id="7e489-121">Aby zatrzymać działania, prześlij ponownie do starego działania, Zatrzymaj bieżący identyfikator działania i zresetuj stary identyfikator działania w zakresie.</span><span class="sxs-lookup"><span data-stu-id="7e489-121">To stop the activities, transfer back to the old activity, stop the current activity id, and reset the old activity id in scope.</span></span>

<span data-ttu-id="7e489-122">Poniższy kod demonstruje, jak to zrobić.</span><span class="sxs-lookup"><span data-stu-id="7e489-122">The following code demonstrates how to do this.</span></span>

```csharp
ts.TraceTransfer(0, "transfer", oldID);
ts.TraceEvent(TraceEventType.Stop, 0, "Add request");
Trace.CorrelationManager.ActivityId = oldID;
```

## <a name="propagating-the-activity-id-to-a-service"></a><span data-ttu-id="7e489-123">Propagowanie identyfikatora działania do usługi</span><span class="sxs-lookup"><span data-stu-id="7e489-123">Propagating the Activity ID to A Service</span></span>

<span data-ttu-id="7e489-124">Jeśli ustawisz `propagateActivity` atrybut na `true` dla `System.ServiceModel` źródła śledzenia zarówno w pliku konfiguracji klienta, jak i usługi, przetwarzanie usługi dla żądania Add będzie odbywać się w tym samym działaniu jak w przypadku tego, co zostało zdefiniowane w kliencie.</span><span class="sxs-lookup"><span data-stu-id="7e489-124">If you set the `propagateActivity` attribute to `true` for the `System.ServiceModel` trace source in both the client and service configuration files, the service processing for the Add request occurs in the same activity as the one defined in the client.</span></span> <span data-ttu-id="7e489-125">Jeśli usługa definiuje własne działania i transfery, ślady usług nie są wyświetlane w działaniu propagowanym przez klienta.</span><span class="sxs-lookup"><span data-stu-id="7e489-125">If the service defines its own activities and transfers, the service traces do not appear in the client-propagated activity.</span></span> <span data-ttu-id="7e489-126">Zamiast tego pojawiają się one w działaniu skorelowanym przez dane śledzenia przeniesienia do działania, którego identyfikator jest propagowany przez klienta.</span><span class="sxs-lookup"><span data-stu-id="7e489-126">Instead, they appear in an activity correlated by transfer traces to the activity whose ID is propagated by the client.</span></span>

> [!NOTE]
> <span data-ttu-id="7e489-127">Jeśli `propagateActivity` atrybut jest ustawiony na `true` zarówno dla klienta, jak i usługi, działanie otoczenia w zakresie operacji usługi jest ustawiane przez funkcję WCF.</span><span class="sxs-lookup"><span data-stu-id="7e489-127">If the `propagateActivity` attribute is set to `true` on both the client and service, the ambient activity in the operation scope of the service is set by WCF.</span></span>

<span data-ttu-id="7e489-128">Można użyć poniższego kodu, aby sprawdzić, czy działanie zostało ustawione w zakresie przez WCF.</span><span class="sxs-lookup"><span data-stu-id="7e489-128">You can use the following code to check whether an activity was set in scope by WCF.</span></span>

```csharp
// Check if an activity was set in scope by WCF, if it was
// propagated from the client. If not, ( ambient activity is
// equal to Guid.Empty), create a new one.
if(Trace.CorrelationManager.ActivityId == Guid.Empty)
{
    Guid newGuid = Guid.NewGuid();
    Trace.CorrelationManager.ActivityId = newGuid;
}
// Emit your Start trace.
ts.TraceEvent(TraceEventType.Start, 0, "Add Activity");

// Emit the processing traces for that request.
serviceTs.TraceInformation("Service receives Add "
                            + n1 + ", " + n2);
// double result = n1 + n2;
serviceTs.TraceInformation("Service sends Add result" + result);

// Emit the Stop trace and exit the method scope.
ts.TraceEvent(TraceEventType.Stop, 0, "Add Activity");
// return result;
```

## <a name="tracing-exceptions-thrown-in-code"></a><span data-ttu-id="7e489-129">Śledzenie wyjątków zgłoszonych w kodzie</span><span class="sxs-lookup"><span data-stu-id="7e489-129">Tracing Exceptions Thrown in Code</span></span>

<span data-ttu-id="7e489-130">Gdy zgłaszasz wyjątek w kodzie, możesz również śledzić wyjątek na poziomie ostrzeżenia lub przy użyciu następującego kodu.</span><span class="sxs-lookup"><span data-stu-id="7e489-130">When you throw an exception in code, you can also trace the exception at Warning level or up using the following code.</span></span>

```csharp
ts.TraceEvent(TraceEventType.Warning, 0, "Throwing exception " + "exceptionMessage");
```

## <a name="viewing-user-traces-in-the-service-trace-viewer-tool"></a><span data-ttu-id="7e489-131">Wyświetlanie śladów użytkowników w narzędziu Podgląd śledzenia usługi</span><span class="sxs-lookup"><span data-stu-id="7e489-131">Viewing User Traces in the Service Trace Viewer Tool</span></span>

<span data-ttu-id="7e489-132">Ta sekcja zawiera zrzuty ekranu śledzenia wygenerowane przez uruchomienie przykładowego [śledzenia](../../samples/extending-tracing.md) , gdy jest wyświetlany za pomocą [narzędzia Podgląd śledzenia usług (SvcTraceViewer. exe)](../../service-trace-viewer-tool-svctraceviewer-exe.md).</span><span class="sxs-lookup"><span data-stu-id="7e489-132">This section contains screenshots of traces generated by running the [Extending Tracing](../../samples/extending-tracing.md) sample, when viewed using the [Service Trace Viewer Tool (SvcTraceViewer.exe)](../../service-trace-viewer-tool-svctraceviewer-exe.md).</span></span>

<span data-ttu-id="7e489-133">Na poniższym diagramie jest zaznaczone działanie "Dodaj żądanie" utworzone wcześniej w panelu po lewej stronie.</span><span class="sxs-lookup"><span data-stu-id="7e489-133">In the following diagram, the "Add request" activity created previously is selected on the left panel.</span></span> <span data-ttu-id="7e489-134">Jest on wyświetlany na trzy inne działania operacji matematycznych (dzielenie, odejmowanie, mnożenie) stanowiące program klienta aplikacji.</span><span class="sxs-lookup"><span data-stu-id="7e489-134">It is listed with three other Math operation activities (Divide, Subtract, Multiply) that constitute the application client program.</span></span> <span data-ttu-id="7e489-135">Kod użytkownika definiuje jedno nowe działanie dla każdej operacji, aby odizolować potencjalne wystąpienia błędów w różnych żądaniach.</span><span class="sxs-lookup"><span data-stu-id="7e489-135">The user code has defined one new activity for each operation to isolate potential error occurrences in different requests.</span></span>

<span data-ttu-id="7e489-136">Aby zademonstrować użycie transferów w przykładzie [Rozszerzanie śledzenia](../../samples/extending-tracing.md) , tworzone jest również działanie kalkulatora, które hermetyzuje cztery żądania operacji.</span><span class="sxs-lookup"><span data-stu-id="7e489-136">To demonstrate the use of transfers in the [Extending Tracing](../../samples/extending-tracing.md) sample, a Calculator activity that encapsulates the four operation requests is also created.</span></span> <span data-ttu-id="7e489-137">Dla każdego żądania istnieje transfer z powrotem i z działania kalkulatora do działania żądania (Trace jest wyróżniony w prawym górnym panelu na rysunku).</span><span class="sxs-lookup"><span data-stu-id="7e489-137">For each request, there is a transfer back and forth from the Calculator activity to the request activity (trace is highlighted in the upper right panel in the figure).</span></span>

<span data-ttu-id="7e489-138">Po wybraniu działania w lewym panelu ślady zawarte w tym działaniu są wyświetlane w prawym górnym panelu.</span><span class="sxs-lookup"><span data-stu-id="7e489-138">When you select an activity on the left panel, the traces included by this activity are shown on the upper right panel.</span></span> <span data-ttu-id="7e489-139">Jeśli `propagateActivity` jest w `true` każdym punkcie końcowym w ścieżce żądania, ślady w działaniu żądania pochodzą ze wszystkich procesów, które uczestniczą w żądaniu.</span><span class="sxs-lookup"><span data-stu-id="7e489-139">If `propagateActivity` is `true` at every endpoint in the request path, traces in the request activity are from all processes that participate in the request.</span></span> <span data-ttu-id="7e489-140">W tym przykładzie można zobaczyć ślady zarówno klienta, jak i usługi w czwartej kolumnie panelu.</span><span class="sxs-lookup"><span data-stu-id="7e489-140">In this example, you can see traces from both the client and service in the 4th column in the panel.</span></span>

<span data-ttu-id="7e489-141">To działanie pokazuje następującą kolejność przetwarzania:</span><span class="sxs-lookup"><span data-stu-id="7e489-141">This activity shows the following order of processing:</span></span>

1. <span data-ttu-id="7e489-142">Klient wysyła komunikat do dodania.</span><span class="sxs-lookup"><span data-stu-id="7e489-142">Client sends message to Add.</span></span>

2. <span data-ttu-id="7e489-143">Usługa otrzymuje komunikat żądania dodania.</span><span class="sxs-lookup"><span data-stu-id="7e489-143">Service receives Add request message.</span></span>

3. <span data-ttu-id="7e489-144">Usługa wysyła odpowiedź na dodanie.</span><span class="sxs-lookup"><span data-stu-id="7e489-144">Service sends Add response.</span></span>

4. <span data-ttu-id="7e489-145">Klient otrzymuje odpowiedź na dodanie.</span><span class="sxs-lookup"><span data-stu-id="7e489-145">Client receives Add response.</span></span>

<span data-ttu-id="7e489-146">Wszystkie te ślady zostały emitowane na poziomie informacji.</span><span class="sxs-lookup"><span data-stu-id="7e489-146">All these traces were emitted at Information level.</span></span> <span data-ttu-id="7e489-147">Kliknięcie śladu w prawym górnym okienku powoduje wyświetlenie szczegółów tego śladu w prawym dolnym panelu.</span><span class="sxs-lookup"><span data-stu-id="7e489-147">Clicking a trace in the upper-right panel shows the details of that trace in the lower-right panel.</span></span>

<span data-ttu-id="7e489-148">Na poniższym diagramie przedstawiono również dane śledzenia transferu z i do działania kalkulatora, a także dwie pary uruchamiania i zatrzymywania śledzenia na żądanie, jeden dla klienta i jeden dla usługi (po jednym dla każdego źródła śledzenia).</span><span class="sxs-lookup"><span data-stu-id="7e489-148">In the following diagram, we also see transfer traces from and to the Calculator activity, as well as two pairs of Start and Stop traces per request activity, one for the client and one for the service (one for each trace source).</span></span>

<span data-ttu-id="7e489-149">![Podgląd śledzenia: emitowanie śladów kodu&#45;użytkownika](media/242c9358-475a-4baf-83f3-4227aa942fcd.gif "242c9358-475a-4baf-83f3-4227aa942fcd") Lista działań według czasu utworzenia (lewy panel) i ich działań zagnieżdżonych (Panel w prawym górnym rogu)</span><span class="sxs-lookup"><span data-stu-id="7e489-149">![Trace Viewer: Emitting User&#45;code traces](media/242c9358-475a-4baf-83f3-4227aa942fcd.gif "242c9358-475a-4baf-83f3-4227aa942fcd") List of activities by creation time (left panel) and their nested activities (upper-right panel)</span></span>

<span data-ttu-id="7e489-150">Jeśli kod usługi zgłasza wyjątek, który powoduje, że klient może zgłosić się również (na przykład gdy klient nie otrzymał odpowiedzi na żądanie), zarówno ostrzeżenie usługi, jak i komunikaty o błędach są wykonywane w tym samym działaniu dla bezpośredniej korelacji.</span><span class="sxs-lookup"><span data-stu-id="7e489-150">If the service code throws an exception that causes the client to throw as well (for example, when the client did not get the response to its request), both the service and client warning or error messages occur in the same activity for direct correlation.</span></span> <span data-ttu-id="7e489-151">Na poniższej ilustracji usługa zgłasza wyjątek informujący o tym, że usługa odmówi, aby przetworzyć to żądanie w kodzie użytkownika ".</span><span class="sxs-lookup"><span data-stu-id="7e489-151">In the following image, the service throws an exception that states "The service refuses to process this request in user code."</span></span> <span data-ttu-id="7e489-152">Klient zgłasza również wyjątek informujący o tym, że serwer nie może przetworzyć żądania z powodu błędu wewnętrznego. "</span><span class="sxs-lookup"><span data-stu-id="7e489-152">The client also throws an exception that states "The server was unable to process the request due to an internal error."</span></span>

<span data-ttu-id="7e489-153">Poniższe obrazy pokazują, że błędy między punktami końcowymi danego żądania pojawiają się w tym samym działaniu, jeśli identyfikator działania żądania został rozpropagowany:</span><span class="sxs-lookup"><span data-stu-id="7e489-153">The following images shows that errors across endpoints for a given request appear in the same activity if the request activity id was propagated:</span></span>

![Zrzut ekranu pokazujący błędy w punktach końcowych dla danego żądania.](./media/emitting-user-code-traces/trace-viewer-endpoint-errors.gif)

<span data-ttu-id="7e489-155">Dwukrotne kliknięcie w lewym panelu działania operacji pomnóż powoduje wyświetlenie poniższego wykresu z śladami działania pomnożenie dla każdego procesu.</span><span class="sxs-lookup"><span data-stu-id="7e489-155">Double-clicking the Multiply activity on the left panel shows the following graph, with the traces for the Multiply activity for each process involved.</span></span> <span data-ttu-id="7e489-156">Zobaczysz ostrzeżenie podczas pierwszego wystąpienia usługi (zgłoszono wyjątek), po którym następuje ostrzeżenia i błędy na kliencie, ponieważ nie można przetworzyć żądania.</span><span class="sxs-lookup"><span data-stu-id="7e489-156">We can see a warning first occurred at the service (exception thrown), which is followed by warnings and errors on the client because the request could not be processed.</span></span> <span data-ttu-id="7e489-157">W związku z tym możemy oznaczać relację błędu przyczynowego między punktami końcowymi i utworzyć główną przyczynę błędu.</span><span class="sxs-lookup"><span data-stu-id="7e489-157">Therefore, we can imply the causal error relationship between endpoints and derive the root cause of the error.</span></span>

<span data-ttu-id="7e489-158">Na poniższej ilustracji przedstawiono widok wykresu korelacji błędów:</span><span class="sxs-lookup"><span data-stu-id="7e489-158">The following image shows a graph view of error correlation:</span></span>

![Zrzut ekranu pokazujący widok wykresu korelacji błędów.](./media/emitting-user-code-traces/trace-viewer-error-correlation.gif)

<span data-ttu-id="7e489-160">Aby uzyskać poprzednie dane śledzenia, należy ustawić `ActivityTracing` dla źródeł śledzenia użytkownika i `propagateActivity=true` dla `System.ServiceModel` źródła śledzenia.</span><span class="sxs-lookup"><span data-stu-id="7e489-160">To obtain the previous traces, we set `ActivityTracing` for the user trace sources and `propagateActivity=true` for the `System.ServiceModel` trace source.</span></span> <span data-ttu-id="7e489-161">Nie ustawiono `ActivityTracing` `System.ServiceModel` źródła śledzenia, aby umożliwić propagację działania kodu użytkownika na kod użytkownika.</span><span class="sxs-lookup"><span data-stu-id="7e489-161">We did not set `ActivityTracing` for the `System.ServiceModel` trace source to enable user code to user code activity propagation.</span></span> <span data-ttu-id="7e489-162">(Gdy śledzenie aktywności ServiceModel jest włączone, identyfikator działania zdefiniowany w kliencie nie jest propagowany do kodu użytkownika usługi; Transfery są jednak skorelowane z działaniami kodu użytkownika klienta i usługi do pośrednich działań WCF.</span><span class="sxs-lookup"><span data-stu-id="7e489-162">(When ServiceModel activity tracing is on, the activity ID defined in the client is not propagated all the way to the service user code; Transfers, however, correlate the client and service user code activities to the intermediate WCF activities.)</span></span>

<span data-ttu-id="7e489-163">Definiowanie działań i propagowanie identyfikatora działania umożliwia nam wykonywanie bezpośrednich korelacji błędów w punktach końcowych.</span><span class="sxs-lookup"><span data-stu-id="7e489-163">Defining activities and propagating the activity ID enables us to perform direct error correlation across endpoints.</span></span> <span data-ttu-id="7e489-164">Dzięki temu możemy szybciej zlokalizować główną przyczynę błędu.</span><span class="sxs-lookup"><span data-stu-id="7e489-164">In this way, we can locate the root cause of an error more quickly.</span></span>

## <a name="see-also"></a><span data-ttu-id="7e489-165">Zobacz też</span><span class="sxs-lookup"><span data-stu-id="7e489-165">See also</span></span>

- [<span data-ttu-id="7e489-166">Rozszerzanie śledzenia</span><span class="sxs-lookup"><span data-stu-id="7e489-166">Extending Tracing</span></span>](../../samples/extending-tracing.md)
