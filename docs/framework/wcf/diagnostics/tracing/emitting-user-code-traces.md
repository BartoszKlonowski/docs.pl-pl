---
title: Emitowanie danych śledzenia elementu User-Code
ms.date: 03/30/2017
ms.assetid: fa54186a-8ffa-4332-b0e7-63867126fd49
ms.openlocfilehash: 93da2eb74705a0581923d0317315e628f374be3e
ms.sourcegitcommit: 9b552addadfb57fab0b9e7852ed4f1f1b8a42f8e
ms.translationtype: MT
ms.contentlocale: pl-PL
ms.lasthandoff: 04/23/2019
ms.locfileid: "61998136"
---
# <a name="emitting-user-code-traces"></a><span data-ttu-id="02ac8-102">Emitowanie danych śledzenia elementu User-Code</span><span class="sxs-lookup"><span data-stu-id="02ac8-102">Emitting User-Code Traces</span></span>

<span data-ttu-id="02ac8-103">Oprócz włączenia śledzenia w konfiguracji, aby zebrać dane Instrumentacji wygenerowane przez Windows Communication Foundation (WCF), można również wysyłać ślady programowo w kodzie użytkownika.</span><span class="sxs-lookup"><span data-stu-id="02ac8-103">In addition to enabling tracing in configuration to collect instrumentation data generated by Windows Communication Foundation (WCF), you can also emit traces programmatically in user code.</span></span> <span data-ttu-id="02ac8-104">W ten sposób można utworzyć z wyprzedzeniem danych instrumentacji, które można przejrzeć w dalszej części w celu diagnostyki.</span><span class="sxs-lookup"><span data-stu-id="02ac8-104">In this way, you can proactively create instrumentation data that you can peruse later for diagnostic purpose.</span></span> <span data-ttu-id="02ac8-105">W tym temacie omówiono, jak to zrobić.</span><span class="sxs-lookup"><span data-stu-id="02ac8-105">This topic discusses how you can do this.</span></span>

<span data-ttu-id="02ac8-106">Ponadto [rozszerzanie śledzenia](../../../../../docs/framework/wcf/samples/extending-tracing.md) przykład obejmuje cały kod, przedstawione w poniższych sekcjach.</span><span class="sxs-lookup"><span data-stu-id="02ac8-106">In addition, the [Extending Tracing](../../../../../docs/framework/wcf/samples/extending-tracing.md) sample includes all the code demonstrated in the following sections.</span></span>

## <a name="creating-a-trace-source"></a><span data-ttu-id="02ac8-107">Tworzenie źródła śledzenia</span><span class="sxs-lookup"><span data-stu-id="02ac8-107">Creating a Trace Source</span></span>

<span data-ttu-id="02ac8-108">Poniższy kod służy do utworzenia źródła śledzenia użytkowników.</span><span class="sxs-lookup"><span data-stu-id="02ac8-108">You can use the following code to create a user trace source.</span></span>

```csharp
TraceSource ts = new TraceSource("myUserTraceSource");
```

## <a name="creating-activities"></a><span data-ttu-id="02ac8-109">Tworzenie działań</span><span class="sxs-lookup"><span data-stu-id="02ac8-109">Creating Activities</span></span>

<span data-ttu-id="02ac8-110">Działania to jednostka logiczna przetwarzania.</span><span class="sxs-lookup"><span data-stu-id="02ac8-110">Activities are logical unit of processing.</span></span> <span data-ttu-id="02ac8-111">Możesz utworzyć jedno działanie, dla każdej jednostki główne przetwarzania, w którym chcesz śladów, aby być zgrupowane razem.</span><span class="sxs-lookup"><span data-stu-id="02ac8-111">You can create one activity for each major processing unit in which you want traces to be grouped together.</span></span> <span data-ttu-id="02ac8-112">Na przykład można utworzyć jedno działanie dla każdego żądania do usługi.</span><span class="sxs-lookup"><span data-stu-id="02ac8-112">For example, you can create one activity for each request to the service.</span></span> <span data-ttu-id="02ac8-113">Aby to zrobić, wykonaj następujące czynności.</span><span class="sxs-lookup"><span data-stu-id="02ac8-113">To do so, perform the following steps.</span></span>

1. <span data-ttu-id="02ac8-114">Zapisz identyfikator działania w zakresie.</span><span class="sxs-lookup"><span data-stu-id="02ac8-114">Save the activity ID in scope.</span></span>

2. <span data-ttu-id="02ac8-115">Utwórz nowy identyfikator działania.</span><span class="sxs-lookup"><span data-stu-id="02ac8-115">Create a new activity ID.</span></span>

3. <span data-ttu-id="02ac8-116">Transfer z działania w zakresie na nową, Ustaw nowe działanie w zakresie i emitować Rozpocznij śledzenie dla tego działania.</span><span class="sxs-lookup"><span data-stu-id="02ac8-116">Transfer from the activity in scope to the new one, set the new activity in scope and emit a start trace for that activity.</span></span>

<span data-ttu-id="02ac8-117">Poniższy kod pokazuje, jak to zrobić.</span><span class="sxs-lookup"><span data-stu-id="02ac8-117">The following code demonstrates how to do this.</span></span>

```csharp
Guid oldID = Trace.CorrelationManager.ActivityId;
Guid traceID = Guid.NewGuid();
ts.TraceTransfer(0, "transfer", traceID);
Trace.CorrelationManager.ActivityId = traceID; // Trace is static
ts.TraceEvent(TraceEventType.Start, 0, "Add request");
```

## <a name="emitting-traces-within-a-user-activity"></a><span data-ttu-id="02ac8-118">Emitowanie danych śledzenia w aktywność użytkownika</span><span class="sxs-lookup"><span data-stu-id="02ac8-118">Emitting Traces within a User Activity</span></span>

<span data-ttu-id="02ac8-119">Poniższy kod generuje ślady wewnątrz działania użytkownika.</span><span class="sxs-lookup"><span data-stu-id="02ac8-119">The following code emits traces within a user activity.</span></span>

```csharp
double value1 = 100.00D;
double value2 = 15.99D;
ts.TraceInformation("Client sends message to Add " + value1 + ", " + value2);
double result = client.Add(value1, value2);
ts.TraceInformation("Client receives Add response '" + result + "'");
```

## <a name="stopping-the-activities"></a><span data-ttu-id="02ac8-120">Zatrzymywanie działania</span><span class="sxs-lookup"><span data-stu-id="02ac8-120">Stopping the Activities</span></span>

<span data-ttu-id="02ac8-121">Aby zatrzymać działania, transfer powrót do starych działań, Zatrzymaj bieżący identyfikator działania i zresetować stary identyfikator działania w zakresie.</span><span class="sxs-lookup"><span data-stu-id="02ac8-121">To stop the activities, transfer back to the old activity, stop the current activity id, and reset the old activity id in scope.</span></span>

<span data-ttu-id="02ac8-122">Poniższy kod pokazuje, jak to zrobić.</span><span class="sxs-lookup"><span data-stu-id="02ac8-122">The following code demonstrates how to do this.</span></span>

```csharp
ts.TraceTransfer(0, "transfer", oldID);
ts.TraceEvent(TraceEventType.Stop, 0, "Add request");
Trace.CorrelationManager.ActivityId = oldID;
```

## <a name="propagating-the-activity-id-to-a-service"></a><span data-ttu-id="02ac8-123">Propagowanie identyfikator działania usługi</span><span class="sxs-lookup"><span data-stu-id="02ac8-123">Propagating the Activity ID to A Service</span></span>

<span data-ttu-id="02ac8-124">Jeśli ustawisz `propagateActivity` atrybutu `true` dla `System.ServiceModel` plików źródła śledzenia w konfiguracji klienta i usługi, usługi przetwarzania dla żądania Dodaj odbywa się w tym samym działaniu, jak ten zdefiniowany w obiekcie klienta.</span><span class="sxs-lookup"><span data-stu-id="02ac8-124">If you set the `propagateActivity` attribute to `true` for the `System.ServiceModel` trace source in both the client and service configuration files, the service processing for the Add request occurs in the same activity as the one defined in the client.</span></span> <span data-ttu-id="02ac8-125">Jeśli usługa definiuje własne działania i transferu danych śledzenia usługi nie są wyświetlane w działaniu propagowane przez klienta.</span><span class="sxs-lookup"><span data-stu-id="02ac8-125">If the service defines its own activities and transfers, the service traces do not appear in the client-propagated activity.</span></span> <span data-ttu-id="02ac8-126">Zamiast tego są wyświetlane w działaniu Skorelowane przez ślady transferu do działania, których identyfikator jest propagowany przez klienta.</span><span class="sxs-lookup"><span data-stu-id="02ac8-126">Instead, they appear in an activity correlated by transfer traces to the activity whose ID is propagated by the client.</span></span>

> [!NOTE]
> <span data-ttu-id="02ac8-127">Jeśli `propagateActivity` ma ustawioną wartość atrybutu `true` na klienta i usługi, działania otoczenia w zakresie operacji usługi jest ustawiana przez architekturę WCF.</span><span class="sxs-lookup"><span data-stu-id="02ac8-127">If the `propagateActivity` attribute is set to `true` on both the client and service, the ambient activity in the operation scope of the service is set by WCF.</span></span>

<span data-ttu-id="02ac8-128">Poniższy kod służy do sprawdzenia, czy działanie zostało ustawione w zakresie przez architekturę WCF.</span><span class="sxs-lookup"><span data-stu-id="02ac8-128">You can use the following code to check whether an activity was set in scope by WCF.</span></span>

```csharp
// Check if an activity was set in scope by WCF, if it was
// propagated from the client. If not, ( ambient activity is
// equal to Guid.Empty), create a new one.
if(Trace.CorrelationManager.ActivityId == Guid.Empty)
{
    Guid newGuid = Guid.NewGuid();
    Trace.CorrelationManager.ActivityId = newGuid;
}
// Emit your Start trace.
ts.TraceEvent(TraceEventType.Start, 0, "Add Activity");

// Emit the processing traces for that request.
serviceTs.TraceInformation("Service receives Add "
                            + n1 + ", " + n2);
// double result = n1 + n2;
serviceTs.TraceInformation("Service sends Add result" + result);

// Emit the Stop trace and exit the method scope.
ts.TraceEvent(TraceEventType.Stop, 0, "Add Activity");
// return result;
```

## <a name="tracing-exceptions-thrown-in-code"></a><span data-ttu-id="02ac8-129">Śledzenie wyjątków zgłoszonych w kodzie</span><span class="sxs-lookup"><span data-stu-id="02ac8-129">Tracing Exceptions Thrown in Code</span></span>

<span data-ttu-id="02ac8-130">Gdy zgłoszenie wyjątku w kodzie, można również śledzenia wyjątków na poziomie ostrzeżenia lub przy użyciu następującego kodu.</span><span class="sxs-lookup"><span data-stu-id="02ac8-130">When you throw an exception in code, you can also trace the exception at Warning level or up using the following code.</span></span>

```csharp
ts.TraceEvent(TraceEventType.Warning, 0, "Throwing exception " + "exceptionMessage");
```

## <a name="viewing-user-traces-in-the-service-trace-viewer-tool"></a><span data-ttu-id="02ac8-131">Wyświetlanie śladów użytkownika w narzędziu Podgląd śledzenia usługi</span><span class="sxs-lookup"><span data-stu-id="02ac8-131">Viewing User Traces in the Service Trace Viewer Tool</span></span>

<span data-ttu-id="02ac8-132">Ta sekcja zawiera zrzuty ekranu przedstawiające śledzenie wygenerowane przez uruchomienie [rozszerzanie śledzenia](../../../../../docs/framework/wcf/samples/extending-tracing.md) przykładowy, gdy wyświetlany w przeglądarce [narzędzie śledzenia usług (SvcTraceViewer.exe)](../../../../../docs/framework/wcf/service-trace-viewer-tool-svctraceviewer-exe.md).</span><span class="sxs-lookup"><span data-stu-id="02ac8-132">This section contains screenshots of traces generated by running the [Extending Tracing](../../../../../docs/framework/wcf/samples/extending-tracing.md) sample, when viewed using the [Service Trace Viewer Tool (SvcTraceViewer.exe)](../../../../../docs/framework/wcf/service-trace-viewer-tool-svctraceviewer-exe.md).</span></span>

<span data-ttu-id="02ac8-133">Na poniższym diagramie aktywności "Dodaj żądanie" utworzony wcześniej wybranego na lewym panelu.</span><span class="sxs-lookup"><span data-stu-id="02ac8-133">In the following diagram, the "Add request" activity created previously is selected on the left panel.</span></span> <span data-ttu-id="02ac8-134">Jest ona wyświetlana z trzech innych matematycznych operacji działań (dzielenie, odejmowanie, mnożenie) wchodzących w skład programu klienckiego aplikacji.</span><span class="sxs-lookup"><span data-stu-id="02ac8-134">It is listed with three other Math operation activities (Divide, Subtract, Multiply) that constitute the application client program.</span></span> <span data-ttu-id="02ac8-135">Kod użytkownika został zdefiniowany jeden nowe działanie dla każdej operacji do izolowania potencjalnych wystąpienia błędów w innych żądań.</span><span class="sxs-lookup"><span data-stu-id="02ac8-135">The user code has defined one new activity for each operation to isolate potential error occurrences in different requests.</span></span>

<span data-ttu-id="02ac8-136">Aby zademonstrować użycie transfery [rozszerzanie śledzenia](../../../../../docs/framework/wcf/samples/extending-tracing.md) próbki, działanie Kalkulator, który hermetyzuje żądania operacji cztery tworzona jest również.</span><span class="sxs-lookup"><span data-stu-id="02ac8-136">To demonstrate the use of transfers in the [Extending Tracing](../../../../../docs/framework/wcf/samples/extending-tracing.md) sample, a Calculator activity that encapsulates the four operation requests is also created.</span></span> <span data-ttu-id="02ac8-137">Dla każdego żądania jest transferu i z powrotem z działania kalkulatora działania żądania (śledzenia jest wyróżniony w górnym prawym panelu na rysunku).</span><span class="sxs-lookup"><span data-stu-id="02ac8-137">For each request, there is a transfer back and forth from the Calculator activity to the request activity (trace is highlighted in the upper right panel in the figure).</span></span>

<span data-ttu-id="02ac8-138">Po wybraniu do działania w lewym panelu, ślady dołączane przez to działanie są wyświetlane w prawym górnym panelu.</span><span class="sxs-lookup"><span data-stu-id="02ac8-138">When you select an activity on the left panel, the traces included by this activity are shown on the upper right panel.</span></span> <span data-ttu-id="02ac8-139">Jeśli `propagateActivity` jest `true` w każdym punkcie końcowym ścieżki żądania są ślady w działaniu żądania od wszystkich procesów, które uczestniczą w żądaniu.</span><span class="sxs-lookup"><span data-stu-id="02ac8-139">If `propagateActivity` is `true` at every endpoint in the request path, traces in the request activity are from all processes that participate in the request.</span></span> <span data-ttu-id="02ac8-140">W tym przykładzie widać śladów od klienta i usługi w kolumnie 4. w panelu.</span><span class="sxs-lookup"><span data-stu-id="02ac8-140">In this example, you can see traces from both the client and service in the 4th column in the panel.</span></span>

<span data-ttu-id="02ac8-141">To działanie pokazano w następującej kolejności przetwarzania:</span><span class="sxs-lookup"><span data-stu-id="02ac8-141">This activity shows the following order of processing:</span></span>

1. <span data-ttu-id="02ac8-142">Klient wysyła komunikat do dodania.</span><span class="sxs-lookup"><span data-stu-id="02ac8-142">Client sends message to Add.</span></span>

2. <span data-ttu-id="02ac8-143">Usługa odbiera komunikat żądania Dodaj.</span><span class="sxs-lookup"><span data-stu-id="02ac8-143">Service receives Add request message.</span></span>

3. <span data-ttu-id="02ac8-144">Dodaj odpowiedzi wysyłane przez usługę.</span><span class="sxs-lookup"><span data-stu-id="02ac8-144">Service sends Add response.</span></span>

4. <span data-ttu-id="02ac8-145">Klient odbiera odpowiedź Dodaj.</span><span class="sxs-lookup"><span data-stu-id="02ac8-145">Client receives Add response.</span></span>

<span data-ttu-id="02ac8-146">Ślady te zostały emitowane na poziomie informacji.</span><span class="sxs-lookup"><span data-stu-id="02ac8-146">All these traces were emitted at Information level.</span></span> <span data-ttu-id="02ac8-147">Klikając śledzenia w prawym górnym rogu panelu zawiera szczegółowe informacje o tym śledzenia w dolnym prawym panelu.</span><span class="sxs-lookup"><span data-stu-id="02ac8-147">Clicking a trace in the upper-right panel shows the details of that trace in the lower-right panel.</span></span>

<span data-ttu-id="02ac8-148">Na poniższym diagramie Widzimy również ślady transferu, od i do działania Kalkulatora, a także dwie pary uruchomienia i zatrzymania śledzenia na działanie żądania: jeden dla klienta, a drugi dla usługi, (po jednym dla każdego źródła śledzenia).</span><span class="sxs-lookup"><span data-stu-id="02ac8-148">In the following diagram, we also see transfer traces from and to the Calculator activity, as well as two pairs of Start and Stop traces per request activity, one for the client and one for the service (one for each trace source).</span></span>

<span data-ttu-id="02ac8-149">![Przeglądarki danych śledzenia: Emitowanie użytkownika&#45;kodu ślady](../../../../../docs/framework/wcf/diagnostics/tracing/media/242c9358-475a-4baf-83f3-4227aa942fcd.gif "242c9358-475a-4baf-83f3-4227aa942fcd") listę działań w oparciu o czas utworzenia (panelu po lewej stronie) oraz ich zagnieżdżonych działania (w prawym górnym rogu panelu)</span><span class="sxs-lookup"><span data-stu-id="02ac8-149">![Trace Viewer: Emitting User&#45;code traces](../../../../../docs/framework/wcf/diagnostics/tracing/media/242c9358-475a-4baf-83f3-4227aa942fcd.gif "242c9358-475a-4baf-83f3-4227aa942fcd") List of activities by creation time (left panel) and their nested activities (upper-right panel)</span></span>

<span data-ttu-id="02ac8-150">Jeśli kod usługi zgłasza wyjątek, który powoduje, że klient throw również (na przykład, gdy klient nie uzyskano odpowiedź na żądanie), w tym samym działaniu dla bezpośrednia korelacja wystąpić, zarówno usługi i klienta, ostrzeżenie lub komunikaty o błędach.</span><span class="sxs-lookup"><span data-stu-id="02ac8-150">If the service code throws an exception that causes the client to throw as well (for example, when the client did not get the response to its request), both the service and client warning or error messages occur in the same activity for direct correlation.</span></span> <span data-ttu-id="02ac8-151">Na poniższej ilustracji usługa zgłasza wyjątek informacją "Usługa odmówi przetworzenia tego żądania, w kodzie użytkownika."</span><span class="sxs-lookup"><span data-stu-id="02ac8-151">In the following image, the service throws an exception that states "The service refuses to process this request in user code."</span></span> <span data-ttu-id="02ac8-152">Klient również zgłasza wyjątek, informacją "serwer nie może przetworzyć żądania z powodu błędu wewnętrznego."</span><span class="sxs-lookup"><span data-stu-id="02ac8-152">The client also throws an exception that states "The server was unable to process the request due to an internal error."</span></span>

<span data-ttu-id="02ac8-153">Następujące obrazy pokazuje, czy błędy w obrębie punktów końcowych dla danego żądania są wyświetlane w tym samym działaniu, jeśli identyfikator działania żądania został rozpropagowany:</span><span class="sxs-lookup"><span data-stu-id="02ac8-153">The following images shows that errors across endpoints for a given request appear in the same activity if the request activity id was propagated:</span></span>

![Zrzut ekranu pokazujący błędy w obrębie punktów końcowych dla danego żądania.](./media/emitting-user-code-traces/trace-viewer-endpoint-errors.gif)

<span data-ttu-id="02ac8-155">Dwukrotne kliknięcie wielokrotnie działania na lewym panelu pokazuje kolejnym wykresie ślady mnożenia działanie dla każdego procesu, które są zaangażowani.</span><span class="sxs-lookup"><span data-stu-id="02ac8-155">Double-clicking the Multiply activity on the left panel shows the following graph, with the traces for the Multiply activity for each process involved.</span></span> <span data-ttu-id="02ac8-156">Można zauważyć, że najpierw wystąpiło ostrzeżenie w punkcie usług (wystąpienie wyjątku), który następuje ostrzeżeń i błędów na komputerze klienckim, ponieważ nie można przetworzyć żądania.</span><span class="sxs-lookup"><span data-stu-id="02ac8-156">We can see a warning first occurred at the service (exception thrown), which is followed by warnings and errors on the client because the request could not be processed.</span></span> <span data-ttu-id="02ac8-157">Dlatego firma Microsoft oznaczać błąd przyczynowego relacji między punktami końcowymi i pochodzić główną przyczynę tego błędu.</span><span class="sxs-lookup"><span data-stu-id="02ac8-157">Therefore, we can imply the causal error relationship between endpoints and derive the root cause of the error.</span></span>

<span data-ttu-id="02ac8-158">Na poniższej ilustracji przedstawiono widok wykresu korelacji błąd:</span><span class="sxs-lookup"><span data-stu-id="02ac8-158">The following image shows a graph view of error correlation:</span></span>

![Zrzut ekranu pokazujący widoku wykresu korelacji błędu.](./media/emitting-user-code-traces/trace-viewer-error-correlation.gif)

<span data-ttu-id="02ac8-160">Uzyskanie ślady poprzedniego, ustawiliśmy `ActivityTracing` dla źródła śledzenia użytkowników i `propagateActivity=true` dla `System.ServiceModel` źródła śledzenia.</span><span class="sxs-lookup"><span data-stu-id="02ac8-160">To obtain the previous traces, we set `ActivityTracing` for the user trace sources and `propagateActivity=true` for the `System.ServiceModel` trace source.</span></span> <span data-ttu-id="02ac8-161">Firma Microsoft nie ustawiła prawidłowo `ActivityTracing` dla `System.ServiceModel` źródła śledzenia, aby włączyć kod użytkownika do propagowania działań kodu użytkownika.</span><span class="sxs-lookup"><span data-stu-id="02ac8-161">We did not set `ActivityTracing` for the `System.ServiceModel` trace source to enable user code to user code activity propagation.</span></span> <span data-ttu-id="02ac8-162">(Gdy ServiceModel działania śledzenia jest włączona, identyfikator działania zdefiniowane w obiekcie klienta nie są propagowane do kodu użytkownika usługi; Transfery, jednak skorelować działaniach kodu użytkownika klienta i usługi pośrednie działań usługi WCF.)</span><span class="sxs-lookup"><span data-stu-id="02ac8-162">(When ServiceModel activity tracing is on, the activity ID defined in the client is not propagated all the way to the service user code; Transfers, however, correlate the client and service user code activities to the intermediate WCF activities.)</span></span>

<span data-ttu-id="02ac8-163">Definiowanie działania zmiany i propagowanie identyfikator działania pozwala nam wykonywać bezpośrednie błąd korelację między punktami końcowymi.</span><span class="sxs-lookup"><span data-stu-id="02ac8-163">Defining activities and propagating the activity ID enables us to perform direct error correlation across endpoints.</span></span> <span data-ttu-id="02ac8-164">Dzięki temu będzie można znaleźć przyczynę błędu szybciej.</span><span class="sxs-lookup"><span data-stu-id="02ac8-164">In this way, we can locate the root cause of an error more quickly.</span></span>

## <a name="see-also"></a><span data-ttu-id="02ac8-165">Zobacz także</span><span class="sxs-lookup"><span data-stu-id="02ac8-165">See also</span></span>

- [<span data-ttu-id="02ac8-166">Rozszerzanie śledzenia</span><span class="sxs-lookup"><span data-stu-id="02ac8-166">Extending Tracing</span></span>](../../../../../docs/framework/wcf/samples/extending-tracing.md)
