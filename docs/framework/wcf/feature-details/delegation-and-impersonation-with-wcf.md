---
title: Delegowanie i personifikacja za pomocą programu WCF
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
helpviewer_keywords:
- impersonation [WCF]
- delegation [WCF]
ms.assetid: 110e60f7-5b03-4b69-b667-31721b8e3152
ms.openlocfilehash: ec34c19da9cd642f5de51166bef0264c2e75c58c
ms.sourcegitcommit: 0be8a279af6d8a43e03141e349d3efd5d35f8767
ms.translationtype: HT
ms.contentlocale: pl-PL
ms.lasthandoff: 04/18/2019
ms.locfileid: "59345524"
---
# <a name="delegation-and-impersonation-with-wcf"></a><span data-ttu-id="390f5-102">Delegowanie i personifikacja za pomocą programu WCF</span><span class="sxs-lookup"><span data-stu-id="390f5-102">Delegation and Impersonation with WCF</span></span>
<span data-ttu-id="390f5-103">*Personifikacja* jest typową techniką, której usługi użyć do ograniczenia dostępu klienta do zasobów w domenie usługi.</span><span class="sxs-lookup"><span data-stu-id="390f5-103">*Impersonation* is a common technique that services use to restrict client access to a service domain's resources.</span></span> <span data-ttu-id="390f5-104">Zasobów domeny usługi może być zasoby maszyny, takie jak pliki lokalne (dokona personifikacji) lub zasobów na innej maszynie, na przykład do udziału plików (delegowania).</span><span class="sxs-lookup"><span data-stu-id="390f5-104">Service domain resources can either be machine resources, such as local files (impersonation), or a resource on another machine, such as a file share (delegation).</span></span> <span data-ttu-id="390f5-105">Dla przykładowej aplikacji, zobacz [Personifikowanie klienta](../../../../docs/framework/wcf/samples/impersonating-the-client.md).</span><span class="sxs-lookup"><span data-stu-id="390f5-105">For a sample application, see [Impersonating the Client](../../../../docs/framework/wcf/samples/impersonating-the-client.md).</span></span> <span data-ttu-id="390f5-106">Na przykład jak używać personifikacji zobacz [jak: Personifikowanie klienta w usłudze](../../../../docs/framework/wcf/how-to-impersonate-a-client-on-a-service.md).</span><span class="sxs-lookup"><span data-stu-id="390f5-106">For an example of how to use impersonation, see [How to: Impersonate a Client on a Service](../../../../docs/framework/wcf/how-to-impersonate-a-client-on-a-service.md).</span></span>  
  
> [!IMPORTANT]
>  <span data-ttu-id="390f5-107">Należy pamiętać podczas personifikowania klienta w usłudze, usługa była uruchamiana przy użyciu poświadczeń klienta, które mogą mieć wyższe uprawnienia niż aktualnie proces serwera.</span><span class="sxs-lookup"><span data-stu-id="390f5-107">Be aware that when impersonating a client on a service, the service runs with the client's credentials, which may have higher privileges than the server process.</span></span>  
  
## <a name="overview"></a><span data-ttu-id="390f5-108">Omówienie</span><span class="sxs-lookup"><span data-stu-id="390f5-108">Overview</span></span>  
 <span data-ttu-id="390f5-109">Zazwyczaj klienci wywołują usługi, aby usługa wykonanie akcji w imieniu klienta.</span><span class="sxs-lookup"><span data-stu-id="390f5-109">Typically, clients call a service to have the service perform some action on the client’s behalf.</span></span> <span data-ttu-id="390f5-110">Personifikacja umożliwia usługa do działania jako klienta podczas wykonywania akcji.</span><span class="sxs-lookup"><span data-stu-id="390f5-110">Impersonation allows the service to act as the client while performing the action.</span></span> <span data-ttu-id="390f5-111">Delegowanie umożliwia usłudze frontonu przesyła żądanie klienta do usługi zaplecza w taki sposób, że usługa zaplecza może również personifikować klienta.</span><span class="sxs-lookup"><span data-stu-id="390f5-111">Delegation allows a front-end service to forward the client’s request to a back-end service in such a way that the back-end service can also impersonate the client.</span></span> <span data-ttu-id="390f5-112">Personifikacja jest najczęściej używana jako sposób sprawdzania, czy klient jest autoryzowany do wykonania określonej akcji, gdy delegowanie to sposób możliwości płynące personifikacji, wraz z tożsamość klienta usługi zaplecza.</span><span class="sxs-lookup"><span data-stu-id="390f5-112">Impersonation is most commonly used as a way of checking whether a client is authorized to perform a particular action, while delegation is a way of flowing impersonation capabilities, along with the client’s identity, to a back-end service.</span></span> <span data-ttu-id="390f5-113">Delegowanie jest funkcją domeny Windows, które mogą być używane podczas uwierzytelniania Kerberos jest wykonywane.</span><span class="sxs-lookup"><span data-stu-id="390f5-113">Delegation is a Windows domain feature that can be used when Kerberos-based authentication is performed.</span></span> <span data-ttu-id="390f5-114">Delegowanie różni się od przepływ tożsamości, a ponieważ delegowania transferów możliwość personifikacji klienta bez posiadania hasła użytkownika, jest znacznie wyższa uprzywilejowaną operacją niż przepływ tożsamości.</span><span class="sxs-lookup"><span data-stu-id="390f5-114">Delegation is distinct from identity flow and, because delegation transfers the ability to impersonate the client without possession of the client’s password, it is a much higher privileged operation than identity flow.</span></span>  
  
 <span data-ttu-id="390f5-115">Delegowanie i personifikacja wymaga się, że klient ma tożsamości Windows.</span><span class="sxs-lookup"><span data-stu-id="390f5-115">Both impersonation and delegation require that the client have a Windows identity.</span></span> <span data-ttu-id="390f5-116">Jeśli klient nie posiada tożsamości Windows, jedyną dostępną opcją jest tożsamość klienta do drugiego usługi flow.</span><span class="sxs-lookup"><span data-stu-id="390f5-116">If a client does not possess a Windows identity, then the only option available is to flow the client’s identity to the second service.</span></span>  
  
## <a name="impersonation-basics"></a><span data-ttu-id="390f5-117">Podstawowe informacje o personifikacji</span><span class="sxs-lookup"><span data-stu-id="390f5-117">Impersonation Basics</span></span>  
 <span data-ttu-id="390f5-118">Windows Communication Foundation (WCF) obsługuje personifikacji dla różnych poświadczeń klienta.</span><span class="sxs-lookup"><span data-stu-id="390f5-118">Windows Communication Foundation (WCF) supports impersonation for a variety of client credentials.</span></span> <span data-ttu-id="390f5-119">W tym temacie opisano obsługę modelu usługi personifikacji wywołującego podczas implementacji metody usługi.</span><span class="sxs-lookup"><span data-stu-id="390f5-119">This topic describes service model support for impersonating the caller during the implementation of a service method.</span></span> <span data-ttu-id="390f5-120">Omówiono także typowe scenariusze wdrożenia obejmujące personifikacji i zabezpieczeniach SOAP oraz opcje usługi WCF w tych scenariuszach.</span><span class="sxs-lookup"><span data-stu-id="390f5-120">Also discussed are common deployment scenarios involving impersonation and SOAP security and WCF options in these scenarios.</span></span>  
  
 <span data-ttu-id="390f5-121">Ten temat koncentruje się na personifikacji i delegowanie w programie WCF, korzystając z zabezpieczeń protokołu SOAP.</span><span class="sxs-lookup"><span data-stu-id="390f5-121">This topic focuses on impersonation and delegation in WCF when using SOAP security.</span></span> <span data-ttu-id="390f5-122">Umożliwia także personifikacji i delegowanie z programem WCF podczas za pomocą zabezpieczeń transportu, zgodnie z opisem w [przy użyciu personifikacji z zabezpieczeniami transportu](../../../../docs/framework/wcf/feature-details/using-impersonation-with-transport-security.md).</span><span class="sxs-lookup"><span data-stu-id="390f5-122">You can also use impersonation and delegation with WCF when using transport security, as described in [Using Impersonation with Transport Security](../../../../docs/framework/wcf/feature-details/using-impersonation-with-transport-security.md).</span></span>  
  
## <a name="two-methods"></a><span data-ttu-id="390f5-123">Dwie metody</span><span class="sxs-lookup"><span data-stu-id="390f5-123">Two Methods</span></span>  
 <span data-ttu-id="390f5-124">WCF SOAP zabezpieczeń ma dwa różne metody służące do wykonywania personifikacji.</span><span class="sxs-lookup"><span data-stu-id="390f5-124">WCF SOAP security has two distinct methods for performing impersonation.</span></span> <span data-ttu-id="390f5-125">Metoda używana zależy od powiązania.</span><span class="sxs-lookup"><span data-stu-id="390f5-125">The method used depends on the binding.</span></span> <span data-ttu-id="390f5-126">Jeden jest personifikacji z tokenu Windows uzyskany z uwierzytelniania interfejsu dostawcy obsługi zabezpieczeń (SSPI) i Kerberos, które są zapisane w pamięci podręcznej w usłudze.</span><span class="sxs-lookup"><span data-stu-id="390f5-126">One is impersonation from a Windows token obtained from the Security Support Provider Interface (SSPI) or Kerberos authentication, which is then cached on the service.</span></span> <span data-ttu-id="390f5-127">Drugi to personifikacji z tokenem Windows uzyskany z rozszerzenia protokołu Kerberos, nazywane *Service for User* (S4U).</span><span class="sxs-lookup"><span data-stu-id="390f5-127">The second is impersonation from a Windows token obtained from the Kerberos extensions, collectively called *Service-for-User* (S4U).</span></span>  
  
### <a name="cached-token-impersonation"></a><span data-ttu-id="390f5-128">Buforowany Token personifikacji</span><span class="sxs-lookup"><span data-stu-id="390f5-128">Cached Token Impersonation</span></span>  
 <span data-ttu-id="390f5-129">Możesz wykonać pamięci podręcznej tokenu personifikacji z następujących czynności:</span><span class="sxs-lookup"><span data-stu-id="390f5-129">You can perform cached-token impersonation with the following:</span></span>  
  
-   <span data-ttu-id="390f5-130"><xref:System.ServiceModel.WSHttpBinding>, <xref:System.ServiceModel.WSDualHttpBinding>, i <xref:System.ServiceModel.NetTcpBinding> przy użyciu poświadczeń klienta Windows.</span><span class="sxs-lookup"><span data-stu-id="390f5-130"><xref:System.ServiceModel.WSHttpBinding>, <xref:System.ServiceModel.WSDualHttpBinding>, and <xref:System.ServiceModel.NetTcpBinding> with a Windows client credential.</span></span>  
  
-   <span data-ttu-id="390f5-131"><xref:System.ServiceModel.BasicHttpBinding> za pomocą <xref:System.ServiceModel.BasicHttpSecurityMode> równa <xref:System.ServiceModel.BasicHttpSecurityMode.TransportWithMessageCredential> poświadczenia lub innych Powiązanie standardowe, gdzie klient przedstawia poświadczenie nazwy użytkownika, że usługa może mapować do prawidłowego konta Windows.</span><span class="sxs-lookup"><span data-stu-id="390f5-131"><xref:System.ServiceModel.BasicHttpBinding> with a <xref:System.ServiceModel.BasicHttpSecurityMode> set to the <xref:System.ServiceModel.BasicHttpSecurityMode.TransportWithMessageCredential> credential, or any other standard binding where the client presents a user name credential that the service can map to a valid Windows account.</span></span>  
  
-   <span data-ttu-id="390f5-132">Wszelkie <xref:System.ServiceModel.Channels.CustomBinding> , który używa poświadczeń klienta Windows za pomocą `requireCancellation` równa `true`.</span><span class="sxs-lookup"><span data-stu-id="390f5-132">Any <xref:System.ServiceModel.Channels.CustomBinding> that uses a Windows client credential with the `requireCancellation` set to `true`.</span></span> <span data-ttu-id="390f5-133">(Właściwość jest dostępna w następujących klas: <xref:System.ServiceModel.Security.Tokens.SecureConversationSecurityTokenParameters>, <xref:System.ServiceModel.Security.Tokens.SslSecurityTokenParameters>, i <xref:System.ServiceModel.Security.Tokens.SspiSecurityTokenParameters>.) Jeśli bezpiecznej konwersacji jest używany w wiązaniu, musi mieć również `requireCancellation` właściwością `true`.</span><span class="sxs-lookup"><span data-stu-id="390f5-133">(The property is available on the following classes: <xref:System.ServiceModel.Security.Tokens.SecureConversationSecurityTokenParameters>, <xref:System.ServiceModel.Security.Tokens.SslSecurityTokenParameters>, and <xref:System.ServiceModel.Security.Tokens.SspiSecurityTokenParameters>.) If a secure conversation is used on the binding, it must also have the `requireCancellation` property set to `true`.</span></span>  
  
-   <span data-ttu-id="390f5-134">Wszelkie <xref:System.ServiceModel.Channels.CustomBinding> gdzie klient przedstawia poświadczenie nazwy użytkownika.</span><span class="sxs-lookup"><span data-stu-id="390f5-134">Any <xref:System.ServiceModel.Channels.CustomBinding> where the client presents a user name credential.</span></span> <span data-ttu-id="390f5-135">Jeśli bezpiecznej konwersacji jest używany w wiązaniu, musi mieć również `requireCancellation` właściwością `true`.</span><span class="sxs-lookup"><span data-stu-id="390f5-135">If secure conversation is used on the binding, it must also have the `requireCancellation` property set to `true`.</span></span>  
  
### <a name="s4u-based-impersonation"></a><span data-ttu-id="390f5-136">Na podstawie S4U personifikacji</span><span class="sxs-lookup"><span data-stu-id="390f5-136">S4U-Based Impersonation</span></span>  
 <span data-ttu-id="390f5-137">Można wykonywać na podstawie S4U personifikacji z następujących czynności:</span><span class="sxs-lookup"><span data-stu-id="390f5-137">You can perform S4U-based impersonation with the following:</span></span>  
  
-   <span data-ttu-id="390f5-138"><xref:System.ServiceModel.WSHttpBinding>, <xref:System.ServiceModel.WSDualHttpBinding>, i <xref:System.ServiceModel.NetTcpBinding> przy użyciu poświadczeń klienta certyfikatu, który usługi można mapować do prawidłowego konta Windows.</span><span class="sxs-lookup"><span data-stu-id="390f5-138"><xref:System.ServiceModel.WSHttpBinding>, <xref:System.ServiceModel.WSDualHttpBinding>, and <xref:System.ServiceModel.NetTcpBinding> with a certificate client credential that the service can map to a valid Windows account.</span></span>  
  
-   <span data-ttu-id="390f5-139">Wszelkie <xref:System.ServiceModel.Channels.CustomBinding> , który używa poświadczeń klienta Windows za pomocą `requireCancellation` właściwością `false`.</span><span class="sxs-lookup"><span data-stu-id="390f5-139">Any <xref:System.ServiceModel.Channels.CustomBinding> that uses a Windows client credential with the `requireCancellation` property set to `false`.</span></span>  
  
-   <span data-ttu-id="390f5-140">Wszelkie <xref:System.ServiceModel.Channels.CustomBinding> które używa nazwy użytkownika lub poświadczeń klienta Windows i bezpiecznej konwersacji z `requireCancellation` właściwością `false`.</span><span class="sxs-lookup"><span data-stu-id="390f5-140">Any <xref:System.ServiceModel.Channels.CustomBinding> that uses a user name or Windows client credential and secure conversation with the `requireCancellation` property set to `false`.</span></span>  
  
 <span data-ttu-id="390f5-141">Zakres, do którego usługa może personifikować klienta zależy od uprawnień, który przechowuje konto usługi, podczas prób personifikacji, typ personifikacji używane i prawdopodobnie stopnia personifikacji, który pozwala na kliencie.</span><span class="sxs-lookup"><span data-stu-id="390f5-141">The extent to which the service can impersonate the client depends on the privileges the service account holds when it attempts impersonation, the type of impersonation used, and possibly the extent of impersonation the client permits.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="390f5-142">Gdy klient i usługa są uruchomione na tym samym komputerze i klient jest uruchomiony w ramach konta system (na przykład `Local System` lub `Network Service`), nie można spersonifikować klienta, po nawiązaniu bezpiecznej sesji przy użyciu stanowych kontekstu zabezpieczeń tokeny.</span><span class="sxs-lookup"><span data-stu-id="390f5-142">When the client and service are running on the same computer and the client is running under a system account (for example, `Local System` or `Network Service`), the client cannot be impersonated when a secure session is established with stateful Security Context tokens.</span></span> <span data-ttu-id="390f5-143">Formularz Windows lub konsoli aplikacji jest zazwyczaj uruchamiany przy użyciu aktualnie zalogowanego konta tak, aby konto mogą personalizacji domyślnie.</span><span class="sxs-lookup"><span data-stu-id="390f5-143">A Windows Form or console application typically runs under the currently logged-in account, so that account can be impersonated by default.</span></span> <span data-ttu-id="390f5-144">Jednakże, gdy klient jest [!INCLUDE[vstecasp](../../../../includes/vstecasp-md.md)] strony i na tej stronie znajduje się w [!INCLUDE[iis601](../../../../includes/iis601-md.md)] lub [!INCLUDE[iisver](../../../../includes/iisver-md.md)], a następnie uruchom klienta, w obszarze `Network Service` konto domyślne.</span><span class="sxs-lookup"><span data-stu-id="390f5-144">However, when the client is an [!INCLUDE[vstecasp](../../../../includes/vstecasp-md.md)] page and that page is hosted in [!INCLUDE[iis601](../../../../includes/iis601-md.md)] or [!INCLUDE[iisver](../../../../includes/iisver-md.md)], then the client does run under the `Network Service` account by default.</span></span> <span data-ttu-id="390f5-145">Domyślnie wszystkie powiązania dostarczane przez system, które obsługują bezpiecznej sesji używają tokenu kontekstu zabezpieczeń o bezstanowa (SCT).</span><span class="sxs-lookup"><span data-stu-id="390f5-145">All of the system-provided bindings that support secure sessions use a stateless security context token (SCT) by default.</span></span> <span data-ttu-id="390f5-146">Jednakże jeśli klient jest [!INCLUDE[vstecasp](../../../../includes/vstecasp-md.md)] strony i bezpieczne sesje stanowych SCTs są używane, nie można spersonifikować klienta.</span><span class="sxs-lookup"><span data-stu-id="390f5-146">However, if the client is an [!INCLUDE[vstecasp](../../../../includes/vstecasp-md.md)] page, and secure sessions with stateful SCTs are used, the client cannot be impersonated.</span></span> <span data-ttu-id="390f5-147">Aby uzyskać więcej informacji na temat w ramach bezpiecznej sesji przy użyciu stanowych SCTs zobacz [jak: Utwórz kontekst zabezpieczeń tokenu dla bezpiecznej sesji](../../../../docs/framework/wcf/feature-details/how-to-create-a-security-context-token-for-a-secure-session.md).</span><span class="sxs-lookup"><span data-stu-id="390f5-147">For more information about using stateful SCTs in a secure session, see [How to: Create a Security Context Token for a Secure Session](../../../../docs/framework/wcf/feature-details/how-to-create-a-security-context-token-for-a-secure-session.md).</span></span>  
  
## <a name="impersonation-in-a-service-method-declarative-model"></a><span data-ttu-id="390f5-148">Personifikacji w metodzie usług: Deklaratywny Model</span><span class="sxs-lookup"><span data-stu-id="390f5-148">Impersonation in a Service Method: Declarative Model</span></span>  
 <span data-ttu-id="390f5-149">Większość scenariuszy personifikacji wymagają wykonania metody usługi w kontekście obiektu wywołującego.</span><span class="sxs-lookup"><span data-stu-id="390f5-149">Most impersonation scenarios involve executing the service method in the caller context.</span></span> <span data-ttu-id="390f5-150">WCF oferuje funkcję personifikacji, który sprawia, że są to proste, umożliwiając użytkownikowi na określenie wymagań personifikacji w <xref:System.ServiceModel.OperationBehaviorAttribute> atrybutu.</span><span class="sxs-lookup"><span data-stu-id="390f5-150">WCF provides an impersonation feature that makes this easy to do by allowing the user to specify the impersonation requirement in the <xref:System.ServiceModel.OperationBehaviorAttribute> attribute.</span></span> <span data-ttu-id="390f5-151">Na przykład, poniższy kod, infrastruktura WCF personifikuje obiekt wywołujący przed wykonaniem `Hello` metody.</span><span class="sxs-lookup"><span data-stu-id="390f5-151">For example, in the following code, the WCF infrastructure impersonates the caller before executing the `Hello` method.</span></span> <span data-ttu-id="390f5-152">Dowolne próba dostępu do zasobów natywnych wewnątrz `Hello` metoda powiedzie się tylko wtedy, gdy listy kontroli dostępu (ACL) zasobu umożliwia obiektowi wywołującemu przywileje dostępu.</span><span class="sxs-lookup"><span data-stu-id="390f5-152">Any attempt to access native resources inside the `Hello` method succeed only if the access control list (ACL) of the resource allows the caller access privileges.</span></span> <span data-ttu-id="390f5-153">Aby włączyć personifikacji, ustaw <xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A> jedną z właściwości <xref:System.ServiceModel.ImpersonationOption> wartości wyliczenia, albo <xref:System.ServiceModel.ImpersonationOption.Required?displayProperty=nameWithType> lub <xref:System.ServiceModel.ImpersonationOption.Allowed?displayProperty=nameWithType>, jak pokazano w poniższym przykładzie.</span><span class="sxs-lookup"><span data-stu-id="390f5-153">To enable impersonation, set the <xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A> property to one of the <xref:System.ServiceModel.ImpersonationOption> enumeration values, either <xref:System.ServiceModel.ImpersonationOption.Required?displayProperty=nameWithType> or <xref:System.ServiceModel.ImpersonationOption.Allowed?displayProperty=nameWithType>, as shown in the following example.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="390f5-154">Gdy usługa poświadczeniami wyższe niż w przypadku zdalnego klienta, są używane poświadczenia usługi, jeśli <xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A> właściwość jest ustawiona na <xref:System.ServiceModel.ImpersonationOption.Allowed>.</span><span class="sxs-lookup"><span data-stu-id="390f5-154">When a service has higher credentials than the remote client, the credentials of the service are used if the <xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A> property is set to <xref:System.ServiceModel.ImpersonationOption.Allowed>.</span></span> <span data-ttu-id="390f5-155">Oznacza to jeśli użytkownika o niskich uprawnieniach udostępnia swoje poświadczenia, usługa wyższych uprawnieniach wykonuje metodę przy użyciu poświadczeń usługi i mogą korzystać z niskim poziomem uprawnień użytkownika w przeciwnym razie nie będzie mógł używać zasobów.</span><span class="sxs-lookup"><span data-stu-id="390f5-155">That is, if a low-privileged user provides its credentials, a higher-privileged service executes the method with the credentials of the service, and can use resources that the low-privileged user would otherwise not be able to use.</span></span>  
  
 [!code-csharp[c_ImpersonationAndDelegation#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_impersonationanddelegation/cs/source.cs#1)]
 [!code-vb[c_ImpersonationAndDelegation#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_impersonationanddelegation/vb/source.vb#1)]  
  
 <span data-ttu-id="390f5-156">Infrastruktura WCF można personifikują wywołującego, tylko wtedy, gdy obiekt wywołujący jest uwierzytelniany przy użyciu poświadczeń, które mogą zostać zamapowane na konto użytkownika Windows.</span><span class="sxs-lookup"><span data-stu-id="390f5-156">The WCF infrastructure can impersonate the caller only if the caller is authenticated with credentials that can be mapped to a Windows user account.</span></span> <span data-ttu-id="390f5-157">Jeśli usługa jest skonfigurowana do uwierzytelniania przy użyciu poświadczeń, które nie mogą być mapowane na konta Windows, metoda usługi nie jest wykonywany.</span><span class="sxs-lookup"><span data-stu-id="390f5-157">If the service is configured to authenticate using a credential that cannot be mapped to a Windows account, the service method is not executed.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="390f5-158">Na [!INCLUDE[wxp](../../../../includes/wxp-md.md)], personifikacji zakończy się niepowodzeniem, jeśli stanowa, SCT jest tworzony z wynikiem <xref:System.InvalidOperationException>.</span><span class="sxs-lookup"><span data-stu-id="390f5-158">On [!INCLUDE[wxp](../../../../includes/wxp-md.md)], impersonation fails if a stateful SCT is created, resulting in an <xref:System.InvalidOperationException>.</span></span> <span data-ttu-id="390f5-159">Aby uzyskać więcej informacji, zobacz [nieobsługiwane scenariusze](../../../../docs/framework/wcf/feature-details/unsupported-scenarios.md).</span><span class="sxs-lookup"><span data-stu-id="390f5-159">For more information, see [Unsupported Scenarios](../../../../docs/framework/wcf/feature-details/unsupported-scenarios.md).</span></span>  
  
## <a name="impersonation-in-a-service-method-imperative-model"></a><span data-ttu-id="390f5-160">Personifikacji w metodzie usług: Model imperatywne</span><span class="sxs-lookup"><span data-stu-id="390f5-160">Impersonation in a Service Method: Imperative Model</span></span>  
 <span data-ttu-id="390f5-161">Czasami obiekt wywołujący nie musi dokonać personifikacji metoda całą usługę do funkcji, ale tylko jego części.</span><span class="sxs-lookup"><span data-stu-id="390f5-161">Sometimes a caller does not need to impersonate the entire service method to function, but for only a portion of it.</span></span> <span data-ttu-id="390f5-162">W tym przypadku uzyskać tożsamość Windows obiektu wywołującego wewnątrz metody usługi i wykonywać obowiązkowo personifikacji.</span><span class="sxs-lookup"><span data-stu-id="390f5-162">In this case, obtain the Windows identity of the caller inside the service method and imperatively perform the impersonation.</span></span> <span data-ttu-id="390f5-163">To zrobić za pomocą <xref:System.ServiceModel.ServiceSecurityContext.WindowsIdentity%2A> właściwość <xref:System.ServiceModel.ServiceSecurityContext> do zwrócenia wystąpienia <xref:System.Security.Principal.WindowsIdentity> klasy i wywoływania <xref:System.Security.Principal.WindowsIdentity.Impersonate%2A> metoda przed rozpoczęciem korzystania z wystąpienia.</span><span class="sxs-lookup"><span data-stu-id="390f5-163">Do this by using the <xref:System.ServiceModel.ServiceSecurityContext.WindowsIdentity%2A> property of the <xref:System.ServiceModel.ServiceSecurityContext> to return an instance of the <xref:System.Security.Principal.WindowsIdentity> class and calling the <xref:System.Security.Principal.WindowsIdentity.Impersonate%2A> method before using the instance.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="390f5-164">Należy użyć programu Visual Basic`Using` instrukcji lub C# `using` instrukcję, aby automatycznie przywrócić działanie personifikacji.</span><span class="sxs-lookup"><span data-stu-id="390f5-164">Be sure to use the Visual Basic`Using` statement or the C# `using` statement to automatically revert the impersonation action.</span></span> <span data-ttu-id="390f5-165">Nie należy używać instrukcji lub jeśli używasz języka programowania niż Visual Basic lub C#, pamiętaj przywrócić poziom personifikacji.</span><span class="sxs-lookup"><span data-stu-id="390f5-165">If you do not use the statement, or if you use a programming language other than Visual Basic or C#, be sure to revert the impersonation level.</span></span> <span data-ttu-id="390f5-166">Niewykonanie tej czynności to może stanowić podstawę dla typu odmowa usługi i atakom powodującym podniesienie uprawnień.</span><span class="sxs-lookup"><span data-stu-id="390f5-166">Failure to do this can form the basis for denial of service and elevation of privilege attacks.</span></span>  
  
 [!code-csharp[c_ImpersonationAndDelegation#2](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_impersonationanddelegation/cs/source.cs#2)]
 [!code-vb[c_ImpersonationAndDelegation#2](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_impersonationanddelegation/vb/source.vb#2)]  
  
## <a name="impersonation-for-all-service-methods"></a><span data-ttu-id="390f5-167">Personifikacji dla wszystkich metod usługi</span><span class="sxs-lookup"><span data-stu-id="390f5-167">Impersonation for All Service Methods</span></span>  
 <span data-ttu-id="390f5-168">W niektórych przypadkach należy wykonać wszystkie metody usługi w kontekście obiektu wywołującego.</span><span class="sxs-lookup"><span data-stu-id="390f5-168">In some cases, you must perform all the methods of a service in the caller’s context.</span></span> <span data-ttu-id="390f5-169">Zamiast jawnie włączenie tej funkcji, na podstawie na metodzie, użyj <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior>.</span><span class="sxs-lookup"><span data-stu-id="390f5-169">Instead of explicitly enabling this feature on a per-method basis, use the <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior>.</span></span> <span data-ttu-id="390f5-170">Jak pokazano w poniższym kodzie, ustaw <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior.ImpersonateCallerForAllOperations%2A> właściwość `true`.</span><span class="sxs-lookup"><span data-stu-id="390f5-170">As shown in the following code, set the <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior.ImpersonateCallerForAllOperations%2A> property to `true`.</span></span> <span data-ttu-id="390f5-171"><xref:System.ServiceModel.Description.ServiceAuthorizationBehavior> Są pobierane z kolekcji zachowań <xref:System.ServiceModel.ServiceHost> klasy.</span><span class="sxs-lookup"><span data-stu-id="390f5-171">The <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior> is retrieved from the collections of behaviors of the <xref:System.ServiceModel.ServiceHost> class.</span></span> <span data-ttu-id="390f5-172">Należy również zauważyć, że `Impersonation` właściwość <xref:System.ServiceModel.OperationBehaviorAttribute> stosowane do każdej metody również musi być ustawiona na <xref:System.ServiceModel.ImpersonationOption.Allowed> lub <xref:System.ServiceModel.ImpersonationOption.Required>.</span><span class="sxs-lookup"><span data-stu-id="390f5-172">Also note that the `Impersonation` property of the <xref:System.ServiceModel.OperationBehaviorAttribute> applied to each method must also be set to either <xref:System.ServiceModel.ImpersonationOption.Allowed> or <xref:System.ServiceModel.ImpersonationOption.Required>.</span></span>  
  
 [!code-csharp[c_ImpersonationAndDelegation#3](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_impersonationanddelegation/cs/source.cs#3)]
 [!code-vb[c_ImpersonationAndDelegation#3](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_impersonationanddelegation/vb/source.vb#3)]  
  
 <span data-ttu-id="390f5-173">W poniższej tabeli przedstawiono zachowania usługi WCF w przypadku wszystkich możliwych kombinacji `ImpersonationOption` i `ImpersonateCallerForAllServiceOperations`.</span><span class="sxs-lookup"><span data-stu-id="390f5-173">The following table describes WCF behavior for all possible combinations of `ImpersonationOption` and `ImpersonateCallerForAllServiceOperations`.</span></span>  
  
|`ImpersonationOption`|`ImpersonateCallerForAllServiceOperations`|<span data-ttu-id="390f5-174">Zachowanie</span><span class="sxs-lookup"><span data-stu-id="390f5-174">Behavior</span></span>|  
|---------------------------|------------------------------------------------|--------------|  
|<span data-ttu-id="390f5-175">Wymagane</span><span class="sxs-lookup"><span data-stu-id="390f5-175">Required</span></span>|<span data-ttu-id="390f5-176">n/d</span><span class="sxs-lookup"><span data-stu-id="390f5-176">n/a</span></span>|<span data-ttu-id="390f5-177">Usługi WCF personifikuje obiektu wywołującego</span><span class="sxs-lookup"><span data-stu-id="390f5-177">WCF impersonates the caller</span></span>|  
|<span data-ttu-id="390f5-178">Dozwolone</span><span class="sxs-lookup"><span data-stu-id="390f5-178">Allowed</span></span>|<span data-ttu-id="390f5-179">false</span><span class="sxs-lookup"><span data-stu-id="390f5-179">false</span></span>|<span data-ttu-id="390f5-180">Usługi WCF nie spersonifikować obiektu wywołującego</span><span class="sxs-lookup"><span data-stu-id="390f5-180">WCF does not impersonate the caller</span></span>|  
|<span data-ttu-id="390f5-181">Dozwolone</span><span class="sxs-lookup"><span data-stu-id="390f5-181">Allowed</span></span>|<span data-ttu-id="390f5-182">true</span><span class="sxs-lookup"><span data-stu-id="390f5-182">true</span></span>|<span data-ttu-id="390f5-183">Usługi WCF personifikuje obiektu wywołującego</span><span class="sxs-lookup"><span data-stu-id="390f5-183">WCF impersonates the caller</span></span>|  
|<span data-ttu-id="390f5-184">NotAllowed</span><span class="sxs-lookup"><span data-stu-id="390f5-184">NotAllowed</span></span>|<span data-ttu-id="390f5-185">false</span><span class="sxs-lookup"><span data-stu-id="390f5-185">false</span></span>|<span data-ttu-id="390f5-186">Usługi WCF nie spersonifikować obiektu wywołującego</span><span class="sxs-lookup"><span data-stu-id="390f5-186">WCF does not impersonate the caller</span></span>|  
|<span data-ttu-id="390f5-187">NotAllowed</span><span class="sxs-lookup"><span data-stu-id="390f5-187">NotAllowed</span></span>|<span data-ttu-id="390f5-188">true</span><span class="sxs-lookup"><span data-stu-id="390f5-188">true</span></span>|<span data-ttu-id="390f5-189">Niedozwolone.</span><span class="sxs-lookup"><span data-stu-id="390f5-189">Disallowed.</span></span> <span data-ttu-id="390f5-190">( <xref:System.InvalidOperationException> Zgłaszany.)</span><span class="sxs-lookup"><span data-stu-id="390f5-190">(An <xref:System.InvalidOperationException> is thrown.)</span></span>|  
  
## <a name="impersonation-level-obtained-from-windows-credentials-and-cached-token-impersonation"></a><span data-ttu-id="390f5-191">Poziom personifikacji uzyskanych od Windows poświadczeń i pamięci podręcznej tokenu personifikacji</span><span class="sxs-lookup"><span data-stu-id="390f5-191">Impersonation Level Obtained from Windows Credentials and Cached Token Impersonation</span></span>  
 <span data-ttu-id="390f5-192">W niektórych przypadkach klient ma częściowa kontrola nad poziomem personifikacji, którego usługa wykonuje stosowania poświadczeń klienta Windows.</span><span class="sxs-lookup"><span data-stu-id="390f5-192">In some scenarios the client has partial control over the level of impersonation the service performs when a Windows client credential is used.</span></span> <span data-ttu-id="390f5-193">Jeden scenariusz występuje, gdy klient określa poziom personifikacji anonimowe.</span><span class="sxs-lookup"><span data-stu-id="390f5-193">One scenario occurs when the client specifies an Anonymous impersonation level.</span></span> <span data-ttu-id="390f5-194">Druga występuje podczas przeprowadzania personifikacja za pomocą tokenu z pamięci podręcznej.</span><span class="sxs-lookup"><span data-stu-id="390f5-194">The other occurs when performing impersonation with a cached token.</span></span> <span data-ttu-id="390f5-195">Jest to realizowane przez ustawienie <xref:System.ServiceModel.Security.WindowsClientCredential.AllowedImpersonationLevel%2A> właściwość <xref:System.ServiceModel.Security.WindowsClientCredential> klasy, który jest dostępny jako właściwość ogólnego <xref:System.ServiceModel.ChannelFactory%601> klasy.</span><span class="sxs-lookup"><span data-stu-id="390f5-195">This is done by setting the <xref:System.ServiceModel.Security.WindowsClientCredential.AllowedImpersonationLevel%2A> property of the <xref:System.ServiceModel.Security.WindowsClientCredential> class, which is accessed as a property of the generic <xref:System.ServiceModel.ChannelFactory%601> class.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="390f5-196">Określając poziom personifikacji anonimowe powoduje, że klient anonimowego logowania się do usługi.</span><span class="sxs-lookup"><span data-stu-id="390f5-196">Specifying an impersonation level of Anonymous causes the client to log on to the service anonymously.</span></span> <span data-ttu-id="390f5-197">W związku z tym usługa muszą zezwalać na logowanie anonimowe, niezależnie od tego, czy personifikacja jest wykonywane.</span><span class="sxs-lookup"><span data-stu-id="390f5-197">The service must therefore allow anonymous logons, regardless of whether impersonation is performed.</span></span>  
  
 <span data-ttu-id="390f5-198">Klienta można określić poziom personifikacji jako <xref:System.Security.Principal.TokenImpersonationLevel.Anonymous>, <xref:System.Security.Principal.TokenImpersonationLevel.Identification>, <xref:System.Security.Principal.TokenImpersonationLevel.Impersonation>, lub <xref:System.Security.Principal.TokenImpersonationLevel.Delegation>.</span><span class="sxs-lookup"><span data-stu-id="390f5-198">The client can specify the impersonation level as <xref:System.Security.Principal.TokenImpersonationLevel.Anonymous>, <xref:System.Security.Principal.TokenImpersonationLevel.Identification>, <xref:System.Security.Principal.TokenImpersonationLevel.Impersonation>, or <xref:System.Security.Principal.TokenImpersonationLevel.Delegation>.</span></span> <span data-ttu-id="390f5-199">Jest generowany tylko token na określonym poziomie, jak pokazano w poniższym kodzie.</span><span class="sxs-lookup"><span data-stu-id="390f5-199">Only a token at the specified level is produced, as shown in the following code.</span></span>  
  
 [!code-csharp[c_ImpersonationAndDelegation#4](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_impersonationanddelegation/cs/source.cs#4)]
 [!code-vb[c_ImpersonationAndDelegation#4](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_impersonationanddelegation/vb/source.vb#4)]  
  
 <span data-ttu-id="390f5-200">W poniższej tabeli określono poziom personifikacji, którego usługi uzyskuje podczas personifikacji z tokenu z pamięci podręcznej.</span><span class="sxs-lookup"><span data-stu-id="390f5-200">The following table specifies the impersonation level the service obtains when impersonating from a cached token.</span></span>  
  
|<span data-ttu-id="390f5-201">`AllowedImpersonationLevel` Wartość</span><span class="sxs-lookup"><span data-stu-id="390f5-201">`AllowedImpersonationLevel` value</span></span>|<span data-ttu-id="390f5-202">Usługa ma `SeImpersonatePrivilege`</span><span class="sxs-lookup"><span data-stu-id="390f5-202">Service has `SeImpersonatePrivilege`</span></span>|<span data-ttu-id="390f5-203">Usługi i klienta są w stanie delegowania</span><span class="sxs-lookup"><span data-stu-id="390f5-203">Service and client are capable of delegation</span></span>|<span data-ttu-id="390f5-204">Tokenu z pamięci podręcznej `ImpersonationLevel`</span><span class="sxs-lookup"><span data-stu-id="390f5-204">Cached token `ImpersonationLevel`</span></span>|  
|---------------------------------------|------------------------------------------|--------------------------------------------------|---------------------------------------|  
|<span data-ttu-id="390f5-205">Anonimowe</span><span class="sxs-lookup"><span data-stu-id="390f5-205">Anonymous</span></span>|<span data-ttu-id="390f5-206">Tak</span><span class="sxs-lookup"><span data-stu-id="390f5-206">Yes</span></span>|<span data-ttu-id="390f5-207">n/d</span><span class="sxs-lookup"><span data-stu-id="390f5-207">n/a</span></span>|<span data-ttu-id="390f5-208">Personifikacja</span><span class="sxs-lookup"><span data-stu-id="390f5-208">Impersonation</span></span>|  
|<span data-ttu-id="390f5-209">Anonimowe</span><span class="sxs-lookup"><span data-stu-id="390f5-209">Anonymous</span></span>|<span data-ttu-id="390f5-210">Nie</span><span class="sxs-lookup"><span data-stu-id="390f5-210">No</span></span>|<span data-ttu-id="390f5-211">n/d</span><span class="sxs-lookup"><span data-stu-id="390f5-211">n/a</span></span>|<span data-ttu-id="390f5-212">Identyfikacja</span><span class="sxs-lookup"><span data-stu-id="390f5-212">Identification</span></span>|  
|<span data-ttu-id="390f5-213">Identyfikacja</span><span class="sxs-lookup"><span data-stu-id="390f5-213">Identification</span></span>|<span data-ttu-id="390f5-214">n/d</span><span class="sxs-lookup"><span data-stu-id="390f5-214">n/a</span></span>|<span data-ttu-id="390f5-215">n/d</span><span class="sxs-lookup"><span data-stu-id="390f5-215">n/a</span></span>|<span data-ttu-id="390f5-216">Identyfikacja</span><span class="sxs-lookup"><span data-stu-id="390f5-216">Identification</span></span>|  
|<span data-ttu-id="390f5-217">Personifikacja</span><span class="sxs-lookup"><span data-stu-id="390f5-217">Impersonation</span></span>|<span data-ttu-id="390f5-218">Tak</span><span class="sxs-lookup"><span data-stu-id="390f5-218">Yes</span></span>|<span data-ttu-id="390f5-219">n/d</span><span class="sxs-lookup"><span data-stu-id="390f5-219">n/a</span></span>|<span data-ttu-id="390f5-220">Personifikacja</span><span class="sxs-lookup"><span data-stu-id="390f5-220">Impersonation</span></span>|  
|<span data-ttu-id="390f5-221">Personifikacja</span><span class="sxs-lookup"><span data-stu-id="390f5-221">Impersonation</span></span>|<span data-ttu-id="390f5-222">Nie</span><span class="sxs-lookup"><span data-stu-id="390f5-222">No</span></span>|<span data-ttu-id="390f5-223">n/d</span><span class="sxs-lookup"><span data-stu-id="390f5-223">n/a</span></span>|<span data-ttu-id="390f5-224">Identyfikacja</span><span class="sxs-lookup"><span data-stu-id="390f5-224">Identification</span></span>|  
|<span data-ttu-id="390f5-225">Delegowanie</span><span class="sxs-lookup"><span data-stu-id="390f5-225">Delegation</span></span>|<span data-ttu-id="390f5-226">Tak</span><span class="sxs-lookup"><span data-stu-id="390f5-226">Yes</span></span>|<span data-ttu-id="390f5-227">Tak</span><span class="sxs-lookup"><span data-stu-id="390f5-227">Yes</span></span>|<span data-ttu-id="390f5-228">Delegowanie</span><span class="sxs-lookup"><span data-stu-id="390f5-228">Delegation</span></span>|  
|<span data-ttu-id="390f5-229">Delegowanie</span><span class="sxs-lookup"><span data-stu-id="390f5-229">Delegation</span></span>|<span data-ttu-id="390f5-230">Yes</span><span class="sxs-lookup"><span data-stu-id="390f5-230">Yes</span></span>|<span data-ttu-id="390f5-231">Nie</span><span class="sxs-lookup"><span data-stu-id="390f5-231">No</span></span>|<span data-ttu-id="390f5-232">Personifikacja</span><span class="sxs-lookup"><span data-stu-id="390f5-232">Impersonation</span></span>|  
|<span data-ttu-id="390f5-233">Delegowanie</span><span class="sxs-lookup"><span data-stu-id="390f5-233">Delegation</span></span>|<span data-ttu-id="390f5-234">Nie</span><span class="sxs-lookup"><span data-stu-id="390f5-234">No</span></span>|<span data-ttu-id="390f5-235">n/d</span><span class="sxs-lookup"><span data-stu-id="390f5-235">n/a</span></span>|<span data-ttu-id="390f5-236">Identyfikacja</span><span class="sxs-lookup"><span data-stu-id="390f5-236">Identification</span></span>|  
  
## <a name="impersonation-level-obtained-from-user-name-credentials-and-cached-token-impersonation"></a><span data-ttu-id="390f5-237">Poziom personifikacji uzyskany z poświadczenia nazwy użytkownika i pamięci podręcznej tokenu personifikacji</span><span class="sxs-lookup"><span data-stu-id="390f5-237">Impersonation Level Obtained from User Name Credentials and Cached Token Impersonation</span></span>  
 <span data-ttu-id="390f5-238">Przekazując usługi swoją nazwę użytkownika i hasło, klienta umożliwia WCF zalogować się jako ten użytkownik, który jest odpowiednikiem ustawienia `AllowedImpersonationLevel` właściwość <xref:System.Security.Principal.TokenImpersonationLevel.Delegation>.</span><span class="sxs-lookup"><span data-stu-id="390f5-238">By passing the service its user name and password, a client enables WCF to log on as that user, which is equivalent to setting the `AllowedImpersonationLevel` property to <xref:System.Security.Principal.TokenImpersonationLevel.Delegation>.</span></span> <span data-ttu-id="390f5-239">( `AllowedImpersonationLevel` Jest dostępny na <xref:System.ServiceModel.Security.WindowsClientCredential> i <xref:System.ServiceModel.Security.HttpDigestClientCredential> klasy.) W poniższej tabeli przedstawiono personifikacji poziom uzyskane podczas usługa odbiera poświadczenia nazwy użytkownika.</span><span class="sxs-lookup"><span data-stu-id="390f5-239">(The `AllowedImpersonationLevel` is available on the <xref:System.ServiceModel.Security.WindowsClientCredential> and <xref:System.ServiceModel.Security.HttpDigestClientCredential> classes.) The following table provides the impersonation level obtained when the service receives user name credentials.</span></span>  
  
|`AllowedImpersonationLevel`|<span data-ttu-id="390f5-240">Usługa ma `SeImpersonatePrivilege`</span><span class="sxs-lookup"><span data-stu-id="390f5-240">Service has `SeImpersonatePrivilege`</span></span>|<span data-ttu-id="390f5-241">Usługi i klienta są w stanie delegowania</span><span class="sxs-lookup"><span data-stu-id="390f5-241">Service and client are capable of delegation</span></span>|<span data-ttu-id="390f5-242">Tokenu z pamięci podręcznej `ImpersonationLevel`</span><span class="sxs-lookup"><span data-stu-id="390f5-242">Cached token `ImpersonationLevel`</span></span>|  
|---------------------------------|------------------------------------------|--------------------------------------------------|---------------------------------------|  
|<span data-ttu-id="390f5-243">n/d</span><span class="sxs-lookup"><span data-stu-id="390f5-243">n/a</span></span>|<span data-ttu-id="390f5-244">Tak</span><span class="sxs-lookup"><span data-stu-id="390f5-244">Yes</span></span>|<span data-ttu-id="390f5-245">Tak</span><span class="sxs-lookup"><span data-stu-id="390f5-245">Yes</span></span>|<span data-ttu-id="390f5-246">Delegowanie</span><span class="sxs-lookup"><span data-stu-id="390f5-246">Delegation</span></span>|  
|<span data-ttu-id="390f5-247">n/d</span><span class="sxs-lookup"><span data-stu-id="390f5-247">n/a</span></span>|<span data-ttu-id="390f5-248">Tak</span><span class="sxs-lookup"><span data-stu-id="390f5-248">Yes</span></span>|<span data-ttu-id="390f5-249">Nie</span><span class="sxs-lookup"><span data-stu-id="390f5-249">No</span></span>|<span data-ttu-id="390f5-250">Personifikacja</span><span class="sxs-lookup"><span data-stu-id="390f5-250">Impersonation</span></span>|  
|<span data-ttu-id="390f5-251">n/d</span><span class="sxs-lookup"><span data-stu-id="390f5-251">n/a</span></span>|<span data-ttu-id="390f5-252">Nie</span><span class="sxs-lookup"><span data-stu-id="390f5-252">No</span></span>|<span data-ttu-id="390f5-253">n/d</span><span class="sxs-lookup"><span data-stu-id="390f5-253">n/a</span></span>|<span data-ttu-id="390f5-254">Identyfikacja</span><span class="sxs-lookup"><span data-stu-id="390f5-254">Identification</span></span>|  
  
## <a name="impersonation-level-obtained-from-s4u-based-impersonation"></a><span data-ttu-id="390f5-255">Poziom personifikacji uzyskany z systemem S4U personifikacji</span><span class="sxs-lookup"><span data-stu-id="390f5-255">Impersonation Level Obtained from S4U-Based Impersonation</span></span>  
  
|<span data-ttu-id="390f5-256">Usługa ma `SeTcbPrivilege`</span><span class="sxs-lookup"><span data-stu-id="390f5-256">Service has `SeTcbPrivilege`</span></span>|<span data-ttu-id="390f5-257">Usługa ma `SeImpersonatePrivilege`</span><span class="sxs-lookup"><span data-stu-id="390f5-257">Service has `SeImpersonatePrivilege`</span></span>|<span data-ttu-id="390f5-258">Usługi i klienta są w stanie delegowania</span><span class="sxs-lookup"><span data-stu-id="390f5-258">Service and client are capable of delegation</span></span>|<span data-ttu-id="390f5-259">Tokenu z pamięci podręcznej `ImpersonationLevel`</span><span class="sxs-lookup"><span data-stu-id="390f5-259">Cached token `ImpersonationLevel`</span></span>|  
|----------------------------------|------------------------------------------|--------------------------------------------------|---------------------------------------|  
|<span data-ttu-id="390f5-260">Tak</span><span class="sxs-lookup"><span data-stu-id="390f5-260">Yes</span></span>|<span data-ttu-id="390f5-261">Tak</span><span class="sxs-lookup"><span data-stu-id="390f5-261">Yes</span></span>|<span data-ttu-id="390f5-262">n/d</span><span class="sxs-lookup"><span data-stu-id="390f5-262">n/a</span></span>|<span data-ttu-id="390f5-263">Personifikacja</span><span class="sxs-lookup"><span data-stu-id="390f5-263">Impersonation</span></span>|  
|<span data-ttu-id="390f5-264">Tak</span><span class="sxs-lookup"><span data-stu-id="390f5-264">Yes</span></span>|<span data-ttu-id="390f5-265">Nie</span><span class="sxs-lookup"><span data-stu-id="390f5-265">No</span></span>|<span data-ttu-id="390f5-266">n/d</span><span class="sxs-lookup"><span data-stu-id="390f5-266">n/a</span></span>|<span data-ttu-id="390f5-267">Identyfikacja</span><span class="sxs-lookup"><span data-stu-id="390f5-267">Identification</span></span>|  
|<span data-ttu-id="390f5-268">Nie</span><span class="sxs-lookup"><span data-stu-id="390f5-268">No</span></span>|<span data-ttu-id="390f5-269">n/d</span><span class="sxs-lookup"><span data-stu-id="390f5-269">n/a</span></span>|<span data-ttu-id="390f5-270">n/d</span><span class="sxs-lookup"><span data-stu-id="390f5-270">n/a</span></span>|<span data-ttu-id="390f5-271">Identyfikacja</span><span class="sxs-lookup"><span data-stu-id="390f5-271">Identification</span></span>|  
  
## <a name="mapping-a-client-certificate-to-a-windows-account"></a><span data-ttu-id="390f5-272">Mapowanie certyfikatu klienta na konto Windows</span><span class="sxs-lookup"><span data-stu-id="390f5-272">Mapping a Client Certificate to a Windows Account</span></span>  
 <span data-ttu-id="390f5-273">Istnieje możliwość dla klienta do samodzielnego uwierzytelnienia usługi przy użyciu certyfikatu, a także mieć mapy usługi klienta do istniejącego konta za pośrednictwem usługi Active Directory.</span><span class="sxs-lookup"><span data-stu-id="390f5-273">It is possible for a client to authenticate itself to a service using a certificate, and to have the service map the client to an existing account through Active Directory.</span></span> <span data-ttu-id="390f5-274">Następujący kody XML pokazuje sposób konfigurowania usługi do mapowania certyfikatu.</span><span class="sxs-lookup"><span data-stu-id="390f5-274">The following XML shows how to configure the service to map the certificate.</span></span>  
  
```xml  
<behaviors>  
  <serviceBehaviors>  
    <behavior name="MapToWindowsAccount">  
      <serviceCredentials>  
        <clientCertificate>  
          <authentication mapClientCertificateToWindowsAccount="true" />  
        </clientCertificate>  
      </serviceCredentials>  
    </behavior>  
  </serviceBehaviors>  
</behaviors>  
```  
  
 <span data-ttu-id="390f5-275">Poniższy kod przedstawia sposób konfigurowania usługi.</span><span class="sxs-lookup"><span data-stu-id="390f5-275">The following code shows how to configure the service.</span></span>  
  
```  
// Create a binding that sets a certificate as the client credential type.  
WSHttpBinding b = new WSHttpBinding();  
b.Security.Message.ClientCredentialType = MessageCredentialType.Certificate;  
  
// Create a service host that maps the certificate to a Windows account.  
Uri httpUri = new Uri("http://localhost/Calculator");  
ServiceHost sh = new ServiceHost(typeof(HelloService), httpUri);  
sh.Credentials.ClientCertificate.Authentication.MapClientCertificateToWindowsAccount = true;  
```  
  
## <a name="delegation"></a><span data-ttu-id="390f5-276">Delegowanie</span><span class="sxs-lookup"><span data-stu-id="390f5-276">Delegation</span></span>  
 <span data-ttu-id="390f5-277">Aby delegować do usługi zaplecza, usługi, należy wykonać Kerberos wielu gałęzi (SSPI bez rezerwowego protokołu NTLM) lub Kerberos bezpośrednie uwierzytelnianie w usłudze zaplecza przy użyciu klienta programu Windows identity.</span><span class="sxs-lookup"><span data-stu-id="390f5-277">To delegate to a back-end service, a service must perform Kerberos multi-leg (SSPI without NTLM fallback) or Kerberos direct authentication to the back-end service using the client’s Windows identity.</span></span> <span data-ttu-id="390f5-278">Aby delegować do usługi zaplecza, należy utworzyć <xref:System.ServiceModel.ChannelFactory%601> i kanał, a następnie komunikować się za pośrednictwem kanału podczas personifikacji klienta.</span><span class="sxs-lookup"><span data-stu-id="390f5-278">To delegate to a back-end service, create a <xref:System.ServiceModel.ChannelFactory%601> and a channel, and then communicate through the channel while impersonating the client.</span></span> <span data-ttu-id="390f5-279">Przy użyciu tej formy delegowania odległość, na którym usługa zaplecza można znaleźć usługi frontonu zależy od poziomu personifikacji osiągnięte przez usługi frontonu.</span><span class="sxs-lookup"><span data-stu-id="390f5-279">With this form of delegation, the distance at which the back-end service can be located from the front-end service depends on the impersonation level achieved by the front-end service.</span></span> <span data-ttu-id="390f5-280">Gdy jest poziom personifikacji <xref:System.Security.Principal.TokenImpersonationLevel.Impersonation>, usługi frontonu i zaplecza, musi być uruchomiona na tym samym komputerze.</span><span class="sxs-lookup"><span data-stu-id="390f5-280">When the impersonation level is <xref:System.Security.Principal.TokenImpersonationLevel.Impersonation>, the front-end and back-end services must be running on the same machine.</span></span> <span data-ttu-id="390f5-281">Gdy jest poziom personifikacji <xref:System.Security.Principal.TokenImpersonationLevel.Delegation>, usługi frontonu i zaplecza mogą być na oddzielnych komputerach lub na tym samym komputerze.</span><span class="sxs-lookup"><span data-stu-id="390f5-281">When the impersonation level is <xref:System.Security.Principal.TokenImpersonationLevel.Delegation>, the front-end and back-end services can be on separate machines or on the same machine.</span></span> <span data-ttu-id="390f5-282">Włączanie delegowania poziom personifikacji wymaga skonfigurowania zasad domeny Windows Aby umożliwić delegowanie.</span><span class="sxs-lookup"><span data-stu-id="390f5-282">Enabling delegation-level impersonation requires that Windows domain policy be configured to permit delegation.</span></span> <span data-ttu-id="390f5-283">Aby uzyskać więcej informacji o konfigurowaniu usługi Active Directory do obsługi delegowania, zobacz [Włączanie uwierzytelniania delegowanego](https://go.microsoft.com/fwlink/?LinkId=99690).</span><span class="sxs-lookup"><span data-stu-id="390f5-283">For more information about configuring Active Directory for delegation support, see [Enabling Delegated Authentication](https://go.microsoft.com/fwlink/?LinkId=99690).</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="390f5-284">Klient uwierzytelnia się do usługi frontonu przy użyciu nazwy użytkownika i hasło, które odnoszą się do konta Windows w usłudze zaplecza, usługi frontonu mogą uwierzytelniać w usłudze zaplecza na podstawie nazwy użytkownika i hasła klienta.</span><span class="sxs-lookup"><span data-stu-id="390f5-284">When a client authenticates to the front-end service using a user name and password that correspond to a Windows account on the back-end service, the front-end service can authenticate to the back-end service by reusing the client’s user name and password.</span></span> <span data-ttu-id="390f5-285">Jest to szczególnie wydajna formą przepływu tożsamości, ponieważ przekazanie nazwy użytkownika i hasła do usługi zaplecza włącza usługę zaplecza w celu wykonania personifikacji, ale go nie stanowi delegowanie, ponieważ nie jest używany protokół Kerberos.</span><span class="sxs-lookup"><span data-stu-id="390f5-285">This is a particularly powerful form of identity flow, because passing user name and password to the back-end service enables the back-end service to perform impersonation, but it does not constitute delegation because Kerberos is not used.</span></span> <span data-ttu-id="390f5-286">Active Directory kontrole delegowanie nie dotyczą użytkownika nazwy i hasła uwierzytelniania.</span><span class="sxs-lookup"><span data-stu-id="390f5-286">Active Directory controls on delegation do not apply to user name and password authentication.</span></span>  
  
### <a name="delegation-ability-as-a-function-of-impersonation-level"></a><span data-ttu-id="390f5-287">Możliwość delegowania w zależności od poziomu personifikacji</span><span class="sxs-lookup"><span data-stu-id="390f5-287">Delegation Ability as a Function of Impersonation Level</span></span>  
  
|<span data-ttu-id="390f5-288">Poziom personifikacji</span><span class="sxs-lookup"><span data-stu-id="390f5-288">Impersonation level</span></span>|<span data-ttu-id="390f5-289">Usługa może wykonywać delegowanie między procesami</span><span class="sxs-lookup"><span data-stu-id="390f5-289">Service can perform cross-process delegation</span></span>|<span data-ttu-id="390f5-290">Usługa może wykonywać delegowanie między komputerami</span><span class="sxs-lookup"><span data-stu-id="390f5-290">Service can perform cross-machine delegation</span></span>|  
|-------------------------|---------------------------------------------------|---------------------------------------------------|  
|<xref:System.Security.Principal.TokenImpersonationLevel.Identification>|<span data-ttu-id="390f5-291">Nie</span><span class="sxs-lookup"><span data-stu-id="390f5-291">No</span></span>|<span data-ttu-id="390f5-292">Nie</span><span class="sxs-lookup"><span data-stu-id="390f5-292">No</span></span>|  
|<xref:System.Security.Principal.TokenImpersonationLevel.Impersonation>|<span data-ttu-id="390f5-293">Yes</span><span class="sxs-lookup"><span data-stu-id="390f5-293">Yes</span></span>|<span data-ttu-id="390f5-294">Nie</span><span class="sxs-lookup"><span data-stu-id="390f5-294">No</span></span>|  
|<xref:System.Security.Principal.TokenImpersonationLevel.Delegation>|<span data-ttu-id="390f5-295">Yes</span><span class="sxs-lookup"><span data-stu-id="390f5-295">Yes</span></span>|<span data-ttu-id="390f5-296">Tak</span><span class="sxs-lookup"><span data-stu-id="390f5-296">Yes</span></span>|  
  
 <span data-ttu-id="390f5-297">Poniższy przykład kodu pokazuje, jak używać delegowania.</span><span class="sxs-lookup"><span data-stu-id="390f5-297">The following code example demonstrates how to use delegation.</span></span>  
  
 [!code-csharp[c_delegation#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_delegation/cs/source.cs#1)]
 [!code-vb[c_delegation#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_delegation/vb/source.vb#1)]  
  
### <a name="how-to-configure-an-application-to-use-constrained-delegation"></a><span data-ttu-id="390f5-298">Jak skonfigurować aplikację do korzystania z delegowania ograniczonego</span><span class="sxs-lookup"><span data-stu-id="390f5-298">How to Configure an Application to Use Constrained Delegation</span></span>  
 <span data-ttu-id="390f5-299">Zanim będzie można Użyj ograniczonego delegowania, nadawca, odbiorca, a kontroler domeny musi być skonfigurowany tak, aby to zrobić.</span><span class="sxs-lookup"><span data-stu-id="390f5-299">Before you can use constrained delegation, the sender, receiver, and the domain controller must be configured to do so.</span></span> <span data-ttu-id="390f5-300">W poniższej procedurze wyszczególniono czynności, które włączyć ograniczone delegowanie.</span><span class="sxs-lookup"><span data-stu-id="390f5-300">The following procedure lists the steps that enable constrained delegation.</span></span> <span data-ttu-id="390f5-301">Aby uzyskać szczegółowe informacje o różnicach między delegowanie i ograniczonego delegowania, zobacz część [systemu Windows Server 2003 Kerberos Extensions](https://go.microsoft.com/fwlink/?LinkId=100194) , w tym artykule omówiono ograniczone dyskusji.</span><span class="sxs-lookup"><span data-stu-id="390f5-301">For details about the differences between delegation and constrained delegation, see the portion of [Windows Server 2003 Kerberos Extensions](https://go.microsoft.com/fwlink/?LinkId=100194) that discusses constrained discussion.</span></span>  
  
1. <span data-ttu-id="390f5-302">Na kontrolerze domeny, należy wyczyścić **konto jest poufne i nie może być delegowane** pole wyboru dla konta, w którym aplikacja kliencka jest uruchomiona.</span><span class="sxs-lookup"><span data-stu-id="390f5-302">On the domain controller, clear the **Account is sensitive and cannot be delegated** check box for the account under which the client application is running.</span></span>  
  
2. <span data-ttu-id="390f5-303">Na kontrolerze domeny, wybierz **konto jest zaufany dla celów delegacji** pole wyboru dla konta, w którym aplikacja kliencka jest uruchomiona.</span><span class="sxs-lookup"><span data-stu-id="390f5-303">On the domain controller, select the **Account is trusted for delegation** check box for the account under which the client application is running.</span></span>  
  
3. <span data-ttu-id="390f5-304">Na kontrolerze domeny, skonfiguruj komputer tak, warstwy środkowej, tak aby jest zaufany dla celów delegacji, klikając **zaufania komputerowi w delegowaniu** opcji.</span><span class="sxs-lookup"><span data-stu-id="390f5-304">On the domain controller, configure the middle tier computer so that it is trusted for delegation, by clicking the **Trust computer for delegation** option.</span></span>  
  
4. <span data-ttu-id="390f5-305">Na kontrolerze domeny, skonfiguruj komputer tak warstwy środkowej w taki sposób, aby używały ograniczonego delegowania, klikając **Ufaj temu komputerowi w delegowaniu tylko do określonych usług** opcji.</span><span class="sxs-lookup"><span data-stu-id="390f5-305">On the domain controller, configure the middle tier computer to use constrained delegation, by clicking the **Trust this computer for delegation to specified services only** option.</span></span>  
  
 <span data-ttu-id="390f5-306">Aby uzyskać bardziej szczegółowe instrukcje na temat konfigurowania ograniczonego delegowania zobacz następujące tematy w witrynie MSDN:</span><span class="sxs-lookup"><span data-stu-id="390f5-306">For more detailed instructions about configuring constrained delegation, see the following topics on MSDN:</span></span>  
  
-   [<span data-ttu-id="390f5-307">Rozwiązywanie problemów z delegowania protokołu Kerberos</span><span class="sxs-lookup"><span data-stu-id="390f5-307">Troubleshooting Kerberos Delegation</span></span>](https://go.microsoft.com/fwlink/?LinkId=36724)  
  
-   [<span data-ttu-id="390f5-308">Protokół Kerberos przejścia i ograniczone delegowanie</span><span class="sxs-lookup"><span data-stu-id="390f5-308">Kerberos Protocol Transition and Constrained Delegation</span></span>](https://go.microsoft.com/fwlink/?LinkId=36725)  
  
## <a name="see-also"></a><span data-ttu-id="390f5-309">Zobacz także</span><span class="sxs-lookup"><span data-stu-id="390f5-309">See also</span></span>

- <xref:System.ServiceModel.OperationBehaviorAttribute>
- <xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A>
- <xref:System.ServiceModel.ImpersonationOption>
- <xref:System.ServiceModel.ServiceSecurityContext.WindowsIdentity%2A>
- <xref:System.ServiceModel.ServiceSecurityContext>
- <xref:System.Security.Principal.WindowsIdentity>
- <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior>
- <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior.ImpersonateCallerForAllOperations%2A>
- <xref:System.ServiceModel.ServiceHost>
- <xref:System.ServiceModel.Security.WindowsClientCredential.AllowedImpersonationLevel%2A>
- <xref:System.ServiceModel.Security.WindowsClientCredential>
- <xref:System.ServiceModel.ChannelFactory%601>
- <xref:System.Security.Principal.TokenImpersonationLevel.Identification>
- [<span data-ttu-id="390f5-310">Korzystanie z personifikacji z zabezpieczeniami transportu</span><span class="sxs-lookup"><span data-stu-id="390f5-310">Using Impersonation with Transport Security</span></span>](../../../../docs/framework/wcf/feature-details/using-impersonation-with-transport-security.md)
- [<span data-ttu-id="390f5-311">Personifikowanie klienta</span><span class="sxs-lookup"><span data-stu-id="390f5-311">Impersonating the Client</span></span>](../../../../docs/framework/wcf/samples/impersonating-the-client.md)
- [<span data-ttu-id="390f5-312">Instrukcje: Personifikowanie klienta w usłudze</span><span class="sxs-lookup"><span data-stu-id="390f5-312">How to: Impersonate a Client on a Service</span></span>](../../../../docs/framework/wcf/how-to-impersonate-a-client-on-a-service.md)
- [<span data-ttu-id="390f5-313">Narzędzie do obsługi metadanych elementu ServiceModel (Svcutil.exe)</span><span class="sxs-lookup"><span data-stu-id="390f5-313">ServiceModel Metadata Utility Tool (Svcutil.exe)</span></span>](../../../../docs/framework/wcf/servicemodel-metadata-utility-tool-svcutil-exe.md)
