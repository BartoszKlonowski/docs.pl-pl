---
title: Używanie utraconych kolejek na potrzeby obsługi transferów komunikatów zakończonych niepowodzeniem
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
ms.assetid: 9e891c6a-d960-45ea-904f-1a00e202d61a
ms.openlocfilehash: 268f14bc7294a4cbe6f7253dc7f3c71d89985133
ms.sourcegitcommit: a4f9b754059f0210e29ae0578363a27b9ba84b64
ms.translationtype: MT
ms.contentlocale: pl-PL
ms.lasthandoff: 12/05/2019
ms.locfileid: "74837964"
---
# <a name="using-dead-letter-queues-to-handle-message-transfer-failures"></a><span data-ttu-id="7fae0-102">Używanie utraconych kolejek na potrzeby obsługi transferów komunikatów zakończonych niepowodzeniem</span><span class="sxs-lookup"><span data-stu-id="7fae0-102">Using Dead-Letter Queues to Handle Message Transfer Failures</span></span>
<span data-ttu-id="7fae0-103">Komunikaty w kolejce mogą kończyć się niepowodzeniem.</span><span class="sxs-lookup"><span data-stu-id="7fae0-103">Queued messages can fail delivery.</span></span> <span data-ttu-id="7fae0-104">Te nieudane komunikaty są rejestrowane w kolejce utraconych wiadomości.</span><span class="sxs-lookup"><span data-stu-id="7fae0-104">These failed messages are recorded in a dead-letter queue.</span></span> <span data-ttu-id="7fae0-105">Nieudane dostarczenie może być spowodowane przyczynami, takimi jak awarie sieci, kolejka usunięta, pełna kolejka, niepowodzenie uwierzytelniania lub niepowodzenie dostarczania na czas.</span><span class="sxs-lookup"><span data-stu-id="7fae0-105">The failed delivery can be caused by reasons such as network failures, a deleted queue, a full queue, authentication failure, or a failure to deliver on time.</span></span>  
  
 <span data-ttu-id="7fae0-106">Wiadomości w kolejce mogą pozostawać w kolejce przez dłuższy czas, jeśli aplikacja do odbioru nie odczytuje ich z kolejki w odpowiednim czasie.</span><span class="sxs-lookup"><span data-stu-id="7fae0-106">Queued messages can remain in the queue for a long time if the receiving application does not read them from the queue in a timely fashion.</span></span> <span data-ttu-id="7fae0-107">Takie zachowanie może być nieodpowiednie dla komunikatów zależnych od czasu.</span><span class="sxs-lookup"><span data-stu-id="7fae0-107">This behavior may not be appropriate for time-sensitive messages.</span></span> <span data-ttu-id="7fae0-108">Komunikaty zależne od czasu mają ustawioną właściwość Time to Live (TTL) ustawianą w powiązaniu umieszczonym w kolejce, która wskazuje, jak długo komunikaty mogą znajdować się w kolejce przed ich wygaśnięciem.</span><span class="sxs-lookup"><span data-stu-id="7fae0-108">Time-sensitive messages have a Time to Live (TTL) property set in the queued binding, which indicates how long the messages can be in the queue before they must expire.</span></span> <span data-ttu-id="7fae0-109">Wygasłe komunikaty są wysyłane do kolejki specjalnej zwanej kolejką utraconych wiadomości.</span><span class="sxs-lookup"><span data-stu-id="7fae0-109">Expired messages are sent to a special queue called the dead-letter queue.</span></span> <span data-ttu-id="7fae0-110">Komunikaty mogą być również umieszczane w kolejce utraconych z innych powodów, takich jak przekroczenie limitu przydziału kolejki lub z powodu błędu uwierzytelniania.</span><span class="sxs-lookup"><span data-stu-id="7fae0-110">Messages can also be put in a dead-letter queue for other reasons, such as exceeding a queue quota or because of authentication failure.</span></span>  
  
 <span data-ttu-id="7fae0-111">Ogólnie rzecz biorąc, aplikacje zapisują logikę kompensacji do odczytu wiadomości z kolejki utraconych wiadomości i przyczyn niepowodzenia.</span><span class="sxs-lookup"><span data-stu-id="7fae0-111">Generally, applications write compensation logic to read messages from the dead-letter queue and failure reasons.</span></span> <span data-ttu-id="7fae0-112">Logika kompensacji zależy od przyczyny błędu.</span><span class="sxs-lookup"><span data-stu-id="7fae0-112">The compensation logic depends on the cause of the failure.</span></span> <span data-ttu-id="7fae0-113">Na przykład w przypadku niepowodzenia uwierzytelniania można poprawić certyfikat dołączony do wiadomości i ponownie wysłać wiadomość.</span><span class="sxs-lookup"><span data-stu-id="7fae0-113">For example, in the case of authentication failure, you can correct the certificate attached with the message and resend the message.</span></span> <span data-ttu-id="7fae0-114">Jeśli dostarczenie nie powiodło się, ponieważ osiągnięto limit przydziału kolejki docelowej, możesz ponowić próbę dostarczenia w ramach tej metody, aby rozwiązać problem z limitem przydziału.</span><span class="sxs-lookup"><span data-stu-id="7fae0-114">If delivery failed because the target queue quota was reached, you can reattempt delivery in the hope that the quota problem was resolved.</span></span>  
  
 <span data-ttu-id="7fae0-115">Większość systemów kolejkowania ma kolejkę utraconych wiadomości w całej systemie, w której przechowywane są wszystkie komunikaty zakończone niepowodzeniem z tego systemu.</span><span class="sxs-lookup"><span data-stu-id="7fae0-115">Most queuing systems have a system-wide dead-letter queue where all failed messages from that system are stored.</span></span> <span data-ttu-id="7fae0-116">Usługa kolejkowania komunikatów (MSMQ) oferuje dwie kolejki utraconych wiadomości w całym systemie: transakcyjna kolejka utraconych wiadomości w całej systemie, która przechowuje komunikaty, które przestaną być dostarczone do kolejki transakcyjnej, oraz nietransakcyjnej kolejki utraconych wiadomości w całej systemie, która przechowuje komunikaty, które przekończyły się niepowodzeniem dostarczania do kolejki nietransakcyjnej.</span><span class="sxs-lookup"><span data-stu-id="7fae0-116">Message Queuing (MSMQ) provides two system-wide dead-letter queues: a transactional system-wide dead-letter queue that stores messages that failed delivery to the transactional queue and a non-transactional system-wide dead-letter queue that stores messages that failed delivery to the non-transactional queue.</span></span> <span data-ttu-id="7fae0-117">Jeśli dwa klienci wysyłają komunikaty do dwóch różnych usług, w związku z czym różne kolejki w programie WCF współużytkują tę samą usługę MSMQ do wysłania</span><span class="sxs-lookup"><span data-stu-id="7fae0-117">If two clients are sending messages to two different services, and therefore different queues in WCF are sharing the same MSMQ service to send, then it is possible to have a mix of messages in the system dead-letter queue.</span></span> <span data-ttu-id="7fae0-118">Nie zawsze jest to optymalna.</span><span class="sxs-lookup"><span data-stu-id="7fae0-118">This is not always optimal.</span></span> <span data-ttu-id="7fae0-119">W kilku przypadkach (na przykład) można nie chcieć, aby jeden klient mógł odczytywać komunikaty innego klienta z kolejki utraconych wiadomości.</span><span class="sxs-lookup"><span data-stu-id="7fae0-119">In several cases (security, for example), you may not want one client to read another client's messages from a dead-letter queue.</span></span> <span data-ttu-id="7fae0-120">Udostępniona Kolejka utraconych wiadomości wymaga również od klientów przejrzenia kolejki w celu znalezienia wysyłanego komunikatu, co może być niezwykle kosztowne w oparciu o liczbę komunikatów w kolejce utraconych wiadomości.</span><span class="sxs-lookup"><span data-stu-id="7fae0-120">A shared dead-letter queue also requires clients to browse through the queue to find a message that they sent, which can be prohibitively expensive based on the number of messages in the dead-letter queue.</span></span> <span data-ttu-id="7fae0-121">W związku z tym w`NetMsmqBinding`WCF `MsmqIntegrationBinding,` i usługi MSMQ w systemie Windows Vista zapewniają niestandardową kolejkę utraconych wiadomości (nazywaną czasami kolejką utraconych wiadomości specyficzną dla aplikacji).</span><span class="sxs-lookup"><span data-stu-id="7fae0-121">Therefore, in WCF`NetMsmqBinding`, `MsmqIntegrationBinding,` and MSMQ on Windows Vista provide a custom dead-letter queue (sometimes referred to as an application-specific dead-letter queue).</span></span>  
  
 <span data-ttu-id="7fae0-122">Niestandardowa Kolejka utraconych wiadomości zapewnia izolację między klientami, którzy korzystają z tej samej usługi MSMQ do wysyłania wiadomości.</span><span class="sxs-lookup"><span data-stu-id="7fae0-122">The custom dead-letter queue provides isolation between clients that share the same MSMQ service to send messages.</span></span>  
  
 <span data-ttu-id="7fae0-123">W systemach [!INCLUDE[ws2003](../../../../includes/ws2003-md.md)] i [!INCLUDE[wxp](../../../../includes/wxp-md.md)]funkcja Windows Communication Foundation (WCF) zapewnia kolejkę utraconych wiadomości w całej systemie dla wszystkich aplikacji klienckich umieszczonych w kolejce.</span><span class="sxs-lookup"><span data-stu-id="7fae0-123">On [!INCLUDE[ws2003](../../../../includes/ws2003-md.md)] and [!INCLUDE[wxp](../../../../includes/wxp-md.md)], Windows Communication Foundation (WCF) provides a system-wide dead-letter queue for all queued client applications.</span></span> <span data-ttu-id="7fae0-124">W systemie Windows Vista funkcja WCF udostępnia kolejkę utraconych wiadomości dla każdej Kolejkowanej aplikacji klienckiej.</span><span class="sxs-lookup"><span data-stu-id="7fae0-124">On Windows Vista, WCF provides a dead-letter queue for each queued client application.</span></span>  
  
## <a name="specifying-use-of-the-dead-letter-queue"></a><span data-ttu-id="7fae0-125">Określanie użycia kolejki utraconych wiadomości</span><span class="sxs-lookup"><span data-stu-id="7fae0-125">Specifying Use of the Dead-Letter Queue</span></span>  
 <span data-ttu-id="7fae0-126">Kolejka utraconych wiadomości znajduje się w Menedżerze kolejek aplikacji wysyłającej.</span><span class="sxs-lookup"><span data-stu-id="7fae0-126">A dead-letter queue is in the queue manager of the sending application.</span></span> <span data-ttu-id="7fae0-127">Przechowuje komunikaty, które wygasły lub które nie powiodły się.</span><span class="sxs-lookup"><span data-stu-id="7fae0-127">It stores messages that have expired or that have failed transfer or delivery.</span></span>  
  
 <span data-ttu-id="7fae0-128">Powiązanie ma następujące właściwości kolejki utraconych wiadomości:</span><span class="sxs-lookup"><span data-stu-id="7fae0-128">The binding has the following dead-letter queue properties:</span></span>  
  
- <xref:System.ServiceModel.MsmqBindingBase.DeadLetterQueue%2A>  
  
- <xref:System.ServiceModel.MsmqBindingBase.CustomDeadLetterQueue%2A>  
  
## <a name="reading-messages-from-the-dead-letter-queue"></a><span data-ttu-id="7fae0-129">Odczytywanie wiadomości z kolejki utraconych wiadomości</span><span class="sxs-lookup"><span data-stu-id="7fae0-129">Reading Messages from the Dead-Letter Queue</span></span>  
 <span data-ttu-id="7fae0-130">Aplikacja, która odczytuje komunikaty z kolejki utraconych wiadomości, jest podobna do usługi WCF, która odczytuje z kolejki aplikacji, z wyjątkiem następujących drobnych różnic:</span><span class="sxs-lookup"><span data-stu-id="7fae0-130">An application that reads messages out of a dead-letter queue is similar to a WCF service that reads from an application queue, except for the following minor differences:</span></span>  
  
- <span data-ttu-id="7fae0-131">Aby można było odczytać wiadomości z kolejki utraconych wiadomości transakcyjnych systemu, Uniform Resource Identifier (URI) musi mieć postać: net. MSMQ://localhost/system $;D eadXact.</span><span class="sxs-lookup"><span data-stu-id="7fae0-131">To read messages from a system transactional dead-letter queue, the Uniform Resource Identifier (URI) must be of the form: net.msmq://localhost/system$;DeadXact.</span></span>  
  
- <span data-ttu-id="7fae0-132">Aby można było odczytać wiadomości z nietransakcyjnej kolejki utraconych wiadomości, identyfikator URI musi mieć postać: net. MSMQ://localhost/system $;D eadLetter.</span><span class="sxs-lookup"><span data-stu-id="7fae0-132">To read messages from a system non-transactional dead-letter queue, the URI must be of the form: net.msmq://localhost/system$;DeadLetter.</span></span>  
  
- <span data-ttu-id="7fae0-133">Aby można było odczytać wiadomości z niestandardowej kolejki utraconych wiadomości, identyfikator URI musi mieć postać: net. MSMQ://localhost/Private/\<*Custom-DLQ-name*> gdzie *Custom-DLQ-Name* to nazwa niestandardowej kolejki utraconych wiadomości.</span><span class="sxs-lookup"><span data-stu-id="7fae0-133">To read messages from a custom dead-letter queue, the URI must be of the form:net.msmq://localhost/private/\<*custom-dlq-name*> where *custom-dlq-name* is the name of the custom dead-letter queue.</span></span>  
  
 <span data-ttu-id="7fae0-134">Aby uzyskać więcej informacji o sposobie adresowania kolejek, zobacz [punkty końcowe usługi i adresowanie kolejki](../../../../docs/framework/wcf/feature-details/service-endpoints-and-queue-addressing.md).</span><span class="sxs-lookup"><span data-stu-id="7fae0-134">For more information about how to address queues, see [Service Endpoints and Queue Addressing](../../../../docs/framework/wcf/feature-details/service-endpoints-and-queue-addressing.md).</span></span>  
  
 <span data-ttu-id="7fae0-135">Stos WCF w odbiorniku pasuje do adresów, na których nasłuchuje usługa, przy użyciu adresu w wiadomości.</span><span class="sxs-lookup"><span data-stu-id="7fae0-135">The WCF stack on the receiver matches addresses that the service is listening on with the address on the message.</span></span> <span data-ttu-id="7fae0-136">Jeśli adresy są zgodne, komunikat jest wysyłany; Jeśli nie, komunikat nie jest wysyłany.</span><span class="sxs-lookup"><span data-stu-id="7fae0-136">If the addresses match, the message is dispatched; if not, the message is not dispatched.</span></span> <span data-ttu-id="7fae0-137">Może to spowodować problemy podczas odczytywania z kolejki utraconych wiadomości, ponieważ komunikaty w kolejce utraconych wiadomości są zwykle kierowane do usługi, a nie do usługi kolejki utraconych wiadomości.</span><span class="sxs-lookup"><span data-stu-id="7fae0-137">This can cause problems when reading from the dead-letter queue, because messages in the dead-letter queue are typically addressed to the service and not the dead-letter queue service.</span></span> <span data-ttu-id="7fae0-138">W związku z tym odczytywanie z kolejki utraconych wiadomości musi spowodować zainstalowanie filtru adresów `ServiceBehavior`, który nakazuje stosowi dopasowanie wszystkich komunikatów w kolejce niezależnie od adresata.</span><span class="sxs-lookup"><span data-stu-id="7fae0-138">Therefore, the service reading from the dead-letter queue must install an address filter `ServiceBehavior` that instructs the stack to match all messages in the queue independently of the addressee.</span></span> <span data-ttu-id="7fae0-139">W szczególnych przypadkach należy dodać `ServiceBehavior` z parametrem <xref:System.ServiceModel.AddressFilterMode.Any> do usługi odczytującej komunikaty z kolejki utraconych wiadomości.</span><span class="sxs-lookup"><span data-stu-id="7fae0-139">Specifically, you must add a `ServiceBehavior` with the <xref:System.ServiceModel.AddressFilterMode.Any> parameter to the service reading messages from the dead-letter queue.</span></span>  
  
## <a name="poison-message-handling-from-the-dead-letter-queue"></a><span data-ttu-id="7fae0-140">Obsługa skażonych komunikatów z kolejki utraconych wiadomości</span><span class="sxs-lookup"><span data-stu-id="7fae0-140">Poison Message Handling from the Dead-Letter Queue</span></span>  
 <span data-ttu-id="7fae0-141">Obsługa skażonych komunikatów jest dostępna w przypadku kolejek z utraconymi komunikatami z pewnymi warunkami.</span><span class="sxs-lookup"><span data-stu-id="7fae0-141">Poison message handling is available on dead-letter queues, with some conditions.</span></span> <span data-ttu-id="7fae0-142">Ponieważ nie można tworzyć podkolejek z kolejek systemowych, podczas odczytywania z kolejki utraconych wiadomości systemowych nie można ustawić `ReceiveErrorHandling` na `Move`.</span><span class="sxs-lookup"><span data-stu-id="7fae0-142">Because you cannot create sub-queues from system queues, when reading from the system dead-letter queue, the `ReceiveErrorHandling` cannot be set to `Move`.</span></span> <span data-ttu-id="7fae0-143">Należy pamiętać, że w przypadku odczytywania z niestandardowej kolejki utraconych wiadomości można mieć kolejki podrzędne i dlatego `Move` jest prawidłową dyspozycją dla trującego komunikatu.</span><span class="sxs-lookup"><span data-stu-id="7fae0-143">Note that if you are reading from a custom dead-letter queue, you can have sub-queues and, therefore, `Move` is a valid disposition for the poison message.</span></span>  
  
 <span data-ttu-id="7fae0-144">Gdy `ReceiveErrorHandling` jest ustawiona na `Reject`, podczas odczytywania z niestandardowej kolejki utraconych wiadomości, Trująca wiadomość jest umieszczana w kolejce utraconych wiadomości systemowych.</span><span class="sxs-lookup"><span data-stu-id="7fae0-144">When `ReceiveErrorHandling` is set to `Reject`, when reading from the custom dead letter queue, the poison message is put in the system dead-letter queue.</span></span> <span data-ttu-id="7fae0-145">W przypadku odczytywania z kolejki utraconych wiadomości systemowych komunikat jest porzucany (przeczyszczany).</span><span class="sxs-lookup"><span data-stu-id="7fae0-145">If reading from the system dead-letter queue, the message is dropped (purged).</span></span> <span data-ttu-id="7fae0-146">Odrzucanie z kolejki utraconych wiadomości systemowych w usłudze MSMQ powoduje porzucanie (przeczyszczanie) wiadomości.</span><span class="sxs-lookup"><span data-stu-id="7fae0-146">A reject from a system dead-letter queue in MSMQ drops (purges) the message.</span></span>  
  
## <a name="example"></a><span data-ttu-id="7fae0-147">Przykład</span><span class="sxs-lookup"><span data-stu-id="7fae0-147">Example</span></span>  
 <span data-ttu-id="7fae0-148">Poniższy przykład pokazuje, jak utworzyć kolejkę utraconych wiadomości i jak używać jej do przetwarzania wygasłych komunikatów.</span><span class="sxs-lookup"><span data-stu-id="7fae0-148">The following example shows how to create a dead-letter queue and how to use it to process expired messages.</span></span> <span data-ttu-id="7fae0-149">Przykład jest oparty na przykładzie w [instrukcje: Wymiana komunikatów umieszczonych w kolejce z punktami końcowymi WCF](../../../../docs/framework/wcf/feature-details/how-to-exchange-queued-messages-with-wcf-endpoints.md).</span><span class="sxs-lookup"><span data-stu-id="7fae0-149">The example is based on the example in [How to: Exchange Queued Messages with WCF Endpoints](../../../../docs/framework/wcf/feature-details/how-to-exchange-queued-messages-with-wcf-endpoints.md).</span></span> <span data-ttu-id="7fae0-150">Poniższy przykład pokazuje, jak napisać kod klienta do usługi przetwarzania zamówień, która używa kolejki utraconych wiadomości dla każdej aplikacji.</span><span class="sxs-lookup"><span data-stu-id="7fae0-150">The following example shows how to write the client code to the order processing service that uses a dead-letter queue for each application.</span></span> <span data-ttu-id="7fae0-151">W przykładzie pokazano również, jak przetwarzać komunikaty z kolejki utraconych wiadomości.</span><span class="sxs-lookup"><span data-stu-id="7fae0-151">The example also shows how to process messages from the dead-letter queue.</span></span>  
  
 <span data-ttu-id="7fae0-152">Poniżej przedstawiono kod dla klienta, który określa kolejkę utraconych wiadomości dla każdej aplikacji.</span><span class="sxs-lookup"><span data-stu-id="7fae0-152">The following is code for a client that specifies a dead-letter queue for each application.</span></span>  
  
 [!code-csharp[S_DeadLetter#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/s_deadletter/cs/client.cs#1)]
 [!code-vb[S_DeadLetter#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/s_deadletter/vb/client.vb#1)]  
  
 <span data-ttu-id="7fae0-153">Poniżej znajduje się kod pliku konfiguracji klienta.</span><span class="sxs-lookup"><span data-stu-id="7fae0-153">The following is code for the client configuration file.</span></span>  

 <span data-ttu-id="7fae0-154">Poniżej przedstawiono kod dla komunikatów przetwarzania usługi z kolejki utraconych wiadomości.</span><span class="sxs-lookup"><span data-stu-id="7fae0-154">The following is code for a service processing messages from a dead-letter queue.</span></span>  
  
 [!code-csharp[S_DeadLetter#3](../../../../samples/snippets/csharp/VS_Snippets_CFX/s_deadletter/cs/dlservice.cs#3)]
 [!code-vb[S_DeadLetter#3](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/s_deadletter/vb/dlservice.vb#3)]  
  
 <span data-ttu-id="7fae0-155">Poniżej znajduje się kod pliku konfiguracji usługi kolejki utraconych wiadomości.</span><span class="sxs-lookup"><span data-stu-id="7fae0-155">The following is code for the dead-letter queue service configuration file.</span></span>  

## <a name="see-also"></a><span data-ttu-id="7fae0-156">Zobacz także</span><span class="sxs-lookup"><span data-stu-id="7fae0-156">See also</span></span>

- [<span data-ttu-id="7fae0-157">Omówienie kolejek</span><span class="sxs-lookup"><span data-stu-id="7fae0-157">Queues Overview</span></span>](../../../../docs/framework/wcf/feature-details/queues-overview.md)
- [<span data-ttu-id="7fae0-158">Instrukcje: wymiana komunikatów znajdujących się w kolejce z punktami końcowymi WCF</span><span class="sxs-lookup"><span data-stu-id="7fae0-158">How to: Exchange Queued Messages with WCF Endpoints</span></span>](../../../../docs/framework/wcf/feature-details/how-to-exchange-queued-messages-with-wcf-endpoints.md)
- [<span data-ttu-id="7fae0-159">Obsługa komunikatów zanieczyszczonych</span><span class="sxs-lookup"><span data-stu-id="7fae0-159">Poison Message Handling</span></span>](../../../../docs/framework/wcf/feature-details/poison-message-handling.md)
