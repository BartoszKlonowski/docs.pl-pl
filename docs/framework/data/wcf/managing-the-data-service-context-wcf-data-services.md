---
title: Zarządzanie kontekstem usługi danych (Usługi danych programu WCF)
ms.date: 03/30/2017
ms.assetid: 15b19d09-7de7-4638-9556-6ef396cc45ec
ms.openlocfilehash: 104b87a9fdfc1e461b708acf7a75c8327ad182af
ms.sourcegitcommit: 79a2d6a07ba4ed08979819666a0ee6927bbf1b01
ms.translationtype: MT
ms.contentlocale: pl-PL
ms.lasthandoff: 11/28/2019
ms.locfileid: "74568936"
---
# <a name="managing-the-data-service-context-wcf-data-services"></a>Zarządzanie kontekstem usługi danych (Usługi danych programu WCF)
Klasa <xref:System.Data.Services.Client.DataServiceContext> hermetyzuje operacje, które są obsługiwane w odniesieniu do określonej usługi danych. Chociaż usługi OData są bezstanowe, kontekst nie jest. W związku z tym można użyć klasy <xref:System.Data.Services.Client.DataServiceContext>, aby zachować stan na kliencie między interakcjami z usługą danych w celu obsługi funkcji, takich jak zarządzanie zmianami. Ta klasa zarządza także tożsamościami i śledzi zmiany.  
  
## <a name="merge-options-and-identity-resolution"></a>Opcje scalania i rozpoznawanie tożsamości  
 Po wykonaniu <xref:System.Data.Services.Client.DataServiceQuery%601> jednostki w kanale informacyjnym odpowiedzi są uwzględniane w obiektach. Aby uzyskać więcej informacji, zobacz [obiekt materializację](object-materialization-wcf-data-services.md). Sposób, w jaki wpisy w komunikacie odpowiedzi są uwzględniane w obiektach, odbywa się na podstawie rozpoznawania tożsamości i zależy od opcji scalania, w której wykonano zapytanie. Gdy wiele zapytań lub żądań ładowania jest wykonywanych w zakresie jednego <xref:System.Data.Services.Client.DataServiceContext>, klient Usługi danych programu WCF śledzi tylko pojedyncze wystąpienie obiektu o określonej wartości klucza. Ten klucz, który jest używany do rozpoznawania tożsamości, jednoznacznie identyfikuje jednostkę.  
  
 Domyślnie klient materializuje tylko wpis w kanale informacyjnym odpowiedzi do obiektu dla jednostek, które nie są jeszcze śledzone przez <xref:System.Data.Services.Client.DataServiceContext>. Oznacza to, że zmiany w obiektach znajdujących się już w pamięci podręcznej nie są zastępowane. To zachowanie jest kontrolowane przez określenie wartości <xref:System.Data.Services.Client.MergeOption> dla zapytań i operacji ładowania. Ta opcja jest określona przez ustawienie właściwości <xref:System.Data.Services.Client.DataServiceContext.MergeOption%2A> w <xref:System.Data.Services.Client.DataServiceContext>. Domyślna wartość opcji scalania to <xref:System.Data.Services.Client.MergeOption.AppendOnly>. To tylko obiekty materializuje dla jednostek, które nie są już śledzone, co oznacza, że istniejące obiekty nie są zastępowane. Innym sposobem, aby zapobiec zastępowaniu zmian w obiektach na kliencie przed zastąpieniem ich przez aktualizacje z usługi danych, jest określenie <xref:System.Data.Services.Client.MergeOption.PreserveChanges>. Po określeniu <xref:System.Data.Services.Client.MergeOption.OverwriteChanges>wartości obiektów na kliencie są zastępowane najnowszymi wartościami z wpisów w kanale informacyjnym odpowiedzi, nawet jeśli zostały już wprowadzone zmiany w tych obiektach. Gdy jest używana opcja scalania <xref:System.Data.Services.Client.MergeOption.NoTracking>, <xref:System.Data.Services.Client.DataServiceContext> nie może wysyłać zmian wprowadzonych w obiektach klienta do usługi danych. W przypadku tej opcji zmiany są zawsze zastępowane wartościami z usługi danych.  
  
## <a name="managing-concurrency"></a>Zarządzanie współbieżnością  
 Usługa OData obsługuje optymistyczną współbieżność, która umożliwia usłudze danych wykrywanie konfliktów aktualizacji. Dostawcę usługi danych można skonfigurować w taki sposób, że usługa danych sprawdza zmiany w jednostkach za pomocą tokenu współbieżności. Ten token zawiera jedną lub więcej właściwości typu jednostki, które są sprawdzane przez usługę danych w celu ustalenia, czy zasób został zmieniony. Tokeny współbieżności, które są zawarte w nagłówku eTag żądań do i odpowiedzi z usługi danych, są zarządzane przez klienta Usługi danych programu WCF. Aby uzyskać więcej informacji, zobacz [Aktualizowanie usługi danych](updating-the-data-service-wcf-data-services.md).  
  
 <xref:System.Data.Services.Client.DataServiceContext> śledzi zmiany wprowadzone w obiektach, które zostały zgłoszone ręcznie przy użyciu <xref:System.Data.Services.Client.DataServiceContext.AddObject%2A>, <xref:System.Data.Services.Client.DataServiceContext.UpdateObject%2A>i <xref:System.Data.Services.Client.DataServiceContext.DeleteObject%2A>lub przez <xref:System.Data.Services.Client.DataServiceCollection%601>. Po wywołaniu metody <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A> klient wysyła zmiany z powrotem do usługi danych. <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A> może zakończyć się niepowodzeniem, gdy zmiany danych w kliencie spowodują konflikt ze zmianami w usłudze danych. W takim przypadku należy ponownie wykonać zapytanie o zasób jednostki w celu uzyskania danych aktualizacji. Aby zastąpić zmiany w usłudze danych, wykonaj zapytanie przy użyciu opcji scalania <xref:System.Data.Services.Client.MergeOption.PreserveChanges>. Po ponownym wywołaniu <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A> zmiany przechowywane na kliencie są utrwalane w usłudze danych, o ile inne zmiany nie zostały jeszcze wprowadzone do zasobu w usłudze danych.  
  
## <a name="saving-changes"></a>Zapisywanie zmian  
 Zmiany są śledzone w wystąpieniu <xref:System.Data.Services.Client.DataServiceContext>, ale nie są natychmiast wysyłane do serwera. Po zakończeniu wymaganych zmian dla określonego działania Wywołaj <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A>, aby przesłać wszystkie zmiany do usługi danych. Po ukończeniu operacji <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A> zwracany jest obiekt <xref:System.Data.Services.Client.DataServiceResponse>. Obiekt <xref:System.Data.Services.Client.DataServiceResponse> zawiera sekwencję obiektów <xref:System.Data.Services.Client.OperationResponse>, które z kolei zawierają sekwencję <xref:System.Data.Services.Client.EntityDescriptor> lub <xref:System.Data.Services.Client.LinkDescriptor> wystąpienia, które reprezentują zmiany, które zostały utrwalone lub podjęte. W przypadku utworzenia lub zmodyfikowania jednostki w usłudze danych <xref:System.Data.Services.Client.EntityDescriptor> zawiera odwołanie do zaktualizowanej jednostki, w tym wszystkie wartości właściwości wygenerowane przez serwer, takie jak wygenerowana `ProductID` wartość w poprzednim przykładzie. Biblioteka klienta automatycznie aktualizuje obiekt .NET Framework tak, aby miał nowe wartości.  
  
 W przypadku pomyślnych operacji wstawiania i aktualizowania Właściwość State obiektu <xref:System.Data.Services.Client.EntityDescriptor> lub <xref:System.Data.Services.Client.LinkDescriptor> skojarzonego z operacją jest ustawiona na <xref:System.Data.Services.Client.EntityStates.Unchanged> i nowe wartości są scalane przy użyciu <xref:System.Data.Services.Client.MergeOption.OverwriteChanges>. W przypadku niepowodzenia operacji INSERT, Update lub DELETE w usłudze danych stan jednostki pozostaje taki sam, jak poprzednio <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A> został wywołany, a właściwość <xref:System.Data.Services.Client.OperationResponse.Error%2A> <xref:System.Data.Services.Client.OperationResponse> jest ustawiona na <xref:System.Data.Services.Client.DataServiceRequestException>, która zawiera informacje o błędzie. Aby uzyskać więcej informacji, zobacz [Aktualizowanie usługi danych](updating-the-data-service-wcf-data-services.md).  
  
### <a name="setting-the-http-method-for-updates"></a>Ustawianie metody HTTP dla aktualizacji  
 Domyślnie Biblioteka klienta .NET Framework wysyła aktualizacje istniejących jednostek jako żądania SCALEnia. Żądanie scalania aktualizuje wybrane właściwości jednostki; jednak klient zawsze zawiera wszystkie właściwości w żądaniu scalania, nawet właściwości, które nie uległy zmianie. Protokół OData obsługuje również wysyłanie żądań PUT do aktualizacji jednostek. W żądaniu PUT Istniejąca jednostka jest zasadniczo zastępowana nowym wystąpieniem jednostki z wartościami właściwości z klienta. Aby użyć żądań PUT, Ustaw flagę <xref:System.Data.Services.Client.SaveChangesOptions.ReplaceOnUpdate> na Wyliczenie <xref:System.Data.Services.Client.SaveChangesOptions> podczas wywoływania <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A>.  
  
> [!NOTE]
> Żądanie PUT będzie zachowywać się inaczej niż żądanie scalania, gdy klient nie wie o wszystkich właściwościach jednostki. Taka sytuacja może wystąpić podczas projekcji typu jednostki w nowym typie na kliencie. Może się również zdarzyć, gdy dodano nowe właściwości do jednostki w modelu danych usługi, a właściwość <xref:System.Data.Services.Client.DataServiceContext.IgnoreMissingProperties%2A> w <xref:System.Data.Services.Client.DataServiceContext> jest ustawiona na `true`, aby zignorować takie błędy mapowania klienta. W takich przypadkach żądanie PUT zresetuje wszystkie właściwości, które są nieznane dla klienta do wartości domyślnych.  
  
### <a name="post-tunneling"></a>Tunelowanie końcowe  
 Domyślnie Biblioteka kliencka wysyła żądania Create, Read, Update i DELETE do usługi OData przy użyciu odpowiednich metod HTTP polecenia POST, GET/MERGE/Scale/PATCH i DELETE. Ta funkcja zawiera podstawowe zasady przenoszenia stanu (REST). Jednak nie każda implementacja serwera sieci Web obsługuje pełny zestaw metod HTTP. W niektórych przypadkach obsługiwane metody mogą być ograniczone do tylko pobierania i publikowania. Taka sytuacja może wystąpić, gdy pośrednik, taki jak zapora, blokuje żądania przy użyciu określonych metod. Ponieważ metody GET i POST są najczęściej obsługiwane, OData stanowi sposób wykonywania nieobsługiwanych metod HTTP przy użyciu żądania POST. Określany jako *tunelowanie metody* lub tunelowanie, dzięki czemu klient może wysyłać *żądanie post z*rzeczywistą metodą określoną w nagłówku `X-HTTP-Method` niestandardowego. Aby włączyć tunelowanie na potrzeby żądań, ustaw właściwość <xref:System.Data.Services.Client.DataServiceContext.UsePostTunneling%2A> w wystąpieniu <xref:System.Data.Services.Client.DataServiceContext> na `true`.  
  
## <a name="see-also"></a>Zobacz także

- [Biblioteka klienta usług danych WCF](wcf-data-services-client-library.md)
- [Aktualizacja usługi danych](updating-the-data-service-wcf-data-services.md)
- [Operacje asynchroniczne](asynchronous-operations-wcf-data-services.md)
- [Operacje przetwarzania wsadowego](batching-operations-wcf-data-services.md)
