---
title: SQL Server puli połączeń
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
ms.assetid: 7e51d44e-7c4e-4040-9332-f0190fe36f07
ms.openlocfilehash: 3bf0ce98b9b16b8d698a814f3bf2c4f442f3bf06
ms.sourcegitcommit: 19014f9c081ca2ff19652ca12503828db8239d48
ms.translationtype: MT
ms.contentlocale: pl-PL
ms.lasthandoff: 02/04/2020
ms.locfileid: "76980044"
---
# <a name="sql-server-connection-pooling-adonet"></a><span data-ttu-id="dd94f-102">Buforowanie połączenia z programem SQL Server (ADO.NET)</span><span class="sxs-lookup"><span data-stu-id="dd94f-102">SQL Server Connection Pooling (ADO.NET)</span></span>
<span data-ttu-id="dd94f-103">Połączenie z serwerem bazy danych zwykle składa się z kilku czasochłonnych kroków.</span><span class="sxs-lookup"><span data-stu-id="dd94f-103">Connecting to a database server typically consists of several time-consuming steps.</span></span> <span data-ttu-id="dd94f-104">Musi zostać ustanowiony kanał fizyczny, taki jak gniazdo lub nazwany potok, początkowe uzgadnianie z serwerem, muszą być przeanalizowane informacje o parametrach połączenia, połączenie musi być uwierzytelniane przez serwer. bieżąca transakcja i tak dalej.</span><span class="sxs-lookup"><span data-stu-id="dd94f-104">A physical channel such as a socket or a named pipe must be established, the initial handshake with the server must occur, the connection string information must be parsed, the connection must be authenticated by the server, checks must be run for enlisting in the current transaction, and so on.</span></span>  
  
 <span data-ttu-id="dd94f-105">W tym przypadku większość aplikacji używa tylko jednej lub kilku różnych konfiguracji dla połączeń.</span><span class="sxs-lookup"><span data-stu-id="dd94f-105">In practice, most applications use only one or a few different configurations for connections.</span></span> <span data-ttu-id="dd94f-106">Oznacza to, że podczas wykonywania aplikacji wiele identycznych połączeń zostanie wielokrotnie otwarte i zamknięte.</span><span class="sxs-lookup"><span data-stu-id="dd94f-106">This means that during application execution, many identical connections will be repeatedly opened and closed.</span></span> <span data-ttu-id="dd94f-107">Aby zminimalizować koszt otwarcia połączeń, ADO.NET korzysta z techniki optymalizacji zwanej *pulą połączeń*.</span><span class="sxs-lookup"><span data-stu-id="dd94f-107">To minimize the cost of opening connections, ADO.NET uses an optimization technique called *connection pooling*.</span></span>  
  
 <span data-ttu-id="dd94f-108">Buforowanie połączeń zmniejsza liczbę przypadków otwarcia nowych połączeń.</span><span class="sxs-lookup"><span data-stu-id="dd94f-108">Connection pooling reduces the number of times that new connections must be opened.</span></span> <span data-ttu-id="dd94f-109">*Pulę* utrzymuje własność połączenia fizycznego.</span><span class="sxs-lookup"><span data-stu-id="dd94f-109">The *pooler* maintains ownership of the physical connection.</span></span> <span data-ttu-id="dd94f-110">Zarządza on połączeniami przez utrzymywanie zestawu aktywnych połączeń dla każdej danej konfiguracji połączenia.</span><span class="sxs-lookup"><span data-stu-id="dd94f-110">It manages connections by keeping alive a set of active connections for each given connection configuration.</span></span> <span data-ttu-id="dd94f-111">Za każdym razem, gdy użytkownik wywołuje `Open` w ramach połączenia, pulę szuka dostępnego połączenia w puli.</span><span class="sxs-lookup"><span data-stu-id="dd94f-111">Whenever a user calls `Open` on a connection, the pooler looks for an available connection in the pool.</span></span> <span data-ttu-id="dd94f-112">Jeśli połączenie z pulą jest dostępne, zwraca je do obiektu wywołującego, zamiast otwierać nowe połączenie.</span><span class="sxs-lookup"><span data-stu-id="dd94f-112">If a pooled connection is available, it returns it to the caller instead of opening a new connection.</span></span> <span data-ttu-id="dd94f-113">Gdy aplikacja wywołuje `Close` w ramach połączenia, pulę zwraca go do zestawu aktywnych połączeń w puli, zamiast go zamknąć.</span><span class="sxs-lookup"><span data-stu-id="dd94f-113">When the application calls `Close` on the connection, the pooler returns it to the pooled set of active connections instead of closing it.</span></span> <span data-ttu-id="dd94f-114">Gdy połączenie zostanie zwrócone do puli, jest gotowe do ponownego użycia na następnym wywołaniu `Open`.</span><span class="sxs-lookup"><span data-stu-id="dd94f-114">Once the connection is returned to the pool, it is ready to be reused on the next `Open` call.</span></span>  
  
 <span data-ttu-id="dd94f-115">Tylko połączenia z tą samą konfiguracją mogą być w puli.</span><span class="sxs-lookup"><span data-stu-id="dd94f-115">Only connections with the same configuration can be pooled.</span></span> <span data-ttu-id="dd94f-116">ADO.NET przechowuje kilka pul w tym samym czasie, po jednej dla każdej konfiguracji.</span><span class="sxs-lookup"><span data-stu-id="dd94f-116">ADO.NET keeps several pools at the same time, one for each configuration.</span></span> <span data-ttu-id="dd94f-117">Połączenia są rozdzielone na pule przez parametry połączenia oraz przez tożsamość systemu Windows, gdy są używane zintegrowane zabezpieczenia.</span><span class="sxs-lookup"><span data-stu-id="dd94f-117">Connections are separated into pools by connection string, and by Windows identity when integrated security is used.</span></span> <span data-ttu-id="dd94f-118">Połączenia są również w puli zależnie od tego, czy są one zarejestrowane w transakcji.</span><span class="sxs-lookup"><span data-stu-id="dd94f-118">Connections are also pooled based on whether they are enlisted in a transaction.</span></span> <span data-ttu-id="dd94f-119">W przypadku korzystania z <xref:System.Data.SqlClient.SqlConnection.ChangePassword%2A>wystąpienie <xref:System.Data.SqlClient.SqlCredential> ma wpływ na pulę połączeń.</span><span class="sxs-lookup"><span data-stu-id="dd94f-119">When using <xref:System.Data.SqlClient.SqlConnection.ChangePassword%2A>, the <xref:System.Data.SqlClient.SqlCredential> instance affects the connection pool.</span></span> <span data-ttu-id="dd94f-120">Różne wystąpienia <xref:System.Data.SqlClient.SqlCredential> będą używały różnych pul połączeń, nawet jeśli identyfikator użytkownika i hasło są takie same.</span><span class="sxs-lookup"><span data-stu-id="dd94f-120">Different instances of <xref:System.Data.SqlClient.SqlCredential> will use different connection pools, even if the user ID and password are the same.</span></span>  
  
 <span data-ttu-id="dd94f-121">Połączenia w puli mogą znacząco zwiększyć wydajność i skalowalność aplikacji.</span><span class="sxs-lookup"><span data-stu-id="dd94f-121">Pooling connections can significantly enhance the performance and scalability of your application.</span></span> <span data-ttu-id="dd94f-122">Domyślnie pule połączeń są włączone w ADO.NET.</span><span class="sxs-lookup"><span data-stu-id="dd94f-122">By default, connection pooling is enabled in ADO.NET.</span></span> <span data-ttu-id="dd94f-123">O ile nie zostanie on jawnie wyłączony, pulę optymalizuje połączenia w miarę ich otwierania i zamykania w aplikacji.</span><span class="sxs-lookup"><span data-stu-id="dd94f-123">Unless you explicitly disable it, the pooler optimizes the connections as they are opened and closed in your application.</span></span> <span data-ttu-id="dd94f-124">Możesz również podać kilka modyfikatorów parametrów połączenia, aby kontrolować zachowanie puli połączeń.</span><span class="sxs-lookup"><span data-stu-id="dd94f-124">You can also supply several connection string modifiers to control connection pooling behavior.</span></span> <span data-ttu-id="dd94f-125">Aby uzyskać więcej informacji, zobacz "kontrolowanie puli połączeń ze słowami kluczowymi parametrów połączenia" w dalszej części tego tematu.</span><span class="sxs-lookup"><span data-stu-id="dd94f-125">For more information, see "Controlling Connection Pooling with Connection String Keywords" later in this topic.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="dd94f-126">Po włączeniu puli połączeń, jeśli wystąpi błąd limitu czasu lub inny błąd logowania, zostanie zgłoszony wyjątek, a kolejne próby połączenia będą kończyć się niepowodzeniem przez kolejne pięć sekund, "okres blokowania".</span><span class="sxs-lookup"><span data-stu-id="dd94f-126">When connection pooling is enabled, and if a timeout error or other login error occurs, an exception will be thrown and subsequent connection attempts will fail for the next five seconds, the "blocking period".</span></span> <span data-ttu-id="dd94f-127">Jeśli aplikacja próbuje nawiązać połączenie w okresie blokowania, zostanie zgłoszony pierwszy wyjątek.</span><span class="sxs-lookup"><span data-stu-id="dd94f-127">If the application attempts to connect within the blocking period, the first exception will be thrown again.</span></span> <span data-ttu-id="dd94f-128">Kolejne błędy po zakończeniu okresu blokowania spowodują nowe okresy blokowania, które są dwa razy większe niż w poprzednim okresie blokowania, maksymalnie do minuty.</span><span class="sxs-lookup"><span data-stu-id="dd94f-128">Subsequent failures after a blocking period ends will result in a new blocking periods that is twice as long as the previous blocking period, up to a maximum of one minute.</span></span>  
  
## <a name="pool-creation-and-assignment"></a><span data-ttu-id="dd94f-129">Tworzenie i przypisywanie puli</span><span class="sxs-lookup"><span data-stu-id="dd94f-129">Pool Creation and Assignment</span></span>  
 <span data-ttu-id="dd94f-130">Po pierwszym otwarciu połączenia tworzona jest pula połączeń oparta na dokładnie zgodnym algorytmie, który kojarzy pulę z parametrami połączenia w połączeniu.</span><span class="sxs-lookup"><span data-stu-id="dd94f-130">When a connection is first opened, a connection pool is created based on an exact matching algorithm that associates the pool with the connection string in the connection.</span></span> <span data-ttu-id="dd94f-131">Każda pula połączeń jest skojarzona z unikatowymi parametrami połączenia.</span><span class="sxs-lookup"><span data-stu-id="dd94f-131">Each connection pool is associated with a distinct connection string.</span></span> <span data-ttu-id="dd94f-132">W przypadku otwarcia nowego połączenia, jeśli parametry połączenia nie są dokładnie zgodne z istniejącą pulą, tworzona jest nowa pula.</span><span class="sxs-lookup"><span data-stu-id="dd94f-132">When a new connection is opened, if the connection string is not an exact match to an existing pool, a new pool is created.</span></span> <span data-ttu-id="dd94f-133">Połączenia są w puli według poszczególnych procesów, poszczególnych domen aplikacji, na parametry połączenia oraz w przypadku użycia zintegrowanych zabezpieczeń na tożsamość systemu Windows.</span><span class="sxs-lookup"><span data-stu-id="dd94f-133">Connections are pooled per process, per application domain, per connection string and when integrated security is used, per Windows identity.</span></span> <span data-ttu-id="dd94f-134">Parametry połączenia muszą być również dokładnymi dopasowaniami; Słowa kluczowe podane w innej kolejności dla tego samego połączenia będą dzielone osobno.</span><span class="sxs-lookup"><span data-stu-id="dd94f-134">Connection strings must also be an exact match; keywords supplied in a different order for the same connection will be pooled separately.</span></span>  
  
 <span data-ttu-id="dd94f-135">W poniższym C# przykładzie są tworzone trzy nowe obiekty <xref:System.Data.SqlClient.SqlConnection>, ale zarządzanie nimi wymaga tylko dwóch pul połączeń.</span><span class="sxs-lookup"><span data-stu-id="dd94f-135">In the following C# example, three new <xref:System.Data.SqlClient.SqlConnection> objects are created, but only two connection pools are required to manage them.</span></span> <span data-ttu-id="dd94f-136">Należy zauważyć, że pierwsze i drugie parametry połączenia różnią się wartością przypisaną dla `Initial Catalog`.</span><span class="sxs-lookup"><span data-stu-id="dd94f-136">Note that the first and second connection strings differ by the value assigned for `Initial Catalog`.</span></span>  
  
```csharp
using (SqlConnection connection = new SqlConnection(  
  "Integrated Security=SSPI;Initial Catalog=Northwind"))  
    {  
        connection.Open();        
        // Pool A is created.  
    }  
  
using (SqlConnection connection = new SqlConnection(  
  "Integrated Security=SSPI;Initial Catalog=pubs"))  
    {  
        connection.Open();        
        // Pool B is created because the connection strings differ.  
    }  
  
using (SqlConnection connection = new SqlConnection(  
  "Integrated Security=SSPI;Initial Catalog=Northwind"))  
    {  
        connection.Open();        
        // The connection string matches pool A.  
    }  
```  
  
 <span data-ttu-id="dd94f-137">Jeśli `MinPoolSize` nie została określona w parametrach połączenia lub zostanie określona jako zero, połączenia w puli zostaną zamknięte po okresie braku aktywności.</span><span class="sxs-lookup"><span data-stu-id="dd94f-137">If `MinPoolSize` is either not specified in the connection string or is specified as zero, the connections in the pool will be closed after a period of inactivity.</span></span> <span data-ttu-id="dd94f-138">Jeśli jednak określony `MinPoolSize` jest większy od zera, pula połączeń nie zostanie zniszczona, dopóki nie zostanie zwolnione `AppDomain`, a proces zakończy się.</span><span class="sxs-lookup"><span data-stu-id="dd94f-138">However, if the specified `MinPoolSize` is greater than zero, the connection pool is not destroyed until the `AppDomain` is unloaded and the process ends.</span></span> <span data-ttu-id="dd94f-139">Obsługa pul nieaktywnych lub pustych obejmuje minimalne obciążenie systemu.</span><span class="sxs-lookup"><span data-stu-id="dd94f-139">Maintenance of inactive or empty pools involves minimal system overhead.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="dd94f-140">Pula jest automatycznie czyszczona po wystąpieniu błędu krytycznego, na przykład w trybie failover.</span><span class="sxs-lookup"><span data-stu-id="dd94f-140">The pool is automatically cleared when a fatal error occurs, such as a failover.</span></span>  
  
## <a name="adding-connections"></a><span data-ttu-id="dd94f-141">Dodawanie połączeń</span><span class="sxs-lookup"><span data-stu-id="dd94f-141">Adding Connections</span></span>  
 <span data-ttu-id="dd94f-142">Pula połączeń jest tworzona dla każdego unikatowego ciągu połączenia.</span><span class="sxs-lookup"><span data-stu-id="dd94f-142">A connection pool is created for each unique connection string.</span></span> <span data-ttu-id="dd94f-143">Po utworzeniu puli do puli są tworzone i dodawane wiele obiektów połączeń, aby zapewnić spełnienie minimalnych wymagań dotyczących rozmiaru puli.</span><span class="sxs-lookup"><span data-stu-id="dd94f-143">When a pool is created, multiple connection objects are created and added to the pool so that the minimum pool size requirement is satisfied.</span></span> <span data-ttu-id="dd94f-144">Połączenia są dodawane do puli, w razie potrzeby, do maksymalnego określonego rozmiaru puli (100 jest domyślnie).</span><span class="sxs-lookup"><span data-stu-id="dd94f-144">Connections are added to the pool as needed, up to the maximum pool size specified (100 is the default).</span></span> <span data-ttu-id="dd94f-145">Połączenia są zwalniane z powrotem do puli, gdy są zamknięte lub usuwane.</span><span class="sxs-lookup"><span data-stu-id="dd94f-145">Connections are released back into the pool when they are closed or disposed.</span></span>  
  
 <span data-ttu-id="dd94f-146">Gdy zażądano obiektu <xref:System.Data.SqlClient.SqlConnection>, jest on uzyskiwany z puli, jeśli dostępne jest połączenie możliwe do użycia.</span><span class="sxs-lookup"><span data-stu-id="dd94f-146">When a <xref:System.Data.SqlClient.SqlConnection> object is requested, it is obtained from the pool if a usable connection is available.</span></span> <span data-ttu-id="dd94f-147">Aby można było korzystać z usługi, połączenie musi być nieużywane, mieć pasujący kontekst transakcji lub być nieskojarzone z dowolnym kontekstem transakcji i mieć prawidłowe połączenie z serwerem.</span><span class="sxs-lookup"><span data-stu-id="dd94f-147">To be usable, a connection must be unused, have a matching transaction context or be unassociated with any transaction context, and have a valid link to the server.</span></span>  
  
 <span data-ttu-id="dd94f-148">Połączenie pulę spełnia żądania połączeń przez ponowne przypisanie połączeń po ich ponownym wydaniu do puli.</span><span class="sxs-lookup"><span data-stu-id="dd94f-148">The connection pooler satisfies requests for connections by reallocating connections as they are released back into the pool.</span></span> <span data-ttu-id="dd94f-149">Jeśli maksymalny rozmiar puli został osiągnięty i nie jest dostępne żadne możliwe połączenie, żądanie jest umieszczane w kolejce.</span><span class="sxs-lookup"><span data-stu-id="dd94f-149">If the maximum pool size has been reached and no usable connection is available, the request is queued.</span></span> <span data-ttu-id="dd94f-150">Pulę próbuje odnowić wszelkie połączenia do momentu osiągnięcia limitu czasu (wartość domyślna to 15 sekund).</span><span class="sxs-lookup"><span data-stu-id="dd94f-150">The pooler then tries to reclaim any connections until the time-out is reached (the default is 15 seconds).</span></span> <span data-ttu-id="dd94f-151">Jeśli pulę nie może spełnić żądania przed upływem limitu czasu połączenia, zostanie zgłoszony wyjątek.</span><span class="sxs-lookup"><span data-stu-id="dd94f-151">If the pooler cannot satisfy the request before the connection times out, an exception is thrown.</span></span>  
  
> [!CAUTION]
> <span data-ttu-id="dd94f-152">Zdecydowanie zalecamy, aby zawsze zamykać połączenie po zakończeniu korzystania z niego, aby połączenie zostało zwrócone do puli.</span><span class="sxs-lookup"><span data-stu-id="dd94f-152">We strongly recommend that you always close the connection when you are finished using it so that the connection will be returned to the pool.</span></span> <span data-ttu-id="dd94f-153">Można to zrobić przy użyciu metod `Close` lub `Dispose` obiektu `Connection` lub przez otwarcie wszystkich połączeń wewnątrz instrukcji C#`using` lub instrukcji `Using` w Visual Basic.</span><span class="sxs-lookup"><span data-stu-id="dd94f-153">You can do this using either the `Close` or `Dispose` methods of the `Connection` object, or by opening all connections inside a `using` statement in C#, or a `Using` statement in Visual Basic.</span></span> <span data-ttu-id="dd94f-154">Połączenia, które nie zostały jawnie zamknięte, mogą nie zostać dodane lub zwrócone do puli.</span><span class="sxs-lookup"><span data-stu-id="dd94f-154">Connections that are not explicitly closed might not be added or returned to the pool.</span></span> <span data-ttu-id="dd94f-155">Aby uzyskać więcej informacji, zobacz [using instrukcji](../../../csharp/language-reference/keywords/using-statement.md) lub [How to: Dispose a Resource system](../../../visual-basic/programming-guide/language-features/control-flow/how-to-dispose-of-a-system-resource.md) for Visual Basic.</span><span class="sxs-lookup"><span data-stu-id="dd94f-155">For more information, see [using Statement](../../../csharp/language-reference/keywords/using-statement.md) or [How to: Dispose of a System Resource](../../../visual-basic/programming-guide/language-features/control-flow/how-to-dispose-of-a-system-resource.md) for Visual Basic.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="dd94f-156">Nie wywołuj `Close` ani `Dispose` na `Connection`, `DataReader`ani żadnych innych zarządzanych obiektów w metodzie `Finalize` klasy.</span><span class="sxs-lookup"><span data-stu-id="dd94f-156">Do not call `Close` or `Dispose` on a `Connection`, a `DataReader`, or any other managed object in the `Finalize` method of your class.</span></span> <span data-ttu-id="dd94f-157">W finalizatorze zwalniane są tylko niezarządzane zasoby, które są własnością klasy bezpośrednio.</span><span class="sxs-lookup"><span data-stu-id="dd94f-157">In a finalizer, only release unmanaged resources that your class owns directly.</span></span> <span data-ttu-id="dd94f-158">Jeśli Klasa nie jest własnością żadnych niezarządzanych zasobów, nie Uwzględniaj metody `Finalize` w definicji klasy.</span><span class="sxs-lookup"><span data-stu-id="dd94f-158">If your class does not own any unmanaged resources, do not include a `Finalize` method in your class definition.</span></span> <span data-ttu-id="dd94f-159">Aby uzyskać więcej informacji, zobacz [odzyskiwanie pamięci](../../../standard/garbage-collection/index.md).</span><span class="sxs-lookup"><span data-stu-id="dd94f-159">For more information, see [Garbage Collection](../../../standard/garbage-collection/index.md).</span></span>  
  
<span data-ttu-id="dd94f-160">Aby uzyskać więcej informacji na temat zdarzeń skojarzonych z otwieraniem i zamykaniem połączeń, zobacz [Inspekcja klas zdarzeń logowania](/sql/relational-databases/event-classes/audit-login-event-class) i [zdarzeń inspekcji](/sql/relational-databases/event-classes/audit-logout-event-class) w dokumentacji SQL Server.</span><span class="sxs-lookup"><span data-stu-id="dd94f-160">For more info about the events associated with opening and closing connections, see [Audit Login Event Class](/sql/relational-databases/event-classes/audit-login-event-class) and [Audit Logout Event Class](/sql/relational-databases/event-classes/audit-logout-event-class) in the SQL Server documentation.</span></span>  
  
## <a name="removing-connections"></a><span data-ttu-id="dd94f-161">Usuwanie połączeń</span><span class="sxs-lookup"><span data-stu-id="dd94f-161">Removing Connections</span></span>  
 <span data-ttu-id="dd94f-162">Pulę połączenia usuwa połączenie z puli, gdy było ono bezczynne przez około 4-8 minut, lub jeśli pulę wykryje, że połączenie z serwerem zostało odłączone.</span><span class="sxs-lookup"><span data-stu-id="dd94f-162">The connection pooler removes a connection from the pool after it has been idle for approximately 4-8 minutes, or if the pooler detects that the connection with the server has been severed.</span></span> <span data-ttu-id="dd94f-163">Należy zauważyć, że pociągnięcie może być wykrywane tylko po próbie nawiązania połączenia z serwerem.</span><span class="sxs-lookup"><span data-stu-id="dd94f-163">Note that a severed connection can be detected only after attempting to communicate with the server.</span></span> <span data-ttu-id="dd94f-164">Jeśli zostanie znalezione połączenie, które nie jest już połączone z serwerem, jest oznaczone jako nieprawidłowe.</span><span class="sxs-lookup"><span data-stu-id="dd94f-164">If a connection is found that is no longer connected to the server, it is marked as invalid.</span></span> <span data-ttu-id="dd94f-165">Nieprawidłowe połączenia są usuwane z puli połączeń tylko wtedy, gdy są zamknięte lub odzyskiwane.</span><span class="sxs-lookup"><span data-stu-id="dd94f-165">Invalid connections are removed from the connection pool only when they are closed or reclaimed.</span></span>  
  
 <span data-ttu-id="dd94f-166">Jeśli połączenie istnieje na serwerze, który został wyświetlony, to połączenie może być narysowane z puli, nawet jeśli połączenie pulę nie wykryło poprawnego połączenia i oznaczenie go jako nieprawidłowe.</span><span class="sxs-lookup"><span data-stu-id="dd94f-166">If a connection exists to a server that has disappeared, this connection can be drawn from the pool even if the connection pooler has not detected the severed connection and marked it as invalid.</span></span> <span data-ttu-id="dd94f-167">Dzieje się tak, ponieważ obciążenie związane z sprawdzeniem, czy połączenie jest nadal ważne, eliminuje korzyści płynące z pulę, powodując wystąpienie kolejnej podróży z serwerem.</span><span class="sxs-lookup"><span data-stu-id="dd94f-167">This is the case because the overhead of checking that the connection is still valid would eliminate the benefits of having a pooler by causing another round trip to the server to occur.</span></span> <span data-ttu-id="dd94f-168">W takim przypadku pierwsza próba użycia połączenia wykryje, że połączenie zostało porzucone i zostanie zgłoszony wyjątek.</span><span class="sxs-lookup"><span data-stu-id="dd94f-168">When this occurs, the first attempt to use the connection will detect that the connection has been severed, and an exception is thrown.</span></span>  
  
## <a name="clearing-the-pool"></a><span data-ttu-id="dd94f-169">Czyszczenie puli</span><span class="sxs-lookup"><span data-stu-id="dd94f-169">Clearing the Pool</span></span>  
 <span data-ttu-id="dd94f-170">W ADO.NET 2,0 wprowadzono dwie nowe metody czyszczenia puli: <xref:System.Data.SqlClient.SqlConnection.ClearAllPools%2A> i <xref:System.Data.SqlClient.SqlConnection.ClearPool%2A>.</span><span class="sxs-lookup"><span data-stu-id="dd94f-170">ADO.NET 2.0 introduced two new methods to clear the pool: <xref:System.Data.SqlClient.SqlConnection.ClearAllPools%2A> and <xref:System.Data.SqlClient.SqlConnection.ClearPool%2A>.</span></span> <span data-ttu-id="dd94f-171">`ClearAllPools` czyści pule połączeń dla danego dostawcy, a `ClearPool` czyści pulę połączeń skojarzoną z określonym połączeniem.</span><span class="sxs-lookup"><span data-stu-id="dd94f-171">`ClearAllPools` clears the connection pools for a given provider, and `ClearPool` clears the connection pool that is associated with a specific connection.</span></span> <span data-ttu-id="dd94f-172">Jeśli w momencie wywołania są używane połączenia, są one odpowiednio oznaczone.</span><span class="sxs-lookup"><span data-stu-id="dd94f-172">If there are connections being used at the time of the call, they are marked appropriately.</span></span> <span data-ttu-id="dd94f-173">Po ich zamknięciu są one odrzucane, nie są zwracane do puli.</span><span class="sxs-lookup"><span data-stu-id="dd94f-173">When they are closed, they are discarded instead of being returned to the pool.</span></span>  
  
## <a name="transaction-support"></a><span data-ttu-id="dd94f-174">Obsługa transakcji</span><span class="sxs-lookup"><span data-stu-id="dd94f-174">Transaction Support</span></span>  
 <span data-ttu-id="dd94f-175">Połączenia są rysowane z puli i przypisywane na podstawie kontekstu transakcji.</span><span class="sxs-lookup"><span data-stu-id="dd94f-175">Connections are drawn from the pool and assigned based on transaction context.</span></span> <span data-ttu-id="dd94f-176">Jeśli w parametrach połączenia nie określono `Enlist=false`, pula połączeń sprawdza, czy połączenie jest zarejestrowane w kontekście <xref:System.Transactions.Transaction.Current%2A>.</span><span class="sxs-lookup"><span data-stu-id="dd94f-176">Unless `Enlist=false` is specified in the connection string, the connection pool makes sure that the connection is enlisted in the <xref:System.Transactions.Transaction.Current%2A> context.</span></span> <span data-ttu-id="dd94f-177">Gdy połączenie jest zamykane i zwracane do puli z zarejestrowaną `System.Transactions` transakcji, zostaje odłożone w taki sposób, że następne żądanie dla tej puli połączeń z tą samą `System.Transactions` transakcji zwróci to samo połączenie, jeśli jest dostępne.</span><span class="sxs-lookup"><span data-stu-id="dd94f-177">When a connection is closed and returned to the pool with an enlisted `System.Transactions` transaction, it is set aside in such a way that the next request for that connection pool with the same `System.Transactions` transaction will return the same connection if it is available.</span></span> <span data-ttu-id="dd94f-178">Jeśli takie żądanie jest wydawane, a połączenia w puli nie są dostępne, połączenie jest naliczane z nietransakcyjnej części puli i zarejestrowane.</span><span class="sxs-lookup"><span data-stu-id="dd94f-178">If such a request is issued, and there are no pooled connections available, a connection is drawn from the non-transacted part of the pool and enlisted.</span></span> <span data-ttu-id="dd94f-179">Jeśli w obu obszarach puli nie ma dostępnych połączeń, zostanie utworzone i zarejestrowane nowe połączenie.</span><span class="sxs-lookup"><span data-stu-id="dd94f-179">If no connections are available in either area of the pool, a new connection is created and enlisted.</span></span>  
  
 <span data-ttu-id="dd94f-180">Gdy połączenie jest zamknięte, zostaje wydane z powrotem do puli i do odpowiedniej części pola na podstawie kontekstu transakcji.</span><span class="sxs-lookup"><span data-stu-id="dd94f-180">When a connection is closed, it is released back into the pool and into the appropriate subdivision based on its transaction context.</span></span> <span data-ttu-id="dd94f-181">W związku z tym możesz zamknąć połączenie bez generowania błędu, mimo że transakcja rozproszona nadal oczekuje.</span><span class="sxs-lookup"><span data-stu-id="dd94f-181">Therefore, you can close the connection without generating an error, even though a distributed transaction is still pending.</span></span> <span data-ttu-id="dd94f-182">Dzięki temu możesz zatwierdzić lub przerwać transakcję rozproszoną później.</span><span class="sxs-lookup"><span data-stu-id="dd94f-182">This allows you to commit or abort the distributed transaction later.</span></span>  
  
## <a name="controlling-connection-pooling-with-connection-string-keywords"></a><span data-ttu-id="dd94f-183">Kontrolowanie puli połączeń przy użyciu słów kluczowych parametrów połączenia</span><span class="sxs-lookup"><span data-stu-id="dd94f-183">Controlling Connection Pooling with Connection String Keywords</span></span>  
 <span data-ttu-id="dd94f-184">Właściwość `ConnectionString` obiektu <xref:System.Data.SqlClient.SqlConnection> obsługuje pary klucz/wartość parametrów połączenia, których można użyć do dostosowania zachowania logiki puli połączeń.</span><span class="sxs-lookup"><span data-stu-id="dd94f-184">The `ConnectionString` property of the <xref:System.Data.SqlClient.SqlConnection> object supports connection string key/value pairs that can be used to adjust the behavior of the connection pooling logic.</span></span> <span data-ttu-id="dd94f-185">Aby uzyskać więcej informacji, zobacz temat <xref:System.Data.SqlClient.SqlConnection.ConnectionString%2A>.</span><span class="sxs-lookup"><span data-stu-id="dd94f-185">For more information, see <xref:System.Data.SqlClient.SqlConnection.ConnectionString%2A>.</span></span>  
  
## <a name="pool-fragmentation"></a><span data-ttu-id="dd94f-186">Fragmentacja puli</span><span class="sxs-lookup"><span data-stu-id="dd94f-186">Pool Fragmentation</span></span>  
 <span data-ttu-id="dd94f-187">Fragmentacja puli to typowy problem w wielu aplikacjach sieci Web, w których aplikacja może utworzyć dużą liczbę pul, które nie są zwalniane do momentu zakończenia procesu.</span><span class="sxs-lookup"><span data-stu-id="dd94f-187">Pool fragmentation is a common problem in many Web applications where the application can create a large number of pools that are not freed until the process exits.</span></span> <span data-ttu-id="dd94f-188">Pozostawia to dużą liczbę połączeń, które otwierają i zużywają pamięć, co skutkuje niską wydajnością.</span><span class="sxs-lookup"><span data-stu-id="dd94f-188">This leaves a large number of connections open and consuming memory, which results in poor performance.</span></span>  
  
### <a name="pool-fragmentation-due-to-integrated-security"></a><span data-ttu-id="dd94f-189">Fragmentacja puli ze względu na zabezpieczenia zintegrowane</span><span class="sxs-lookup"><span data-stu-id="dd94f-189">Pool Fragmentation Due to Integrated Security</span></span>  
 <span data-ttu-id="dd94f-190">Połączenia są w puli zgodne z parametrami połączenia i tożsamością użytkownika.</span><span class="sxs-lookup"><span data-stu-id="dd94f-190">Connections are pooled according to the connection string plus the user identity.</span></span> <span data-ttu-id="dd94f-191">Z tego względu, jeśli używasz uwierzytelniania podstawowego lub uwierzytelniania systemu Windows w witrynie sieci Web i zintegrowanego logowania zabezpieczeń, uzyskasz jedną pulę dla każdego użytkownika.</span><span class="sxs-lookup"><span data-stu-id="dd94f-191">Therefore, if you use Basic authentication or Windows Authentication on the Web site and an integrated security login, you get one pool per user.</span></span> <span data-ttu-id="dd94f-192">Chociaż zwiększa to wydajność kolejnych żądań bazy danych dla jednego użytkownika, użytkownik nie może korzystać z połączeń wykonywanych przez innych użytkowników.</span><span class="sxs-lookup"><span data-stu-id="dd94f-192">Although this improves the performance of subsequent database requests for a single user, that user cannot take advantage of connections made by other users.</span></span> <span data-ttu-id="dd94f-193">Powoduje to również co najmniej jedno połączenie dla użytkownika z serwerem bazy danych.</span><span class="sxs-lookup"><span data-stu-id="dd94f-193">It also results in at least one connection per user to the database server.</span></span> <span data-ttu-id="dd94f-194">Jest to efekt uboczny konkretnej architektury aplikacji sieci Web, którą deweloperzy muszą odważyć przed wymaganiami dotyczącymi zabezpieczeń i inspekcji.</span><span class="sxs-lookup"><span data-stu-id="dd94f-194">This is a side effect of a particular Web application architecture that developers must weigh against security and auditing requirements.</span></span>  
  
### <a name="pool-fragmentation-due-to-many-databases"></a><span data-ttu-id="dd94f-195">Fragmentacja puli ze względu na wiele baz danych</span><span class="sxs-lookup"><span data-stu-id="dd94f-195">Pool Fragmentation Due to Many Databases</span></span>  
 <span data-ttu-id="dd94f-196">Wielu usługodawców internetowych obsługuje kilka witryn sieci Web na jednym serwerze.</span><span class="sxs-lookup"><span data-stu-id="dd94f-196">Many Internet service providers host several Web sites on a single server.</span></span> <span data-ttu-id="dd94f-197">Mogą oni użyć pojedynczej bazy danych, aby potwierdzić Logowanie przy użyciu uwierzytelniania formularzy, a następnie otworzyć połączenie z określoną bazą danych dla tego użytkownika lub grupy użytkowników.</span><span class="sxs-lookup"><span data-stu-id="dd94f-197">They may use a single database to confirm a Forms authentication login and then open a connection to a specific database for that user or group of users.</span></span> <span data-ttu-id="dd94f-198">Połączenie z bazą danych uwierzytelniania jest w puli używane przez wszystkich użytkowników.</span><span class="sxs-lookup"><span data-stu-id="dd94f-198">The connection to the authentication database is pooled and used by everyone.</span></span> <span data-ttu-id="dd94f-199">Istnieje jednak oddzielna pula połączeń z każdą bazą danych, która zwiększa liczbę połączeń z serwerem.</span><span class="sxs-lookup"><span data-stu-id="dd94f-199">However, there is a separate pool of connections to each database, which increase the number of connections to the server.</span></span>  
  
 <span data-ttu-id="dd94f-200">Jest to również efektem ubocznym projektu aplikacji.</span><span class="sxs-lookup"><span data-stu-id="dd94f-200">This is also a side-effect of the application design.</span></span> <span data-ttu-id="dd94f-201">Istnieje stosunkowo prosty sposób, aby uniknąć tego efektu ubocznego bez naruszania zabezpieczeń podczas łączenia się z SQL Server.</span><span class="sxs-lookup"><span data-stu-id="dd94f-201">There is a relatively simple way to avoid this side effect without compromising security when you connect to SQL Server.</span></span> <span data-ttu-id="dd94f-202">Zamiast łączyć się z oddzielną bazą danych dla każdego użytkownika lub grupy, nawiąż połączenie z tą samą bazą danych na serwerze, a następnie wykonaj instrukcję USE języka Transact-SQL, aby zmienić żądaną bazę danych.</span><span class="sxs-lookup"><span data-stu-id="dd94f-202">Instead of connecting to a separate database for each user or group, connect to the same database on the server and then execute the Transact-SQL USE statement to change to the desired database.</span></span> <span data-ttu-id="dd94f-203">Poniższy fragment kodu ilustruje utworzenie początkowego połączenia z bazą danych `master`, a następnie przełączenie na żądaną bazę danych określoną w `databaseName` zmiennej ciągu.</span><span class="sxs-lookup"><span data-stu-id="dd94f-203">The following code fragment demonstrates creating an initial connection to the `master` database and then switching to the desired database specified in the `databaseName` string variable.</span></span>  
  
```vb  
' Assumes that command is a valid SqlCommand object and that  
' connectionString connects to master.  
    command.Text = "USE DatabaseName"  
Using connection As New SqlConnection(connectionString)  
    connection.Open()  
    command.ExecuteNonQuery()  
End Using  
```  
  
```csharp  
// Assumes that command is a SqlCommand object and that  
// connectionString connects to master.  
command.Text = "USE DatabaseName";  
using (SqlConnection connection = new SqlConnection(  
  connectionString))  
  {  
    connection.Open();  
    command.ExecuteNonQuery();  
  }  
```  
  
## <a name="application-roles-and-connection-pooling"></a><span data-ttu-id="dd94f-204">Role aplikacji i pule połączeń</span><span class="sxs-lookup"><span data-stu-id="dd94f-204">Application Roles and Connection Pooling</span></span>  
 <span data-ttu-id="dd94f-205">Po aktywowaniu SQL Server roli aplikacji przez wywołanie procedury składowanej systemu `sp_setapprole` nie można zresetować kontekstu zabezpieczeń tego połączenia.</span><span class="sxs-lookup"><span data-stu-id="dd94f-205">After a SQL Server application role has been activated by calling the `sp_setapprole` system stored procedure, the security context of that connection cannot be reset.</span></span> <span data-ttu-id="dd94f-206">Jeśli jednak włączono obsługę puli, połączenie zostanie zwrócone do puli i wystąpi błąd, gdy połączenie z pulą jest ponownie używane.</span><span class="sxs-lookup"><span data-stu-id="dd94f-206">However, if pooling is enabled, the connection is returned to the pool, and an error occurs when the pooled connection is reused.</span></span> <span data-ttu-id="dd94f-207">Aby uzyskać więcej informacji, zobacz artykuł w bazie wiedzy "[Błędy ról aplikacji SQL z pulą zasobów OLE DB](https://support.microsoft.com/default.aspx?scid=KB;EN-US;Q229564)".</span><span class="sxs-lookup"><span data-stu-id="dd94f-207">For more information, see the Knowledge Base article, "[SQL application role errors with OLE DB resource pooling](https://support.microsoft.com/default.aspx?scid=KB;EN-US;Q229564)."</span></span>  
  
### <a name="application-role-alternatives"></a><span data-ttu-id="dd94f-208">Alternatywy ról aplikacji</span><span class="sxs-lookup"><span data-stu-id="dd94f-208">Application Role Alternatives</span></span>  
 <span data-ttu-id="dd94f-209">Zalecamy skorzystanie z mechanizmów zabezpieczeń, których można używać zamiast ról aplikacji.</span><span class="sxs-lookup"><span data-stu-id="dd94f-209">We recommend that you take advantage of security mechanisms that you can use instead of application roles.</span></span> <span data-ttu-id="dd94f-210">Aby uzyskać więcej informacji, zobacz [Tworzenie ról aplikacji w SQL Server](./sql/creating-application-roles-in-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="dd94f-210">For more information, see [Creating Application Roles in SQL Server](./sql/creating-application-roles-in-sql-server.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="dd94f-211">Zobacz także</span><span class="sxs-lookup"><span data-stu-id="dd94f-211">See also</span></span>

- [<span data-ttu-id="dd94f-212">Pula połączeń</span><span class="sxs-lookup"><span data-stu-id="dd94f-212">Connection Pooling</span></span>](connection-pooling.md)
- [<span data-ttu-id="dd94f-213">SQL Server i ADO.NET</span><span class="sxs-lookup"><span data-stu-id="dd94f-213">SQL Server and ADO.NET</span></span>](./sql/index.md)
- [<span data-ttu-id="dd94f-214">Liczniki wydajności</span><span class="sxs-lookup"><span data-stu-id="dd94f-214">Performance Counters</span></span>](performance-counters.md)
- [<span data-ttu-id="dd94f-215">Omówienie ADO.NET</span><span class="sxs-lookup"><span data-stu-id="dd94f-215">ADO.NET Overview</span></span>](ado-net-overview.md)
