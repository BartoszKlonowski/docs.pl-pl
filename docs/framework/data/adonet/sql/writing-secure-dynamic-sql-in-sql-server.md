---
title: Pisanie bezpiecznego dynamicznego kodu SQL w programie SQL Server
ms.date: 03/30/2017
ms.assetid: df5512b0-c249-40d2-82f9-f9a2ce6665bc
ms.openlocfilehash: c02455ba8798df1de1d52f6b4db3426d41b95daf
ms.sourcegitcommit: d2e1dfa7ef2d4e9ffae3d431cf6a4ffd9c8d378f
ms.translationtype: MT
ms.contentlocale: pl-PL
ms.lasthandoff: 09/07/2019
ms.locfileid: "70791420"
---
# <a name="writing-secure-dynamic-sql-in-sql-server"></a><span data-ttu-id="7f2b0-102">Pisanie bezpiecznego dynamicznego kodu SQL w programie SQL Server</span><span class="sxs-lookup"><span data-stu-id="7f2b0-102">Writing Secure Dynamic SQL in SQL Server</span></span>
<span data-ttu-id="7f2b0-103">Iniekcja SQL to proces, za pomocą którego złośliwy użytkownik wprowadza instrukcje języka Transact-SQL zamiast prawidłowych danych wejściowych.</span><span class="sxs-lookup"><span data-stu-id="7f2b0-103">SQL Injection is the process by which a malicious user enters Transact-SQL statements instead of valid input.</span></span> <span data-ttu-id="7f2b0-104">Jeśli dane wejściowe są przesyłane bezpośrednio do serwera bez sprawdzania poprawności i jeśli aplikacja przypadkowo wykonuje wprowadzony kod, atakujący może uszkodzić lub zniszczyć dane.</span><span class="sxs-lookup"><span data-stu-id="7f2b0-104">If the input is passed directly to the server without being validated and if the application inadvertently executes the injected code, the attack has the potential to damage or destroy data.</span></span>  
  
 <span data-ttu-id="7f2b0-105">Każda procedura, która konstruuje instrukcje SQL, powinna zostać sprawdzona pod kątem luk w zabezpieczeniach, ponieważ SQL Server będzie wykonywała wszystkie zapytania z prawidłowymi składnią.</span><span class="sxs-lookup"><span data-stu-id="7f2b0-105">Any procedure that constructs SQL statements should be reviewed for injection vulnerabilities because SQL Server will execute all syntactically valid queries that it receives.</span></span> <span data-ttu-id="7f2b0-106">Nawet sparametryzowane dane można manipulować przez wykwalifikowany i ustaloną osobę atakującą.</span><span class="sxs-lookup"><span data-stu-id="7f2b0-106">Even parameterized data can be manipulated by a skilled and determined attacker.</span></span> <span data-ttu-id="7f2b0-107">Jeśli używasz dynamicznego języka SQL, pamiętaj, aby Sparametryzuj polecenia, i nigdy nie dodawaj wartości parametrów bezpośrednio do ciągu zapytania.</span><span class="sxs-lookup"><span data-stu-id="7f2b0-107">If you use dynamic SQL, be sure to parameterize your commands, and never include parameter values directly into the query string.</span></span>  
  
## <a name="anatomy-of-a-sql-injection-attack"></a><span data-ttu-id="7f2b0-108">Anatomia ataku polegającego na iniekcji SQL</span><span class="sxs-lookup"><span data-stu-id="7f2b0-108">Anatomy of a SQL Injection Attack</span></span>  
 <span data-ttu-id="7f2b0-109">Proces wstrzykiwania działa przez przedwcześnie zakończenie ciągu tekstowego i dołączenie nowego polecenia.</span><span class="sxs-lookup"><span data-stu-id="7f2b0-109">The injection process works by prematurely terminating a text string and appending a new command.</span></span> <span data-ttu-id="7f2b0-110">Ze względu na to, że wstawione polecenie może mieć do niego dodatkowe ciągi, przed wykonaniem malefactor kończy wstrzykiwany ciąg z znacznikiem komentarza "--".</span><span class="sxs-lookup"><span data-stu-id="7f2b0-110">Because the inserted command may have additional strings appended to it before it is executed, the malefactor terminates the injected string with a comment mark "--".</span></span> <span data-ttu-id="7f2b0-111">Następny tekst jest ignorowany w czasie wykonywania.</span><span class="sxs-lookup"><span data-stu-id="7f2b0-111">Subsequent text is ignored at execution time.</span></span> <span data-ttu-id="7f2b0-112">Można wstawiać wiele poleceń przy użyciu średnika (;) ogranicznik.</span><span class="sxs-lookup"><span data-stu-id="7f2b0-112">Multiple commands can be inserted using a semicolon (;) delimiter.</span></span>  
  
 <span data-ttu-id="7f2b0-113">Tak długo, jak wstrzyknięty kod SQL ma poprawną składnię, nie można programowo wykryć naruszenia.</span><span class="sxs-lookup"><span data-stu-id="7f2b0-113">As long as injected SQL code is syntactically correct, tampering cannot be detected programmatically.</span></span> <span data-ttu-id="7f2b0-114">W związku z tym należy zweryfikować wszystkie dane wejściowe użytkownika i uważnie przejrzeć kod, który wykonuje skonstruowane polecenia SQL na serwerze, który jest używany.</span><span class="sxs-lookup"><span data-stu-id="7f2b0-114">Therefore, you must validate all user input and carefully review code that executes constructed SQL commands in the server that you are using.</span></span> <span data-ttu-id="7f2b0-115">Nigdy nie łącz danych wprowadzonych przez użytkownika, które nie zostały zweryfikowane.</span><span class="sxs-lookup"><span data-stu-id="7f2b0-115">Never concatenate user input that is not validated.</span></span> <span data-ttu-id="7f2b0-116">Łączenie ciągów to podstawowy punkt wejścia dla iniekcji skryptu.</span><span class="sxs-lookup"><span data-stu-id="7f2b0-116">String concatenation is the primary point of entry for script injection.</span></span>  
  
 <span data-ttu-id="7f2b0-117">Oto kilka przydatnych wskazówek:</span><span class="sxs-lookup"><span data-stu-id="7f2b0-117">Here are some helpful guidelines:</span></span>  
  
- <span data-ttu-id="7f2b0-118">Nigdy nie Kompiluj instrukcji języka Transact-SQL bezpośrednio z danych wejściowych użytkownika; Użyj procedur składowanych, aby sprawdzić poprawność danych wejściowych użytkownika.</span><span class="sxs-lookup"><span data-stu-id="7f2b0-118">Never build Transact-SQL statements directly from user input; use stored procedures to validate user input.</span></span>  
  
- <span data-ttu-id="7f2b0-119">Sprawdź poprawność danych wejściowych użytkownika, sprawdzając typ, długość, format i zakres.</span><span class="sxs-lookup"><span data-stu-id="7f2b0-119">Validate user input by testing type, length, format, and range.</span></span> <span data-ttu-id="7f2b0-120">Użyj funkcji CYTATu języka Transact-SQL (), aby wypróbować nazwy systemu lub funkcję REPLACE () w celu ucieczki dowolnego znaku w ciągu.</span><span class="sxs-lookup"><span data-stu-id="7f2b0-120">Use the Transact-SQL QUOTENAME() function to escape system names or the REPLACE() function to escape any character in a string.</span></span>  
  
- <span data-ttu-id="7f2b0-121">Zaimplementuj wiele warstw walidacji w każdej warstwie aplikacji.</span><span class="sxs-lookup"><span data-stu-id="7f2b0-121">Implement multiple layers of validation in each tier of your application.</span></span>  
  
- <span data-ttu-id="7f2b0-122">Przetestuj rozmiar i typ danych wejściowych i wymuś odpowiednie limity.</span><span class="sxs-lookup"><span data-stu-id="7f2b0-122">Test the size and data type of input and enforce appropriate limits.</span></span> <span data-ttu-id="7f2b0-123">Może to pomóc w zapobieganiu zamierzonym przekroczeniu buforu.</span><span class="sxs-lookup"><span data-stu-id="7f2b0-123">This can help prevent deliberate buffer overruns.</span></span>  
  
- <span data-ttu-id="7f2b0-124">Przetestuj zawartość zmiennych ciągów i zaakceptuj tylko oczekiwane wartości.</span><span class="sxs-lookup"><span data-stu-id="7f2b0-124">Test the content of string variables and accept only expected values.</span></span> <span data-ttu-id="7f2b0-125">Odrzuć wpisy zawierające dane binarne, sekwencje ucieczki i znaki komentarza.</span><span class="sxs-lookup"><span data-stu-id="7f2b0-125">Reject entries that contain binary data, escape sequences, and comment characters.</span></span>  
  
- <span data-ttu-id="7f2b0-126">Podczas pracy z dokumentami XML Sprawdź poprawność wszystkich danych względem schematu w miarę ich wprowadzania.</span><span class="sxs-lookup"><span data-stu-id="7f2b0-126">When you are working with XML documents, validate all data against its schema as it is entered.</span></span>  
  
- <span data-ttu-id="7f2b0-127">W środowiskach wielowarstwowych wszystkie dane powinny być weryfikowane przed przystąpieniem do zaufanej strefy.</span><span class="sxs-lookup"><span data-stu-id="7f2b0-127">In multi-tiered environments, all data should be validated before admission to the trusted zone.</span></span>  
  
- <span data-ttu-id="7f2b0-128">Nie Akceptuj następujących ciągów w polach, z których można utworzyć nazwy plików: AUX, CLOCK $, COM1 przez COM8, CON, CONFIG $, LPT1 przez LPT8, NUL i PRN.</span><span class="sxs-lookup"><span data-stu-id="7f2b0-128">Do not accept the following strings in fields from which file names can be constructed: AUX, CLOCK$, COM1 through COM8, CON, CONFIG$, LPT1 through LPT8, NUL, and PRN.</span></span>  
  
- <span data-ttu-id="7f2b0-129">Użyj <xref:System.Data.SqlClient.SqlParameter> obiektów z procedurami składowanymi i poleceniami, aby zapewnić sprawdzanie typu i weryfikację długości.</span><span class="sxs-lookup"><span data-stu-id="7f2b0-129">Use <xref:System.Data.SqlClient.SqlParameter> objects with stored procedures and commands to provide type checking and length validation.</span></span>  
  
- <span data-ttu-id="7f2b0-130">Używanie <xref:System.Text.RegularExpressions.Regex> wyrażeń w kodzie klienta do filtrowania nieprawidłowych znaków.</span><span class="sxs-lookup"><span data-stu-id="7f2b0-130">Use <xref:System.Text.RegularExpressions.Regex> expressions in client code to filter invalid characters.</span></span>  
  
## <a name="dynamic-sql-strategies"></a><span data-ttu-id="7f2b0-131">Dynamiczne strategie SQL</span><span class="sxs-lookup"><span data-stu-id="7f2b0-131">Dynamic SQL Strategies</span></span>  
 <span data-ttu-id="7f2b0-132">Wykonywanie dynamicznie utworzonych instrukcji SQL w kodzie proceduralnym powoduje przerwanie łańcucha własności, co sprawia, że SQL Server sprawdzać uprawnienia obiektu wywołującego względem obiektów, do których uzyskuje się dostęp za pomocą dynamicznego języka SQL.</span><span class="sxs-lookup"><span data-stu-id="7f2b0-132">Executing dynamically created SQL statements in your procedural code breaks the ownership chain, causing SQL Server to check the permissions of the caller against the objects being accessed by the dynamic SQL.</span></span>  
  
 <span data-ttu-id="7f2b0-133">SQL Server ma metody udzielania użytkownikom dostępu do danych za pomocą procedur składowanych i funkcji zdefiniowanych przez użytkownika, które wykonują dynamiczne SQL.</span><span class="sxs-lookup"><span data-stu-id="7f2b0-133">SQL Server has methods for granting users access to data using stored procedures and user-defined functions that execute dynamic SQL.</span></span>  
  
- <span data-ttu-id="7f2b0-134">Używanie personifikacji z klauzulą EXECUTE AS języka Transact-SQL, zgodnie z opisem w temacie [Dostosowywanie uprawnień przy użyciu personifikacji w SQL Server](customizing-permissions-with-impersonation-in-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="7f2b0-134">Using impersonation with the Transact-SQL EXECUTE AS clause, as described in [Customizing Permissions with Impersonation in SQL Server](customizing-permissions-with-impersonation-in-sql-server.md).</span></span>  
  
- <span data-ttu-id="7f2b0-135">Podpisywanie procedur składowanych z certyfikatami, zgodnie z opisem w temacie [procedury składowane podpisywania w SQL Server](signing-stored-procedures-in-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="7f2b0-135">Signing stored procedures with certificates, as described in [Signing Stored Procedures in SQL Server](signing-stored-procedures-in-sql-server.md).</span></span>  
  
### <a name="execute-as"></a><span data-ttu-id="7f2b0-136">WYKONAJ JAKO</span><span class="sxs-lookup"><span data-stu-id="7f2b0-136">EXECUTE AS</span></span>  
 <span data-ttu-id="7f2b0-137">Klauzula EXECUTE AS zastępuje uprawnienia obiektu wywołującego określonym w klauzuli EXECUTE AS.</span><span class="sxs-lookup"><span data-stu-id="7f2b0-137">The EXECUTE AS clause replaces the permissions of the caller with that of the user specified in the EXECUTE AS clause.</span></span> <span data-ttu-id="7f2b0-138">Zagnieżdżone procedury składowane lub wyzwalacze są wykonywane w kontekście zabezpieczeń użytkownika serwera proxy.</span><span class="sxs-lookup"><span data-stu-id="7f2b0-138">Nested stored procedures or triggers execute under the security context of the proxy user.</span></span> <span data-ttu-id="7f2b0-139">Może to spowodować uszkodzenie aplikacji, które korzystają z zabezpieczeń na poziomie wiersza lub wymagają inspekcji.</span><span class="sxs-lookup"><span data-stu-id="7f2b0-139">This can break applications that rely on row-level security or require auditing.</span></span> <span data-ttu-id="7f2b0-140">Niektóre funkcje, które zwracają tożsamość użytkownika, zwracają użytkownika określonego w klauzuli EXECUTE AS, a nie oryginalnego obiektu wywołującego.</span><span class="sxs-lookup"><span data-stu-id="7f2b0-140">Some functions that return the identity of the user return the user specified in the EXECUTE AS clause, not the original caller.</span></span> <span data-ttu-id="7f2b0-141">Kontekst wykonywania jest przywracany do oryginalnego obiektu wywołującego dopiero po wykonaniu procedury lub po wydaniu instrukcji przywracania.</span><span class="sxs-lookup"><span data-stu-id="7f2b0-141">Execution context is reverted to the original caller only after execution of the procedure or when a REVERT statement is issued.</span></span>  
  
### <a name="certificate-signing"></a><span data-ttu-id="7f2b0-142">Podpisywanie certyfikatu</span><span class="sxs-lookup"><span data-stu-id="7f2b0-142">Certificate Signing</span></span>  
 <span data-ttu-id="7f2b0-143">Po wykonaniu procedury składowanej podpisanej przy użyciu certyfikatu uprawnienia przyznane użytkownikowi certyfikatu są scalane z tymi obiektu wywołującego.</span><span class="sxs-lookup"><span data-stu-id="7f2b0-143">When a stored procedure that has been signed with a certificate executes, the permissions granted to the certificate user are merged with those of the caller.</span></span> <span data-ttu-id="7f2b0-144">Kontekst wykonywania pozostaje taki sam; Użytkownik certyfikatu nie personifikuje obiektu wywołującego.</span><span class="sxs-lookup"><span data-stu-id="7f2b0-144">The execution context remains the same; the certificate user does not impersonate the caller.</span></span> <span data-ttu-id="7f2b0-145">Procedury składowane podpisywania wymagają wykonania kilku kroków.</span><span class="sxs-lookup"><span data-stu-id="7f2b0-145">Signing stored procedures requires several steps to implement.</span></span> <span data-ttu-id="7f2b0-146">Za każdym razem, gdy procedura jest modyfikowana, należy ją podpisać.</span><span class="sxs-lookup"><span data-stu-id="7f2b0-146">Each time the procedure is modified, it must be re-signed.</span></span>  
  
### <a name="cross-database-access"></a><span data-ttu-id="7f2b0-147">Dostęp między bazami danych</span><span class="sxs-lookup"><span data-stu-id="7f2b0-147">Cross Database Access</span></span>  
 <span data-ttu-id="7f2b0-148">Tworzenie łańcucha własności między bazami danych nie działa w przypadkach, w których są wykonywane dynamiczne instrukcje SQL.</span><span class="sxs-lookup"><span data-stu-id="7f2b0-148">Cross-database ownership chaining does not work in cases where dynamically created SQL statements are executed.</span></span> <span data-ttu-id="7f2b0-149">Można obejść ten krok w SQL Server przez utworzenie procedury składowanej, która uzyskuje dostęp do danych w innej bazie danych i podpisywanie procedury z certyfikatem, który istnieje w obu bazach danych.</span><span class="sxs-lookup"><span data-stu-id="7f2b0-149">You can work around this in SQL Server by creating a stored procedure that accesses data in another database and signing the procedure with a certificate that exists in both databases.</span></span> <span data-ttu-id="7f2b0-150">Zapewnia to użytkownikom dostęp do zasobów bazy danych używanych przez procedurę bez udzielania im dostępu do bazy danych lub uprawnień.</span><span class="sxs-lookup"><span data-stu-id="7f2b0-150">This gives users access to the database resources used by the procedure without granting them database access or permissions.</span></span>  
  
## <a name="external-resources"></a><span data-ttu-id="7f2b0-151">Zasoby zewnętrzne</span><span class="sxs-lookup"><span data-stu-id="7f2b0-151">External Resources</span></span>  
 <span data-ttu-id="7f2b0-152">Aby uzyskać więcej informacji, zobacz następujące zasoby.</span><span class="sxs-lookup"><span data-stu-id="7f2b0-152">For more information, see the following resources.</span></span>  
  
|<span data-ttu-id="7f2b0-153">Zasób</span><span class="sxs-lookup"><span data-stu-id="7f2b0-153">Resource</span></span>|<span data-ttu-id="7f2b0-154">Opis</span><span class="sxs-lookup"><span data-stu-id="7f2b0-154">Description</span></span>|  
|--------------|-----------------|  
|<span data-ttu-id="7f2b0-155">[Procedury składowane](/sql/relational-databases/stored-procedures/stored-procedures-database-engine) i [iniekcja kodu SQL](/sql/relational-databases/security/sql-injection) w usłudze SQL Server Books Online</span><span class="sxs-lookup"><span data-stu-id="7f2b0-155">[Stored Procedures](/sql/relational-databases/stored-procedures/stored-procedures-database-engine) and [SQL Injection](/sql/relational-databases/security/sql-injection) in SQL Server Books Online</span></span>|<span data-ttu-id="7f2b0-156">Tematy opisują sposób tworzenia procedur składowanych i sposobu działania iniekcji SQL.</span><span class="sxs-lookup"><span data-stu-id="7f2b0-156">Topics describe how to create stored procedures and how SQL Injection works.</span></span>|  
  
## <a name="see-also"></a><span data-ttu-id="7f2b0-157">Zobacz także</span><span class="sxs-lookup"><span data-stu-id="7f2b0-157">See also</span></span>

- [<span data-ttu-id="7f2b0-158">Zabezpieczanie aplikacji ADO.NET</span><span class="sxs-lookup"><span data-stu-id="7f2b0-158">Securing ADO.NET Applications</span></span>](../securing-ado-net-applications.md)
- [<span data-ttu-id="7f2b0-159">Przegląd zabezpieczeń serwera SQL</span><span class="sxs-lookup"><span data-stu-id="7f2b0-159">Overview of SQL Server Security</span></span>](overview-of-sql-server-security.md)
- [<span data-ttu-id="7f2b0-160">Scenariusze zabezpieczeń aplikacji w programie SQL Server</span><span class="sxs-lookup"><span data-stu-id="7f2b0-160">Application Security Scenarios in SQL Server</span></span>](application-security-scenarios-in-sql-server.md)
- [<span data-ttu-id="7f2b0-161">Zarządzanie uprawnieniami za pomocą procedur składowanych w programie SQL Server</span><span class="sxs-lookup"><span data-stu-id="7f2b0-161">Managing Permissions with Stored Procedures in SQL Server</span></span>](managing-permissions-with-stored-procedures-in-sql-server.md)
- [<span data-ttu-id="7f2b0-162">Rejestrowanie procedur składowanych w programie SQL Server</span><span class="sxs-lookup"><span data-stu-id="7f2b0-162">Signing Stored Procedures in SQL Server</span></span>](signing-stored-procedures-in-sql-server.md)
- [<span data-ttu-id="7f2b0-163">Dostosowywanie uprawnień personifikacji w programie SQL Server</span><span class="sxs-lookup"><span data-stu-id="7f2b0-163">Customizing Permissions with Impersonation in SQL Server</span></span>](customizing-permissions-with-impersonation-in-sql-server.md)
- [<span data-ttu-id="7f2b0-164">Omówienie ADO.NET</span><span class="sxs-lookup"><span data-stu-id="7f2b0-164">ADO.NET Overview</span></span>](../ado-net-overview.md)
