---
title: Izolacja migawki w programie SQL Server
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
ms.assetid: 43ae5dd3-50f5-43a8-8d01-e37a61664176
ms.openlocfilehash: 8313ffc8eef70c1e5efc24b09a160edb7cec1595
ms.sourcegitcommit: 7588136e355e10cbc2582f389c90c127363c02a5
ms.translationtype: MT
ms.contentlocale: pl-PL
ms.lasthandoff: 03/12/2020
ms.locfileid: "79174267"
---
# <a name="snapshot-isolation-in-sql-server"></a><span data-ttu-id="9403b-102">Izolacja migawki w programie SQL Server</span><span class="sxs-lookup"><span data-stu-id="9403b-102">Snapshot Isolation in SQL Server</span></span>
<span data-ttu-id="9403b-103">Izolacja migawki zwiększa współbieżność aplikacji OLTP.</span><span class="sxs-lookup"><span data-stu-id="9403b-103">Snapshot isolation enhances concurrency for OLTP applications.</span></span>  
  
## <a name="understanding-snapshot-isolation-and-row-versioning"></a><span data-ttu-id="9403b-104">Opis izolacji migawki i przechowywania wersji wiersza</span><span class="sxs-lookup"><span data-stu-id="9403b-104">Understanding Snapshot Isolation and Row Versioning</span></span>  
 <span data-ttu-id="9403b-105">Po włączeniu izolacji migawki zaktualizowane wersje wierszy dla każdej transakcji muszą być zachowane.</span><span class="sxs-lookup"><span data-stu-id="9403b-105">Once snapshot isolation is enabled, updated row versions for each transaction must be maintained.</span></span>  <span data-ttu-id="9403b-106">Przed programem SQL Server 2019 wersje te były przechowywane w **programie tempdb**.</span><span class="sxs-lookup"><span data-stu-id="9403b-106">Prior to SQL Server 2019, these versions were stored in **tempdb**.</span></span> <span data-ttu-id="9403b-107">SQL Server 2019 wprowadza nową funkcję, Przyspieszone odzyskiwanie bazy danych (ADR), która wymaga własnego zestawu wersji wierszy.</span><span class="sxs-lookup"><span data-stu-id="9403b-107">SQL Server 2019 introduces a new feature, Accelerated Database Recovery (ADR) which requires its own set of row versions.</span></span>  <span data-ttu-id="9403b-108">Tak, od SQL Server 2019, jeśli ADR nie jest włączona, wersje wierszy są przechowywane w **tempdb** jak zawsze.</span><span class="sxs-lookup"><span data-stu-id="9403b-108">So, as of SQL Server 2019, if ADR is not enabled, row versions are kept in **tempdb** as always.</span></span>  <span data-ttu-id="9403b-109">Jeśli ADR jest włączona, wszystkie wersje wierszy, zarówno związane z izolacją migawki i ADR, są przechowywane w magazynie wersji trwałych ADR (PVS), który znajduje się w bazie danych użytkowników w grupie plików, którą określa użytkownik.</span><span class="sxs-lookup"><span data-stu-id="9403b-109">If ADR is enabled, then all row versions, both related to snapshot isolation and ADR, are kept in ADR's Persistent Version Store (PVS), which is located in the user database in a filegroup which the user specifies.</span></span> <span data-ttu-id="9403b-110">Unikatowy numer sekwencyjny transakcji identyfikuje każdą transakcję, a te unikatowe numery są rejestrowane dla każdej wersji wiersza.</span><span class="sxs-lookup"><span data-stu-id="9403b-110">A unique transaction sequence number identifies each transaction, and these unique numbers are recorded for each row version.</span></span> <span data-ttu-id="9403b-111">Transakcja działa z najnowszymi wersjami wierszy o numerze sekwencyjnym przed numerem sekwencyjnym transakcji.</span><span class="sxs-lookup"><span data-stu-id="9403b-111">The transaction works with the most recent row versions having a sequence number before the sequence number of the transaction.</span></span> <span data-ttu-id="9403b-112">Nowsze wersje wierszy utworzone po rozpoczęciu transakcji są ignorowane przez transakcję.</span><span class="sxs-lookup"><span data-stu-id="9403b-112">Newer row versions created after the transaction has begun are ignored by the transaction.</span></span>  
  
 <span data-ttu-id="9403b-113">Termin "migawka" odzwierciedla fakt, że wszystkie zapytania w transakcji zobacz tę samą wersję lub migawkę bazy danych, na podstawie stanu bazy danych w momencie rozpoczęcia transakcji.</span><span class="sxs-lookup"><span data-stu-id="9403b-113">The term "snapshot" reflects the fact that all queries in the transaction see the same version, or snapshot, of the database, based on the state of the database at the moment in time when the transaction begins.</span></span> <span data-ttu-id="9403b-114">Żadne blokady nie są nabywane na podstawowych wierszy danych lub stron danych w transakcji migawki, która umożliwia inne transakcje do wykonania bez blokowane przez poprzednią nieukończonej transakcji.</span><span class="sxs-lookup"><span data-stu-id="9403b-114">No locks are acquired on the underlying data rows or data pages in a snapshot transaction, which permits other transactions to execute without being blocked by a prior uncompleted transaction.</span></span> <span data-ttu-id="9403b-115">Transakcje modyfikując dane nie blokują transakcji, które odczytują dane, a transakcje odczytywane dane nie blokują transakcji, które zapisują dane, tak jak zwykle w ramach domyślnego poziomu izolacji ODCZYTU POPEŁNIONE w programie SQL Server.</span><span class="sxs-lookup"><span data-stu-id="9403b-115">Transactions that modify data do not block transactions that read data, and transactions that read data do not block transactions that write data, as they normally would under the default READ COMMITTED isolation level in SQL Server.</span></span> <span data-ttu-id="9403b-116">To zachowanie nieblokujące również znacznie zmniejsza prawdopodobieństwo zakleszczenia dla złożonych transakcji.</span><span class="sxs-lookup"><span data-stu-id="9403b-116">This non-blocking behavior also significantly reduces the likelihood of deadlocks for complex transactions.</span></span>  
  
 <span data-ttu-id="9403b-117">Izolacja migawki używa modelu współbieżności optymistyczne.</span><span class="sxs-lookup"><span data-stu-id="9403b-117">Snapshot isolation uses an optimistic concurrency model.</span></span> <span data-ttu-id="9403b-118">Jeśli transakcja migawki próbuje zatwierdzić modyfikacje danych, które uległy zmianie od momentu rozpoczęcia transakcji, transakcja zostanie wycofana i zostanie zgłoszony błąd.</span><span class="sxs-lookup"><span data-stu-id="9403b-118">If a snapshot transaction attempts to commit modifications to data that has changed since the transaction began, the transaction will roll back and an error will be raised.</span></span> <span data-ttu-id="9403b-119">Można tego uniknąć, używając wskazówek UPDLOCK dla instrukcji SELECT, które mają być modyfikowane przez dane dostępu.</span><span class="sxs-lookup"><span data-stu-id="9403b-119">You can avoid this by using UPDLOCK hints for SELECT statements that access data to be modified.</span></span> <span data-ttu-id="9403b-120">Aby uzyskać więcej informacji, zobacz "Wskazówki dotyczące blokowania" w programie SQL Server Books Online.</span><span class="sxs-lookup"><span data-stu-id="9403b-120">See "Locking Hints" in SQL Server Books Online for more information.</span></span>  
  
 <span data-ttu-id="9403b-121">Izolacja migawki musi być włączona, ustawiając opcję bazy danych ALLOW_SNAPSHOT_ISOLATION ON, zanim będzie używana w transakcjach.</span><span class="sxs-lookup"><span data-stu-id="9403b-121">Snapshot isolation must be enabled by setting the ALLOW_SNAPSHOT_ISOLATION ON database option before it is used in transactions.</span></span> <span data-ttu-id="9403b-122">Aktywuje to mechanizm przechowywania wersji wiersza w tymczasowej bazie danych (**tempdb**).</span><span class="sxs-lookup"><span data-stu-id="9403b-122">This activates the mechanism for storing row versions in the temporary database (**tempdb**).</span></span> <span data-ttu-id="9403b-123">Izolacja migawki w każdej bazie danych, która używa go z Instrukcja Transact-SQL ALTER DATABASE.</span><span class="sxs-lookup"><span data-stu-id="9403b-123">You must enable snapshot isolation in each database that uses it with the Transact-SQL ALTER DATABASE statement.</span></span> <span data-ttu-id="9403b-124">W związku z tym izolacja migawki różni się od tradycyjnych poziomów izolacji ODCZYT COMMITTED, REPEATABLE READ, SERIALIZABLE i READ UNCOMMITTED, które nie wymagają konfiguracji.</span><span class="sxs-lookup"><span data-stu-id="9403b-124">In this respect, snapshot isolation differs from the traditional isolation levels of READ COMMITTED, REPEATABLE READ, SERIALIZABLE, and READ UNCOMMITTED, which require no configuration.</span></span> <span data-ttu-id="9403b-125">Następujące instrukcje aktywują izolację migawki i zastępują domyślne zachowanie READ COMMITTED migawką:</span><span class="sxs-lookup"><span data-stu-id="9403b-125">The following statements activate snapshot isolation and replace the default READ COMMITTED behavior with SNAPSHOT:</span></span>  
  
```sql  
ALTER DATABASE MyDatabase  
SET ALLOW_SNAPSHOT_ISOLATION ON  
  
ALTER DATABASE MyDatabase  
SET READ_COMMITTED_SNAPSHOT ON  
```  
  
 <span data-ttu-id="9403b-126">Ustawienie opcji READ_COMMITTED_SNAPSHOT ON umożliwia dostęp do wierszy wersjonowanych pod domyślnym poziomem izolacji ODCZYTU POPEŁNIONE.</span><span class="sxs-lookup"><span data-stu-id="9403b-126">Setting the READ_COMMITTED_SNAPSHOT ON option allows access to versioned rows under the default READ COMMITTED isolation level.</span></span> <span data-ttu-id="9403b-127">Jeśli opcja READ_COMMITTED_SNAPSHOT jest ustawiona na OFF, należy jawnie ustawić poziom izolacji migawki dla każdej sesji, aby uzyskać dostęp do wierszy wersjonowanych.</span><span class="sxs-lookup"><span data-stu-id="9403b-127">If the READ_COMMITTED_SNAPSHOT option is set to OFF, you must explicitly set the Snapshot isolation level for each session in order to access versioned rows.</span></span>  
  
## <a name="managing-concurrency-with-isolation-levels"></a><span data-ttu-id="9403b-128">Zarządzanie współbieżnością z poziomami izolacji</span><span class="sxs-lookup"><span data-stu-id="9403b-128">Managing Concurrency with Isolation Levels</span></span>  
 <span data-ttu-id="9403b-129">Poziom izolacji, na którym wykonuje instrukcja Transact-SQL określa jego zachowanie blokowania i przechowywania wersji wiersza.</span><span class="sxs-lookup"><span data-stu-id="9403b-129">The isolation level under which a Transact-SQL statement executes determines its locking and row versioning behavior.</span></span> <span data-ttu-id="9403b-130">Poziom izolacji ma zakres całego połączenia i po ustawieniu połączenia z instrukcją SET TRANSACTION ISOLATION LEVEL pozostaje w mocy, dopóki połączenie nie zostanie zamknięte lub zostanie ustawiony inny poziom izolacji.</span><span class="sxs-lookup"><span data-stu-id="9403b-130">An isolation level has connection-wide scope, and once set for a connection with the SET TRANSACTION ISOLATION LEVEL statement, it remains in effect until the connection is closed or another isolation level is set.</span></span> <span data-ttu-id="9403b-131">Gdy połączenie jest zamknięte i zwrócone do puli, poziom izolacji z ostatniej instrukcji SET TRANSACTION ISOLATION LEVEL jest zachowywany.</span><span class="sxs-lookup"><span data-stu-id="9403b-131">When a connection is closed and returned to the pool, the isolation level from the last SET TRANSACTION ISOLATION LEVEL statement is retained.</span></span> <span data-ttu-id="9403b-132">Kolejne połączenia ponownie korzystające z połączenia pooled używają poziomu izolacji, który obowiązywał w momencie połączenia.</span><span class="sxs-lookup"><span data-stu-id="9403b-132">Subsequent connections reusing a pooled connection use the isolation level that was in effect at the time the connection is pooled.</span></span>  
  
 <span data-ttu-id="9403b-133">Poszczególne zapytania wydane w ramach połączenia mogą zawierać wskazówki blokady, które modyfikują izolację dla pojedynczej instrukcji lub transakcji, ale nie wpływają na poziom izolacji połączenia.</span><span class="sxs-lookup"><span data-stu-id="9403b-133">Individual queries issued within a connection can contain lock hints that modify the isolation for a single statement or transaction but do not affect the isolation level of the connection.</span></span> <span data-ttu-id="9403b-134">Poziomy izolacji lub wskazówki blokady ustawione w procedurach składowanych lub funkcji nie zmieniają poziomu izolacji połączenia, które je wywołuje i obowiązują tylko przez czas trwania procedury składowanej lub wywołania funkcji.</span><span class="sxs-lookup"><span data-stu-id="9403b-134">Isolation levels or lock hints set in stored procedures or functions do not change the isolation level of the connection that calls them and are in effect only for the duration of the stored procedure or function call.</span></span>  
  
 <span data-ttu-id="9403b-135">Cztery poziomy izolacji zdefiniowane w standardzie SQL-92 były obsługiwane we wczesnych wersjach programu SQL Server:</span><span class="sxs-lookup"><span data-stu-id="9403b-135">Four isolation levels defined in the SQL-92 standard were supported in early versions of SQL Server:</span></span>  
  
- <span data-ttu-id="9403b-136">READ UNCOMMITTED jest najmniej restrykcyjny poziom izolacji, ponieważ ignoruje blokady umieszczone przez inne transakcje.</span><span class="sxs-lookup"><span data-stu-id="9403b-136">READ UNCOMMITTED is the least restrictive isolation level because it ignores locks placed by other transactions.</span></span> <span data-ttu-id="9403b-137">Transakcje wykonywane w ramach odczytu BEZKOMIENIA można odczytać zmodyfikowane wartości danych, które nie zostały jeszcze zatwierdzone przez inne transakcje; są one nazywane "brudne" odczyty.</span><span class="sxs-lookup"><span data-stu-id="9403b-137">Transactions executing under READ UNCOMMITTED can read modified data values that have not yet been committed by other transactions; these are called "dirty" reads.</span></span>  
  
- <span data-ttu-id="9403b-138">READ COMMITTED jest domyślnym poziomem izolacji dla programu SQL Server.</span><span class="sxs-lookup"><span data-stu-id="9403b-138">READ COMMITTED is the default isolation level for SQL Server.</span></span> <span data-ttu-id="9403b-139">Zapobiega odczyty brudne, określając, że instrukcje nie można odczytać wartości danych, które zostały zmodyfikowane, ale jeszcze nie zatwierdzone przez inne transakcje.</span><span class="sxs-lookup"><span data-stu-id="9403b-139">It prevents dirty reads by specifying that statements cannot read data values that have been modified but not yet committed by other transactions.</span></span> <span data-ttu-id="9403b-140">Inne transakcje mogą nadal modyfikować, wstawiać lub usuwać dane między wykonaniami poszczególnych instrukcji w ramach bieżącej transakcji, co powoduje powtarzalne odczyty lub dane "fantomowe".</span><span class="sxs-lookup"><span data-stu-id="9403b-140">Other transactions can still modify, insert, or delete data between executions of individual statements within the current transaction, resulting in non-repeatable reads, or "phantom" data.</span></span>  
  
- <span data-ttu-id="9403b-141">ODCZYT POWTARZALNY jest bardziej restrykcyjnym poziomem izolacji niż odczyt committed.</span><span class="sxs-lookup"><span data-stu-id="9403b-141">REPEATABLE READ is a more restrictive isolation level than READ COMMITTED.</span></span> <span data-ttu-id="9403b-142">Obejmuje ona read committed i dodatkowo określa, że żadne inne transakcje można modyfikować lub usuwać dane, które zostały odczytane przez bieżącą transakcję, dopóki bieżąca transakcja zatwierdza.</span><span class="sxs-lookup"><span data-stu-id="9403b-142">It encompasses READ COMMITTED and additionally specifies that no other transactions can modify or delete data that has been read by the current transaction until the current transaction commits.</span></span> <span data-ttu-id="9403b-143">Współbieżność jest niższa niż dla ODCZYTU POPEŁNIONE, ponieważ blokady udostępnione na odczyt danych są przechowywane przez czas trwania transakcji, a nie są zwalniane na końcu każdej instrukcji.</span><span class="sxs-lookup"><span data-stu-id="9403b-143">Concurrency is lower than for READ COMMITTED because shared locks on read data are held for the duration of the transaction instead of being released at the end of each statement.</span></span>  
  
- <span data-ttu-id="9403b-144">SERIALIZABLE jest najbardziej restrykcyjny poziom izolacji, ponieważ blokuje całe zakresy kluczy i przechowuje blokady, dopóki transakcja nie zostanie zakończona.</span><span class="sxs-lookup"><span data-stu-id="9403b-144">SERIALIZABLE is the most restrictive isolation level, because it locks entire ranges of keys and holds the locks until the transaction is complete.</span></span> <span data-ttu-id="9403b-145">Obejmuje powtarzalny odczyt i dodaje ograniczenie, że inne transakcje nie można wstawić nowe wiersze do zakresów, które zostały odczytane przez transakcję, dopóki transakcja nie zostanie zakończona.</span><span class="sxs-lookup"><span data-stu-id="9403b-145">It encompasses REPEATABLE READ and adds the restriction that other transactions cannot insert new rows into ranges that have been read by the transaction until the transaction is complete.</span></span>  
  
 <span data-ttu-id="9403b-146">Aby uzyskać więcej informacji, zapoznaj się z [przewodnikiem blokowania transakcji i wersji wiersza](/sql/relational-databases/sql-server-transaction-locking-and-row-versioning-guide).</span><span class="sxs-lookup"><span data-stu-id="9403b-146">For more information, refer to the [Transaction Locking and Row Versioning Guide](/sql/relational-databases/sql-server-transaction-locking-and-row-versioning-guide).</span></span>  
  
### <a name="snapshot-isolation-level-extensions"></a><span data-ttu-id="9403b-147">Rozszerzenia poziomu izolacji migawki</span><span class="sxs-lookup"><span data-stu-id="9403b-147">Snapshot Isolation Level Extensions</span></span>  
 <span data-ttu-id="9403b-148">SQL Server wprowadzono rozszerzenia do poziomów izolacji SQL-92 z wprowadzeniem poziomu izolacji migawki i dodatkowej implementacji READ COMMITTED.</span><span class="sxs-lookup"><span data-stu-id="9403b-148">SQL Server introduced extensions to the SQL-92 isolation levels with the introduction of the SNAPSHOT isolation level and an additional implementation of READ COMMITTED.</span></span> <span data-ttu-id="9403b-149">Poziom izolacji READ_COMMITTED_SNAPSHOT może w sposób przejrzysty zastąpić READ COMMITTED dla wszystkich transakcji.</span><span class="sxs-lookup"><span data-stu-id="9403b-149">The READ_COMMITTED_SNAPSHOT isolation level can transparently replace READ COMMITTED for all transactions.</span></span>  
  
- <span data-ttu-id="9403b-150">Izolacja migawka określa, że dane odczytane w ramach transakcji nigdy nie będą odzwierciedlać zmian wprowadzonych przez inne transakcje jednoczesne.</span><span class="sxs-lookup"><span data-stu-id="9403b-150">SNAPSHOT isolation specifies that data read within a transaction will never reflect changes made by other simultaneous transactions.</span></span> <span data-ttu-id="9403b-151">Transakcja używa wersji wiersza danych, które istnieją po rozpoczęciu transakcji.</span><span class="sxs-lookup"><span data-stu-id="9403b-151">The transaction uses the data row versions that exist when the transaction begins.</span></span> <span data-ttu-id="9403b-152">Żadne blokady są umieszczane na danych, gdy jest odczytywany, więc transakcje MIGAWKA nie blokują innych transakcji z zapisywania danych.</span><span class="sxs-lookup"><span data-stu-id="9403b-152">No locks are placed on the data when it is read, so SNAPSHOT transactions do not block other transactions from writing data.</span></span> <span data-ttu-id="9403b-153">Transakcje, które zapisują dane, nie blokują transakcji migawki z odczytu danych.</span><span class="sxs-lookup"><span data-stu-id="9403b-153">Transactions that write data do not block snapshot transactions from reading data.</span></span> <span data-ttu-id="9403b-154">Aby ją użyć, należy włączyć izolację migawki, ustawiając opcję ALLOW_SNAPSHOT_ISOLATION bazy danych.</span><span class="sxs-lookup"><span data-stu-id="9403b-154">You need to enable snapshot isolation by setting the ALLOW_SNAPSHOT_ISOLATION database option in order to use it.</span></span>  
  
- <span data-ttu-id="9403b-155">Opcja READ_COMMITTED_SNAPSHOT bazy danych określa zachowanie domyślnego poziomu izolacji ODCZYTU POPEŁNIONE, gdy izolacja migawki jest włączona w bazie danych.</span><span class="sxs-lookup"><span data-stu-id="9403b-155">The READ_COMMITTED_SNAPSHOT database option determines the behavior of the default READ COMMITTED isolation level when snapshot isolation is enabled in a database.</span></span> <span data-ttu-id="9403b-156">Jeśli nie zostanie jawnie określić READ_COMMITTED_SNAPSHOT ON, READ COMMITTED jest stosowany do wszystkich transakcji niejawnych.</span><span class="sxs-lookup"><span data-stu-id="9403b-156">If you do not explicitly specify READ_COMMITTED_SNAPSHOT ON, READ COMMITTED is applied to all implicit transactions.</span></span> <span data-ttu-id="9403b-157">Powoduje to takie samo zachowanie jak ustawienie READ_COMMITTED_SNAPSHOT OFF (domyślnie).</span><span class="sxs-lookup"><span data-stu-id="9403b-157">This produces the same behavior as setting READ_COMMITTED_SNAPSHOT OFF (the default).</span></span> <span data-ttu-id="9403b-158">Gdy READ_COMMITTED_SNAPSHOT OFF jest w mocy, Aparat baz danych używa blokad udostępnionych w celu wymuszenia domyślnego poziomu izolacji.</span><span class="sxs-lookup"><span data-stu-id="9403b-158">When READ_COMMITTED_SNAPSHOT OFF is in effect, the Database Engine uses shared locks to enforce the default isolation level.</span></span> <span data-ttu-id="9403b-159">Jeśli ustawisz opcję READ_COMMITTED_SNAPSHOT bazy danych na ON, aparat bazy danych używa przechowywania wersji wiersza i izolacji migawki jako domyślnej, zamiast używać blokad do ochrony danych.</span><span class="sxs-lookup"><span data-stu-id="9403b-159">If you set the READ_COMMITTED_SNAPSHOT database option to ON, the database engine uses row versioning and snapshot isolation as the default, instead of using locks to protect the data.</span></span>  
  
## <a name="how-snapshot-isolation-and-row-versioning-work"></a><span data-ttu-id="9403b-160">Jak działa izolacja migawki i przechowywanie wersji wiersza</span><span class="sxs-lookup"><span data-stu-id="9403b-160">How Snapshot Isolation and Row Versioning Work</span></span>  
 <span data-ttu-id="9403b-161">Po włączeniu poziomu izolacji migawki, za każdym razem, gdy wiersz jest aktualizowany, aparat baz danych programu SQL Server przechowuje kopię oryginalnego wiersza w **programie tempdb**i dodaje numer sekwencyjny transakcji do wiersza.</span><span class="sxs-lookup"><span data-stu-id="9403b-161">When the SNAPSHOT isolation level is enabled, each time a row is updated, the SQL Server Database Engine stores a copy of the original row in **tempdb**, and adds a transaction sequence number to the row.</span></span> <span data-ttu-id="9403b-162">Poniżej przedstawiono sekwencję zdarzeń, które występują:</span><span class="sxs-lookup"><span data-stu-id="9403b-162">The following is the sequence of events that occurs:</span></span>  
  
- <span data-ttu-id="9403b-163">Nowa transakcja jest inicjowana i jest przypisywana numer sekwencyjny transakcji.</span><span class="sxs-lookup"><span data-stu-id="9403b-163">A new transaction is initiated, and it is assigned a transaction sequence number.</span></span>  
  
- <span data-ttu-id="9403b-164">Aparat baz danych odczytuje wiersz w ramach transakcji i pobiera wersję wiersza z **tempdb,** którego numer sekwencyjny jest najbliżej i niższy niż numer sekwencyjny transakcji.</span><span class="sxs-lookup"><span data-stu-id="9403b-164">The Database Engine reads a row within the transaction and retrieves the row version from **tempdb** whose sequence number is closest to, and lower than, the transaction sequence number.</span></span>  
  
- <span data-ttu-id="9403b-165">Aparat baz danych sprawdza, czy numer sekwencyjny transakcji nie znajduje się na liście numerów sekwencyjnych transakcji niezakończonej transakcji aktywnych po rozpoczęciu transakcji migawkowej.</span><span class="sxs-lookup"><span data-stu-id="9403b-165">The Database Engine checks to see if the transaction sequence number is not in the list of transaction sequence numbers of the uncommitted transactions active when the snapshot transaction started.</span></span>  
  
- <span data-ttu-id="9403b-166">Transakcja odczytuje wersję wiersza z **tempdb,** który był bieżący od początku transakcji.</span><span class="sxs-lookup"><span data-stu-id="9403b-166">The transaction reads the version of the row from **tempdb** that was current as of the start of the transaction.</span></span> <span data-ttu-id="9403b-167">Nie będzie widać nowych wierszy wstawionych po rozpoczęciu transakcji, ponieważ te wartości numerów sekwencyjnych będą wyższe niż wartość numeru sekwencyjnyego transakcji.</span><span class="sxs-lookup"><span data-stu-id="9403b-167">It will not see new rows inserted after the transaction was started because those sequence number values will be higher than the value of the transaction sequence number.</span></span>  
  
- <span data-ttu-id="9403b-168">Bieżąca transakcja zobaczy wiersze, które zostały usunięte po rozpoczęciu transakcji, ponieważ w **pliku tempdb** będzie dostępna wersja wiersza o niższej wartości numeru sekwencowego.</span><span class="sxs-lookup"><span data-stu-id="9403b-168">The current transaction will see rows that were deleted after the transaction began, because there will be a row version in **tempdb** with a lower sequence number value.</span></span>  
  
 <span data-ttu-id="9403b-169">Efekt netto izolacji migawki jest, że transakcja widzi wszystkie dane, jak istniały na początku transakcji, bez honorowania lub umieszczania żadnych blokad na tabelach źródłowych.</span><span class="sxs-lookup"><span data-stu-id="9403b-169">The net effect of snapshot isolation is that the transaction sees all of the data as it existed at the start of the transaction, without honoring or placing any locks on the underlying tables.</span></span> <span data-ttu-id="9403b-170">Może to spowodować poprawę wydajności w sytuacjach, w których istnieje rywalizacja.</span><span class="sxs-lookup"><span data-stu-id="9403b-170">This can result in performance improvements in situations where there is contention.</span></span>  
  
 <span data-ttu-id="9403b-171">Transakcja migawka zawsze używa kontroli współbieżności optymistyczne, wstrzymanie wszelkich blokad, które uniemożliwiłyby inne transakcje aktualizowanie wierszy.</span><span class="sxs-lookup"><span data-stu-id="9403b-171">A snapshot transaction always uses optimistic concurrency control, withholding any locks that would prevent other transactions from updating rows.</span></span> <span data-ttu-id="9403b-172">Jeśli transakcja migawki próbuje zatwierdzić aktualizację do wiersza, który został zmieniony po rozpoczęciu transakcji, transakcja jest przywracana i zgłaszany jest błąd.</span><span class="sxs-lookup"><span data-stu-id="9403b-172">If a snapshot transaction attempts to commit an update to a row that was changed after the transaction began, the transaction is rolled back, and an error is raised.</span></span>  
  
## <a name="working-with-snapshot-isolation-in-adonet"></a><span data-ttu-id="9403b-173">Praca z izolacją migawek w ADO.NET</span><span class="sxs-lookup"><span data-stu-id="9403b-173">Working with Snapshot Isolation in ADO.NET</span></span>  
 <span data-ttu-id="9403b-174">Izolacja migawki jest obsługiwana <xref:System.Data.SqlClient.SqlTransaction> w ADO.NET przez klasę.</span><span class="sxs-lookup"><span data-stu-id="9403b-174">Snapshot isolation is supported in ADO.NET by the <xref:System.Data.SqlClient.SqlTransaction> class.</span></span> <span data-ttu-id="9403b-175">Jeśli baza danych została włączona dla izolacji migawki, ale nie jest skonfigurowany do READ_COMMITTED_SNAPSHOT ON, należy zainicjować <xref:System.Data.SqlClient.SqlTransaction> przy użyciu **IsolationLevel.Snapshot** wartość wyliczenia podczas wywoływania <xref:System.Data.SqlClient.SqlConnection.BeginTransaction%2A> metody.</span><span class="sxs-lookup"><span data-stu-id="9403b-175">If a database has been enabled for snapshot isolation but is not configured for READ_COMMITTED_SNAPSHOT ON, you must initiate a <xref:System.Data.SqlClient.SqlTransaction> using the **IsolationLevel.Snapshot** enumeration value when calling the <xref:System.Data.SqlClient.SqlConnection.BeginTransaction%2A> method.</span></span> <span data-ttu-id="9403b-176">Ten fragment kodu zakłada, że <xref:System.Data.SqlClient.SqlConnection> połączenie jest obiektem otwartym.</span><span class="sxs-lookup"><span data-stu-id="9403b-176">This code fragment assumes that connection is an open <xref:System.Data.SqlClient.SqlConnection> object.</span></span>  
  
```vb  
Dim sqlTran As SqlTransaction = _  
  connection.BeginTransaction(IsolationLevel.Snapshot)  
```  
  
```csharp  
SqlTransaction sqlTran =
  connection.BeginTransaction(IsolationLevel.Snapshot);  
```  
  
### <a name="example"></a><span data-ttu-id="9403b-177">Przykład</span><span class="sxs-lookup"><span data-stu-id="9403b-177">Example</span></span>  
 <span data-ttu-id="9403b-178">W poniższym przykładzie pokazano, jak zachowują się różne poziomy izolacji, próbując uzyskać dostęp do zablokowanych danych i nie jest przeznaczony do użycia w kodzie produkcyjnym.</span><span class="sxs-lookup"><span data-stu-id="9403b-178">The following example demonstrates how the different isolation levels behave by attempting to access locked data, and it is not intended to be used in production code.</span></span>  
  
 <span data-ttu-id="9403b-179">Kod łączy się z przykładową bazą danych **AdventureWorks** w programie SQL Server i tworzy tabelę o nazwie **TestSnapshot** i wstawia jeden wiersz danych.</span><span class="sxs-lookup"><span data-stu-id="9403b-179">The code connects to the **AdventureWorks** sample database in SQL Server and creates a table named **TestSnapshot** and inserts one row of data.</span></span> <span data-ttu-id="9403b-180">Kod używa alter database Transact-SQL instrukcji, aby włączyć izolację migawki dla bazy danych, ale nie ustawia READ_COMMITTED_SNAPSHOT, pozostawiając domyślne odczytu popełnione zachowanie na poziomie izolacji w efekcie.</span><span class="sxs-lookup"><span data-stu-id="9403b-180">The code uses the ALTER DATABASE Transact-SQL statement to turn on snapshot isolation for the database, but it does not set the READ_COMMITTED_SNAPSHOT option, leaving the default READ COMMITTED isolation-level behavior in effect.</span></span> <span data-ttu-id="9403b-181">Następnie kod wykonuje następujące akcje:</span><span class="sxs-lookup"><span data-stu-id="9403b-181">The code then performs the following actions:</span></span>  
  
- <span data-ttu-id="9403b-182">Rozpoczyna się, ale nie kończy, sqlTransaction1, który używa poziomu izolacji serializable, aby rozpocząć transakcję aktualizacji.</span><span class="sxs-lookup"><span data-stu-id="9403b-182">It begins, but does not complete, sqlTransaction1, which uses the SERIALIZABLE isolation level to start an update transaction.</span></span> <span data-ttu-id="9403b-183">Ma to wpływ na zablokowanie tabeli.</span><span class="sxs-lookup"><span data-stu-id="9403b-183">This has the effect of locking the table.</span></span>  
  
- <span data-ttu-id="9403b-184">Otwiera drugie połączenie i inicjuje drugą transakcję przy użyciu poziomu izolacji MIGAWKA do odczytu danych w **tabeli TestSnapshot.**</span><span class="sxs-lookup"><span data-stu-id="9403b-184">It opens a second connection and initiates a second transaction using the SNAPSHOT isolation level to read the data in the **TestSnapshot** table.</span></span> <span data-ttu-id="9403b-185">Ponieważ izolacja migawki jest włączona, ta transakcja może odczytać dane, które istniały przed sqlTransaction1 rozpoczęte.</span><span class="sxs-lookup"><span data-stu-id="9403b-185">Because snapshot isolation is enabled, this transaction can read the data that existed before sqlTransaction1 started.</span></span>  
  
- <span data-ttu-id="9403b-186">Otwiera trzecie połączenie i inicjuje transakcję przy użyciu poziomu izolacji READ COMMITTED, aby spróbować odczytać dane w tabeli.</span><span class="sxs-lookup"><span data-stu-id="9403b-186">It opens a third connection and initiates a transaction using the READ COMMITTED isolation level to attempt to read the data in the table.</span></span> <span data-ttu-id="9403b-187">W takim przypadku kod nie może odczytać danych, ponieważ nie można odczytać obok blokad umieszczonych w tabeli w pierwszej transakcji i upoicie limit czasu. Ten sam wynik będzie występować, jeśli powtarzalne odczytu i serializable poziomy izolacji zostały użyte, ponieważ te poziomy izolacji również nie można odczytać przeszłości blokady umieszczone w pierwszej transakcji.</span><span class="sxs-lookup"><span data-stu-id="9403b-187">In this case, the code cannot read the data because it cannot read past the locks placed on the table in the first transaction and times out. The same result would occur if the REPEATABLE READ and SERIALIZABLE isolation levels were used because these isolation levels also cannot read past the locks placed in the first transaction.</span></span>  
  
- <span data-ttu-id="9403b-188">Otwiera czwarte połączenie i inicjuje transakcję przy użyciu poziomu izolacji UNCOMMITTED ODCZYTu, który wykonuje brudny odczyt niezatwierdzonej wartości w sqlTransaction1.</span><span class="sxs-lookup"><span data-stu-id="9403b-188">It opens a fourth connection and initiates a transaction using the READ UNCOMMITTED isolation level, which performs a dirty read of the uncommitted value in sqlTransaction1.</span></span> <span data-ttu-id="9403b-189">Ta wartość może nigdy nie istnieć w bazie danych, jeśli pierwsza transakcja nie jest zatwierdzona.</span><span class="sxs-lookup"><span data-stu-id="9403b-189">This value may never actually exist in the database if the first transaction is not committed.</span></span>  
  
- <span data-ttu-id="9403b-190">Wycofuje pierwszą transakcję i czyści przez usunięcie **TestSnapshot** tabeli i wyłączenie izolacji migawki dla **adventureworks** bazy danych.</span><span class="sxs-lookup"><span data-stu-id="9403b-190">It rolls back the first transaction and cleans up by deleting the **TestSnapshot** table and turning off snapshot isolation for the **AdventureWorks** database.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="9403b-191">W poniższych przykładach użyto tego samego ciągu połączenia z wyłączonym buforem połączeń.</span><span class="sxs-lookup"><span data-stu-id="9403b-191">The following examples use the same connection string with connection pooling turned off.</span></span> <span data-ttu-id="9403b-192">Jeśli połączenie jest połączone, zresetowanie jego poziomu izolacji nie resetuje poziomu izolacji na serwerze.</span><span class="sxs-lookup"><span data-stu-id="9403b-192">If a connection is pooled, resetting its isolation level does not reset the isolation level at the server.</span></span> <span data-ttu-id="9403b-193">W rezultacie kolejne połączenia, które używają tego samego połączenia wewnętrznego puli rozpocząć z ich poziomów izolacji ustawiona na to, że połączenie w puli.</span><span class="sxs-lookup"><span data-stu-id="9403b-193">As a result, subsequent connections that use the same pooled inner connection start with their isolation levels set to that of the pooled connection.</span></span> <span data-ttu-id="9403b-194">Alternatywą dla wyłączania buforowania połączeń jest jawne ustawienie poziomu izolacji dla każdego połączenia.</span><span class="sxs-lookup"><span data-stu-id="9403b-194">An alternative to turning off connection pooling is to set the isolation level explicitly for each connection.</span></span>  
  
 [!code-csharp[DataWorks SnapshotIsolation.Demo#1](../../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks SnapshotIsolation.Demo/CS/source.cs#1)]
 [!code-vb[DataWorks SnapshotIsolation.Demo#1](../../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks SnapshotIsolation.Demo/VB/source.vb#1)]  
  
### <a name="example"></a><span data-ttu-id="9403b-195">Przykład</span><span class="sxs-lookup"><span data-stu-id="9403b-195">Example</span></span>  
 <span data-ttu-id="9403b-196">W poniższym przykładzie pokazano zachowanie izolacji migawki, gdy dane są modyfikowane.</span><span class="sxs-lookup"><span data-stu-id="9403b-196">The following example demonstrates the behavior of snapshot isolation when data is being modified.</span></span> <span data-ttu-id="9403b-197">Kod wykonuje następujące akcje:</span><span class="sxs-lookup"><span data-stu-id="9403b-197">The code performs the following actions:</span></span>  
  
- <span data-ttu-id="9403b-198">Łączy się z **adventureworks** przykładowej bazy danych i umożliwia izolację MIGAWKI.</span><span class="sxs-lookup"><span data-stu-id="9403b-198">Connects to the **AdventureWorks** sample database and enables SNAPSHOT isolation.</span></span>  
  
- <span data-ttu-id="9403b-199">Tworzy tabelę o nazwie **TestSnapshotUpdate** i wstawia trzy wiersze przykładowych danych.</span><span class="sxs-lookup"><span data-stu-id="9403b-199">Creates a table named **TestSnapshotUpdate** and inserts three rows of sample data.</span></span>  
  
- <span data-ttu-id="9403b-200">Rozpoczyna się, ale nie kończy, sqlTransaction1 przy użyciu izolacji migawki.</span><span class="sxs-lookup"><span data-stu-id="9403b-200">Begins, but does not complete, sqlTransaction1 using SNAPSHOT isolation.</span></span> <span data-ttu-id="9403b-201">W transakcji są wybierane trzy wiersze danych.</span><span class="sxs-lookup"><span data-stu-id="9403b-201">Three rows of data are selected in the transaction.</span></span>  
  
- <span data-ttu-id="9403b-202">Tworzy drugi **SqlConnection** do **AdventureWorks** i tworzy drugą transakcję przy użyciu odczytu popełnione poziom izolacji, który aktualizuje wartość w jednym z wierszy wybranych w sqlTransaction1.</span><span class="sxs-lookup"><span data-stu-id="9403b-202">Creates a second **SqlConnection** to **AdventureWorks** and creates a second transaction using the READ COMMITTED isolation level that updates a value in one of the rows selected in sqlTransaction1.</span></span>  
  
- <span data-ttu-id="9403b-203">Zatwierdza sqlTransaction2.</span><span class="sxs-lookup"><span data-stu-id="9403b-203">Commits sqlTransaction2.</span></span>  
  
- <span data-ttu-id="9403b-204">Zwraca do sqlTransaction1 i próbuje zaktualizować ten sam wiersz, który sqlTransaction1 już zatwierdzone.</span><span class="sxs-lookup"><span data-stu-id="9403b-204">Returns to sqlTransaction1 and attempts to update the same row that sqlTransaction1 already committed.</span></span> <span data-ttu-id="9403b-205">Błąd 3960 jest wywoływany, a sqlTransaction1 jest przywracany automatycznie.</span><span class="sxs-lookup"><span data-stu-id="9403b-205">Error 3960 is raised, and sqlTransaction1 is rolled back automatically.</span></span> <span data-ttu-id="9403b-206">**SqlException.Number** i **SqlException.Message** są wyświetlane w oknie konsoli.</span><span class="sxs-lookup"><span data-stu-id="9403b-206">The **SqlException.Number** and **SqlException.Message** are displayed in the Console window.</span></span>  
  
- <span data-ttu-id="9403b-207">Wykonuje kod oczyszczania, aby wyłączyć izolację migawki w **AdventureWorks** i usunąć **testsnapshotUpdate** tabeli.</span><span class="sxs-lookup"><span data-stu-id="9403b-207">Executes clean-up code to turn off snapshot isolation in **AdventureWorks** and delete the **TestSnapshotUpdate** table.</span></span>  
  
 [!code-csharp[DataWorks SnapshotIsolation.DemoUpdate#1](../../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks SnapshotIsolation.DemoUpdate/CS/source.cs#1)]
 [!code-vb[DataWorks SnapshotIsolation.DemoUpdate#1](../../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks SnapshotIsolation.DemoUpdate/VB/source.vb#1)]  
  
### <a name="using-lock-hints-with-snapshot-isolation"></a><span data-ttu-id="9403b-208">Korzystanie z wskazówek dotyczących blokowania z izolacją migawki</span><span class="sxs-lookup"><span data-stu-id="9403b-208">Using Lock Hints with Snapshot Isolation</span></span>  
 <span data-ttu-id="9403b-209">W poprzednim przykładzie pierwsza transakcja wybiera dane, a druga transakcja aktualizuje dane przed pierwszą transakcją jest w stanie zakończyć, powodując konflikt aktualizacji, gdy pierwsza transakcja próbuje zaktualizować ten sam wiersz.</span><span class="sxs-lookup"><span data-stu-id="9403b-209">In the previous example, the first transaction selects data, and a second transaction updates the data before the first transaction is able to complete, causing an update conflict when the first transaction tries to update the same row.</span></span> <span data-ttu-id="9403b-210">Można zmniejszyć ryzyko konfliktów aktualizacji w długotrwałych transakcji migawki, podając wskazówki blokady na początku transakcji.</span><span class="sxs-lookup"><span data-stu-id="9403b-210">You can reduce the chance of update conflicts in long-running snapshot transactions by supplying lock hints at the beginning of the transaction.</span></span> <span data-ttu-id="9403b-211">Następująca instrukcja SELECT używa wskazówki UPDLOCK do blokowania wybranych wierszy:</span><span class="sxs-lookup"><span data-stu-id="9403b-211">The following SELECT statement uses the UPDLOCK hint to lock the selected rows:</span></span>  
  
```sql  
SELECT * FROM TestSnapshotUpdate WITH (UPDLOCK)
  WHERE PriKey BETWEEN 1 AND 3  
```  
  
 <span data-ttu-id="9403b-212">Za pomocą wskazówki blokady UPDLOCK blokuje wiersze próby aktualizacji wierszy przed zakończeniem pierwszej transakcji.</span><span class="sxs-lookup"><span data-stu-id="9403b-212">Using the UPDLOCK lock hint blocks any rows attempting to update the rows before the first transaction completes.</span></span> <span data-ttu-id="9403b-213">Gwarantuje to, że wybrane wiersze nie mają konfliktów, gdy są aktualizowane w dalszej części transakcji.</span><span class="sxs-lookup"><span data-stu-id="9403b-213">This guarantees that the selected rows have no conflicts when they are updated later in the transaction.</span></span> <span data-ttu-id="9403b-214">Zobacz "Wskazówki dotyczące blokowania" w programie SQL Server Books Online.</span><span class="sxs-lookup"><span data-stu-id="9403b-214">See "Locking Hints" in SQL Server Books Online.</span></span>  
  
 <span data-ttu-id="9403b-215">Jeśli aplikacja ma wiele konfliktów, izolacja migawki może nie być najlepszym wyborem.</span><span class="sxs-lookup"><span data-stu-id="9403b-215">If your application has many conflicts, snapshot isolation may not be the best choice.</span></span> <span data-ttu-id="9403b-216">Wskazówki powinny być używane tylko wtedy, gdy naprawdę potrzebne.</span><span class="sxs-lookup"><span data-stu-id="9403b-216">Hints should only be used when really needed.</span></span> <span data-ttu-id="9403b-217">Aplikacja nie powinna być zaprojektowana tak, aby stale opiera się na wskazówki blokady dla jego działania.</span><span class="sxs-lookup"><span data-stu-id="9403b-217">Your application should not be designed so that it constantly relies on lock hints for its operation.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="9403b-218">Zobacz też</span><span class="sxs-lookup"><span data-stu-id="9403b-218">See also</span></span>

- [<span data-ttu-id="9403b-219">SQL Server i ADO.NET</span><span class="sxs-lookup"><span data-stu-id="9403b-219">SQL Server and ADO.NET</span></span>](index.md)
- [<span data-ttu-id="9403b-220">Omówienie ADO.NET</span><span class="sxs-lookup"><span data-stu-id="9403b-220">ADO.NET Overview</span></span>](../ado-net-overview.md)
- [<span data-ttu-id="9403b-221">Przewodnik po blokowaniu transakcji i wersjowaniu wierszy</span><span class="sxs-lookup"><span data-stu-id="9403b-221">Transaction Locking and Row Versioning Guide</span></span>](/sql/relational-databases/sql-server-transaction-locking-and-row-versioning-guide)
