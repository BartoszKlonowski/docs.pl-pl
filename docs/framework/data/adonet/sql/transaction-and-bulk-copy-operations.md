---
title: Transakcja i operacje kopiowania zbiorczego
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
ms.assetid: f6f0cbc9-f7bf-4d6e-875f-ad1ba0b4aa62
ms.openlocfilehash: b05ff42fc79a8fc39b7ebe4969875dbadf0dab7b
ms.sourcegitcommit: 6b308cf6d627d78ee36dbbae8972a310ac7fd6c8
ms.translationtype: MT
ms.contentlocale: pl-PL
ms.lasthandoff: 01/23/2019
ms.locfileid: "54527734"
---
# <a name="transaction-and-bulk-copy-operations"></a><span data-ttu-id="17b79-102">Transakcja i operacje kopiowania zbiorczego</span><span class="sxs-lookup"><span data-stu-id="17b79-102">Transaction and Bulk Copy Operations</span></span>
<span data-ttu-id="17b79-103">Jako operacje izolowanej lub w ramach wielu transakcji krok można wykonać operacji kopiowania zbiorczego.</span><span class="sxs-lookup"><span data-stu-id="17b79-103">Bulk copy operations can be performed as isolated operations or as part of a multiple step transaction.</span></span> <span data-ttu-id="17b79-104">Tę opcję, ostatnie pozwala wykonać kilka operacji kopiowania zbiorczego w ramach tej samej transakcji, a także wykonywać inne operacje bazy danych (na przykład wstawiania, aktualizacji i usuwania) przy zachowaniu możliwości Zatwierdź lub Wycofaj całą transakcję.</span><span class="sxs-lookup"><span data-stu-id="17b79-104">This latter option enables you to perform more than one bulk copy operation within the same transaction, as well as perform other database operations (such as inserts, updates, and deletes) while still being able to commit or roll back the entire transaction.</span></span>  
  
 <span data-ttu-id="17b79-105">Domyślnie operacji kopiowania zbiorczego odbywa się jako operacja izolowanym.</span><span class="sxs-lookup"><span data-stu-id="17b79-105">By default, a bulk copy operation is performed as an isolated operation.</span></span> <span data-ttu-id="17b79-106">Operacji kopiowania zbiorczego występuje w sposób nietransakcyjnej z nie możliwości jego wycofania.</span><span class="sxs-lookup"><span data-stu-id="17b79-106">The bulk copy operation occurs in a non-transacted way, with no opportunity for rolling it back.</span></span> <span data-ttu-id="17b79-107">Jeśli musisz wycofać całość lub część kopiowania masowego po wystąpieniu błędu, możesz użyć <xref:System.Data.SqlClient.SqlBulkCopy>-managed transakcji, wykonywać operacji kopiowania zbiorczego w ramach istniejącej transakcji lub być zarejestrowany w **System.Transactions** <xref:System.Transactions.Transaction>.</span><span class="sxs-lookup"><span data-stu-id="17b79-107">If you need to roll back all or part of the bulk copy when an error occurs, you can use a <xref:System.Data.SqlClient.SqlBulkCopy>-managed transaction, perform the bulk copy operation within an existing transaction, or be enlisted in a **System.Transactions**<xref:System.Transactions.Transaction>.</span></span>  
  
## <a name="performing-a-non-transacted-bulk-copy-operation"></a><span data-ttu-id="17b79-108">Wykonywanie operacji kopiowania zbiorczego nietransakcyjnej</span><span class="sxs-lookup"><span data-stu-id="17b79-108">Performing a Non-transacted Bulk Copy Operation</span></span>  
 <span data-ttu-id="17b79-109">Następująca aplikacja konsoli Pokazuje, co się stanie, gdy operacja kopiowania zbiorczego nietransakcyjnej napotka błąd zatrzymuje za pośrednictwem operacji.</span><span class="sxs-lookup"><span data-stu-id="17b79-109">The following Console application shows what happens when a non-transacted bulk copy operation encounters an error partway through the operation.</span></span>  
  
 <span data-ttu-id="17b79-110">W tym przykładzie tabeli źródłowej, jak i tabela docelowa zawiera `Identity` kolumnę o nazwie **ProductID**.</span><span class="sxs-lookup"><span data-stu-id="17b79-110">In the example, the source table and destination table each include an `Identity` column named **ProductID**.</span></span> <span data-ttu-id="17b79-111">Kod najpierw przygotowuje tabelę docelową, usuwając wszystkie wiersze, a następnie wstawianie pojedynczego wiersza, którego **ProductID** istnieje w tabeli źródłowej.</span><span class="sxs-lookup"><span data-stu-id="17b79-111">The code first prepares the destination table by deleting all rows and then inserting a single row whose **ProductID** is known to exist in the source table.</span></span> <span data-ttu-id="17b79-112">Domyślnie nową wartość dla `Identity` kolumny jest generowany w tabeli docelowej dla każdego wiersza dodane.</span><span class="sxs-lookup"><span data-stu-id="17b79-112">By default, a new value for the `Identity` column is generated in the destination table for each row added.</span></span> <span data-ttu-id="17b79-113">W tym przykładzie opcja jest ustawiona, gdy połączenie jest otwarte, która wymusza proces ładowania zbiorczego, używać `Identity` zamiast wartości z tabeli źródłowej.</span><span class="sxs-lookup"><span data-stu-id="17b79-113">In this example, an option is set when the connection is opened that forces the bulk load process to use the `Identity` values from the source table instead.</span></span>  
  
 <span data-ttu-id="17b79-114">Operacji kopiowania zbiorczego jest wykonywane przy użyciu <xref:System.Data.SqlClient.SqlBulkCopy.BatchSize%2A> właściwość jest ustawiona na 10.</span><span class="sxs-lookup"><span data-stu-id="17b79-114">The bulk copy operation is executed with the <xref:System.Data.SqlClient.SqlBulkCopy.BatchSize%2A> property set to 10.</span></span> <span data-ttu-id="17b79-115">Gdy operacja napotka nieprawidłowy wiersz, jest zgłaszany wyjątek.</span><span class="sxs-lookup"><span data-stu-id="17b79-115">When the operation encounters the invalid row, an exception is thrown.</span></span> <span data-ttu-id="17b79-116">W tym przykładzie pierwsze operacji kopiowania zbiorczego jest nietransakcyjnej.</span><span class="sxs-lookup"><span data-stu-id="17b79-116">In this first example, the bulk copy operation is non-transacted.</span></span> <span data-ttu-id="17b79-117">Wszystkie instancje skopiowane aż do momentu wystąpienia błędu są zatwierdzone; zadanie wsadowe zawierające zduplikowany klucz zostanie wycofana i operacji kopiowania zbiorczego zostało zatrzymane przed przetworzeniem pozostałe partie.</span><span class="sxs-lookup"><span data-stu-id="17b79-117">All batches copied up to the point of the error are committed; the batch containing the duplicate key is rolled back, and the bulk copy operation is halted before processing any other batches.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="17b79-118">W tym przykładzie nie będzie działać, chyba że utworzonego tabelami pracy zgodnie z opisem w [Konfiguracja przykładu kopiowania zbiorczego](../../../../../docs/framework/data/adonet/sql/bulk-copy-example-setup.md).</span><span class="sxs-lookup"><span data-stu-id="17b79-118">This sample will not run unless you have created the work tables as described in [Bulk Copy Example Setup](../../../../../docs/framework/data/adonet/sql/bulk-copy-example-setup.md).</span></span> <span data-ttu-id="17b79-119">Ten kod jest dostarczany do zademonstrowania składnia przy użyciu **SqlBulkCopy** tylko.</span><span class="sxs-lookup"><span data-stu-id="17b79-119">This code is provided to demonstrate the syntax for using **SqlBulkCopy** only.</span></span> <span data-ttu-id="17b79-120">Jeśli tabele źródłowy i docelowy znajdują się w tym samym wystąpieniu programu SQL Server, jest łatwiejsze i szybsze do użycia [!INCLUDE[tsql](../../../../../includes/tsql-md.md)] `INSERT … SELECT` instrukcję, aby skopiować dane.</span><span class="sxs-lookup"><span data-stu-id="17b79-120">If the source and destination tables are located in the same SQL Server instance, it is easier and faster to use a [!INCLUDE[tsql](../../../../../includes/tsql-md.md)]`INSERT … SELECT` statement to copy the data.</span></span>  
  
 [!code-csharp[DataWorks SqlBulkCopy.DefaultTransaction#1](../../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.DefaultTransaction/CS/source.cs#1)]
 [!code-vb[DataWorks SqlBulkCopy.DefaultTransaction#1](../../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.DefaultTransaction/VB/source.vb#1)]  
  
## <a name="performing-a-dedicated-bulk-copy-operation-in-a-transaction"></a><span data-ttu-id="17b79-121">Wykonywanie operacji kopiowania zbiorczego dedykowanych w ramach transakcji</span><span class="sxs-lookup"><span data-stu-id="17b79-121">Performing a Dedicated Bulk Copy Operation in a Transaction</span></span>  
 <span data-ttu-id="17b79-122">Domyślnie operacji kopiowania zbiorczego jest swój własny transakcji.</span><span class="sxs-lookup"><span data-stu-id="17b79-122">By default, a bulk copy operation is its own transaction.</span></span> <span data-ttu-id="17b79-123">Do wykonania operacji kopiowania zbiorczego dedykowane, należy utworzyć nowe wystąpienie klasy <xref:System.Data.SqlClient.SqlBulkCopy> przy użyciu parametrów połączenia lub użyj istniejącego <xref:System.Data.SqlClient.SqlConnection> obiektu braku aktywnej transakcji.</span><span class="sxs-lookup"><span data-stu-id="17b79-123">When you want to perform a dedicated bulk copy operation, create a new instance of <xref:System.Data.SqlClient.SqlBulkCopy> with a connection string, or use an existing <xref:System.Data.SqlClient.SqlConnection> object without an active transaction.</span></span> <span data-ttu-id="17b79-124">W każdym scenariuszu operacji kopiowania zbiorczego tworzy i następnie zatwierdza lub powoduje wycofanie transakcji.</span><span class="sxs-lookup"><span data-stu-id="17b79-124">In each scenario, the bulk copy operation creates, and then commits or rolls back the transaction.</span></span>  
  
 <span data-ttu-id="17b79-125">Możesz jawnie określić <xref:System.Data.SqlClient.SqlBulkCopyOptions.UseInternalTransaction> opcji <xref:System.Data.SqlClient.SqlBulkCopy> konstruktora klasy, aby jawnie wywołać operacji kopiowania zbiorczego, można wykonać w jego własnej transakcji, powodując każdej partii operacji kopiowania zbiorczego można wykonać w osobnej transakcji.</span><span class="sxs-lookup"><span data-stu-id="17b79-125">You can explicitly specify the <xref:System.Data.SqlClient.SqlBulkCopyOptions.UseInternalTransaction> option in the <xref:System.Data.SqlClient.SqlBulkCopy> class constructor to explicitly cause a bulk copy operation to execute in its own transaction, causing each batch of the bulk copy operation to execute within a separate transaction.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="17b79-126">Ponieważ różnych partii są wykonywane w innej transakcji, jeśli wystąpi błąd podczas operacji kopiowania zbiorczego, wszystkie wiersze w bieżącej partii zostanie wycofana, ale wiersze z poprzednich partii pozostaną w bazie danych.</span><span class="sxs-lookup"><span data-stu-id="17b79-126">Since different batches are executed in different transactions, if an error occurs during the bulk copy operation, all the rows in the current batch will be rolled back, but rows from previous batches will remain in the database.</span></span>  
  
 <span data-ttu-id="17b79-127">Następująca aplikacja konsoli jest podobny do poprzedniego przykładu, z jednym wyjątkiem: W tym przykładzie operacji kopiowania zbiorczego zarządza własną transakcji.</span><span class="sxs-lookup"><span data-stu-id="17b79-127">The following console application is similar to the previous example, with one exception: In this example, the bulk copy operation manages its own transactions.</span></span> <span data-ttu-id="17b79-128">Wszystkie instancje skopiowane aż do momentu wystąpienia błędu są zatwierdzone; zadanie wsadowe zawierające zduplikowany klucz zostanie wycofana i operacji kopiowania zbiorczego zostało zatrzymane przed przetworzeniem pozostałe partie.</span><span class="sxs-lookup"><span data-stu-id="17b79-128">All batches copied up to the point of the error are committed; the batch containing the duplicate key is rolled back, and the bulk copy operation is halted before processing any other batches.</span></span>  
  
> [!IMPORTANT]
>  <span data-ttu-id="17b79-129">W tym przykładzie nie będzie działać, chyba że utworzonego tabelami pracy zgodnie z opisem w [Konfiguracja przykładu kopiowania zbiorczego](../../../../../docs/framework/data/adonet/sql/bulk-copy-example-setup.md).</span><span class="sxs-lookup"><span data-stu-id="17b79-129">This sample will not run unless you have created the work tables as described in [Bulk Copy Example Setup](../../../../../docs/framework/data/adonet/sql/bulk-copy-example-setup.md).</span></span> <span data-ttu-id="17b79-130">Ten kod jest dostarczany do zademonstrowania składnia przy użyciu **SqlBulkCopy** tylko.</span><span class="sxs-lookup"><span data-stu-id="17b79-130">This code is provided to demonstrate the syntax for using **SqlBulkCopy** only.</span></span> <span data-ttu-id="17b79-131">Jeśli tabele źródłowy i docelowy znajdują się w tym samym wystąpieniu programu SQL Server, jest łatwiejsze i szybsze do użycia [!INCLUDE[tsql](../../../../../includes/tsql-md.md)] `INSERT … SELECT` instrukcję, aby skopiować dane.</span><span class="sxs-lookup"><span data-stu-id="17b79-131">If the source and destination tables are located in the same SQL Server instance, it is easier and faster to use a [!INCLUDE[tsql](../../../../../includes/tsql-md.md)]`INSERT … SELECT` statement to copy the data.</span></span>  
  
 [!code-csharp[DataWorks SqlBulkCopy.InternalTransaction#1](../../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.InternalTransaction/CS/source.cs#1)]
 [!code-vb[DataWorks SqlBulkCopy.InternalTransaction#1](../../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.InternalTransaction/VB/source.vb#1)]  
  
## <a name="using-existing-transactions"></a><span data-ttu-id="17b79-132">Przy użyciu istniejących transakcji</span><span class="sxs-lookup"><span data-stu-id="17b79-132">Using Existing Transactions</span></span>  
 <span data-ttu-id="17b79-133">Można określić istniejący <xref:System.Data.SqlClient.SqlTransaction> obiekt jako parametr w <xref:System.Data.SqlClient.SqlBulkCopy> konstruktora.</span><span class="sxs-lookup"><span data-stu-id="17b79-133">You can specify an existing <xref:System.Data.SqlClient.SqlTransaction> object as a parameter in a <xref:System.Data.SqlClient.SqlBulkCopy> constructor.</span></span> <span data-ttu-id="17b79-134">W takiej sytuacji operacji kopiowania zbiorczego odbywa się w istniejącej transakcji i wprowadzania nie zmian w stan transakcji (oznacza to, go nie jest zatwierdzone ani przerwane).</span><span class="sxs-lookup"><span data-stu-id="17b79-134">In this situation, the bulk copy operation is performed in an existing transaction, and no change is made to the transaction state (that is, it is neither committed nor aborted).</span></span> <span data-ttu-id="17b79-135">Umożliwia to aplikacji, które mają zostać objęte operacji kopiowania zbiorczego transakcji z innymi operacjami bazy danych.</span><span class="sxs-lookup"><span data-stu-id="17b79-135">This allows an application to include the bulk copy operation in a transaction with other database operations.</span></span> <span data-ttu-id="17b79-136">Jednakże jeśli nie określisz <xref:System.Data.SqlClient.SqlTransaction> obiektu i przekazać odwołanie o wartości null, a połączenie ma aktywnej transakcji, zgłaszany jest wyjątek.</span><span class="sxs-lookup"><span data-stu-id="17b79-136">However, if you do not specify a <xref:System.Data.SqlClient.SqlTransaction> object and pass a null reference, and the connection has an active transaction, an exception is thrown.</span></span>  
  
 <span data-ttu-id="17b79-137">Jeśli musisz wycofać cała zbiorcza skopiować operacji, ponieważ wystąpi błąd lub jeśli kopiowania masowego powinien zostać wykonany jako część większego procesu, który można wycofać, można podać <xref:System.Data.SqlClient.SqlTransaction> obiekt <xref:System.Data.SqlClient.SqlBulkCopy> konstruktora.</span><span class="sxs-lookup"><span data-stu-id="17b79-137">If you need to roll back the entire bulk copy operation because an error occurs, or if the bulk copy should execute as part of a larger process that can be rolled back, you can provide a <xref:System.Data.SqlClient.SqlTransaction> object to the <xref:System.Data.SqlClient.SqlBulkCopy> constructor.</span></span>  
  
 <span data-ttu-id="17b79-138">Następująca aplikacja konsoli jest podobne do pierwszego (nietransakcyjnej), z jednym wyjątkiem: w tym przykładzie operacji kopiowania zbiorczego znajduje się w ramach transakcji większych i zewnętrznych.</span><span class="sxs-lookup"><span data-stu-id="17b79-138">The following console application is similar to the first (non-transacted) example, with one exception: in this example, the bulk copy operation is included in a larger, external transaction.</span></span> <span data-ttu-id="17b79-139">Gdy wystąpi błąd naruszenia klucza podstawowego, cała transakcja zostanie wycofana, a żadne wiersze są dodawane do tabeli docelowej.</span><span class="sxs-lookup"><span data-stu-id="17b79-139">When the primary key violation error occurs, the entire transaction is rolled back and no rows are added to the destination table.</span></span>  
  
> [!IMPORTANT]
>  <span data-ttu-id="17b79-140">W tym przykładzie nie będzie działać, chyba że utworzonego tabelami pracy zgodnie z opisem w [Konfiguracja przykładu kopiowania zbiorczego](../../../../../docs/framework/data/adonet/sql/bulk-copy-example-setup.md).</span><span class="sxs-lookup"><span data-stu-id="17b79-140">This sample will not run unless you have created the work tables as described in [Bulk Copy Example Setup](../../../../../docs/framework/data/adonet/sql/bulk-copy-example-setup.md).</span></span> <span data-ttu-id="17b79-141">Ten kod jest dostarczany do zademonstrowania składnia przy użyciu **SqlBulkCopy** tylko.</span><span class="sxs-lookup"><span data-stu-id="17b79-141">This code is provided to demonstrate the syntax for using **SqlBulkCopy** only.</span></span> <span data-ttu-id="17b79-142">Jeśli tabele źródłowy i docelowy znajdują się w tym samym wystąpieniu programu SQL Server, jest łatwiejsze i szybsze do użycia [!INCLUDE[tsql](../../../../../includes/tsql-md.md)] `INSERT … SELECT` instrukcję, aby skopiować dane.</span><span class="sxs-lookup"><span data-stu-id="17b79-142">If the source and destination tables are located in the same SQL Server instance, it is easier and faster to use a [!INCLUDE[tsql](../../../../../includes/tsql-md.md)]`INSERT … SELECT` statement to copy the data.</span></span>  
  
 [!code-csharp[DataWorks SqlBulkCopy.SqlTransaction#1](../../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.SqlTransaction/CS/source.cs#1)]
 [!code-vb[DataWorks SqlBulkCopy.SqlTransaction#1](../../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.SqlTransaction/VB/source.vb#1)]  
  
## <a name="see-also"></a><span data-ttu-id="17b79-143">Zobacz także</span><span class="sxs-lookup"><span data-stu-id="17b79-143">See also</span></span>
- [<span data-ttu-id="17b79-144">Operacje kopiowania masowego w programie SQL Server</span><span class="sxs-lookup"><span data-stu-id="17b79-144">Bulk Copy Operations in SQL Server</span></span>](../../../../../docs/framework/data/adonet/sql/bulk-copy-operations-in-sql-server.md)
- [<span data-ttu-id="17b79-145">ADO.NET zarządzanego dostawcy i Centrum deweloperów zestawu danych</span><span class="sxs-lookup"><span data-stu-id="17b79-145">ADO.NET Managed Providers and DataSet Developer Center</span></span>](https://go.microsoft.com/fwlink/?LinkId=217917)
