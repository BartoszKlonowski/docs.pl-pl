---
title: Kopiowanie i przypinanie
ms.date: 03/30/2017
ms.prod: .net-framework
ms.technology:
- dotnet-clr
ms.topic: article
helpviewer_keywords:
- pinning, interop marshaling
- copying, interop marshaling
- interop marshaling, copying
- interop marshaling, pinning
ms.assetid: 0059f576-e460-4e70-b257-668870e420b8
author: rpetrusha
ms.author: ronpet
manager: wpickett
ms.workload:
- dotnet
ms.openlocfilehash: c785c7bc9160cb252aad61fea00cce0d9a7eacdf
ms.sourcegitcommit: 9a4fe1a1c37b26532654b4bbe22d702237950009
ms.translationtype: MT
ms.contentlocale: pl-PL
ms.lasthandoff: 04/16/2018
---
# <a name="copying-and-pinning"></a><span data-ttu-id="b9ca3-102">Kopiowanie i przypinanie</span><span class="sxs-lookup"><span data-stu-id="b9ca3-102">Copying and Pinning</span></span>
<span data-ttu-id="b9ca3-103">Podczas organizowania danych, międzyoperacyjnego organizatora można skopiować lub przypiąć dane są przekazywane.</span><span class="sxs-lookup"><span data-stu-id="b9ca3-103">When marshaling data, the interop marshaler can copy or pin the data being marshaled.</span></span> <span data-ttu-id="b9ca3-104">Kopiowanie danych umieszcza kopię danych z jednej lokalizacji pamięci w innej lokalizacji pamięci.</span><span class="sxs-lookup"><span data-stu-id="b9ca3-104">Copying the data places a copy of data from one memory location in another memory location.</span></span> <span data-ttu-id="b9ca3-105">Na poniższej ilustracji przedstawiono różnice między kopiowanie typu wartości i kopiowanie typ przekazany przez odwołanie z zarządzanych do niezarządzanych pamięci.</span><span class="sxs-lookup"><span data-stu-id="b9ca3-105">The following illustration shows the differences between copying a value type and copying a type passed by reference from managed to unmanaged memory.</span></span>  
  
 <span data-ttu-id="b9ca3-106">![Wartość typów przekazywane według wartości i według odwołania](./media/interopmarshalcopy.gif "interopmarshalcopy")</span><span class="sxs-lookup"><span data-stu-id="b9ca3-106">![Value types passed by value and by reference](./media/interopmarshalcopy.gif "interopmarshalcopy")</span></span>  
<span data-ttu-id="b9ca3-107">Typy wartości przekazywane według wartości i według odwołania</span><span class="sxs-lookup"><span data-stu-id="b9ca3-107">Value types passed by value and by reference</span></span>  
  
 <span data-ttu-id="b9ca3-108">Argumenty metody przekazany przez wartość są przekazywane do kodu niezarządzanego jako wartości na stosie.</span><span class="sxs-lookup"><span data-stu-id="b9ca3-108">Method arguments passed by value are marshaled to unmanaged code as values on the stack.</span></span> <span data-ttu-id="b9ca3-109">Proces kopiowania jest bezpośrednie.</span><span class="sxs-lookup"><span data-stu-id="b9ca3-109">The copying process is direct.</span></span> <span data-ttu-id="b9ca3-110">Argumenty przekazywane przez odwołanie są przekazywane jako wskaźników na stosie.</span><span class="sxs-lookup"><span data-stu-id="b9ca3-110">Arguments passed by reference are passed as pointers on the stack.</span></span> <span data-ttu-id="b9ca3-111">Typy odwołań również są przekazywane według wartości i według odwołania.</span><span class="sxs-lookup"><span data-stu-id="b9ca3-111">Reference types are also passed by value and by reference.</span></span> <span data-ttu-id="b9ca3-112">Jak pokazano na poniższej ilustracji, typu odwołania przekazany przez wartość są kopiowane lub przypięty.</span><span class="sxs-lookup"><span data-stu-id="b9ca3-112">As the following illustration shows, reference types passed by value are either copied or pinned.</span></span>  
  
 <span data-ttu-id="b9ca3-113">![Współdziałanie z COM](./media/interopmarshalpin.gif "interopmarshalpin")</span><span class="sxs-lookup"><span data-stu-id="b9ca3-113">![COM interop](./media/interopmarshalpin.gif "interopmarshalpin")</span></span>  
<span data-ttu-id="b9ca3-114">Typy odwołań przekazywane według wartości i według odwołania</span><span class="sxs-lookup"><span data-stu-id="b9ca3-114">Reference types passed by value and by reference</span></span>  
  
 <span data-ttu-id="b9ca3-115">Przypinanie tymczasowo blokuje danych w jego bieżącej lokalizacji pamięci, w związku z tym zachowaniu z przeniesieniu przez moduł Garbage Collector środowiska CLR firmy.</span><span class="sxs-lookup"><span data-stu-id="b9ca3-115">Pinning temporarily locks the data in its current memory location, thus keeping it from being relocated by the common language runtime's garbage collector.</span></span> <span data-ttu-id="b9ca3-116">Organizator PIN danych pozwala zmniejszyć liczbę czynności kopiowania i zwiększyć wydajność.</span><span class="sxs-lookup"><span data-stu-id="b9ca3-116">The marshaler pins data to reduce the overhead of copying and enhance performance.</span></span> <span data-ttu-id="b9ca3-117">Typ danych określa, czy jest kopiowany lub przypięty podczas organizowania procesu.</span><span class="sxs-lookup"><span data-stu-id="b9ca3-117">The type of the data determines whether it is copied or pinned during the marshaling process.</span></span>  <span data-ttu-id="b9ca3-118">Przypinanie jest wykonywana automatycznie podczas marshaling dla obiektów, takich jak <xref:System.String>, ale można też ręcznie przypiąć przy użyciu pamięci <xref:System.Runtime.InteropServices.GCHandle> klasy.</span><span class="sxs-lookup"><span data-stu-id="b9ca3-118">Pinning is automatically performed during marshaling for objects such as <xref:System.String>, however you can also manually pin memory using the <xref:System.Runtime.InteropServices.GCHandle> class.</span></span>  
  
## <a name="formatted-blittable-classes"></a><span data-ttu-id="b9ca3-119">Klasy sformatowany Kopiowalne</span><span class="sxs-lookup"><span data-stu-id="b9ca3-119">Formatted Blittable Classes</span></span>  
 <span data-ttu-id="b9ca3-120">Sformatowany [kopiowalne](blittable-and-non-blittable-types.md) klasy wyeliminowaniu układu (sformatowany) i wspólne reprezentację danych zarówno w zarządzanych i niezarządzanych pamięci.</span><span class="sxs-lookup"><span data-stu-id="b9ca3-120">Formatted [blittable](blittable-and-non-blittable-types.md) classes have fixed layout (formatted) and common data representation in both managed and unmanaged memory.</span></span> <span data-ttu-id="b9ca3-121">Te typy potrzebują przekazywanie, wskaźnik do obiektu w stercie są przekazywane do wywoływany bezpośrednio.</span><span class="sxs-lookup"><span data-stu-id="b9ca3-121">When these types require marshaling, a pointer to the object in the heap is passed to the callee directly.</span></span> <span data-ttu-id="b9ca3-122">Wywoływany, można zmienić zawartość przywoływane przez wskaźnik lokalizacji w pamięci.</span><span class="sxs-lookup"><span data-stu-id="b9ca3-122">The callee can change the contents of the memory location being referenced by the pointer.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="b9ca3-123">Wywoływany, można zmienić zawartości pamięci, jeśli parametr jest oznaczony jako Out lub we/wy. Z kolei wywoływany należy unikać zmiany zawartości, gdy parametr ma wartość do organizowania jako w jest to wartość domyślna dla typy kopiowalne sformatowany.</span><span class="sxs-lookup"><span data-stu-id="b9ca3-123">The callee can change the memory contents if the parameter is marked Out or In/Out. In contrast, the callee should avoid changing the contents when the parameter is set to marshal as In, which is the default for formatted blittable types.</span></span> <span data-ttu-id="b9ca3-124">Modyfikowanie obiektu w generuje problemy podczas eksportowania tej samej klasy do biblioteki typów i używane do nawiązywania połączeń między apartamentu.</span><span class="sxs-lookup"><span data-stu-id="b9ca3-124">Modifying an In object generates problems when the same class is exported to a type library and used to make cross-apartment calls.</span></span>  
  
## <a name="formatted-non-blittable-classes"></a><span data-ttu-id="b9ca3-125">Klasy sformatowany niekopiowalne</span><span class="sxs-lookup"><span data-stu-id="b9ca3-125">Formatted Non-Blittable Classes</span></span>  
 <span data-ttu-id="b9ca3-126">Sformatowany [niekopiowalne](blittable-and-non-blittable-types.md) klasy wyeliminowaniu układu (sformatowany), ale reprezentację danych różni się w pamięci zarządzane i niezarządzane.</span><span class="sxs-lookup"><span data-stu-id="b9ca3-126">Formatted [non-blittable](blittable-and-non-blittable-types.md) classes have fixed layout (formatted) but the data representation is different in managed and unmanaged memory.</span></span> <span data-ttu-id="b9ca3-127">Dane można wymagać transformacji w następujących warunkach:</span><span class="sxs-lookup"><span data-stu-id="b9ca3-127">The data can require transformation under the following conditions:</span></span>  
  
-   <span data-ttu-id="b9ca3-128">Jeśli klasa niekopiowalne jest przekazywane przez wartość, wywoływany otrzymuje wskaźnik kopię struktury danych.</span><span class="sxs-lookup"><span data-stu-id="b9ca3-128">If a non-blittable class is marshaled by value, the callee receives a pointer to a copy of the data structure.</span></span>  
  
-   <span data-ttu-id="b9ca3-129">Jeśli klasa niekopiowalne jest przekazywane przez odwołanie, wywoływany otrzymuje wskaźnik na wskaźnik do kopiowania struktury danych.</span><span class="sxs-lookup"><span data-stu-id="b9ca3-129">If a non-blittable class is marshaled by reference, the callee receives a pointer to a pointer to a copy of the data structure.</span></span>  
  
-   <span data-ttu-id="b9ca3-130">Jeśli <xref:System.Runtime.InteropServices.InAttribute> atrybutu jest ustawiona, ta kopia zawsze jest inicjowany z stan wystąpienia, organizowanie odpowiednio do potrzeb.</span><span class="sxs-lookup"><span data-stu-id="b9ca3-130">If the <xref:System.Runtime.InteropServices.InAttribute> attribute is set, this copy is always initialized with the instance's state, marshaling as necessary.</span></span>  
  
-   <span data-ttu-id="b9ca3-131">Jeśli <xref:System.Runtime.InteropServices.OutAttribute> atrybutu jest ustawiona, stan jest zawsze kopiowany do wystąpienia przy powrocie organizowanie odpowiednio do potrzeb.</span><span class="sxs-lookup"><span data-stu-id="b9ca3-131">If the <xref:System.Runtime.InteropServices.OutAttribute> attribute is set, the state is always copied back to the instance on return, marshaling as necessary.</span></span>  
  
-   <span data-ttu-id="b9ca3-132">Jeśli oba **InAttribute** i **OutAttribute** skonfigurowano obydwie kopie są wymagane.</span><span class="sxs-lookup"><span data-stu-id="b9ca3-132">If both **InAttribute** and **OutAttribute** are set, both copies are required.</span></span> <span data-ttu-id="b9ca3-133">W przypadku pominięcia albo atrybut organizatora zoptymalizować przez wyeliminowanie Kopiuj.</span><span class="sxs-lookup"><span data-stu-id="b9ca3-133">If either attribute is omitted, the marshaler can optimize by eliminating either copy.</span></span>  
  
## <a name="reference-types"></a><span data-ttu-id="b9ca3-134">Typy odwołań</span><span class="sxs-lookup"><span data-stu-id="b9ca3-134">Reference Types</span></span>  
 <span data-ttu-id="b9ca3-135">Typy odwołań, mogą być przekazywane przez wartości lub według odwołania.</span><span class="sxs-lookup"><span data-stu-id="b9ca3-135">Reference types can be passed by value or by reference.</span></span> <span data-ttu-id="b9ca3-136">Gdy są one przekazywane przez wartość wskaźnika do typu są przekazywane na stosie.</span><span class="sxs-lookup"><span data-stu-id="b9ca3-136">When they are passed by value, a pointer to the type is passed on the stack.</span></span> <span data-ttu-id="b9ca3-137">Gdy dane są przekazywane przez odwołanie, wskaźnika do wskaźnika do typu są przekazywane na stosie.</span><span class="sxs-lookup"><span data-stu-id="b9ca3-137">When passed by reference, a pointer to a pointer to the type is passed on the stack.</span></span>  
  
 <span data-ttu-id="b9ca3-138">Typy referencyjne mieć warunkowego następujące działania:</span><span class="sxs-lookup"><span data-stu-id="b9ca3-138">Reference types have the following conditional behavior:</span></span>  
  
-   <span data-ttu-id="b9ca3-139">Jeśli typ referencyjny jest przekazywany przez wartość i ma elementów członkowskich typu niekopiowalne, typy są konwertowane dwa razy:</span><span class="sxs-lookup"><span data-stu-id="b9ca3-139">If a reference type is passed by value and it has members of non-blittable types, the types are converted twice:</span></span>  
  
    -   <span data-ttu-id="b9ca3-140">Gdy argument jest przekazywany do strony niezarządzane.</span><span class="sxs-lookup"><span data-stu-id="b9ca3-140">When an argument is passed to the unmanaged side.</span></span>  
  
    -   <span data-ttu-id="b9ca3-141">Na powrót z wywołania.</span><span class="sxs-lookup"><span data-stu-id="b9ca3-141">On return from the call.</span></span>  
  
     <span data-ttu-id="b9ca3-142">Aby uniknąć niepotrzebnie kopiowanie i konwersji, te typy są przekazywane jako w parametrach.</span><span class="sxs-lookup"><span data-stu-id="b9ca3-142">To avoid unnecessarily copying and conversion, these types are marshaled as In parameters.</span></span> <span data-ttu-id="b9ca3-143">Musisz jawnie zastosować **InAttribute** i **OutAttribute** atrybuty do argumentu dla obiekt wywołujący, aby zobaczyć zmiany wprowadzone przez funkcję wywołującą.</span><span class="sxs-lookup"><span data-stu-id="b9ca3-143">You must explicitly apply the **InAttribute** and **OutAttribute** attributes to an argument for the caller to see changes made by the callee.</span></span>  
  
-   <span data-ttu-id="b9ca3-144">Jeśli typ referencyjny jest przekazywany przez wartość i ma tylko członkowie typy kopiowalne, można przypiąć podczas przekazywania międzyprocesowego i wszelkie zmiany wprowadzone przez funkcję wywołującą elementy członkowskie tego typu są widoczne dla obiekt wywołujący.</span><span class="sxs-lookup"><span data-stu-id="b9ca3-144">If a reference type is passed by value and it has only members of blittable types, it can be pinned during marshaling and any changes made to the members of the type by the callee are seen by the caller.</span></span> <span data-ttu-id="b9ca3-145">Zastosuj **InAttribute** i **OutAttribute** jawnie, jeśli chcesz, aby ten problem.</span><span class="sxs-lookup"><span data-stu-id="b9ca3-145">Apply **InAttribute** and **OutAttribute** explicitly if you want this behavior.</span></span> <span data-ttu-id="b9ca3-146">Bez tych atrybutów kierunkową organizatora międzyoperacyjne nie eksportuje kierunkową informacji do biblioteki typów (go eksportuje jak w programie, co jest ustawieniem domyślnym) i może to spowodować problemy z organizowanie między apartamentu COM.</span><span class="sxs-lookup"><span data-stu-id="b9ca3-146">Without these directional attributes, the interop marshaler does not export directional information to the type library (it exports as In, which is the default) and this can cause problems with COM cross-apartment marshaling.</span></span>  
  
-   <span data-ttu-id="b9ca3-147">Jeśli typ referencyjny jest przekazywana przez odwołanie, jego będzie można zorganizować jako we/wy domyślnie.</span><span class="sxs-lookup"><span data-stu-id="b9ca3-147">If a reference type is passed by reference, it will be marshaled as In/Out by default.</span></span>  
  
## <a name="systemstring-and-systemtextstringbuilder"></a><span data-ttu-id="b9ca3-148">System.String i elementu System.Text.StringBuilder</span><span class="sxs-lookup"><span data-stu-id="b9ca3-148">System.String and System.Text.StringBuilder</span></span>  
 <span data-ttu-id="b9ca3-149">Gdy dane są przekazywane do kodu niezarządzanego według wartości lub według odwołania, organizator zwykle kopiuje dane w buforze dodatkowej (prawdopodobnie konwertowanie zestawów znaków podczas kopiowania) i przekazuje odwołanie do buforu wywoływany.</span><span class="sxs-lookup"><span data-stu-id="b9ca3-149">When data is marshaled to unmanaged code by value or by reference, the marshaler typically copies the data to a secondary buffer (possibly converting character sets during the copy) and passes a reference to the buffer to the callee.</span></span> <span data-ttu-id="b9ca3-150">Chyba, że odwołanie jest **BSTR** przydzielonych za pomocą **SysAllocString**, odwołanie, jest zawsze przydzielana z **CoTaskMemAlloc**.</span><span class="sxs-lookup"><span data-stu-id="b9ca3-150">Unless the reference is a **BSTR** allocated with **SysAllocString**, the reference is always allocated with **CoTaskMemAlloc**.</span></span>  
  
 <span data-ttu-id="b9ca3-151">Optymalizacji podczas dowolnego typu ciąg jest przekazywane przez wartość (na przykład ciąg znaków Unicode) organizatora przekazuje wywoływany bezpośrednio wskaźnika do zarządzanego ciągów w buforze Unicode wewnętrznego, zamiast go kopiować do bufor nowego.</span><span class="sxs-lookup"><span data-stu-id="b9ca3-151">As an optimization when either string type is marshaled by value (such as a Unicode character string), the marshaler passes the callee a direct pointer to managed strings in the internal Unicode buffer instead of copying it to a new buffer.</span></span>  
  
> [!CAUTION]
>  <span data-ttu-id="b9ca3-152">Jeśli ciąg jest przekazywany przez wartość, wywoływany nigdy nie należy zmienić odwołania przekazany przez organizatora.</span><span class="sxs-lookup"><span data-stu-id="b9ca3-152">When a string is passed by value, the callee must never alter the reference passed by the marshaler.</span></span> <span data-ttu-id="b9ca3-153">W ten sposób może spowodować uszkodzenie sterty zarządzanej.</span><span class="sxs-lookup"><span data-stu-id="b9ca3-153">Doing so can corrupt the managed heap.</span></span>  
  
 <span data-ttu-id="b9ca3-154">Gdy <xref:System.String?displayProperty=nameWithType> jest przekazywana przez odwołanie, organizator wpisuje ciąg do dodatkowej buforu przed wykonaniem połączenia.</span><span class="sxs-lookup"><span data-stu-id="b9ca3-154">When a <xref:System.String?displayProperty=nameWithType> is passed by reference, the marshaler copies the contents the string to a secondary buffer before making the call.</span></span> <span data-ttu-id="b9ca3-155">Następnie kopiuje zawartość buforów do nowego ciągu na powrót z wywołania.</span><span class="sxs-lookup"><span data-stu-id="b9ca3-155">It then copies the contents of the buffer into a new string on return from the call.</span></span> <span data-ttu-id="b9ca3-156">Ta metoda gwarantuje, że niezmienny ciąg zarządzanych pozostanie niezmieniona.</span><span class="sxs-lookup"><span data-stu-id="b9ca3-156">This technique ensures that the immutable managed string remains unaltered.</span></span>  
  
 <span data-ttu-id="b9ca3-157">Gdy <xref:System.Text.StringBuilder?displayProperty=nameWithType> jest przekazywany przez wartość i przekazuje organizatora odwołaniem do wewnętrznego buforu elementu **StringBuilder** bezpośrednio do obiektu wywołującego.</span><span class="sxs-lookup"><span data-stu-id="b9ca3-157">When a <xref:System.Text.StringBuilder?displayProperty=nameWithType> is passed by value, the marshaler passes a reference to the internal buffer of the **StringBuilder** directly to the caller.</span></span> <span data-ttu-id="b9ca3-158">Obiekt wywołujący i wywoływany należy uzgodnić rozmiar buforu.</span><span class="sxs-lookup"><span data-stu-id="b9ca3-158">The caller and callee must agree on the size of the buffer.</span></span> <span data-ttu-id="b9ca3-159">Element wywołujący jest odpowiedzialny za tworzenie **StringBuilder** odpowiedniej długości.</span><span class="sxs-lookup"><span data-stu-id="b9ca3-159">The caller is responsible for creating a **StringBuilder** of adequate length.</span></span> <span data-ttu-id="b9ca3-160">Wywoływany musi podjąć niezbędne środki ostrożności, aby upewnić się, że nie jest przepełnienie buforu.</span><span class="sxs-lookup"><span data-stu-id="b9ca3-160">The callee must take the necessary precautions to ensure that the buffer is not overrun.</span></span> <span data-ttu-id="b9ca3-161">**StringBuilder** jest wyjątek do reguły odwołujące się do typów przekazywane przez wartość są przekazywane tak jak parametry domyślnie.</span><span class="sxs-lookup"><span data-stu-id="b9ca3-161">**StringBuilder** is an exception to the rule that reference types passed by value are passed as In parameters by default.</span></span> <span data-ttu-id="b9ca3-162">Jest on zawsze przekazany jako we/wy.</span><span class="sxs-lookup"><span data-stu-id="b9ca3-162">It is always passed as In/Out.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="b9ca3-163">Zobacz też</span><span class="sxs-lookup"><span data-stu-id="b9ca3-163">See Also</span></span>  
 [<span data-ttu-id="b9ca3-164">Domyślne zachowanie marshalingu</span><span class="sxs-lookup"><span data-stu-id="b9ca3-164">Default Marshaling Behavior</span></span>](default-marshaling-behavior.md)  
 <span data-ttu-id="b9ca3-165">[Zarządzanie pamięcią z organizatora międzyoperacyjne](https://msdn.microsoft.com/library/417206ce-ee3e-4619-9529-0c0b686c7bee(v=vs.100))</span><span class="sxs-lookup"><span data-stu-id="b9ca3-165">[Memory Management with the Interop Marshaler](https://msdn.microsoft.com/library/417206ce-ee3e-4619-9529-0c0b686c7bee(v=vs.100))</span></span>  
 <span data-ttu-id="b9ca3-166">[Atrybuty kierunkową](https://msdn.microsoft.com/library/241ac5b5-928e-4969-8f58-1dbc048f9ea2(v=vs.100))</span><span class="sxs-lookup"><span data-stu-id="b9ca3-166">[Directional Attributes](https://msdn.microsoft.com/library/241ac5b5-928e-4969-8f58-1dbc048f9ea2(v=vs.100))</span></span>  
 [<span data-ttu-id="b9ca3-167">Marshaling międzyoperacyjny</span><span class="sxs-lookup"><span data-stu-id="b9ca3-167">Interop Marshaling</span></span>](interop-marshaling.md)
