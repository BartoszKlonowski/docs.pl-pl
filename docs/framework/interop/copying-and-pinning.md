---
title: Kopiowanie i przypinanie
ms.date: 03/30/2017
helpviewer_keywords:
- pinning, interop marshaling
- copying, interop marshaling
- interop marshaling, copying
- interop marshaling, pinning
ms.assetid: 0059f576-e460-4e70-b257-668870e420b8
ms.openlocfilehash: f6db7d37293015911c1285d39e19bf7542a7ac59
ms.sourcegitcommit: 559fcfbe4871636494870a8b716bf7325df34ac5
ms.translationtype: MT
ms.contentlocale: pl-PL
ms.lasthandoff: 10/30/2019
ms.locfileid: "73123639"
---
# <a name="copying-and-pinning"></a><span data-ttu-id="06795-102">Kopiowanie i przypinanie</span><span class="sxs-lookup"><span data-stu-id="06795-102">Copying and Pinning</span></span>

<span data-ttu-id="06795-103">Podczas organizowania danych Organizator międzyoperacyjny może skopiować lub przypiąć dane, które są organizowane.</span><span class="sxs-lookup"><span data-stu-id="06795-103">When marshaling data, the interop marshaler can copy or pin the data being marshaled.</span></span> <span data-ttu-id="06795-104">Kopiowanie danych powoduje umieszczenie kopii danych z jednej lokalizacji w innej lokalizacji pamięci.</span><span class="sxs-lookup"><span data-stu-id="06795-104">Copying the data places a copy of data from one memory location in another memory location.</span></span> <span data-ttu-id="06795-105">Na poniższej ilustracji przedstawiono różnice między kopiowaniem typu wartości i kopiowaniem typu przekazana przez odwołanie z zarządzanej do niezarządzanej pamięci.</span><span class="sxs-lookup"><span data-stu-id="06795-105">The following illustration shows the differences between copying a value type and copying a type passed by reference from managed to unmanaged memory.</span></span>

![Diagram przedstawiający sposób kopiowania typów wartości i odwołań.](./media/copying-and-pinning/interop-marshal-copy.gif)

<span data-ttu-id="06795-107">Argumenty metody przekazywane przez wartość są organizowane w kodzie niezarządzanym jako wartości na stosie.</span><span class="sxs-lookup"><span data-stu-id="06795-107">Method arguments passed by value are marshaled to unmanaged code as values on the stack.</span></span> <span data-ttu-id="06795-108">Proces kopiowania jest bezpośredni.</span><span class="sxs-lookup"><span data-stu-id="06795-108">The copying process is direct.</span></span> <span data-ttu-id="06795-109">Argumenty przekazane przez odwołanie są przekazane jako wskaźniki na stosie.</span><span class="sxs-lookup"><span data-stu-id="06795-109">Arguments passed by reference are passed as pointers on the stack.</span></span> <span data-ttu-id="06795-110">Typy odwołań są również przesyłane przez wartość i przez odwołanie.</span><span class="sxs-lookup"><span data-stu-id="06795-110">Reference types are also passed by value and by reference.</span></span> <span data-ttu-id="06795-111">Jak widać na poniższej ilustracji, typy odwołań przekazana przez wartość są kopiowane lub przypinane:</span><span class="sxs-lookup"><span data-stu-id="06795-111">As the following illustration shows, reference types passed by value are either copied or pinned:</span></span>

![Diagram przedstawiający typy odwołań, które są przesyłane przez wartość i przez odwołanie.](./media/copying-and-pinning/interop-marshal-reference-pin.gif)

<span data-ttu-id="06795-113">Przypinanie tymczasowo powoduje tymczasowe zablokowanie danych w bieżącej lokalizacji pamięci, dzięki czemu nie należy ich przełączać przez moduł wyrzucania elementów bezużytecznych środowiska uruchomieniowego języka wspólnego.</span><span class="sxs-lookup"><span data-stu-id="06795-113">Pinning temporarily locks the data in its current memory location, thus keeping it from being relocated by the common language runtime's garbage collector.</span></span> <span data-ttu-id="06795-114">Organizator przypina dane, aby zmniejszyć koszty kopiowania i zwiększania wydajności.</span><span class="sxs-lookup"><span data-stu-id="06795-114">The marshaler pins data to reduce the overhead of copying and enhance performance.</span></span> <span data-ttu-id="06795-115">Typ danych określa, czy jest on kopiowany, czy przypięty podczas procesu organizowania.</span><span class="sxs-lookup"><span data-stu-id="06795-115">The type of the data determines whether it is copied or pinned during the marshaling process.</span></span>  <span data-ttu-id="06795-116">Przypinanie jest wykonywane automatycznie podczas organizowania obiektów, takich jak <xref:System.String>, jednak można również ręcznie przypiąć pamięć przy użyciu klasy <xref:System.Runtime.InteropServices.GCHandle>.</span><span class="sxs-lookup"><span data-stu-id="06795-116">Pinning is automatically performed during marshaling for objects such as <xref:System.String>, however you can also manually pin memory using the <xref:System.Runtime.InteropServices.GCHandle> class.</span></span>

## <a name="formatted-blittable-classes"></a><span data-ttu-id="06795-117">Sformatowane klasy danych kopiowalnych</span><span class="sxs-lookup"><span data-stu-id="06795-117">Formatted Blittable Classes</span></span>

<span data-ttu-id="06795-118">Sformatowane klasy [danych kopiowalnych](blittable-and-non-blittable-types.md) mają stały układ (sformatowany) i wspólne reprezentację danych w pamięci zarządzanej i niezarządzanej.</span><span class="sxs-lookup"><span data-stu-id="06795-118">Formatted [blittable](blittable-and-non-blittable-types.md) classes have fixed layout (formatted) and common data representation in both managed and unmanaged memory.</span></span> <span data-ttu-id="06795-119">Gdy te typy wymagają kierowania, wskaźnik do obiektu w stercie jest przekazywany do elementu wywoływanego bezpośrednio.</span><span class="sxs-lookup"><span data-stu-id="06795-119">When these types require marshaling, a pointer to the object in the heap is passed to the callee directly.</span></span> <span data-ttu-id="06795-120">Wywoływany może zmienić zawartość lokalizacji pamięci, do której odwołuje się wskaźnik.</span><span class="sxs-lookup"><span data-stu-id="06795-120">The callee can change the contents of the memory location being referenced by the pointer.</span></span>

> [!NOTE]
> <span data-ttu-id="06795-121">Wywoływany może zmienić zawartość pamięci, jeśli parametr jest oznaczony jako out lub out. Z drugiej strony, obiekt wywoływany powinien unikać zmiany zawartości, gdy parametr jest ustawiony na wartość Marshal jako w, która jest wartością domyślną dla sformatowanych typów danych kopiowalnych.</span><span class="sxs-lookup"><span data-stu-id="06795-121">The callee can change the memory contents if the parameter is marked Out or In/Out. In contrast, the callee should avoid changing the contents when the parameter is set to marshal as In, which is the default for formatted blittable types.</span></span> <span data-ttu-id="06795-122">Modyfikowanie obiektu w programie generuje problemy, gdy ta sama klasa jest eksportowana do biblioteki typów i używana do wykonywania wywołań między komórkami.</span><span class="sxs-lookup"><span data-stu-id="06795-122">Modifying an In object generates problems when the same class is exported to a type library and used to make cross-apartment calls.</span></span>

## <a name="formatted-non-blittable-classes"></a><span data-ttu-id="06795-123">Sformatowane klasy inne niż danych kopiowalnych</span><span class="sxs-lookup"><span data-stu-id="06795-123">Formatted Non-Blittable Classes</span></span>

<span data-ttu-id="06795-124">Sformatowane klasy [inne niż danych kopiowalnych](blittable-and-non-blittable-types.md) mają stały układ (sformatowany), ale reprezentacja danych różni się w pamięci zarządzanej i niezarządzanej.</span><span class="sxs-lookup"><span data-stu-id="06795-124">Formatted [non-blittable](blittable-and-non-blittable-types.md) classes have fixed layout (formatted) but the data representation is different in managed and unmanaged memory.</span></span> <span data-ttu-id="06795-125">Dane mogą wymagać przekształcenia w następujących warunkach:</span><span class="sxs-lookup"><span data-stu-id="06795-125">The data can require transformation under the following conditions:</span></span>

- <span data-ttu-id="06795-126">Jeśli Klasa inny niż danych kopiowalnych jest zorganizowany przez wartość, wywoływany otrzymuje wskaźnik do kopii struktury danych.</span><span class="sxs-lookup"><span data-stu-id="06795-126">If a non-blittable class is marshaled by value, the callee receives a pointer to a copy of the data structure.</span></span>

- <span data-ttu-id="06795-127">Jeśli Klasa niedanych kopiowalnycha jest organizowana przez odwołanie, wywoływany otrzymuje wskaźnik do wskaźnika do kopii struktury danych.</span><span class="sxs-lookup"><span data-stu-id="06795-127">If a non-blittable class is marshaled by reference, the callee receives a pointer to a pointer to a copy of the data structure.</span></span>

- <span data-ttu-id="06795-128">Jeśli atrybut <xref:System.Runtime.InteropServices.InAttribute> jest ustawiony, ta kopia jest zawsze inicjowana przy użyciu stanu wystąpienia, kierując w razie potrzeby.</span><span class="sxs-lookup"><span data-stu-id="06795-128">If the <xref:System.Runtime.InteropServices.InAttribute> attribute is set, this copy is always initialized with the instance's state, marshaling as necessary.</span></span>

- <span data-ttu-id="06795-129">Jeśli atrybut <xref:System.Runtime.InteropServices.OutAttribute> jest ustawiony, stan jest zawsze kopiowany z powrotem do wystąpienia w przypadku powrotu, organizowania w razie potrzeby.</span><span class="sxs-lookup"><span data-stu-id="06795-129">If the <xref:System.Runtime.InteropServices.OutAttribute> attribute is set, the state is always copied back to the instance on return, marshaling as necessary.</span></span>

- <span data-ttu-id="06795-130">Jeśli ustawiono zarówno **atrybut unattribute** , jak i **atrybut** , wymagane są obie kopie.</span><span class="sxs-lookup"><span data-stu-id="06795-130">If both **InAttribute** and **OutAttribute** are set, both copies are required.</span></span> <span data-ttu-id="06795-131">Jeśli jeden atrybut zostanie pominięty, organizator może zoptymalizować, eliminując każdą kopię.</span><span class="sxs-lookup"><span data-stu-id="06795-131">If either attribute is omitted, the marshaler can optimize by eliminating either copy.</span></span>

## <a name="reference-types"></a><span data-ttu-id="06795-132">Typy odwołań</span><span class="sxs-lookup"><span data-stu-id="06795-132">Reference Types</span></span>

<span data-ttu-id="06795-133">Typy odwołań mogą być przesyłane przez wartość lub przez odwołanie.</span><span class="sxs-lookup"><span data-stu-id="06795-133">Reference types can be passed by value or by reference.</span></span> <span data-ttu-id="06795-134">Gdy są one przesyłane przez wartość, wskaźnik do typu jest przesyłany na stosie.</span><span class="sxs-lookup"><span data-stu-id="06795-134">When they are passed by value, a pointer to the type is passed on the stack.</span></span> <span data-ttu-id="06795-135">Po przekazaniu przez odwołanie wskaźnik do wskaźnika do typu jest przenoszona na stosie.</span><span class="sxs-lookup"><span data-stu-id="06795-135">When passed by reference, a pointer to a pointer to the type is passed on the stack.</span></span>

<span data-ttu-id="06795-136">Typy odwołań mają następujące zachowanie warunkowe:</span><span class="sxs-lookup"><span data-stu-id="06795-136">Reference types have the following conditional behavior:</span></span>

- <span data-ttu-id="06795-137">Jeśli typ referencyjny jest przesyłany przez wartość i ma elementy członkowskie typu innego niż danych kopiowalnych, typy są konwertowane dwa razy:</span><span class="sxs-lookup"><span data-stu-id="06795-137">If a reference type is passed by value and it has members of non-blittable types, the types are converted twice:</span></span>

  - <span data-ttu-id="06795-138">Gdy argument jest przenoszona do niezarządzanej strony.</span><span class="sxs-lookup"><span data-stu-id="06795-138">When an argument is passed to the unmanaged side.</span></span>

  - <span data-ttu-id="06795-139">Przy powrocie z wywołania.</span><span class="sxs-lookup"><span data-stu-id="06795-139">On return from the call.</span></span>

  <span data-ttu-id="06795-140">Aby uniknąć niepotrzebnego kopiowania i konwersji, te typy są organizowane jako parametry.</span><span class="sxs-lookup"><span data-stu-id="06795-140">To avoid unnecessarily copying and conversion, these types are marshaled as In parameters.</span></span> <span data-ttu-id="06795-141">Należy jawnie zastosować atrybuty **InAttribute** i **Attribute** do argumentu obiektu wywołującego, aby zobaczyć zmiany wprowadzone przez wywoływany element.</span><span class="sxs-lookup"><span data-stu-id="06795-141">You must explicitly apply the **InAttribute** and **OutAttribute** attributes to an argument for the caller to see changes made by the callee.</span></span>

- <span data-ttu-id="06795-142">Jeśli typ odwołania jest przekazywany przez wartość i ma tylko elementy członkowskie typów danych kopiowalnych, może być przypięty podczas organizowania, a wszelkie zmiany wprowadzone do elementów członkowskich typu przez obiekt wywoływany są widoczne przez wywołującego.</span><span class="sxs-lookup"><span data-stu-id="06795-142">If a reference type is passed by value and it has only members of blittable types, it can be pinned during marshaling and any changes made to the members of the type by the callee are seen by the caller.</span></span> <span data-ttu-id="06795-143">W przypadku tego zachowania należy jawnie zastosować **atrybut Attribute** i **subattribute** .</span><span class="sxs-lookup"><span data-stu-id="06795-143">Apply **InAttribute** and **OutAttribute** explicitly if you want this behavior.</span></span> <span data-ttu-id="06795-144">Bez tych atrybutów kierunkowych Organizator międzyoperacyjny nie eksportuje informacji kierunkowych do biblioteki typów (eksportuje ją jako wartość domyślna) i może to spowodować problemy z kierowaniem między projektami COM.</span><span class="sxs-lookup"><span data-stu-id="06795-144">Without these directional attributes, the interop marshaler does not export directional information to the type library (it exports as In, which is the default) and this can cause problems with COM cross-apartment marshaling.</span></span>

- <span data-ttu-id="06795-145">Jeśli typ odwołania jest przekazywany przez odwołanie, będzie on domyślnie zorganizowany jako przewidziany jako element.</span><span class="sxs-lookup"><span data-stu-id="06795-145">If a reference type is passed by reference, it will be marshaled as In/Out by default.</span></span>

## <a name="systemstring-and-systemtextstringbuilder"></a><span data-ttu-id="06795-146">System. String i system. Text. StringBuilder</span><span class="sxs-lookup"><span data-stu-id="06795-146">System.String and System.Text.StringBuilder</span></span>

<span data-ttu-id="06795-147">Gdy dane są przekazywane do kodu niezarządzanego przez wartość lub przez odwołanie, organizator zazwyczaj kopiuje dane do pomocniczego bufora (może to być spowodowane konwersją zestawów znaków podczas kopiowania) i przekazuje odwołanie do buforu do elementu wywoływanego.</span><span class="sxs-lookup"><span data-stu-id="06795-147">When data is marshaled to unmanaged code by value or by reference, the marshaler typically copies the data to a secondary buffer (possibly converting character sets during the copy) and passes a reference to the buffer to the callee.</span></span> <span data-ttu-id="06795-148">O ile odwołanie nie jest znakiem **BSTR** przydzielonym **SysAllocString**, odwołanie jest zawsze przyliczane z **CoTaskMemAlloc**.</span><span class="sxs-lookup"><span data-stu-id="06795-148">Unless the reference is a **BSTR** allocated with **SysAllocString**, the reference is always allocated with **CoTaskMemAlloc**.</span></span>

<span data-ttu-id="06795-149">Jako Optymalizacja, gdy jeden typ ciągu jest zorganizowany przez wartość (na przykład ciąg znaków Unicode), organizator przekazuje wywoływany bezpośredni wskaźnik do zarządzanych ciągów w wewnętrznym buforze Unicode zamiast kopiować go do nowego buforu.</span><span class="sxs-lookup"><span data-stu-id="06795-149">As an optimization when either string type is marshaled by value (such as a Unicode character string), the marshaler passes the callee a direct pointer to managed strings in the internal Unicode buffer instead of copying it to a new buffer.</span></span>

> [!CAUTION]
> <span data-ttu-id="06795-150">Gdy ciąg jest przekazywany przez wartość, wywoływany element nie może zmieniać odwołania przekazywanego przez organizatora.</span><span class="sxs-lookup"><span data-stu-id="06795-150">When a string is passed by value, the callee must never alter the reference passed by the marshaler.</span></span> <span data-ttu-id="06795-151">Wykonanie tej operacji może spowodować uszkodzenie sterty zarządzanej.</span><span class="sxs-lookup"><span data-stu-id="06795-151">Doing so can corrupt the managed heap.</span></span>

<span data-ttu-id="06795-152">Gdy <xref:System.String?displayProperty=nameWithType> jest przekazywany przez odwołanie, organizator kopiuje zawartość ciągu do pomocniczego buforu przed wywołaniem.</span><span class="sxs-lookup"><span data-stu-id="06795-152">When a <xref:System.String?displayProperty=nameWithType> is passed by reference, the marshaler copies the contents the string to a secondary buffer before making the call.</span></span> <span data-ttu-id="06795-153">Następnie zawartość bufora jest kopiowana do nowego ciągu przy powrocie z wywołania.</span><span class="sxs-lookup"><span data-stu-id="06795-153">It then copies the contents of the buffer into a new string on return from the call.</span></span> <span data-ttu-id="06795-154">Ta technika zapewnia, że niezmienny ciąg zarządzany pozostanie niezmieniony.</span><span class="sxs-lookup"><span data-stu-id="06795-154">This technique ensures that the immutable managed string remains unaltered.</span></span>

<span data-ttu-id="06795-155">Gdy <xref:System.Text.StringBuilder?displayProperty=nameWithType> jest przekazywany przez wartość, organizator przekazuje odwołanie do wewnętrznego buforu **StringBuilder** bezpośrednio do obiektu wywołującego.</span><span class="sxs-lookup"><span data-stu-id="06795-155">When a <xref:System.Text.StringBuilder?displayProperty=nameWithType> is passed by value, the marshaler passes a reference to the internal buffer of the **StringBuilder** directly to the caller.</span></span> <span data-ttu-id="06795-156">Obiekt wywołujący i wywoływany muszą zgadzać się z rozmiarem buforu.</span><span class="sxs-lookup"><span data-stu-id="06795-156">The caller and callee must agree on the size of the buffer.</span></span> <span data-ttu-id="06795-157">Obiekt wywołujący jest odpowiedzialny za utworzenie elementu **StringBuilder** o odpowiedniej długości.</span><span class="sxs-lookup"><span data-stu-id="06795-157">The caller is responsible for creating a **StringBuilder** of adequate length.</span></span> <span data-ttu-id="06795-158">Obiekt wywoływany musi wykonać odpowiednie środki ostrożności, aby upewnić się, że bufor nie zostanie przepełniony.</span><span class="sxs-lookup"><span data-stu-id="06795-158">The callee must take the necessary precautions to ensure that the buffer is not overrun.</span></span> <span data-ttu-id="06795-159">**StringBuilder** jest wyjątkiem od reguły, której typy odwołań przesłane przez wartość są domyślnie przesyłane jako parametry w parametrach.</span><span class="sxs-lookup"><span data-stu-id="06795-159">**StringBuilder** is an exception to the rule that reference types passed by value are passed as In parameters by default.</span></span> <span data-ttu-id="06795-160">Jest on zawsze przenoszona jako wynikowy.</span><span class="sxs-lookup"><span data-stu-id="06795-160">It is always passed as In/Out.</span></span>

## <a name="see-also"></a><span data-ttu-id="06795-161">Zobacz także</span><span class="sxs-lookup"><span data-stu-id="06795-161">See also</span></span>

- [<span data-ttu-id="06795-162">Domyślne zachowanie marshalingu</span><span class="sxs-lookup"><span data-stu-id="06795-162">Default Marshaling Behavior</span></span>](default-marshaling-behavior.md)
- <span data-ttu-id="06795-163">[Atrybuty kierunkowe](https://docs.microsoft.com/previous-versions/dotnet/netframework-4.0/77e6taeh(v=vs.100))</span><span class="sxs-lookup"><span data-stu-id="06795-163">[Directional Attributes](https://docs.microsoft.com/previous-versions/dotnet/netframework-4.0/77e6taeh(v=vs.100))</span></span>
- [<span data-ttu-id="06795-164">Marshaling międzyoperacyjny</span><span class="sxs-lookup"><span data-stu-id="06795-164">Interop Marshaling</span></span>](interop-marshaling.md)
