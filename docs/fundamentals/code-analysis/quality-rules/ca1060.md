---
title: 'CA1060: Przenieś P-Invoke do klasy NativeMethods (analiza kodu)'
description: 'Informacje o regule analizy kodu CA1060: Move P-Invoke to NativeMethods Class'
ms.date: 11/04/2016
ms.topic: reference
f1_keywords:
- MovePInvokesToNativeMethodsClass
- CA1060
helpviewer_keywords:
- MovePInvokesToNativeMethodsClass
- CA1060
author: gewarren
ms.author: gewarren
dev_langs:
- CSharp
- VB
ms.openlocfilehash: bc96c1b2d463a95ff5c5f61fc4642411cc6bca3b
ms.sourcegitcommit: a6bd4cad438fe479cbd112eae10f2cd449f06e40
ms.translationtype: MT
ms.contentlocale: pl-PL
ms.lasthandoff: 10/08/2020
ms.locfileid: "96589507"
---
# <a name="ca1060-move-pinvokes-to-nativemethods-class"></a><span data-ttu-id="a80cb-103">CA1060: Przenieś P/Invokes do klasy NativeMethods</span><span class="sxs-lookup"><span data-stu-id="a80cb-103">CA1060: Move P/Invokes to NativeMethods class</span></span>

| | <span data-ttu-id="a80cb-104">Wartość</span><span class="sxs-lookup"><span data-stu-id="a80cb-104">Value</span></span> |
|-|-|
| <span data-ttu-id="a80cb-105">**Identyfikator zasady**</span><span class="sxs-lookup"><span data-stu-id="a80cb-105">**Rule ID**</span></span> |<span data-ttu-id="a80cb-106">CA1060</span><span class="sxs-lookup"><span data-stu-id="a80cb-106">CA1060</span></span>|
| <span data-ttu-id="a80cb-107">**Kategoria**</span><span class="sxs-lookup"><span data-stu-id="a80cb-107">**Category**</span></span> |<span data-ttu-id="a80cb-108">Microsoft. Design</span><span class="sxs-lookup"><span data-stu-id="a80cb-108">Microsoft.Design</span></span>|
| <span data-ttu-id="a80cb-109">**Naprawa jest przerywana lub nieprzerwana**</span><span class="sxs-lookup"><span data-stu-id="a80cb-109">**Fix is breaking or non-breaking**</span></span> |<span data-ttu-id="a80cb-110">Kluczowa</span><span class="sxs-lookup"><span data-stu-id="a80cb-110">Breaking</span></span>|

## <a name="cause"></a><span data-ttu-id="a80cb-111">Przyczyna</span><span class="sxs-lookup"><span data-stu-id="a80cb-111">Cause</span></span>

<span data-ttu-id="a80cb-112">Metoda używa usług wywołania platformy w celu uzyskania dostępu do kodu niezarządzanego i nie jest elementem członkowskim jednej z klas **NativeMethods** .</span><span class="sxs-lookup"><span data-stu-id="a80cb-112">A method uses Platform Invocation Services to access unmanaged code and is not a member of one of the **NativeMethods** classes.</span></span>

## <a name="rule-description"></a><span data-ttu-id="a80cb-113">Opis reguły</span><span class="sxs-lookup"><span data-stu-id="a80cb-113">Rule description</span></span>

<span data-ttu-id="a80cb-114">Metody wywołania platformy, takie jak te, które są oznaczone przy użyciu <xref:System.Runtime.InteropServices.DllImportAttribute?displayProperty=fullName> atrybutu lub metod, które są zdefiniowane za pomocą `Declare` słowa kluczowego w Visual Basic, uzyskują dostęp do kodu niezarządzanego.</span><span class="sxs-lookup"><span data-stu-id="a80cb-114">Platform Invocation methods, such as those that are marked by using the <xref:System.Runtime.InteropServices.DllImportAttribute?displayProperty=fullName> attribute, or methods that are defined by using the `Declare` keyword in Visual Basic, access unmanaged code.</span></span> <span data-ttu-id="a80cb-115">Metody te powinny znajdować się w jednej z następujących klas:</span><span class="sxs-lookup"><span data-stu-id="a80cb-115">These methods should be in one of the following classes:</span></span>

- <span data-ttu-id="a80cb-116">**NativeMethods** — Ta klasa nie pomija przechodzenia stosu dla niezarządzanego kodu.</span><span class="sxs-lookup"><span data-stu-id="a80cb-116">**NativeMethods** - This class does not suppress stack walks for unmanaged code permission.</span></span> <span data-ttu-id="a80cb-117">( <xref:System.Security.SuppressUnmanagedCodeSecurityAttribute?displayProperty=fullName> nie może być zastosowany do tej klasy). Ta klasa jest dla metod, które mogą być używane w dowolnym miejscu, ponieważ zostanie wykonane przeszukiwanie stosu.</span><span class="sxs-lookup"><span data-stu-id="a80cb-117">(<xref:System.Security.SuppressUnmanagedCodeSecurityAttribute?displayProperty=fullName> must not be applied to this class.) This class is for methods that can be used anywhere because a stack walk will be performed.</span></span>

- <span data-ttu-id="a80cb-118">**SafeNativeMethods** — Ta klasa pomija przeszukiwania stosu dla niezarządzanego kodu.</span><span class="sxs-lookup"><span data-stu-id="a80cb-118">**SafeNativeMethods** - This class suppresses stack walks for unmanaged code permission.</span></span> <span data-ttu-id="a80cb-119">( <xref:System.Security.SuppressUnmanagedCodeSecurityAttribute?displayProperty=fullName> jest zastosowany do tej klasy). Ta klasa jest dla metod, które są bezpieczne dla każdego do wywołania.</span><span class="sxs-lookup"><span data-stu-id="a80cb-119">(<xref:System.Security.SuppressUnmanagedCodeSecurityAttribute?displayProperty=fullName> is applied to this class.) This class is for methods that are safe for anyone to call.</span></span> <span data-ttu-id="a80cb-120">Osoby wywołujące te metody nie są wymagane do przeprowadzenia pełnego przeglądu zabezpieczeń, aby upewnić się, że użycie jest bezpieczne, ponieważ metody są nieszkodliwe dla każdego obiektu wywołującego.</span><span class="sxs-lookup"><span data-stu-id="a80cb-120">Callers of these methods are not required to perform a full security review to make sure that the usage is secure because the methods are harmless for any caller.</span></span>

- <span data-ttu-id="a80cb-121">**UnsafeNativeMethods** — Ta klasa pomija przeszukiwania stosu dla niezarządzanego kodu.</span><span class="sxs-lookup"><span data-stu-id="a80cb-121">**UnsafeNativeMethods** - This class suppresses stack walks for unmanaged code permission.</span></span> <span data-ttu-id="a80cb-122">( <xref:System.Security.SuppressUnmanagedCodeSecurityAttribute?displayProperty=fullName> jest zastosowany do tej klasy). Ta klasa jest dla metod, które są potencjalnie niebezpieczne.</span><span class="sxs-lookup"><span data-stu-id="a80cb-122">(<xref:System.Security.SuppressUnmanagedCodeSecurityAttribute?displayProperty=fullName> is applied to this class.) This class is for methods that are potentially dangerous.</span></span> <span data-ttu-id="a80cb-123">Każdy obiekt wywołujący te metody musi wykonać pełny przegląd zabezpieczeń, aby upewnić się, że użycie jest bezpieczne, ponieważ nie zostanie wykonane żadne przeszukiwanie stosu.</span><span class="sxs-lookup"><span data-stu-id="a80cb-123">Any caller of these methods must perform a full security review to make sure that the usage is secure because no stack walk will be performed.</span></span>

<span data-ttu-id="a80cb-124">Klasy te są zadeklarowane jako `internal` ( `Friend` w Visual Basic) i deklarują Konstruktor prywatny, aby zapobiec tworzeniu nowych wystąpień.</span><span class="sxs-lookup"><span data-stu-id="a80cb-124">These classes are declared as `internal` (`Friend` in Visual Basic) and declare a private constructor to prevent new instances from being created.</span></span> <span data-ttu-id="a80cb-125">Metody w tych klasach powinny mieć wartość `static` i `internal` ( `Shared` i `Friend` w Visual Basic).</span><span class="sxs-lookup"><span data-stu-id="a80cb-125">The methods in these classes should be `static` and `internal` (`Shared` and `Friend` in Visual Basic).</span></span>

## <a name="how-to-fix-violations"></a><span data-ttu-id="a80cb-126">Jak naprawić naruszenia</span><span class="sxs-lookup"><span data-stu-id="a80cb-126">How to fix violations</span></span>

<span data-ttu-id="a80cb-127">Aby naprawić naruszenie tej reguły, Przenieś metodę do odpowiedniej klasy **NativeMethods** .</span><span class="sxs-lookup"><span data-stu-id="a80cb-127">To fix a violation of this rule, move the method to the appropriate **NativeMethods** class.</span></span> <span data-ttu-id="a80cb-128">W przypadku większości aplikacji przeniesienie P/Invoke do nowej klasy o nazwie **NativeMethods** jest wystarczające.</span><span class="sxs-lookup"><span data-stu-id="a80cb-128">For most applications, moving P/Invokes to a new class that is named **NativeMethods** is enough.</span></span>

<span data-ttu-id="a80cb-129">Jeśli jednak tworzysz biblioteki do użycia w innych aplikacjach, należy rozważyć zdefiniowanie dwóch innych klas o nazwie **SafeNativeMethods** i **UnsafeNativeMethods**.</span><span class="sxs-lookup"><span data-stu-id="a80cb-129">However, if you are developing libraries for use in other applications, you should consider defining two other classes that are called **SafeNativeMethods** and **UnsafeNativeMethods**.</span></span> <span data-ttu-id="a80cb-130">Klasy te przypominają klasę **NativeMethods** ; są one jednak oznaczone przy użyciu specjalnego atrybutu o nazwie **SuppressUnmanagedCodeSecurityAttribute**.</span><span class="sxs-lookup"><span data-stu-id="a80cb-130">These classes resemble the **NativeMethods** class; however, they are marked by using a special attribute called **SuppressUnmanagedCodeSecurityAttribute**.</span></span> <span data-ttu-id="a80cb-131">Gdy ten atrybut jest stosowany, środowisko uruchomieniowe nie wykonuje pełnego sprawdzenia stosu, aby upewnić się, że wszyscy wywołujący mają uprawnienie **UnmanagedCode** .</span><span class="sxs-lookup"><span data-stu-id="a80cb-131">When this attribute is applied, the runtime does not perform a full stack walk to make sure that all callers have the **UnmanagedCode** permission.</span></span> <span data-ttu-id="a80cb-132">Środowisko uruchomieniowe zwykle sprawdza dla tego uprawnienia podczas uruchamiania.</span><span class="sxs-lookup"><span data-stu-id="a80cb-132">The runtime ordinarily checks for this permission at startup.</span></span> <span data-ttu-id="a80cb-133">Ponieważ sprawdzenie nie jest wykonywane, może znacznie poprawić wydajność wywołań tych metod niezarządzanych, a także kod, który ma ograniczone uprawnienia do wywoływania tych metod.</span><span class="sxs-lookup"><span data-stu-id="a80cb-133">Because the check is not performed, it can greatly improve performance for calls to these unmanaged methods, It also enables code that has limited permissions to call these methods.</span></span>

<span data-ttu-id="a80cb-134">Tego atrybutu należy jednak używać bardzo ostrożnie.</span><span class="sxs-lookup"><span data-stu-id="a80cb-134">However, you should use this attribute with great care.</span></span> <span data-ttu-id="a80cb-135">Jeśli jest zaimplementowany nieprawidłowo, może to mieć poważne konsekwencje dla bezpieczeństwa.</span><span class="sxs-lookup"><span data-stu-id="a80cb-135">It can have serious security implications if it is implemented incorrectly..</span></span>

<span data-ttu-id="a80cb-136">Aby uzyskać informacje na temat sposobu implementacji metod, zobacz przykład **NativeMethods** , **SafeNativeMethods** example i **UnsafeNativeMethods** .</span><span class="sxs-lookup"><span data-stu-id="a80cb-136">For information about how to implement the methods, see the **NativeMethods** example, **SafeNativeMethods** example, and **UnsafeNativeMethods** example.</span></span>

## <a name="when-to-suppress-warnings"></a><span data-ttu-id="a80cb-137">Kiedy pominąć ostrzeżenia</span><span class="sxs-lookup"><span data-stu-id="a80cb-137">When to suppress warnings</span></span>

<span data-ttu-id="a80cb-138">Nie pomijaj ostrzeżeń dla tej reguły.</span><span class="sxs-lookup"><span data-stu-id="a80cb-138">Do not suppress a warning from this rule.</span></span>

## <a name="example"></a><span data-ttu-id="a80cb-139">Przykład</span><span class="sxs-lookup"><span data-stu-id="a80cb-139">Example</span></span>

<span data-ttu-id="a80cb-140">Poniższy przykład deklaruje metodę, która narusza tę regułę.</span><span class="sxs-lookup"><span data-stu-id="a80cb-140">The following example declares a method that violates this rule.</span></span> <span data-ttu-id="a80cb-141">Aby poprawić naruszenie, **RemoveDirectory** p/Invoke należy przenieść do odpowiedniej klasy, która jest przeznaczona do przechowywania tylko P/Invoke.</span><span class="sxs-lookup"><span data-stu-id="a80cb-141">To correct the violation, the **RemoveDirectory** P/Invoke should be moved to an appropriate class that is designed to hold only P/Invokes.</span></span>

:::code language="vb" source="snippets/vb/all-rules/ca1060-move-p-invokes-to-nativemethods-class_1.vb" id="snippet1":::

:::code language="csharp" source="snippets/csharp/all-rules/ca1060.cs" id="snippet1":::

## <a name="nativemethods-example"></a><span data-ttu-id="a80cb-142">Przykład NativeMethods</span><span class="sxs-lookup"><span data-stu-id="a80cb-142">NativeMethods example</span></span>

<span data-ttu-id="a80cb-143">Ponieważ Klasa **NativeMethods** nie powinna być oznaczona przy użyciu **SuppressUnmanagedCodeSecurityAttribute**, P/Invoke, które są umieszczane, będzie wymagały uprawnienia **UnmanagedCode** .</span><span class="sxs-lookup"><span data-stu-id="a80cb-143">Because the **NativeMethods** class should not be marked by using **SuppressUnmanagedCodeSecurityAttribute**, P/Invokes that are put in it will require **UnmanagedCode** permission.</span></span> <span data-ttu-id="a80cb-144">Ponieważ większość aplikacji jest uruchamiana z komputera lokalnego i działa z pełnym zaufaniem, zazwyczaj nie jest to problem.</span><span class="sxs-lookup"><span data-stu-id="a80cb-144">Because most applications run from the local computer and run together with full trust, this is usually not a problem.</span></span> <span data-ttu-id="a80cb-145">Jeśli jednak tworzysz biblioteki wielokrotnego użytku, należy rozważyć zdefiniowanie klasy **SafeNativeMethods** lub **UnsafeNativeMethods** .</span><span class="sxs-lookup"><span data-stu-id="a80cb-145">However, if you are developing reusable libraries, you should consider defining a **SafeNativeMethods** or **UnsafeNativeMethods** class.</span></span>

<span data-ttu-id="a80cb-146">Poniższy przykład przedstawia sposób **interakcji. dźwięk** , który otacza funkcję **MessageBeep** z user32.dll.</span><span class="sxs-lookup"><span data-stu-id="a80cb-146">The following example shows an **Interaction.Beep** method that wraps the **MessageBeep** function from user32.dll.</span></span> <span data-ttu-id="a80cb-147">**MessageBeep** P/Invoke jest umieszczana w klasie **NativeMethods** .</span><span class="sxs-lookup"><span data-stu-id="a80cb-147">The **MessageBeep** P/Invoke is put in the **NativeMethods** class.</span></span>

:::code language="vb" source="snippets/vb/all-rules/ca1060-move-p-invokes-to-nativemethods-class_1.vb" id="snippet2":::

:::code language="csharp" source="snippets/csharp/all-rules/ca1060.cs" id="snippet2":::

## <a name="safenativemethods-example"></a><span data-ttu-id="a80cb-148">Przykład SafeNativeMethods</span><span class="sxs-lookup"><span data-stu-id="a80cb-148">SafeNativeMethods example</span></span>

<span data-ttu-id="a80cb-149">Metody P/Invoke, które mogą być bezpiecznie uwidocznione dla dowolnej aplikacji i które nie mają żadnych efektów ubocznych, powinny być umieszczane w klasie o nazwie **SafeNativeMethods**.</span><span class="sxs-lookup"><span data-stu-id="a80cb-149">P/Invoke methods that can be safely exposed to any application and that do not have any side effects should be put in a class that is named **SafeNativeMethods**.</span></span> <span data-ttu-id="a80cb-150">Nie musisz zażądać uprawnień i nie musisz zwracać uwagi do lokalizacji, z której są wywoływane.</span><span class="sxs-lookup"><span data-stu-id="a80cb-150">You do not have to demand permissions and you do not have to pay much attention to where they are called from.</span></span>

<span data-ttu-id="a80cb-151">W poniższym przykładzie przedstawiono Właściwość **Environment.** nieruchomości, która zawija funkcję **GetTickCount** z kernel32.dll.</span><span class="sxs-lookup"><span data-stu-id="a80cb-151">The following example shows an **Environment.TickCount** property that wraps the **GetTickCount** function from kernel32.dll.</span></span>

:::code language="vb" source="snippets/vb/all-rules/ca1060-move-p-invokes-to-nativemethods-class_1.vb" id="snippet3":::

:::code language="csharp" source="snippets/csharp/all-rules/ca1060.cs" id="snippet3":::

## <a name="unsafenativemethods-example"></a><span data-ttu-id="a80cb-152">Przykład UnsafeNativeMethods</span><span class="sxs-lookup"><span data-stu-id="a80cb-152">UnsafeNativeMethods example</span></span>

<span data-ttu-id="a80cb-153">Metody P/Invoke, które nie mogą być bezpiecznie wywoływane i mogą spowodować, że efekty uboczne powinny zostać umieszczone w klasie o nazwie **UnsafeNativeMethods**.</span><span class="sxs-lookup"><span data-stu-id="a80cb-153">P/Invoke methods that cannot be safely called and that could cause side effects should be put in a class that is named **UnsafeNativeMethods**.</span></span> <span data-ttu-id="a80cb-154">Metody te powinny być ściśle sprawdzone, aby upewnić się, że nie są narażone na użytkownika przypadkowo.</span><span class="sxs-lookup"><span data-stu-id="a80cb-154">These methods should be rigorously checked to make sure that they are not exposed to the user unintentionally.</span></span> <span data-ttu-id="a80cb-155">Alternatywnie metody powinny mieć inne uprawnienia, które są żądane, zamiast **UnmanagedCode** , gdy ich używają.</span><span class="sxs-lookup"><span data-stu-id="a80cb-155">Alternatively, the methods should have another permission that is demanded instead of **UnmanagedCode** when they use them.</span></span>

<span data-ttu-id="a80cb-156">Poniższy przykład przedstawia **kursor. Ukryj** metodę, która zawija funkcję **ShowCursor** z user32.dll.</span><span class="sxs-lookup"><span data-stu-id="a80cb-156">The following example shows a **Cursor.Hide** method that wraps the **ShowCursor** function from user32.dll.</span></span>

:::code language="vb" source="snippets/vb/all-rules/ca1060-move-p-invokes-to-nativemethods-class_1.vb" id="snippet4":::

:::code language="csharp" source="snippets/csharp/all-rules/ca1060.cs" id="snippet4":::

## <a name="see-also"></a><span data-ttu-id="a80cb-157">Zobacz także</span><span class="sxs-lookup"><span data-stu-id="a80cb-157">See also</span></span>

- [<span data-ttu-id="a80cb-158">Reguły projektowania</span><span class="sxs-lookup"><span data-stu-id="a80cb-158">Design rules</span></span>](design-warnings.md)
