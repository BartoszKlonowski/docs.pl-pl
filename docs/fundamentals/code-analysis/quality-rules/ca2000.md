---
title: 'CA2000: Usuń obiekty przed utratą zakresu (analiza kodu)'
description: 'Dowiedz się więcej o regule analizy kodu CA2000: Usuń obiekty przed utratą zakresu'
ms.date: 05/14/2019
ms.topic: reference
f1_keywords:
- CA2000
- Dispose objects before losing scope
- DisposeObjectsBeforeLosingScope
helpviewer_keywords:
- CA2000
- DisposeObjectsBeforeLosingScope
author: gewarren
ms.author: gewarren
dev_langs:
- CSharp
- VB
ms.openlocfilehash: ef29091e9d78dd51abd539d3f185434a71b57138
ms.sourcegitcommit: e301979e3049ce412d19b094c60ed95b316a8f8c
ms.translationtype: MT
ms.contentlocale: pl-PL
ms.lasthandoff: 12/16/2020
ms.locfileid: "97593789"
---
# <a name="ca2000-dispose-objects-before-losing-scope"></a><span data-ttu-id="62a39-103">CA2000: Likwiduj obiekty przed utratą zakresu</span><span class="sxs-lookup"><span data-stu-id="62a39-103">CA2000: Dispose objects before losing scope</span></span>

| | <span data-ttu-id="62a39-104">Wartość</span><span class="sxs-lookup"><span data-stu-id="62a39-104">Value</span></span> |
|-|-|
| <span data-ttu-id="62a39-105">**Identyfikator zasady**</span><span class="sxs-lookup"><span data-stu-id="62a39-105">**Rule ID**</span></span> |<span data-ttu-id="62a39-106">CA2000</span><span class="sxs-lookup"><span data-stu-id="62a39-106">CA2000</span></span>|
| <span data-ttu-id="62a39-107">**Kategoria**</span><span class="sxs-lookup"><span data-stu-id="62a39-107">**Category**</span></span> |<span data-ttu-id="62a39-108">Microsoft. niezawodność</span><span class="sxs-lookup"><span data-stu-id="62a39-108">Microsoft.Reliability</span></span>|
| <span data-ttu-id="62a39-109">**Naprawa jest przerywana lub nieprzerwana**</span><span class="sxs-lookup"><span data-stu-id="62a39-109">**Fix is breaking or non-breaking**</span></span> |<span data-ttu-id="62a39-110">Nieprzerwanie</span><span class="sxs-lookup"><span data-stu-id="62a39-110">Non-breaking</span></span>|

## <a name="cause"></a><span data-ttu-id="62a39-111">Przyczyna</span><span class="sxs-lookup"><span data-stu-id="62a39-111">Cause</span></span>

<span data-ttu-id="62a39-112">Obiekt lokalny <xref:System.IDisposable> typu jest tworzony, ale obiekt nie jest usuwany, zanim wszystkie odwołania do obiektu nie są poza zakresem.</span><span class="sxs-lookup"><span data-stu-id="62a39-112">A local object of an <xref:System.IDisposable> type is created, but the object is not disposed before all references to the object are out of scope.</span></span>

<span data-ttu-id="62a39-113">Domyślnie ta reguła analizuje całą bazę kodu, ale [można to skonfigurować](#configure-code-to-analyze).</span><span class="sxs-lookup"><span data-stu-id="62a39-113">By default, this rule analyzes the entire codebase, but this is [configurable](#configure-code-to-analyze).</span></span>

## <a name="rule-description"></a><span data-ttu-id="62a39-114">Opis reguły</span><span class="sxs-lookup"><span data-stu-id="62a39-114">Rule description</span></span>

<span data-ttu-id="62a39-115">Jeśli obiekt do udostępnienia nie zostanie jawnie usunięty, zanim wszystkie odwołania do niego będą poza zakresem, obiekt zostanie usunięty w pewnym nieokreślonym czasie, gdy moduł zbierający elementy bezużyteczne uruchomi finalizator obiektu.</span><span class="sxs-lookup"><span data-stu-id="62a39-115">If a disposable object is not explicitly disposed before all references to it are out of scope, the object will be disposed at some indeterminate time when the garbage collector runs the finalizer of the object.</span></span> <span data-ttu-id="62a39-116">Ze względu na to, że może wystąpić wyjątkowe zdarzenie uniemożliwiające uruchomienie finalizatora obiektu, obiekt powinien zostać jawnie usunięty.</span><span class="sxs-lookup"><span data-stu-id="62a39-116">Because an exceptional event might occur that will prevent the finalizer of the object from running, the object should be explicitly disposed instead.</span></span>

## <a name="special-cases"></a><span data-ttu-id="62a39-117">Specjalne przypadki</span><span class="sxs-lookup"><span data-stu-id="62a39-117">Special cases</span></span>

<span data-ttu-id="62a39-118">CA2000 reguły nie uruchamia się w przypadku obiektów lokalnych następujących typów, nawet jeśli obiekt nie został usunięty:</span><span class="sxs-lookup"><span data-stu-id="62a39-118">Rule CA2000 does not fire for local objects of the following types even if the object is not disposed:</span></span>

- <xref:System.IO.Stream?displayProperty=nameWithType>
- <xref:System.IO.StringReader?displayProperty=nameWithType>
- <xref:System.IO.TextReader?displayProperty=nameWithType>
- <xref:System.IO.TextWriter?displayProperty=nameWithType>
- <xref:System.Resources.IResourceReader?displayProperty=nameWithType>

<span data-ttu-id="62a39-119">Przekazanie obiektu jednego z tych typów do konstruktora, a następnie przypisanie go do pola wskazuje na *przeniesienie własności usuwania* do nowo skonstruowanego typu.</span><span class="sxs-lookup"><span data-stu-id="62a39-119">Passing an object of one of these types to a constructor and then assigning it to a field indicates a *dispose ownership transfer* to the newly constructed type.</span></span> <span data-ttu-id="62a39-120">Oznacza to, że nowo skonstruowany typ jest teraz odpowiedzialny za usuwanie obiektu.</span><span class="sxs-lookup"><span data-stu-id="62a39-120">That is, the newly constructed type is now responsible for disposing of the object.</span></span> <span data-ttu-id="62a39-121">Jeśli kod przekazuje obiekt jednego z tych typów do konstruktora, nie ma naruszenia reguły CA2000, nawet jeśli obiekt nie zostanie usunięty, zanim wszystkie odwołania do niego będą poza zakresem.</span><span class="sxs-lookup"><span data-stu-id="62a39-121">If your code passes an object of one of these types to a constructor, no violation of rule CA2000 occurs even if the object is not disposed before all references to it are out of scope.</span></span>

## <a name="how-to-fix-violations"></a><span data-ttu-id="62a39-122">Jak naprawić naruszenia</span><span class="sxs-lookup"><span data-stu-id="62a39-122">How to fix violations</span></span>

<span data-ttu-id="62a39-123">Aby naprawić naruszenie tej reguły, wywołaj <xref:System.IDisposable.Dispose%2A> dla obiektu, zanim wszystkie odwołania do niego znajdują się poza zakresem.</span><span class="sxs-lookup"><span data-stu-id="62a39-123">To fix a violation of this rule, call <xref:System.IDisposable.Dispose%2A> on the object before all references to it are out of scope.</span></span>

<span data-ttu-id="62a39-124">Można użyć [ `using` instrukcji](../../../csharp/language-reference/keywords/using-statement.md) ( [`Using`](../../../visual-basic/language-reference/statements/using-statement.md) w Visual Basic) do zawijania obiektów, które implementują <xref:System.IDisposable> .</span><span class="sxs-lookup"><span data-stu-id="62a39-124">You can use the [`using` statement](../../../csharp/language-reference/keywords/using-statement.md) ([`Using`](../../../visual-basic/language-reference/statements/using-statement.md) in Visual Basic) to wrap objects that implement <xref:System.IDisposable>.</span></span> <span data-ttu-id="62a39-125">Obiekty, które są opakowane w ten sposób, są automatycznie usuwane na końcu `using` bloku.</span><span class="sxs-lookup"><span data-stu-id="62a39-125">Objects that are wrapped in this manner are automatically disposed at the end of the `using` block.</span></span> <span data-ttu-id="62a39-126">Jednakże następujące sytuacje nie powinny lub nie mogą być obsługiwane za pomocą `using` instrukcji:</span><span class="sxs-lookup"><span data-stu-id="62a39-126">However, the following situations should not or cannot be handled with a `using` statement:</span></span>

- <span data-ttu-id="62a39-127">Aby zwrócić pojedynczy obiekt, obiekt musi być skonstruowany w `try/finally` bloku poza `using` blokiem.</span><span class="sxs-lookup"><span data-stu-id="62a39-127">To return a disposable object, the object must constructed in a `try/finally` block outside of a `using` block.</span></span>

- <span data-ttu-id="62a39-128">Nie należy inicjować elementów członkowskich jednorazowego obiektu w konstruktorze `using` instrukcji.</span><span class="sxs-lookup"><span data-stu-id="62a39-128">Do not initialize members of a disposable object in the constructor of a `using` statement.</span></span>

- <span data-ttu-id="62a39-129">Gdy konstruktory chronione przez tylko jeden program obsługi wyjątków są zagnieżdżane w [części pozyskiwania `using` instrukcji](../../../csharp/language-reference/keywords/using-statement.md), Niepowodzenie w konstruktorze zewnętrznym może spowodować, że obiekt utworzony przez Konstruktor zagnieżdżony nigdy nie zostanie zamknięty.</span><span class="sxs-lookup"><span data-stu-id="62a39-129">When constructors that are protected by only one exception handler are nested in the [acquisition part of a `using` statement](../../../csharp/language-reference/keywords/using-statement.md), a failure in the outer constructor can result in the object created by the nested constructor never being closed.</span></span> <span data-ttu-id="62a39-130">W poniższym przykładzie błąd w <xref:System.IO.StreamReader> konstruktorze może spowodować, że <xref:System.IO.FileStream> obiekt nigdy nie jest zamykany.</span><span class="sxs-lookup"><span data-stu-id="62a39-130">In the following example, a failure in the <xref:System.IO.StreamReader> constructor can result in the <xref:System.IO.FileStream> object never being closed.</span></span> <span data-ttu-id="62a39-131">CA2000 flaguje naruszenie reguły w tym przypadku.</span><span class="sxs-lookup"><span data-stu-id="62a39-131">CA2000 flags a violation of the rule in this case.</span></span>

   ```csharp
   using (StreamReader sr = new StreamReader(new FileStream("C:\myfile.txt", FileMode.Create)))
   { ... }
   ```

- <span data-ttu-id="62a39-132">Obiekty dynamiczne powinny używać obiektu Shadow do implementowania wzorca Dispose <xref:System.IDisposable> obiektów.</span><span class="sxs-lookup"><span data-stu-id="62a39-132">Dynamic objects should use a shadow object to implement the dispose pattern of <xref:System.IDisposable> objects.</span></span>

## <a name="when-to-suppress-warnings"></a><span data-ttu-id="62a39-133">Kiedy pominąć ostrzeżenia</span><span class="sxs-lookup"><span data-stu-id="62a39-133">When to suppress warnings</span></span>

<span data-ttu-id="62a39-134">Nie pomijaj ostrzeżenia z tej reguły, chyba że:</span><span class="sxs-lookup"><span data-stu-id="62a39-134">Do not suppress a warning from this rule unless:</span></span>

- <span data-ttu-id="62a39-135">Wywołana została metoda dla obiektu wywołującego, na przykład `Dispose`<xref:System.IO.Stream.Close%2A></span><span class="sxs-lookup"><span data-stu-id="62a39-135">You've called a method on your object that calls `Dispose`, such as <xref:System.IO.Stream.Close%2A></span></span>
- <span data-ttu-id="62a39-136">Metoda, która wywołała ostrzeżenie zwraca <xref:System.IDisposable> obiekt, który otacza obiekt</span><span class="sxs-lookup"><span data-stu-id="62a39-136">The method that raised the warning returns an <xref:System.IDisposable> object that wraps your object</span></span>
- <span data-ttu-id="62a39-137">Metoda alokacji nie ma prawa własności; oznacza to, że odpowiedzialność za rozdysponowanie obiektu jest przenoszona do innego obiektu lub otoki, która jest tworzona w metodzie i zwracana do obiektu wywołującego</span><span class="sxs-lookup"><span data-stu-id="62a39-137">The allocating method does not have dispose ownership; that is, the responsibility to dispose the object is transferred to another object or wrapper that's created in the method and returned to the caller</span></span>

## <a name="configure-code-to-analyze"></a><span data-ttu-id="62a39-138">Konfigurowanie kodu do analizy</span><span class="sxs-lookup"><span data-stu-id="62a39-138">Configure code to analyze</span></span>

<span data-ttu-id="62a39-139">Użyj następujących opcji, aby skonfigurować, które części bazy kodu mają uruchamiać tę regułę.</span><span class="sxs-lookup"><span data-stu-id="62a39-139">Use the following options to configure which parts of your codebase to run this rule on.</span></span>

- [<span data-ttu-id="62a39-140">Wyklucz określone symbole</span><span class="sxs-lookup"><span data-stu-id="62a39-140">Exclude specific symbols</span></span>](#exclude-specific-symbols)
- [<span data-ttu-id="62a39-141">Wyklucz określone typy i ich typy pochodne</span><span class="sxs-lookup"><span data-stu-id="62a39-141">Exclude specific types and their derived types</span></span>](#exclude-specific-types-and-their-derived-types)

<span data-ttu-id="62a39-142">Można skonfigurować te opcje tylko dla tej reguły, dla wszystkich reguł lub dla wszystkich reguł w tej kategorii (niezawodność).</span><span class="sxs-lookup"><span data-stu-id="62a39-142">You can configure these options for just this rule, for all rules, or for all rules in this category (Reliability).</span></span> <span data-ttu-id="62a39-143">Aby uzyskać więcej informacji, zobacz [Opcje konfiguracji reguł jakości kodu](../code-quality-rule-options.md).</span><span class="sxs-lookup"><span data-stu-id="62a39-143">For more information, see [Code quality rule configuration options](../code-quality-rule-options.md).</span></span>

[!INCLUDE[excluded-symbol-names](~/includes/code-analysis/excluded-symbol-names.md)]

[!INCLUDE[excluded-type-names-with-derived-types](~/includes/code-analysis/excluded-type-names-with-derived-types.md)]

## <a name="related-rules"></a><span data-ttu-id="62a39-144">Powiązane reguły</span><span class="sxs-lookup"><span data-stu-id="62a39-144">Related rules</span></span>

- [<span data-ttu-id="62a39-145">CA2213: Pola możliwe do likwidacji należy likwidować</span><span class="sxs-lookup"><span data-stu-id="62a39-145">CA2213: Disposable fields should be disposed</span></span>](ca2213.md)

## <a name="example-1"></a><span data-ttu-id="62a39-146">Przykład 1</span><span class="sxs-lookup"><span data-stu-id="62a39-146">Example 1</span></span>

<span data-ttu-id="62a39-147">W przypadku implementowania metody, która zwraca pojedynczy obiekt, należy użyć bloku try/finally bez bloku catch, aby upewnić się, że obiekt został usunięty.</span><span class="sxs-lookup"><span data-stu-id="62a39-147">If you're implementing a method that returns a disposable object, use a try/finally block without a catch block to make sure that the object is disposed.</span></span> <span data-ttu-id="62a39-148">Za pomocą bloku try/finally można wypróbować wyjątki w punkcie błędu i upewnić się, że obiekt został usunięty.</span><span class="sxs-lookup"><span data-stu-id="62a39-148">By using a try/finally block, you allow exceptions to be raised at the fault point and make sure that object is disposed.</span></span>

<span data-ttu-id="62a39-149">W metodzie OpenPort1 wywołanie otwierania obiektu ISerializable klasy SerialPort lub wywołanie SomeMethod może zakończyć się niepowodzeniem.</span><span class="sxs-lookup"><span data-stu-id="62a39-149">In the OpenPort1 method, the call to open the ISerializable object SerialPort or the call to SomeMethod can fail.</span></span> <span data-ttu-id="62a39-150">W tej implementacji zgłoszono ostrzeżenie CA2000.</span><span class="sxs-lookup"><span data-stu-id="62a39-150">A CA2000 warning is raised on this implementation.</span></span>

<span data-ttu-id="62a39-151">W metodzie OpenPort2 są zadeklarowane dwa obiekty klasy SerialPort i mają ustawioną wartość null:</span><span class="sxs-lookup"><span data-stu-id="62a39-151">In the OpenPort2 method, two SerialPort objects are declared and set to null:</span></span>

- <span data-ttu-id="62a39-152">`tempPort`, który jest używany do testowania, że operacje metody powiodły się.</span><span class="sxs-lookup"><span data-stu-id="62a39-152">`tempPort`, which is used to test that the method operations succeed.</span></span>

- <span data-ttu-id="62a39-153">`port`, która jest używana dla wartości zwracanej przez metodę.</span><span class="sxs-lookup"><span data-stu-id="62a39-153">`port`, which is used for the return value of the method.</span></span>

<span data-ttu-id="62a39-154">`tempPort`Jest konstruowany i otwarty w `try` bloku, a wszystkie inne wymagane zadania są wykonywane w tym samym `try` bloku.</span><span class="sxs-lookup"><span data-stu-id="62a39-154">The `tempPort` is constructed and opened in a `try` block, and any other required work is performed in the same `try` block.</span></span> <span data-ttu-id="62a39-155">Na końcu `try` bloku otwarty port zostanie przypisany do `port` obiektu, który będzie zwracany, a `tempPort` obiekt jest ustawiony na `null` .</span><span class="sxs-lookup"><span data-stu-id="62a39-155">At the end of the `try` block, the opened port is assigned to the `port` object that will be returned and the `tempPort` object is set to `null`.</span></span>

<span data-ttu-id="62a39-156">`finally`Blok sprawdza wartość `tempPort` .</span><span class="sxs-lookup"><span data-stu-id="62a39-156">The `finally` block checks the value of `tempPort`.</span></span> <span data-ttu-id="62a39-157">Jeśli wartość nie jest równa null, operacja w metodzie zakończyła się niepowodzeniem i `tempPort` jest ZAMKNIĘTA, aby upewnić się, że wszystkie zasoby zostały wydane.</span><span class="sxs-lookup"><span data-stu-id="62a39-157">If it is not null, an operation in the method has failed, and `tempPort` is closed to make sure that any resources are released.</span></span> <span data-ttu-id="62a39-158">Zwrócony obiekt portu będzie zawierał otwarty obiekt klasy SerialPort, jeśli operacje metody zakończyły się powodzeniem lub jeśli operacja nie powiedzie się, będzie mieć wartość null.</span><span class="sxs-lookup"><span data-stu-id="62a39-158">The returned port object will contain the opened SerialPort object if the operations of the method succeeded, or it will be null if an operation failed.</span></span>

```csharp
public SerialPort OpenPort1(string portName)
{
   SerialPort port = new SerialPort(portName);
   port.Open();  //CA2000 fires because this might throw
   SomeMethod(); //Other method operations can fail
   return port;
}

public SerialPort OpenPort2(string portName)
{
   SerialPort tempPort = null;
   SerialPort port = null;
   try
   {
      tempPort = new SerialPort(portName);
      tempPort.Open();
      SomeMethod();
      //Add any other methods above this line
      port = tempPort;
      tempPort = null;

   }
   finally
   {
      if (tempPort != null)
      {
         tempPort.Close();
      }
   }
   return port;
}
```

```vb
Public Function OpenPort1(ByVal PortName As String) As SerialPort

   Dim port As New SerialPort(PortName)
   port.Open()    'CA2000 fires because this might throw
   SomeMethod()   'Other method operations can fail
   Return port

End Function

Public Function OpenPort2(ByVal PortName As String) As SerialPort

   Dim tempPort As SerialPort = Nothing
   Dim port As SerialPort = Nothing

   Try
      tempPort = New SerialPort(PortName)
      tempPort.Open()
      SomeMethod()
      'Add any other methods above this line
      port = tempPort
      tempPort = Nothing

   Finally
      If Not tempPort Is Nothing Then
         tempPort.Close()
      End If

   End Try

   Return port

End Function
```

## <a name="example-2"></a><span data-ttu-id="62a39-159">Przykład 2</span><span class="sxs-lookup"><span data-stu-id="62a39-159">Example 2</span></span>

<span data-ttu-id="62a39-160">Domyślnie kompilator Visual Basic ma wszystkie operatory arytmetyczne sprawdzają przepełnienie.</span><span class="sxs-lookup"><span data-stu-id="62a39-160">By default, the Visual Basic compiler has all arithmetic operators check for overflow.</span></span> <span data-ttu-id="62a39-161">W związku z tym każda operacja arytmetyczna Visual Basic może zgłosić <xref:System.OverflowException> .</span><span class="sxs-lookup"><span data-stu-id="62a39-161">Therefore, any Visual Basic arithmetic operation might throw an <xref:System.OverflowException>.</span></span> <span data-ttu-id="62a39-162">Może to prowadzić do nieoczekiwanych naruszeń reguł, takich jak CA2000.</span><span class="sxs-lookup"><span data-stu-id="62a39-162">This could lead to unexpected violations in rules such as CA2000.</span></span> <span data-ttu-id="62a39-163">Na przykład następująca funkcja CreateReader1 wygeneruje naruszenie zasad CA2000, ponieważ kompilator Visual Basic emituje instrukcję sprawdzającą przepełnienie dla dodatku, który mógłby zgłosić wyjątek, który mógłby spowodować, że StreamReader nie zostanie usunięte.</span><span class="sxs-lookup"><span data-stu-id="62a39-163">For example, the following CreateReader1 function will produce a CA2000 violation because the Visual Basic compiler is emitting an overflow checking instruction for the addition that could throw an exception that would cause the StreamReader not to be disposed.</span></span>

<span data-ttu-id="62a39-164">Aby rozwiązać ten problem, można wyłączyć emitowanie sprawdzania przepełnienia przez kompilator Visual Basic w projekcie lub zmodyfikować kod jak w następującej funkcji CreateReader2.</span><span class="sxs-lookup"><span data-stu-id="62a39-164">To fix this, you can disable the emitting of overflow checks by the Visual Basic compiler in your project or you can modify your code as in the following CreateReader2 function.</span></span>

<span data-ttu-id="62a39-165">Aby wyłączyć emitowanie sprawdzania przepełnienia, kliknij prawym przyciskiem myszy nazwę projektu w Eksplorator rozwiązań a następnie kliknij pozycję **Właściwości**.</span><span class="sxs-lookup"><span data-stu-id="62a39-165">To disable the emitting of overflow checks, right-click the project name in Solution Explorer and then click **Properties**.</span></span> <span data-ttu-id="62a39-166">Kliknij przycisk **Kompiluj**, kliknij pozycję **Zaawansowane opcje kompilacji**, a następnie zaznacz pole wyboru **Usuń operacje przepełnienia liczby całkowitej**.</span><span class="sxs-lookup"><span data-stu-id="62a39-166">Click **Compile**, click **Advanced Compile Options**, and then check **Remove integer overflow checks**.</span></span>

:::code language="vb" source="snippets/vb/all-rules/ca2000-dispose-objects-before-losing-scope-vboverflow_1.vb":::

## <a name="see-also"></a><span data-ttu-id="62a39-167">Zobacz także</span><span class="sxs-lookup"><span data-stu-id="62a39-167">See also</span></span>

- <xref:System.IDisposable>
- [<span data-ttu-id="62a39-168">Wzorzec Dispose</span><span class="sxs-lookup"><span data-stu-id="62a39-168">Dispose Pattern</span></span>](../../../standard/garbage-collection/implementing-dispose.md)
