---
title: Zbieranie danych diagnostycznych w kontenerach
description: W tym artykule dowiesz się, jak narzędzia diagnostyczne programu .NET Core mogą być używane w kontenerach platformy Docker.
ms.date: 09/01/2020
ms.openlocfilehash: cf4bbdf75e943f093a2202f91303a2eea7125487
ms.sourcegitcommit: 5114e7847e0ff8ddb8c266802d47af78567949cf
ms.translationtype: MT
ms.contentlocale: pl-PL
ms.lasthandoff: 11/19/2020
ms.locfileid: "94916212"
---
# <a name="collect-diagnostics-in-containers"></a><span data-ttu-id="b3316-103">Zbieranie danych diagnostycznych w kontenerach</span><span class="sxs-lookup"><span data-stu-id="b3316-103">Collect diagnostics in containers</span></span>

<span data-ttu-id="b3316-104">Te same narzędzia diagnostyczne, które są przydatne do diagnozowania problemów z platformą .NET Core w innych scenariuszach, również działają w kontenerach platformy Docker.</span><span class="sxs-lookup"><span data-stu-id="b3316-104">The same diagnostics tools that are useful for diagnosing .NET Core issues in other scenarios also work in Docker containers.</span></span> <span data-ttu-id="b3316-105">Jednak niektóre narzędzia wymagają specjalnych kroków do pracy w kontenerze.</span><span class="sxs-lookup"><span data-stu-id="b3316-105">However, some of the tools require special steps to work in a container.</span></span> <span data-ttu-id="b3316-106">W tym artykule opisano, jak narzędzia do zbierania danych śledzenia wydajności i zbierania zrzutów mogą być używane w kontenerach platformy Docker.</span><span class="sxs-lookup"><span data-stu-id="b3316-106">This article covers how tools for gathering performance traces and collecting dumps can be used in Docker containers.</span></span>

## <a name="using-net-core-cli-tools-in-a-container"></a><span data-ttu-id="b3316-107">Korzystanie z interfejs wiersza polecenia platformy .NET Core narzędzi w kontenerze</span><span class="sxs-lookup"><span data-stu-id="b3316-107">Using .NET Core CLI tools in a container</span></span>

<span data-ttu-id="b3316-108">**Te narzędzia dotyczą: ✔️** .net Core 3,0 SDK i nowszych wersji</span><span class="sxs-lookup"><span data-stu-id="b3316-108">**These tools apply to: ✔️** .NET Core 3.0 SDK and later versions</span></span>

<span data-ttu-id="b3316-109">Globalne narzędzia diagnostyczne interfejsu wiersza polecenia platformy .NET Core ( [`dotnet-counters`](dotnet-counters.md) , [`dotnet-dump`](dotnet-dump.md) , [`dotnet-gcdump`](dotnet-gcdump.md) i [`dotnet-trace`](dotnet-trace.md) ) są przeznaczone do pracy w wielu różnych środowiskach i powinny być wykonywane bezpośrednio w kontenerach platformy Docker.</span><span class="sxs-lookup"><span data-stu-id="b3316-109">The .NET Core global CLI diagnostic tools ([`dotnet-counters`](dotnet-counters.md), [`dotnet-dump`](dotnet-dump.md), [`dotnet-gcdump`](dotnet-gcdump.md), and [`dotnet-trace`](dotnet-trace.md)) are designed to work in a wide variety of environments and should all work directly in Docker containers.</span></span> <span data-ttu-id="b3316-110">W związku z tym narzędzia te są preferowaną metodą zbierania informacji diagnostycznych dotyczących scenariuszy .NET Core przeznaczonych dla platformy .NET Core 3,0 lub nowszej (lub 3,1 lub nowszej w przypadku `dotnet-gcdump` ) w kontenerach.</span><span class="sxs-lookup"><span data-stu-id="b3316-110">Because of this, these tools are the preferred method of collecting diagnostic information for .NET Core scenarios targeting .NET Core 3.0 or above (or 3.1 or above in the case of `dotnet-gcdump`) in containers.</span></span>

<span data-ttu-id="b3316-111">Jedynym czynnikiem, który komplikują korzystanie z tych narzędzi w kontenerze jest instalacja z zestaw .NET Core SDK i wiele kontenerów platformy Docker jest uruchomionych bez zestaw .NET Core SDK obecne.</span><span class="sxs-lookup"><span data-stu-id="b3316-111">The only complicating factor of using these tools in a container is that they are installed with the .NET Core SDK and many Docker containers run without the .NET Core SDK present.</span></span> <span data-ttu-id="b3316-112">Jednym z łatwych rozwiązań tego problemu jest zainstalowanie narzędzi w początkowym obrazie platformy Docker.</span><span class="sxs-lookup"><span data-stu-id="b3316-112">One easy solution to this problem is to install the tools in the initial Docker image.</span></span> <span data-ttu-id="b3316-113">Narzędzia nie potrzebują zestaw .NET Core SDK do uruchomienia, tylko do zainstalowania.</span><span class="sxs-lookup"><span data-stu-id="b3316-113">The tools don't need the .NET Core SDK to run, only to be installed.</span></span> <span data-ttu-id="b3316-114">W związku z tym można utworzyć pliku dockerfile z [Wieloetapową kompilacją](https://docs.docker.com/develop/develop-images/multistage-build/) , która instaluje narzędzia na etapie kompilacji (w którym znajduje się zestaw .NET Core SDK), a następnie kopiuje pliki binarne do obrazu końcowego.</span><span class="sxs-lookup"><span data-stu-id="b3316-114">Therefore, it's possible to create a Dockerfile with a [multi-stage build](https://docs.docker.com/develop/develop-images/multistage-build/) that installs the tools in a build stage (where the .NET Core SDK is present) and then copies the binaries into the final image.</span></span> <span data-ttu-id="b3316-115">Jedyną minusemem tego podejścia jest zwiększony rozmiar obrazu platformy Docker.</span><span class="sxs-lookup"><span data-stu-id="b3316-115">The only downside to this approach is increased Docker image size.</span></span>

```dockerfile
# In build stage
# Install desired .NET CLI diagnostics tools
RUN dotnet tool install --tool-path /tools dotnet-trace
RUN dotnet tool install --tool-path /tools dotnet-counters
RUN dotnet tool install --tool-path /tools dotnet-dump

...

# In final stage
# Copy diagnostics tools
WORKDIR /tools
COPY --from=build /tools .
```

<span data-ttu-id="b3316-116">Alternatywnie, zestaw .NET Core SDK można zainstalować w kontenerze, gdy jest to konieczne w celu zainstalowania narzędzi interfejsu wiersza polecenia.</span><span class="sxs-lookup"><span data-stu-id="b3316-116">Alternatively, the .NET Core SDK can be installed in a container when needed in order to install the CLI tools.</span></span> <span data-ttu-id="b3316-117">Należy pamiętać, że zainstalowanie zestaw .NET Core SDK będzie miało wpływ na ponowną instalację środowiska uruchomieniowego platformy .NET Core.</span><span class="sxs-lookup"><span data-stu-id="b3316-117">Be aware that installing the .NET Core SDK will have the side-effect of reinstalling the .NET Core runtime.</span></span> <span data-ttu-id="b3316-118">Upewnij się, że zainstalowano wersję zestawu SDK, która pasuje do środowiska uruchomieniowego znajdującego się w kontenerze.</span><span class="sxs-lookup"><span data-stu-id="b3316-118">So be sure to install the version of the SDK that matches the runtime present in the container.</span></span>

### <a name="using-net-core-global-cli-tools-in-a-sidecar-container"></a><span data-ttu-id="b3316-119">Korzystanie z globalnych narzędzi interfejsu wiersza polecenia platformy .NET Core w kontenerze przyczepki</span><span class="sxs-lookup"><span data-stu-id="b3316-119">Using .NET Core global CLI tools in a sidecar container</span></span>

<span data-ttu-id="b3316-120">Jeśli chcesz użyć narzędzi diagnostycznych globalnych interfejsu wiersza polecenia platformy .NET Core do diagnozowania procesów w innym kontenerze, weź pod uwagę następujące dodatkowe wymagania:</span><span class="sxs-lookup"><span data-stu-id="b3316-120">If you would like to use .NET Core global CLI diagnostic tools to diagnose processes in a different container, bear the following additional requirements in mind:</span></span>

1. <span data-ttu-id="b3316-121">Kontenery muszą [udostępniać przestrzeń nazw procesu](https://docs.docker.com/engine/reference/run/#pid-settings---pid) (dzięki czemu narzędzia w kontenerze przyczepki mogą uzyskać dostęp do procesów w kontenerze docelowym).</span><span class="sxs-lookup"><span data-stu-id="b3316-121">The containers must [share a process namespace](https://docs.docker.com/engine/reference/run/#pid-settings---pid) (so that tools in the sidecar container can access processes in the target container).</span></span>
2. <span data-ttu-id="b3316-122">Globalne narzędzia diagnostyczne interfejsu wiersza polecenia platformy .NET Core potrzebują dostępu do plików, które są zapisywane w środowisku uruchomieniowym .NET Core w katalogu/tmp, więc katalog/tmp musi być współużytkowany między docelowym i kontenerem przyczepki za pośrednictwem instalacji woluminu.</span><span class="sxs-lookup"><span data-stu-id="b3316-122">The .NET Core global CLI diagnostic tools need access to files the .NET Core runtime writes to the /tmp directory, so the /tmp directory must be shared between the target and sidecar container via a volume mount.</span></span> <span data-ttu-id="b3316-123">Można to zrobić na przykład w przypadku, gdy kontenery korzystają ze wspólnego [woluminu](https://docs.docker.com/storage/volumes/#create-and-manage-volumes) lub woluminu [emptyDir](https://kubernetes.io/docs/concepts/storage/volumes/#emptydir) Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="b3316-123">This could be done, for example, by having the containers share a common [volume](https://docs.docker.com/storage/volumes/#create-and-manage-volumes) or a Kubernetes [emptyDir](https://kubernetes.io/docs/concepts/storage/volumes/#emptydir) volume.</span></span> <span data-ttu-id="b3316-124">W przypadku próby użycia narzędzi diagnostycznych z kontenera przyczepki bez udostępniania katalogu/tmp zostanie wyświetlony komunikat o błędzie dotyczący procesu "niezgodnego środowiska uruchomieniowego .NET".</span><span class="sxs-lookup"><span data-stu-id="b3316-124">If you attempt to use the diagnostic tools from a sidecar container without sharing the /tmp directory, you will get an error about the process "not running compatible .NET runtime."</span></span>

## <a name="using-perfcollect-in-a-container"></a><span data-ttu-id="b3316-125">Używanie `PerfCollect` w kontenerze</span><span class="sxs-lookup"><span data-stu-id="b3316-125">Using `PerfCollect` in a container</span></span>

<span data-ttu-id="b3316-126">**To narzędzie dotyczy: ✔️** .net Core 2,1 i jego nowszych wersjach</span><span class="sxs-lookup"><span data-stu-id="b3316-126">**This tool applies to: ✔️** .NET Core 2.1 and later versions</span></span>

<span data-ttu-id="b3316-127">[`PerfCollect`](./trace-perfcollect-lttng.md)Skrypt jest przydatny do zbierania danych śledzenia wydajności i jest zalecanym narzędziem do zbierania śladów przed platformą .NET Core 3,0.</span><span class="sxs-lookup"><span data-stu-id="b3316-127">The [`PerfCollect`](./trace-perfcollect-lttng.md) script is useful for collecting performance traces and is the recommended tool for collecting traces prior to .NET Core 3.0.</span></span> <span data-ttu-id="b3316-128">W przypadku używania `PerfCollect` w kontenerze należy pamiętać o następujących wymaganiach:</span><span class="sxs-lookup"><span data-stu-id="b3316-128">If using `PerfCollect` in a container, keep the following requirements in mind:</span></span>

1. <span data-ttu-id="b3316-129">`PerfCollect`wymaga [ `SYS_ADMIN` możliwości](https://man7.org/linux/man-pages/man7/capabilities.7.html) (w celu uruchomienia `perf` Narzędzia), dlatego należy się upewnić, że kontener został [uruchomiony z tą możliwością](https://docs.docker.com/engine/reference/run/#runtime-privilege-and-linux-capabilities).</span><span class="sxs-lookup"><span data-stu-id="b3316-129">`PerfCollect` requires the [`SYS_ADMIN` capability](https://man7.org/linux/man-pages/man7/capabilities.7.html) (in order to run the `perf` tool), so be sure the container is [started with that capability](https://docs.docker.com/engine/reference/run/#runtime-privilege-and-linux-capabilities).</span></span>
2. <span data-ttu-id="b3316-130">`PerfCollect` wymaga ustawienia niektórych zmiennych środowiskowych przed aplikacją, która jest uruchamiana.</span><span class="sxs-lookup"><span data-stu-id="b3316-130">`PerfCollect` requires some environment variables be set prior to the app it is profiling starting.</span></span> <span data-ttu-id="b3316-131">Można je ustawić w [pliku dockerfile](https://docs.docker.com/engine/reference/builder/#env) lub podczas [uruchamiania kontenera](https://docs.docker.com/engine/reference/run/#env-environment-variables).</span><span class="sxs-lookup"><span data-stu-id="b3316-131">These can be set either in a [Dockerfile](https://docs.docker.com/engine/reference/builder/#env) or when [starting the container](https://docs.docker.com/engine/reference/run/#env-environment-variables).</span></span> <span data-ttu-id="b3316-132">Ponieważ te zmienne nie powinny być ustawiane w normalnych środowiskach produkcyjnych, często należy je dodać podczas uruchamiania kontenera, który zostanie profilowany.</span><span class="sxs-lookup"><span data-stu-id="b3316-132">Because these variables shouldn't be set in normal production environments, it's common to just add them when starting a container that will be profiled.</span></span> <span data-ttu-id="b3316-133">Dwie zmienne, które PerfCollect wymagają:</span><span class="sxs-lookup"><span data-stu-id="b3316-133">The two variables which PerfCollect requires are:</span></span>
    1. <span data-ttu-id="b3316-134">COMPlus_PerfMapEnabled = 1</span><span class="sxs-lookup"><span data-stu-id="b3316-134">COMPlus_PerfMapEnabled=1</span></span>
    1. <span data-ttu-id="b3316-135">COMPlus_EnableEventLog = 1</span><span class="sxs-lookup"><span data-stu-id="b3316-135">COMPlus_EnableEventLog=1</span></span>

### <a name="using-perfcollect-in-a-sidecar-container"></a><span data-ttu-id="b3316-136">Używanie `PerfCollect` w kontenerze przyczepki</span><span class="sxs-lookup"><span data-stu-id="b3316-136">Using `PerfCollect` in a sidecar container</span></span>

<span data-ttu-id="b3316-137">Jeśli chcesz uruchomić program `PerfCollect` w jednym kontenerze w celu profilowania procesu .NET Core w innym kontenerze, środowisko jest niemal takie samo, z wyjątkiem następujących różnic:</span><span class="sxs-lookup"><span data-stu-id="b3316-137">If you would like to run `PerfCollect` in one container to profile a .NET Core process in a different container, the experience is almost the same except for these differences:</span></span>

1. <span data-ttu-id="b3316-138">Zmienne środowiskowe wymienione wcześniej (COMPlus_PerfMapEnabled i COMPlus_EnableEventLog) muszą być ustawione dla kontenera docelowego (a nie z uruchomionym `PerfCollect` ).</span><span class="sxs-lookup"><span data-stu-id="b3316-138">The environment variables mentioned previously (COMPlus_PerfMapEnabled and COMPlus_EnableEventLog) must be set for the target container (not the one running `PerfCollect`).</span></span>
2. <span data-ttu-id="b3316-139">Uruchomiony kontener `PerfCollect` musi mieć `SYS_ADMIN` możliwość (nie jest to kontener docelowy).</span><span class="sxs-lookup"><span data-stu-id="b3316-139">The container running `PerfCollect` must have the `SYS_ADMIN` capability (not the target container).</span></span>
3. <span data-ttu-id="b3316-140">Dwa kontenery muszą [współdzielić przestrzeń nazw procesu](https://docs.docker.com/engine/reference/run/#pid-settings---pid).</span><span class="sxs-lookup"><span data-stu-id="b3316-140">The two containers must [share a process namespace](https://docs.docker.com/engine/reference/run/#pid-settings---pid).</span></span>

## <a name="using-createdump-in-a-container"></a><span data-ttu-id="b3316-141">Używanie `createdump` w kontenerze</span><span class="sxs-lookup"><span data-stu-id="b3316-141">Using `createdump` in a container</span></span>

<span data-ttu-id="b3316-142">**To narzędzie dotyczy: ✔️** .net Core 2,1 i jego nowszych wersjach</span><span class="sxs-lookup"><span data-stu-id="b3316-142">**This tool applies to: ✔️** .NET Core 2.1 and later versions</span></span>

<span data-ttu-id="b3316-143">Alternatywą dla `dotnet-dump` programu [`createdump`](https://github.com/dotnet/runtime/blob/master/docs/design/coreclr/botr/xplat-minidump-generation.md) można użyć do tworzenia podstawowych zrzutów w systemie Linux zawierających zarówno informacje natywne, jak i zarządzane.</span><span class="sxs-lookup"><span data-stu-id="b3316-143">An alternative to `dotnet-dump`, [`createdump`](https://github.com/dotnet/runtime/blob/master/docs/design/coreclr/botr/xplat-minidump-generation.md) can be used for creating core dumps on Linux containing both native and managed information.</span></span> <span data-ttu-id="b3316-144">`createdump`Narzędzie jest instalowane przy użyciu środowiska uruchomieniowego .NET Core i można je znaleźć obok libcoreclr.so (zazwyczaj w "/usr/share/dotnet/Shared/Microsoft.NETCore.App/[wersja]").</span><span class="sxs-lookup"><span data-stu-id="b3316-144">The `createdump` tool is installed with the .NET Core runtime and can be found next to libcoreclr.so (typically in "/usr/share/dotnet/shared/Microsoft.NETCore.App/[version]").</span></span> <span data-ttu-id="b3316-145">Narzędzie działa tak samo w kontenerze, jak w środowiskach z systemem Linux niekontenerów z pojedynczym wyjątkiem, że narzędzie wymaga tej [ `SYS_PTRACE` możliwości](https://man7.org/linux/man-pages/man7/capabilities.7.html), więc kontener platformy Docker musi być [uruchomiony z tą możliwością](https://docs.docker.com/engine/reference/run/#runtime-privilege-and-linux-capabilities).</span><span class="sxs-lookup"><span data-stu-id="b3316-145">The tool works the same in a container as it does in non-containerized Linux environments with the single exception that the tool requires the [`SYS_PTRACE` capability](https://man7.org/linux/man-pages/man7/capabilities.7.html), so the Docker container must be [started with that capability](https://docs.docker.com/engine/reference/run/#runtime-privilege-and-linux-capabilities).</span></span>

### <a name="using-createdump-in-a-sidecar-container"></a><span data-ttu-id="b3316-146">Używanie `createdump` w kontenerze przyczepki</span><span class="sxs-lookup"><span data-stu-id="b3316-146">Using `createdump` in a sidecar container</span></span>

<span data-ttu-id="b3316-147">Jeśli chcesz użyć `createdump` do utworzenia zrzutu z procesu w innym kontenerze, środowisko jest niemal takie samo, z wyjątkiem następujących różnic:</span><span class="sxs-lookup"><span data-stu-id="b3316-147">If you would like to use `createdump` to create a dump from a process in a different container, the experience is almost the same except for these differences:</span></span>

1. <span data-ttu-id="b3316-148">Uruchomiony kontener `createdump` musi mieć `SYS_PTRACE` możliwość (nie jest to kontener docelowy).</span><span class="sxs-lookup"><span data-stu-id="b3316-148">The container running `createdump` must have the `SYS_PTRACE` capability (not the target container).</span></span>
2. <span data-ttu-id="b3316-149">Dwa kontenery muszą [współdzielić przestrzeń nazw procesu](https://docs.docker.com/engine/reference/run/#pid-settings---pid).</span><span class="sxs-lookup"><span data-stu-id="b3316-149">The two containers must [share a process namespace](https://docs.docker.com/engine/reference/run/#pid-settings---pid).</span></span>
